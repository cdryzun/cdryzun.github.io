<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"/>
<title>Rancher 开启监控，及生产应用的优化配置工作说明 (一) - 「Johny'」PlayGround</title>
<meta content="webkit" name="renderer"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport"/>
<meta content="no-transform" http-equiv="Cache-Control"/>
<meta content="no-siteapp" http-equiv="Cache-Control"/>
<meta content="#f8f5ec" name="theme-color"/>
<meta content="#f8f5ec" name="msapplication-navbutton-color"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="#f8f5ec" name="apple-mobile-web-app-status-bar-style"/>
<meta content="Johny" name="author"/><meta content="使用 rancher prometheus operator 开启监控，并配置常用优化项的说明" name="description"/><meta content="rancher, prometheus, operator, devops, k8s, kubernetes" name="keywords"/>
<meta content="Hugo 0.92.0 with theme even" name="generator"/>
<link href="https://cdryzun.github.io/post/rancher-monitor-config-first/" rel="canonical"/>
<link href="/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180"/>
<link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"/>
<link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"/>
<link href="/manifest.json" rel="manifest"/>
<link color="#5bbad5" href="/safari-pinned-tab.svg" rel="mask-icon"/>
<link href="/sass/main.min.404b35997075abed13fc31198c48ccfa115c0855fc6e525128eac767d84fdcd2.css" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://cdn.treesir.pub/blog-css/jquery.fancybox.min.css" rel="stylesheet"/>
<link href="/css/custom.css" rel="stylesheet"/>
<meta content="Rancher 开启监控，及生产应用的优化配置工作说明 (一)" property="og:title"/>
<meta content="使用 rancher prometheus operator 开启监控，并配置常用优化项的说明" property="og:description"/>
<meta content="article" property="og:type"/>
<meta content="https://cdryzun.github.io/post/rancher-monitor-config-first/" property="og:url"/><meta content="post" property="article:section"/>
<meta content="2021-05-17T10:41:26+08:00" property="article:published_time"/>
<meta content="2021-05-17T10:41:26+08:00" property="article:modified_time"/>
<meta content="Rancher 开启监控，及生产应用的优化配置工作说明 (一)" itemprop="name"/>
<meta content="使用 rancher prometheus operator 开启监控，并配置常用优化项的说明" itemprop="description"/><meta content="2021-05-17T10:41:26+08:00" itemprop="datePublished"/>
<meta content="2021-05-17T10:41:26+08:00" itemprop="dateModified"/>
<meta content="3281" itemprop="wordCount"/>
<meta content="rancher,prometheus,operator,k8s,kubekey,exporter," itemprop="keywords"/><meta content="summary" name="twitter:card"/>
<meta content="Rancher 开启监控，及生产应用的优化配置工作说明 (一)" name="twitter:title"/>
<meta content="使用 rancher prometheus operator 开启监控，并配置常用优化项的说明" name="twitter:description"/>
<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->
<!--[if lt IE 9]>
  <script src="https://cdn.treesir.pub/blog-js/html5shiv.min.js"></script>
  <script src="https://cdn.treesir.pub/blog-js/respond.min.js"></script>
<![endif]-->
<link href="https://cdn.treesir.pub/blog-css/docsearch.min.css" rel="stylesheet"/>
</head>
<body>
<header class="header" id="header">
<div class="logo-wrapper">
<a class="logo" href="/">「Johny'」PlayGround</a>
</div>
<nav class="site-navbar">
<ul class="menu" id="menu">
<li class="menu-item">
<a class="menu-item-link" href="/">主页</a>
</li><li class="menu-item">
<a class="menu-item-link" href="/post/">归档</a>
</li><li class="menu-item">
<a class="menu-item-link" href="/tags/">标签</a>
</li><li class="menu-item">
<a class="menu-item-link" href="/categories/">分类</a>
</li>
</ul><li style="display:inline-block;margin-right:10px;">
<input class="docsearch-input" placeholder="Search" type="search"/>
</li></nav>
</header>
<div class="mobile-navbar" id="mobile-navbar">
<div class="mobile-header-logo">
<a class="logo" href="/">「Johny'」PlayGround</a>
</div>
<div class="mobile-navbar-icon">
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav class="mobile-menu slideout-menu" id="mobile-menu">
<ul class="mobile-menu-list">
<a href="/">
<li class="mobile-menu-item">主页</li>
</a><a href="/post/">
<li class="mobile-menu-item">归档</li>
</a><a href="/tags/">
<li class="mobile-menu-item">标签</li>
</a><a href="/categories/">
<li class="mobile-menu-item">分类</li>
</a>
</ul>
</nav>
<div class="container" id="mobile-panel">
<main class="main" id="main">
<div class="content-wrapper">
<div class="content" id="content">
<article class="post">
<header class="post-header">
<h1 class="post-title">Rancher 开启监控，及生产应用的优化配置工作说明 (一)</h1>
<div class="post-meta">
<span class="post-time"> 2021-05-17 </span>
<div class="post-category">
<a href="/categories/devops/"> devops </a>
<a href="/categories/k8s/"> k8s </a>
<a href="/categories/prometheus/"> prometheus </a>
</div>
<span class="more-meta"> 约 3281 字 </span>
<span class="more-meta"> 预计阅读 7 分钟 </span>
</div>
</header>
<div class="post-toc" id="post-toc">
<h2 class="post-toc-title">文章目录</h2>
<div class="post-toc-content always-active">
<nav id="TableOfContents">
<ul>
<li><a href="#环境说明">环境说明</a></li>
<li><a href="#基础环境配置">基础环境配置</a>
<ul>
<li><a href="#使用-kubekey-部署-kubernetes-集群">使用 kubekey 部署 kubernetes 集群</a></li>
<li><a href="#rancher-单机部署">rancher 单机部署</a></li>
<li><a href="#安装-nfs-classstorage">安装 nfs classStorage</a></li>
</ul>
</li>
<li><a href="#开启监控">开启监控</a>
<ul>
<li><a href="#首先为集群开启监控">首先为集群开启监控</a></li>
<li><a href="#开启项目级别监控">开启项目级别监控</a></li>
</ul>
</li>
<li><a href="#监控系统优化">监控系统优化</a>
<ul>
<li><a href="#更改-service-模式为-nodeport">更改 service 模式为 <code>NodePort</code></a></li>
<li><a href="#安装-metrics-server">安装 metrics-server</a></li>
</ul>
</li>
<li><a href="#配置-targets-自动发现说明">配置 targets 自动发现说明</a>
<ul>
<li><a href="#清理无用指标">清理无用指标</a></li>
<li><a href="#添加-targets-指标发现">添加 targets 指标发现</a>
<ul>
<li><a href="#添加-etcd-指标发现">添加 <code>etcd</code> 指标发现</a></li>
<li><a href="#添加-controller-manager-指标抓取">添加 controller-manager 指标抓取</a></li>
<li><a href="#添加-scheduler-指标抓取">添加 scheduler 指标抓取</a></li>
<li><a href="#添加-coredns-指标抓取">添加 coredns 指标抓取</a></li>
<li><a href="#添加-apiserver-指标抓取">添加 apiserver 指标抓取</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#总结">总结</a></li>
</ul>
</nav>
</div>
</div>
<div class="post-content">
<h1 id="环境说明">环境说明</h1>
<ul>
<li>kubernetes version: <code>v1.17.9</code></li>
<li>rancher dashboard: <code>v2.3.5</code></li>
<li>操作系统:  <code>centos 7.8.2003 </code></li>
</ul>
<h1 id="基础环境配置">基础环境配置</h1>
<h2 id="使用-kubekey-部署-kubernetes-集群">使用 kubekey 部署 kubernetes 集群</h2>
<blockquote>
<p>由于篇幅原因，此处省略部署说明，请参考较早期的 <a href="http://hugo.blog:1313/post/kubekey-install-k8s/">文档说明</a></p>
</blockquote>
<h2 id="rancher-单机部署">rancher 单机部署</h2>
<p><strong>安装 docker-compose</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">yum install -y docker-compose
</code></pre></td></tr></table>
</div>
</div><p><strong>创建 workspace 目录</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">mkdir -p /data/docker-compose/rancher
</code></pre></td></tr></table>
</div>
</div><p><strong>创建配置文件 &amp; 启动容器</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> /data/docker-compose/rancher

cat &gt; docker-compose.yaml <span class="s">&lt;&lt; EOF
</span><span class="s">version: "3"
</span><span class="s">services:
</span><span class="s">  rancher:
</span><span class="s">    container_name: rancher
</span><span class="s">    image: rancher/rancher:v2.3.5 # 这里注意一下版本，请使用 2.0.x - 2.4.x 的版本，因为在 2.5 版本后之后的版本，对 dashboard 界面和管理方式做了大幅修改。
</span><span class="s">    volumes:
</span><span class="s">      - /var/lib/rancher:/var/lib/rancher  # rancher 数据持久化
</span><span class="s">    ports:
</span><span class="s">      - "80:80/tcp"
</span><span class="s">      - "443:443/tcp"
</span><span class="s">    privileged: true
</span><span class="s">    restart: unless-stopped
</span><span class="s">EOF</span>

docker-compose up -d <span class="c1"># 启动对应容器</span>

docker-compose logs -f  <span class="c1"># 启动后观察 一下启动日志，有无错误信息</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>省略</code> rancher 导入集群操作，请参考较之前的 <a href="https://www.treesir.pub/post/kubeadm-deploy-k8s1.9/#rancher-%E5%AF%BC%E5%85%A5%E9%9B%86%E7%BE%A4">文档</a></p>
</blockquote>
<p><img alt="image-20210517112232846" src="https://cdn.treesir.pub/img/image-20210517112232846.png"/></p>
<h2 id="安装-nfs-classstorage">安装 nfs classStorage</h2>
<blockquote>
<p>此处同样省略，请参照早期 <a href="https://www.treesir.pub/post/k8s-nfs-strage-class/">文档</a></p>
</blockquote>
<h1 id="开启监控">开启监控</h1>
<h2 id="首先为集群开启监控">首先为集群开启监控</h2>
<blockquote>
<p>rancher 需要开启<code>系统层面</code> 的监控，才能逐个打开项目级别的监控。</p>
</blockquote>
<p><strong>开启系统层面的监控</strong></p>
<p>点击选择的集群</p>
<p><img alt="image-20210517112949250" src="https://cdn.treesir.pub/img/image-20210517112949250.png"/></p>
<p><img alt="image-20210517113023615" src="https://cdn.treesir.pub/img/image-20210517113023615.png"/></p>
<p><img alt="image-20210517113718405" src="https://cdn.treesir.pub/img/image-20210517113718405.png"/></p>
<blockquote>
<p>这里数据持久时间为 <code>168h</code> , 一般开发环境是够用了，生产环境按需延长就好。使用存储类为 <code>nfs</code>，如有条件建议更换为分布式存储，如 ceph，解决 nfs <code>单点故障</code>问题。资源限制这里做了增大处理，毕竟 prometheus 数据是先暂存到内存中，在一定时间后定期刷新到磁盘上去的，还是比较吃内存的，为避免出现 <code>oomkill</code> 情况，建议最少也的配置一个 4g 内存。</p>
</blockquote>
<p>等待所有 pod 启动完成，命名空间为 <code>cattle-prometheus</code></p>
<p><img alt="image-20210517133847287" src="https://cdn.treesir.pub/img/image-20210517133847287.png"/></p>
<p><img alt="image-20210517134221013" src="https://cdn.treesir.pub/img/image-20210517134221013.png"/></p>
<blockquote>
<p>可以看到，再次登录页面查看时，页面也已经丰富了许多。这里需要特别主要以下这个聚合图标，<code>蓝色</code> 为集群资源限制中 <code>limits</code> 所预留占用的资源的聚合，<code>绿色</code> 为集群目前正在使用的资源情况。</p>
</blockquote>
<h2 id="开启项目级别监控">开启项目级别监控</h2>
<p><img alt="image-20210517134831934" src="https://cdn.treesir.pub/img/image-20210517134831934.png"/></p>
<blockquote>
<p>这个就是 rancher 中的项目，属于是 rancher 中对 <code>一组 namespace</code> 集合的抽象。</p>
</blockquote>
<p><strong>选取需要开启监控的项目</strong></p>
<p><img alt="image-20210517135033545" src="https://cdn.treesir.pub/img/image-20210517135033545.png"/></p>
<p><img alt="image-20210517135055519" src="https://cdn.treesir.pub/img/image-20210517135055519.png"/><img alt="image-20210517135144632" src="https://cdn.treesir.pub/img/image-20210517135144632.png"/></p>
<blockquote>
<p>与系统层面的监控类似，这个多是基于 operator 中的 <code>prometheus</code> 资源对象实现，后面会有详细的配置说明。</p>
</blockquote>
<p><img alt="image-20210517135341371" src="https://cdn.treesir.pub/img/image-20210517135341371.png"/></p>
<p><img alt="image-20210517135538259" src="https://cdn.treesir.pub/img/image-20210517135538259.png"/></p>
<h1 id="监控系统优化">监控系统优化</h1>
<h2 id="更改-service-模式为-nodeport">更改 service 模式为 <code>NodePort</code></h2>
<blockquote>
<p>虽然 rancher 对 prometheus operator 做了一层 <code>多租户</code> 的处理，但是 <code>granfana</code> 却并没有做关联 rancher 的多租户处理， grafana 默认 U/P <code>admin/admin</code>。<code>个人</code> 觉得监控系统的多租户不是很好用，使用起来也有点有点鸡肋。这里演示配置将 service 更改为 <code>NodePort</code> 模式，绕过 rancher 多租户进行使用。</p>
</blockquote>
<p><strong>查看 目前 service 资源对象</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl get svc -n cattle-prometheus
access-grafana              ClusterIP   10.233.54.97   &lt;none&gt;        80/TCP              24m
access-prometheus           ClusterIP   10.233.30.75   &lt;none&gt;        80/TCP              24m
expose-grafana-metrics      ClusterIP   None           &lt;none&gt;        3000/TCP            24m
expose-kubelets-metrics     ClusterIP   None           &lt;none&gt;        10250/TCP           24m
expose-kubernetes-metrics   ClusterIP   None           &lt;none&gt;        8080/TCP,8081/TCP   24m
expose-node-metrics         ClusterIP   None           &lt;none&gt;        9796/TCP            24m
expose-operator-metrics     ClusterIP   None           &lt;none&gt;        47323/TCP           24m
expose-prometheus-metrics   ClusterIP   None           &lt;none&gt;        9090/TCP            24m
prometheus-operated         ClusterIP   None           &lt;none&gt;        9090/TCP            24m
</code></pre></td></tr></table>
</div>
</div><p>更改 <code>access-grafana</code> &amp; <code>access-prometheus </code> 这两个 service 资源对象，除了这两个资源对象外，应该还有一个 <code>access-alertmanager</code> 才对，不过这个我们后面才会介绍使用到，这里不做过多的赘述。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl edit svc access-prometheus access-grafana -n cattle-prometheus

...
  selector:
    app: prometheus
    chart: prometheus-0.0.1
    release: cluster-monitoring
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: <span class="m">10800</span>
  type: NodePort  <span class="c1"># 将这个字段更改为 NodePort 即可</span>
...
</code></pre></td></tr></table>
</div>
</div><p><img alt="image-20210517141632600" src="https://cdn.treesir.pub/img/image-20210517141632600.png"/></p>
<p><strong>访问一下 prometheus</strong></p>
<p><img alt="image-20210517142150688" src="https://cdn.treesir.pub/img/image-20210517142150688.png"/></p>
<h2 id="安装-metrics-server">安装 metrics-server</h2>
<blockquote>
<p>如果我们后面需要使用 <code>HPA</code> ，就需要在集群中安装 <code>Metrics Server</code> 服务，要安装 <code>Metrics Server</code> 就需要开启 apiserver 的  <code>Aggregator</code>，因为 <code>Metrics Server</code> 就是通过该代理进行扩展的，如果使用的是 Kubeadm (<code> kubekey 也是基于 kubeadm</code> ) 搭建的，默认就已经是开启状态了，如果是二进制方式安装的集群，需要单独配置 kube-apsierver 添加参数，详细说明，请参考 <a href="https://www.qikqiak.com/k8strain2/controller/hpa/#Metrics-Server">此篇文档</a></p>
</blockquote>
<ul>
<li>
<p>执行安装</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">cat <span class="s">&lt;&lt; EOF | kubectl apply -f -
</span><span class="s">apiVersion: v1
</span><span class="s">kind: ServiceAccount
</span><span class="s">metadata:
</span><span class="s">  labels:
</span><span class="s">    k8s-app: metrics-server
</span><span class="s">  name: metrics-server
</span><span class="s">  namespace: kube-system
</span><span class="s">---
</span><span class="s">apiVersion: rbac.authorization.k8s.io/v1
</span><span class="s">kind: ClusterRole
</span><span class="s">metadata:
</span><span class="s">  labels:
</span><span class="s">    k8s-app: metrics-server
</span><span class="s">    rbac.authorization.k8s.io/aggregate-to-admin: "true"
</span><span class="s">    rbac.authorization.k8s.io/aggregate-to-edit: "true"
</span><span class="s">    rbac.authorization.k8s.io/aggregate-to-view: "true"
</span><span class="s">  name: system:aggregated-metrics-reader
</span><span class="s">rules:
</span><span class="s">- apiGroups:
</span><span class="s">  - metrics.k8s.io
</span><span class="s">  resources:
</span><span class="s">  - pods
</span><span class="s">  - nodes
</span><span class="s">  verbs:
</span><span class="s">  - get
</span><span class="s">  - list
</span><span class="s">  - watch
</span><span class="s">---
</span><span class="s">apiVersion: rbac.authorization.k8s.io/v1
</span><span class="s">kind: ClusterRole
</span><span class="s">metadata:
</span><span class="s">  labels:
</span><span class="s">    k8s-app: metrics-server
</span><span class="s">  name: system:metrics-server
</span><span class="s">rules:
</span><span class="s">- apiGroups:
</span><span class="s">  - ""
</span><span class="s">  resources:
</span><span class="s">  - pods
</span><span class="s">  - nodes
</span><span class="s">  - nodes/stats
</span><span class="s">  - namespaces
</span><span class="s">  - configmaps
</span><span class="s">  verbs:
</span><span class="s">  - get
</span><span class="s">  - list
</span><span class="s">  - watch
</span><span class="s">---
</span><span class="s">apiVersion: rbac.authorization.k8s.io/v1
</span><span class="s">kind: RoleBinding
</span><span class="s">metadata:
</span><span class="s">  labels:
</span><span class="s">    k8s-app: metrics-server
</span><span class="s">  name: metrics-server-auth-reader
</span><span class="s">  namespace: kube-system
</span><span class="s">roleRef:
</span><span class="s">  apiGroup: rbac.authorization.k8s.io
</span><span class="s">  kind: Role
</span><span class="s">  name: extension-apiserver-authentication-reader
</span><span class="s">subjects:
</span><span class="s">- kind: ServiceAccount
</span><span class="s">  name: metrics-server
</span><span class="s">  namespace: kube-system
</span><span class="s">---
</span><span class="s">apiVersion: rbac.authorization.k8s.io/v1
</span><span class="s">kind: ClusterRoleBinding
</span><span class="s">metadata:
</span><span class="s">  labels:
</span><span class="s">    k8s-app: metrics-server
</span><span class="s">  name: metrics-server:system:auth-delegator
</span><span class="s">roleRef:
</span><span class="s">  apiGroup: rbac.authorization.k8s.io
</span><span class="s">  kind: ClusterRole
</span><span class="s">  name: system:auth-delegator
</span><span class="s">subjects:
</span><span class="s">- kind: ServiceAccount
</span><span class="s">  name: metrics-server
</span><span class="s">  namespace: kube-system
</span><span class="s">---
</span><span class="s">apiVersion: rbac.authorization.k8s.io/v1
</span><span class="s">kind: ClusterRoleBinding
</span><span class="s">metadata:
</span><span class="s">  labels:
</span><span class="s">    k8s-app: metrics-server
</span><span class="s">  name: system:metrics-server
</span><span class="s">roleRef:
</span><span class="s">  apiGroup: rbac.authorization.k8s.io
</span><span class="s">  kind: ClusterRole
</span><span class="s">  name: system:metrics-server
</span><span class="s">subjects:
</span><span class="s">- kind: ServiceAccount
</span><span class="s">  name: metrics-server
</span><span class="s">  namespace: kube-system
</span><span class="s">---
</span><span class="s">apiVersion: v1
</span><span class="s">kind: Service
</span><span class="s">metadata:
</span><span class="s">  labels:
</span><span class="s">    k8s-app: metrics-server
</span><span class="s">  name: metrics-server
</span><span class="s">  namespace: kube-system
</span><span class="s">spec:
</span><span class="s">  ports:
</span><span class="s">  - name: https
</span><span class="s">    port: 443
</span><span class="s">    protocol: TCP
</span><span class="s">    targetPort: https
</span><span class="s">  selector:
</span><span class="s">    k8s-app: metrics-server
</span><span class="s">---
</span><span class="s">apiVersion: apps/v1
</span><span class="s">kind: Deployment
</span><span class="s">metadata:
</span><span class="s">  labels:
</span><span class="s">    k8s-app: metrics-server
</span><span class="s">  name: metrics-server
</span><span class="s">  namespace: kube-system
</span><span class="s">spec:
</span><span class="s">  selector:
</span><span class="s">    matchLabels:
</span><span class="s">      k8s-app: metrics-server
</span><span class="s">  strategy:
</span><span class="s">    rollingUpdate:
</span><span class="s">      maxUnavailable: 0
</span><span class="s">  template:
</span><span class="s">    metadata:
</span><span class="s">      labels:
</span><span class="s">        k8s-app: metrics-server
</span><span class="s">    spec:
</span><span class="s">      containers:
</span><span class="s">      - args:
</span><span class="s">        - --cert-dir=/tmp
</span><span class="s">        - --secure-port=4443
</span><span class="s">        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
</span><span class="s">        - --kubelet-use-node-status-port
</span><span class="s">        - --kubelet-insecure-tls
</span><span class="s">        image: k8s.gcr.io/metrics-server/metrics-server:v0.4.4
</span><span class="s">        imagePullPolicy: IfNotPresent
</span><span class="s">        livenessProbe:
</span><span class="s">          failureThreshold: 3
</span><span class="s">          httpGet:
</span><span class="s">            path: /livez
</span><span class="s">            port: https
</span><span class="s">            scheme: HTTPS
</span><span class="s">          periodSeconds: 10
</span><span class="s">        name: metrics-server
</span><span class="s">        ports:
</span><span class="s">        - containerPort: 4443
</span><span class="s">          name: https
</span><span class="s">          protocol: TCP
</span><span class="s">        readinessProbe:
</span><span class="s">          failureThreshold: 3
</span><span class="s">          httpGet:
</span><span class="s">            path: /readyz
</span><span class="s">            port: https
</span><span class="s">            scheme: HTTPS
</span><span class="s">          periodSeconds: 10
</span><span class="s">        securityContext:
</span><span class="s">          readOnlyRootFilesystem: true
</span><span class="s">          runAsNonRoot: true
</span><span class="s">          runAsUser: 1000
</span><span class="s">        volumeMounts:
</span><span class="s">        - mountPath: /tmp
</span><span class="s">          name: tmp-dir
</span><span class="s">      nodeSelector:
</span><span class="s">        kubernetes.io/os: linux
</span><span class="s">      priorityClassName: system-cluster-critical
</span><span class="s">      serviceAccountName: metrics-server
</span><span class="s">      volumes:
</span><span class="s">      - emptyDir: {}
</span><span class="s">        name: tmp-dir
</span><span class="s">---
</span><span class="s">apiVersion: apiregistration.k8s.io/v1
</span><span class="s">kind: APIService
</span><span class="s">metadata:
</span><span class="s">  labels:
</span><span class="s">    k8s-app: metrics-server
</span><span class="s">  name: v1beta1.metrics.k8s.io
</span><span class="s">spec:
</span><span class="s">  group: metrics.k8s.io
</span><span class="s">  groupPriorityMinimum: 100
</span><span class="s">  insecureSkipTLSVerify: true
</span><span class="s">  service:
</span><span class="s">    name: metrics-server
</span><span class="s">    namespace: kube-system
</span><span class="s">  version: v1beta1
</span><span class="s">  versionPriority: 100
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>检查 pod 启动情况</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl get pods -n kube-system -l k8s-app<span class="o">=</span>metrics-server
NAME                              READY   STATUS    RESTARTS   AGE
metrics-server-75b868857d-bpbb6   1/1     Running   <span class="m">0</span>          75s

kubectl top nodes
NAME    CPU<span class="o">(</span>cores<span class="o">)</span>   CPU%   MEMORY<span class="o">(</span>bytes<span class="o">)</span>   MEMORY%   
node1   422m         5%     1865Mi          12%       
node2   241m         3%     1598Mi          10%       
node3   317m         4%     1737Mi          11%       
node4   236m         3%     1123Mi          7%  
</code></pre></td></tr></table>
</div>
</div><p><img alt="image-20210517175050613" src="https://cdn.treesir.pub/img/image-20210517175050613.png"/></p>
<blockquote>
<p>显示有指标即正常</p>
</blockquote>
</li>
</ul>
<h1 id="配置-targets-自动发现说明">配置 targets 自动发现说明</h1>
<blockquote>
<p>可以看到在上面发现的列表中，并没有 <code>etcd</code> 、 <code>controller-manager</code> 、 <code>scheduler</code> 、 <code>apserver</code>、<code>coredns</code>  这几个指标的出现，而且中间不妨出现了一些无法发现指标的配置项。下面介绍如何对这些缺失指标的修复，与无用指标的删除配置说明。</p>
</blockquote>
<h2 id="清理无用指标">清理无用指标</h2>
<p><img alt="image-20210517142758337" src="https://cdn.treesir.pub/img/image-20210517142758337.png"/></p>
<blockquote>
<p>清理 <code>istio</code> 对应 envoy 服务发现，这个是 rancher monitor chart 中默认渲染的，这里我们在渲染时，关闭掉渲染即可。</p>
</blockquote>
<p><strong>系统层面监控 添加配置</strong></p>
<p><img alt="image-20210517143126721" src="https://cdn.treesir.pub/img/image-20210517143126721.png"/></p>
<p><strong>添加应答配置</strong></p>
<ul>
<li><code>prometheus.istioMonitoring.enabled=false</code></li>
<li><code>exporter-fluentd.enabled=false</code></li>
</ul>
<p><img alt="image-20210517143231392" src="https://cdn.treesir.pub/img/image-20210517143231392.png"/></p>
<blockquote>
<p>保存并应该配置，等待生效后，已找不到 与 <code>istio</code> 有关的配置项。</p>
</blockquote>
<p><img alt="image-20210517143433771" src="https://cdn.treesir.pub/img/image-20210517143433771.png"/></p>
<h2 id="添加-targets-指标发现">添加 targets 指标发现</h2>
<blockquote>
<p>下面介绍的几种 <code>targets</code> 指标发现，使用与 集群 内外的 metrics，参照下面的配置说明，添加配置即可。</p>
</blockquote>
<h3 id="添加-etcd-指标发现">添加 <code>etcd</code> 指标发现</h3>
<ul>
<li>
<p>添加 etcd service 资源对象</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">cat <span class="s">&lt;&lt; EOF | kubectl apply -f -
</span><span class="s">apiVersion: v1
</span><span class="s">kind: Service
</span><span class="s">metadata:
</span><span class="s">  name: etcd-k8s
</span><span class="s">  namespace: kube-system
</span><span class="s">  labels:
</span><span class="s">    k8s-app: etcd
</span><span class="s">spec:
</span><span class="s">  type: ClusterIP
</span><span class="s">  clusterIP: None
</span><span class="s">  ports:
</span><span class="s">    - name: port
</span><span class="s">      port: 2381
</span><span class="s">---
</span><span class="s">apiVersion: v1
</span><span class="s">kind: Endpoints
</span><span class="s">metadata:
</span><span class="s">  name: etcd-k8s
</span><span class="s">  namespace: kube-system
</span><span class="s">  labels:
</span><span class="s">    k8s-app: etcd
</span><span class="s">subsets:
</span><span class="s">  - addresses:
</span><span class="s">      - ip: 192.168.8.30 # 指定etcd节点地址，集群节点继续向下添加
</span><span class="s">        nodeName: node1
</span><span class="s">    ports:
</span><span class="s">      - name: port
</span><span class="s">        port: 2381
</span><span class="s">  - addresses:
</span><span class="s">      - ip: 192.168.8.31
</span><span class="s">        nodeName: node2
</span><span class="s">    ports:
</span><span class="s">      - name: port
</span><span class="s">        port: 2381
</span><span class="s">  - addresses:
</span><span class="s">      - ip: 192.168.8.32
</span><span class="s">        nodeName: node3
</span><span class="s">    ports:
</span><span class="s">      - name: port
</span><span class="s">        port: 2381
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>创建 etcd <code>ServiceMonitor</code> 资源对象</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">cat <span class="s">&lt;&lt; EOF | kubectl apply -f -
</span><span class="s">apiVersion: monitoring.coreos.com/v1
</span><span class="s">kind: ServiceMonitor
</span><span class="s">metadata:
</span><span class="s">  name: etcd-k8s
</span><span class="s">  namespace: cattle-prometheus
</span><span class="s">  labels:
</span><span class="s">    k8s-app: etcd-k8s
</span><span class="s">spec:
</span><span class="s">  jobLabel: k8s-app
</span><span class="s">  endpoints:
</span><span class="s">    - port: port
</span><span class="s">      interval: 15s
</span><span class="s">  selector:
</span><span class="s">    matchLabels:
</span><span class="s">      k8s-app: etcd
</span><span class="s">  namespaceSelector:
</span><span class="s">    matchNames:
</span><span class="s">      - kube-system
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p><img alt="image-20210517144812912" src="https://cdn.treesir.pub/img/image-20210517144812912.png"/></p>
<blockquote>
<p>等待 operator 自动将配置加载完成，可以看到这里已经有对应的配置项了，但是好像无法抓取到 <code>metrics</code> 指标。这是因为默认 etcd 的 metrics 监听在 <code>127.0.0.1</code> 的地址上，我们拿的是 <code>192.168.8.0/24</code> 的地址去访问就自然无法访问到了。</p>
</blockquote>
<ul>
<li>
<p>更改 etcd <code>metrics</code> 指标监听地址</p>
<blockquote>
<p>这里示例使用的是 <code>kubekey</code> 部署的集群，<code>etcd 不是使用的 kubeadm 中静态pod进行管理的</code>，更改配置文件为 <code>/etc/etcd.env</code> , 如果你是使用的 <code>kubeadm </code> 只需要修改静态pod配置文件 <code>/etc/kubernetes/manifests/etcd.yaml</code> 中的 <code>listen-metrics-urls</code> 配置项为 <code>--listen-metrics-urls=http://0.0.0.0:2381</code> 即可。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="nb">echo</span> <span class="s1">'# add coustom settings
</span><span class="s1">ETCD_LISTEN_METRICS_URLS=http://0.0.0.0:2381'</span> &gt;&gt; /etc/etcd.env  <span class="c1"># 添加配置</span>

service etcd restart <span class="c1"># 重启服务生效</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>其他 etcd 环境变量说明， 请参考如下 <a href="https://etcd.io/docs/v3.4/op-guide/configuration">文档</a></p>
</blockquote>
</li>
</ul>
<p><img alt="image-20210517153147174" src="https://cdn.treesir.pub/img/image-20210517153147174.png"/></p>
<blockquote>
<p>再次刷新查看，指标已正常显示抓取。</p>
</blockquote>
<h3 id="添加-controller-manager-指标抓取">添加 controller-manager 指标抓取</h3>
<ul>
<li>
<p>添加  controller-manager service 资源对象</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">cat <span class="s">&lt;&lt; EOF | kubectl apply -f -
</span><span class="s">apiVersion: v1
</span><span class="s">kind: Service
</span><span class="s">metadata:
</span><span class="s">  namespace: kube-system
</span><span class="s">  name: kube-controller-manager
</span><span class="s">  labels:
</span><span class="s">    k8s-app: kube-controller-manager
</span><span class="s">spec:
</span><span class="s">  selector:
</span><span class="s">    component: kube-controller-manager  # 这里标签，一定需要后后面的 pod 进行对应上
</span><span class="s">  ports:
</span><span class="s">  - name: http-metrics
</span><span class="s">    port: 10252
</span><span class="s">    targetPort: 10252
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p><img alt="image-20210517154921583" src="https://cdn.treesir.pub/img/image-20210517154921583.png"/></p>
</li>
<li>
<p>创建 controller-manager  <code>ServiceMonitor</code> 资源对象</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">cat <span class="s">&lt;&lt; EOF | kubectl apply -f -
</span><span class="s">apiVersion: monitoring.coreos.com/v1
</span><span class="s">kind: ServiceMonitor
</span><span class="s">metadata:
</span><span class="s">  labels:
</span><span class="s">    k8s-app: kube-controller-manager
</span><span class="s">  name: kube-controller-manager
</span><span class="s">  namespace: cattle-prometheus
</span><span class="s">spec:
</span><span class="s">  endpoints:
</span><span class="s">  - interval: 30s
</span><span class="s">    metricRelabelings:
</span><span class="s">    - action: drop
</span><span class="s">      regex: kubelet_(pod_worker_latency_microseconds|pod_start_latency_microseconds|cgroup_manager_latency_microseconds|pod_worker_start_latency_microseconds|pleg_relist_latency_microseconds|pleg_relist_interval_microseconds|runtime_operations|runtime_operations_latency_microseconds|runtime_operations_errors|eviction_stats_age_microseconds|device_plugin_registration_count|device_plugin_alloc_latency_microseconds|network_plugin_operations_latency_microseconds)
</span><span class="s">      sourceLabels:
</span><span class="s">      - __name__
</span><span class="s">    - action: drop
</span><span class="s">      regex: scheduler_(e2e_scheduling_latency_microseconds|scheduling_algorithm_predicate_evaluation|scheduling_algorithm_priority_evaluation|scheduling_algorithm_preemption_evaluation|scheduling_algorithm_latency_microseconds|binding_latency_microseconds|scheduling_latency_seconds)
</span><span class="s">      sourceLabels:
</span><span class="s">      - __name__
</span><span class="s">    - action: drop
</span><span class="s">      regex: apiserver_(request_count|request_latencies|request_latencies_summary|dropped_requests|storage_data_key_generation_latencies_microseconds|storage_transformation_failures_total|storage_transformation_latencies_microseconds|proxy_tunnel_sync_latency_secs)
</span><span class="s">      sourceLabels:
</span><span class="s">      - __name__
</span><span class="s">    - action: drop
</span><span class="s">      regex: kubelet_docker_(operations|operations_latency_microseconds|operations_errors|operations_timeout)
</span><span class="s">      sourceLabels:
</span><span class="s">      - __name__
</span><span class="s">    - action: drop
</span><span class="s">      regex: reflector_(items_per_list|items_per_watch|list_duration_seconds|lists_total|short_watches_total|watch_duration_seconds|watches_total)
</span><span class="s">      sourceLabels:
</span><span class="s">      - __name__
</span><span class="s">    - action: drop
</span><span class="s">      regex: etcd_(helper_cache_hit_count|helper_cache_miss_count|helper_cache_entry_count|request_cache_get_latencies_summary|request_cache_add_latencies_summary|request_latencies_summary)
</span><span class="s">      sourceLabels:
</span><span class="s">      - __name__
</span><span class="s">    - action: drop
</span><span class="s">      regex: transformation_(transformation_latencies_microseconds|failures_total)
</span><span class="s">      sourceLabels:
</span><span class="s">      - __name__
</span><span class="s">    - action: drop
</span><span class="s">      regex: (admission_quota_controller_adds|crd_autoregistration_controller_work_duration|APIServiceOpenAPIAggregationControllerQueue1_adds|AvailableConditionController_retries|crd_openapi_controller_unfinished_work_seconds|APIServiceRegistrationController_retries|admission_quota_controller_longest_running_processor_microseconds|crdEstablishing_longest_running_processor_microseconds|crdEstablishing_unfinished_work_seconds|crd_openapi_controller_adds|crd_autoregistration_controller_retries|crd_finalizer_queue_latency|AvailableConditionController_work_duration|non_structural_schema_condition_controller_depth|crd_autoregistration_controller_unfinished_work_seconds|AvailableConditionController_adds|DiscoveryController_longest_running_processor_microseconds|autoregister_queue_latency|crd_autoregistration_controller_adds|non_structural_schema_condition_controller_work_duration|APIServiceRegistrationController_adds|crd_finalizer_work_duration|crd_naming_condition_controller_unfinished_work_seconds|crd_openapi_controller_longest_running_processor_microseconds|DiscoveryController_adds|crd_autoregistration_controller_longest_running_processor_microseconds|autoregister_unfinished_work_seconds|crd_naming_condition_controller_queue_latency|crd_naming_condition_controller_retries|non_structural_schema_condition_controller_queue_latency|crd_naming_condition_controller_depth|AvailableConditionController_longest_running_processor_microseconds|crdEstablishing_depth|crd_finalizer_longest_running_processor_microseconds|crd_naming_condition_controller_adds|APIServiceOpenAPIAggregationControllerQueue1_longest_running_processor_microseconds|DiscoveryController_queue_latency|DiscoveryController_unfinished_work_seconds|crd_openapi_controller_depth|APIServiceOpenAPIAggregationControllerQueue1_queue_latency|APIServiceOpenAPIAggregationControllerQueue1_unfinished_work_seconds|DiscoveryController_work_duration|autoregister_adds|crd_autoregistration_controller_queue_latency|crd_finalizer_retries|AvailableConditionController_unfinished_work_seconds|autoregister_longest_running_processor_microseconds|non_structural_schema_condition_controller_unfinished_work_seconds|APIServiceOpenAPIAggregationControllerQueue1_depth|AvailableConditionController_depth|DiscoveryController_retries|admission_quota_controller_depth|crdEstablishing_adds|APIServiceOpenAPIAggregationControllerQueue1_retries|crdEstablishing_queue_latency|non_structural_schema_condition_controller_longest_running_processor_microseconds|autoregister_work_duration|crd_openapi_controller_retries|APIServiceRegistrationController_work_duration|crdEstablishing_work_duration|crd_finalizer_adds|crd_finalizer_depth|crd_openapi_controller_queue_latency|APIServiceOpenAPIAggregationControllerQueue1_work_duration|APIServiceRegistrationController_queue_latency|crd_autoregistration_controller_depth|AvailableConditionController_queue_latency|admission_quota_controller_queue_latency|crd_naming_condition_controller_work_duration|crd_openapi_controller_work_duration|DiscoveryController_depth|crd_naming_condition_controller_longest_running_processor_microseconds|APIServiceRegistrationController_depth|APIServiceRegistrationController_longest_running_processor_microseconds|crd_finalizer_unfinished_work_seconds|crdEstablishing_retries|admission_quota_controller_unfinished_work_seconds|non_structural_schema_condition_controller_adds|APIServiceRegistrationController_unfinished_work_seconds|admission_quota_controller_work_duration|autoregister_depth|autoregister_retries|kubeproxy_sync_proxy_rules_latency_microseconds|rest_client_request_latency_seconds|non_structural_schema_condition_controller_retries)
</span><span class="s">      sourceLabels:
</span><span class="s">      - __name__
</span><span class="s">    - action: drop
</span><span class="s">      regex: etcd_(debugging|disk|request|server).*
</span><span class="s">      sourceLabels:
</span><span class="s">      - __name__
</span><span class="s">    port: http-metrics
</span><span class="s">  jobLabel: k8s-app
</span><span class="s">  namespaceSelector:
</span><span class="s">    matchNames:
</span><span class="s">    - kube-system
</span><span class="s">  selector:
</span><span class="s">    matchLabels:
</span><span class="s">      k8s-app: kube-controller-manager  # 这里需要与 service 的标签进行对应
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p><img alt="image-20210517155535012" src="https://cdn.treesir.pub/img/image-20210517155535012.png"/></p>
<h3 id="添加-scheduler-指标抓取">添加 scheduler 指标抓取</h3>
<ul>
<li>
<p>添加  scheduler service 资源对象</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">cat <span class="s">&lt;&lt; EOF | kubectl apply -f -
</span><span class="s">apiVersion: v1
</span><span class="s">kind: Service
</span><span class="s">metadata:
</span><span class="s">  namespace: kube-system
</span><span class="s">  name: kube-scheduler
</span><span class="s">  labels:
</span><span class="s">    k8s-app: kube-scheduler
</span><span class="s">spec:
</span><span class="s">  selector:
</span><span class="s">    component: kube-scheduler  # 同上指标需要与 pod 标签进行对应
</span><span class="s">  ports:
</span><span class="s">  - name: http-metrics
</span><span class="s">    port: 10251
</span><span class="s">    targetPort: 10251
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>创建 scheduler  <code>ServiceMonitor</code> 资源对象</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">cat <span class="s">&lt;&lt; EOF | kubectl apply -f -
</span><span class="s">apiVersion: monitoring.coreos.com/v1
</span><span class="s">kind: ServiceMonitor
</span><span class="s">metadata:
</span><span class="s">  labels:
</span><span class="s">    k8s-app: kube-scheduler
</span><span class="s">  name: kube-scheduler
</span><span class="s">  namespace: cattle-prometheus
</span><span class="s">spec:
</span><span class="s">  endpoints:
</span><span class="s">  - interval: 30s
</span><span class="s">    port: http-metrics
</span><span class="s">  jobLabel: k8s-app
</span><span class="s">  namespaceSelector:
</span><span class="s">    matchNames:
</span><span class="s">    - kube-system
</span><span class="s">  selector:
</span><span class="s">    matchLabels:
</span><span class="s">      k8s-app: kube-scheduler
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p><img alt="image-20210517164455364" src="https://cdn.treesir.pub/img/image-20210517164455364.png"/></p>
<h3 id="添加-coredns-指标抓取">添加 coredns 指标抓取</h3>
<blockquote>
<p>默认 coredns 的 service 资源对象已被创建，只需要创建 <code>ServiceMonitor</code> 对象即可</p>
</blockquote>
<ul>
<li>
<p>创建 ServiceMonitor 资源对象</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">cat <span class="s">&lt;&lt; EOF | kubectl apply -f -
</span><span class="s">apiVersion: monitoring.coreos.com/v1
</span><span class="s">kind: ServiceMonitor
</span><span class="s">metadata:
</span><span class="s">  labels:
</span><span class="s">    k8s-app: coredns
</span><span class="s">  name: coredns
</span><span class="s">  namespace: cattle-prometheus
</span><span class="s">spec:
</span><span class="s">  endpoints:
</span><span class="s">  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
</span><span class="s">    interval: 15s
</span><span class="s">    port: metrics
</span><span class="s">  jobLabel: k8s-app
</span><span class="s">  namespaceSelector:
</span><span class="s">    matchNames:
</span><span class="s">    - kube-system
</span><span class="s">  selector:
</span><span class="s">    matchLabels:
</span><span class="s">      k8s-app: kube-dns
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p><img alt="image-20210517164923492" src="https://cdn.treesir.pub/img/image-20210517164923492.png"/></p>
<h3 id="添加-apiserver-指标抓取">添加 apiserver 指标抓取</h3>
<ul>
<li>
<p>检查 apiserver service 资源对象</p>
<p><img alt="image-20210517172448682" src="https://cdn.treesir.pub/img/image-20210517172448682.png"/></p>
</li>
<li>
<p>创建 apiserver  <code>ServiceMonitor</code> 资源对象</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">cat <span class="s">&lt;&lt; EOF | kubectl apply -f -
</span><span class="s">apiVersion: monitoring.coreos.com/v1
</span><span class="s">kind: ServiceMonitor
</span><span class="s">metadata:
</span><span class="s">  labels:
</span><span class="s">    k8s-app: apiserver
</span><span class="s">  name: kube-apiserver
</span><span class="s">  namespace: cattle-prometheus
</span><span class="s">spec:
</span><span class="s">  endpoints:
</span><span class="s">  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
</span><span class="s">    interval: 30s
</span><span class="s">    metricRelabelings:
</span><span class="s">    - action: drop
</span><span class="s">      regex: kubelet_(pod_worker_latency_microseconds|pod_start_latency_microseconds|cgroup_manager_latency_microseconds|pod_worker_start_latency_microseconds|pleg_relist_latency_microseconds|pleg_relist_interval_microseconds|runtime_operations|runtime_operations_latency_microseconds|runtime_operations_errors|eviction_stats_age_microseconds|device_plugin_registration_count|device_plugin_alloc_latency_microseconds|network_plugin_operations_latency_microseconds)
</span><span class="s">      sourceLabels:
</span><span class="s">      - __name__
</span><span class="s">    - action: drop
</span><span class="s">      regex: scheduler_(e2e_scheduling_latency_microseconds|scheduling_algorithm_predicate_evaluation|scheduling_algorithm_priority_evaluation|scheduling_algorithm_preemption_evaluation|scheduling_algorithm_latency_microseconds|binding_latency_microseconds|scheduling_latency_seconds)
</span><span class="s">      sourceLabels:
</span><span class="s">      - __name__
</span><span class="s">    - action: drop
</span><span class="s">      regex: apiserver_(request_count|request_latencies|request_latencies_summary|dropped_requests|storage_data_key_generation_latencies_microseconds|storage_transformation_failures_total|storage_transformation_latencies_microseconds|proxy_tunnel_sync_latency_secs)
</span><span class="s">      sourceLabels:
</span><span class="s">      - __name__
</span><span class="s">    - action: drop
</span><span class="s">      regex: kubelet_docker_(operations|operations_latency_microseconds|operations_errors|operations_timeout)
</span><span class="s">      sourceLabels:
</span><span class="s">      - __name__
</span><span class="s">    - action: drop
</span><span class="s">      regex: reflector_(items_per_list|items_per_watch|list_duration_seconds|lists_total|short_watches_total|watch_duration_seconds|watches_total)
</span><span class="s">      sourceLabels:
</span><span class="s">      - __name__
</span><span class="s">    - action: drop
</span><span class="s">      regex: etcd_(helper_cache_hit_count|helper_cache_miss_count|helper_cache_entry_count|request_cache_get_latencies_summary|request_cache_add_latencies_summary|request_latencies_summary)
</span><span class="s">      sourceLabels:
</span><span class="s">      - __name__
</span><span class="s">    - action: drop
</span><span class="s">      regex: transformation_(transformation_latencies_microseconds|failures_total)
</span><span class="s">      sourceLabels:
</span><span class="s">      - __name__
</span><span class="s">    - action: drop
</span><span class="s">      regex: (admission_quota_controller_adds|crd_autoregistration_controller_work_duration|APIServiceOpenAPIAggregationControllerQueue1_adds|AvailableConditionController_retries|crd_openapi_controller_unfinished_work_seconds|APIServiceRegistrationController_retries|admission_quota_controller_longest_running_processor_microseconds|crdEstablishing_longest_running_processor_microseconds|crdEstablishing_unfinished_work_seconds|crd_openapi_controller_adds|crd_autoregistration_controller_retries|crd_finalizer_queue_latency|AvailableConditionController_work_duration|non_structural_schema_condition_controller_depth|crd_autoregistration_controller_unfinished_work_seconds|AvailableConditionController_adds|DiscoveryController_longest_running_processor_microseconds|autoregister_queue_latency|crd_autoregistration_controller_adds|non_structural_schema_condition_controller_work_duration|APIServiceRegistrationController_adds|crd_finalizer_work_duration|crd_naming_condition_controller_unfinished_work_seconds|crd_openapi_controller_longest_running_processor_microseconds|DiscoveryController_adds|crd_autoregistration_controller_longest_running_processor_microseconds|autoregister_unfinished_work_seconds|crd_naming_condition_controller_queue_latency|crd_naming_condition_controller_retries|non_structural_schema_condition_controller_queue_latency|crd_naming_condition_controller_depth|AvailableConditionController_longest_running_processor_microseconds|crdEstablishing_depth|crd_finalizer_longest_running_processor_microseconds|crd_naming_condition_controller_adds|APIServiceOpenAPIAggregationControllerQueue1_longest_running_processor_microseconds|DiscoveryController_queue_latency|DiscoveryController_unfinished_work_seconds|crd_openapi_controller_depth|APIServiceOpenAPIAggregationControllerQueue1_queue_latency|APIServiceOpenAPIAggregationControllerQueue1_unfinished_work_seconds|DiscoveryController_work_duration|autoregister_adds|crd_autoregistration_controller_queue_latency|crd_finalizer_retries|AvailableConditionController_unfinished_work_seconds|autoregister_longest_running_processor_microseconds|non_structural_schema_condition_controller_unfinished_work_seconds|APIServiceOpenAPIAggregationControllerQueue1_depth|AvailableConditionController_depth|DiscoveryController_retries|admission_quota_controller_depth|crdEstablishing_adds|APIServiceOpenAPIAggregationControllerQueue1_retries|crdEstablishing_queue_latency|non_structural_schema_condition_controller_longest_running_processor_microseconds|autoregister_work_duration|crd_openapi_controller_retries|APIServiceRegistrationController_work_duration|crdEstablishing_work_duration|crd_finalizer_adds|crd_finalizer_depth|crd_openapi_controller_queue_latency|APIServiceOpenAPIAggregationControllerQueue1_work_duration|APIServiceRegistrationController_queue_latency|crd_autoregistration_controller_depth|AvailableConditionController_queue_latency|admission_quota_controller_queue_latency|crd_naming_condition_controller_work_duration|crd_openapi_controller_work_duration|DiscoveryController_depth|crd_naming_condition_controller_longest_running_processor_microseconds|APIServiceRegistrationController_depth|APIServiceRegistrationController_longest_running_processor_microseconds|crd_finalizer_unfinished_work_seconds|crdEstablishing_retries|admission_quota_controller_unfinished_work_seconds|non_structural_schema_condition_controller_adds|APIServiceRegistrationController_unfinished_work_seconds|admission_quota_controller_work_duration|autoregister_depth|autoregister_retries|kubeproxy_sync_proxy_rules_latency_microseconds|rest_client_request_latency_seconds|non_structural_schema_condition_controller_retries)
</span><span class="s">      sourceLabels:
</span><span class="s">      - __name__
</span><span class="s">    - action: drop
</span><span class="s">      regex: etcd_(debugging|disk|request|server).*
</span><span class="s">      sourceLabels:
</span><span class="s">      - __name__
</span><span class="s">    - action: drop
</span><span class="s">      regex: apiserver_admission_controller_admission_latencies_seconds_.*
</span><span class="s">      sourceLabels:
</span><span class="s">      - __name__
</span><span class="s">    - action: drop
</span><span class="s">      regex: apiserver_admission_step_admission_latencies_seconds_.*
</span><span class="s">      sourceLabels:
</span><span class="s">      - __name__
</span><span class="s">    - action: drop
</span><span class="s">      regex: apiserver_request_duration_seconds_bucket;(0.15|0.25|0.3|0.35|0.4|0.45|0.6|0.7|0.8|0.9|1.25|1.5|1.75|2.5|3|3.5|4.5|6|7|8|9|15|25|30|50)
</span><span class="s">      sourceLabels:
</span><span class="s">      - __name__
</span><span class="s">      - le
</span><span class="s">    port: https
</span><span class="s">    scheme: https
</span><span class="s">    tlsConfig:
</span><span class="s">      caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
</span><span class="s">      serverName: kubernetes
</span><span class="s">  jobLabel: component
</span><span class="s">  namespaceSelector:
</span><span class="s">    matchNames:
</span><span class="s">    - default
</span><span class="s">  selector:
</span><span class="s">    matchLabels:
</span><span class="s">      component: apiserver  # 与上面查询到的 labels 进行匹配
</span><span class="s">      provider: kubernetes
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p><img alt="image-20210517172850296" src="https://cdn.treesir.pub/img/image-20210517172850296.png"/></p>
<p><img alt="image-20210517175443503" src="https://cdn.treesir.pub/img/image-20210517175443503.png"/></p>
<h1 id="总结">总结</h1>
<blockquote>
<p>基础的指标抓取 和 基础优化就完成了，如后续需要添加指标，参照上面的添加 抓取指标步骤<code>照葫芦画瓢</code> ，创建 <code>ServiceMonitor</code> 资源对象即可，当然还有另外一种添加配置的方法，后面与 exporter 集成使用时会做使用说明。</p>
</blockquote>
</div>
<div class="post-copyright">
<p class="copyright-item">
<span class="item-title">文章作者</span>
<span class="item-content">Johny</span>
</p>
<p class="copyright-item">
<span class="item-title">上次更新</span>
<span class="item-content">
        2021-05-17
        
    </span>
</p>
<p class="copyright-item">
<span class="item-title">许可协议</span>
<span class="item-content"><a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" rel="license noopener" target="_blank">CC BY-NC-ND 4.0</a></span>
</p>
</div>
<footer class="post-footer">
<div class="post-tags">
<a href="/tags/rancher/">rancher</a>
<a href="/tags/prometheus/">prometheus</a>
<a href="/tags/operator/">operator</a>
<a href="/tags/k8s/">k8s</a>
<a href="/tags/kubekey/">kubekey</a>
<a href="/tags/exporter/">exporter</a>
</div>
<nav class="post-nav">
<a class="prev" href="/post/rancher-monitor-config-second/">
<i class="iconfont icon-left"></i>
<span class="prev-text nav-default">Rancher 开启监控后，exporter/metrics 的添加说明 (二)</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class="next" href="/post/velero-install/">
<span class="next-text nav-default">Velero 备份迁移工具的安装</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i>
</a>
</nav>
</footer>
</article>
</div>
<div id="vcomments"></div>
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@3/dist/av-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script>
<script type="text/javascript">
    new Valine({
        el: '#vcomments' ,
        appId: 'wS5tU9o2RILlBpQiEfIDgPwI-gzGzoHsz',
        appKey: 'siSAWI3rzA6Ow8Tmiv7V4GO4',
        notify:  true ,
        verify:  true ,
        avatar:'',
        placeholder: '来留下点什么吧~',
        visitor:  false 
    });
  </script>
</div>
</main>
<footer class="footer" id="footer">
<div class="social-links">
<a class="iconfont icon-email" href="mailto:yangzun@treesir.pub" title="email"></a>
<a class="iconfont icon-github" href="https://github.com/cdryzun" title="github"></a>
<a class="iconfont icon-rss" href="https://cdryzun.github.io/index.xml" title="rss" type="application/rss+xml"></a>
</div>
<div class="copyright">
<span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
</span>
<span class="division">|</span>
<span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
</span>
<span class="copyright-year">
<a class="busuanzi-footer" href="https://beian.miit.gov.cn/">湘ICP备2021002157号-1</a> <img alt="upai" class="ls-is-cached lazyloaded" height="28" src="https://cdn.treesir.pub/img/icp.png" style="margin: -25px 2px" width="23"/> <a href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral" rel="nofollow" target="_blank"><img alt="upai" class="ls-is-cached lazyloaded" height="28" src="https://cdn.treesir.pub/img/upyun.png" style="margin: -25px 2px" width="56"/></a>
    © 
    2019 - 
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>Johny </span>
</span>
</div>
</footer>
<div class="back-to-top" id="back-to-top">
<i class="iconfont icon-up"></i>
</div>
</div>
<script crossorigin="anonymous" src="https://cdn.treesir.pub/blog-js/jquery.min.js"></script>
<script crossorigin="anonymous" src="https://cdn.treesir.pub/blog-js/slideout.min.js"></script>
<script crossorigin="anonymous" src="https://cdn.treesir.pub/blog-js/jquery.fancybox.min.js"></script>
<script src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js" type="text/javascript"></script>
<script src="/js/copy-to-clipboard.js"></script>
<script src="https://cdn.treesir.pub/blog-js/docsearch.min.js"></script>
<script>
    docsearch({
    apiKey: "17388eec628e676a77d6235068b458df",
    indexName: "blog",
    appId: "KEECS2XKBV",
    inputSelector: '.docsearch-input',
    debug: false,
    });
</script>
</body>
</html>
