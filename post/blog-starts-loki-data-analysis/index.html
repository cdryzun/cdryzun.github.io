<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"/>
<title>站点开始使用 Grafana loki 统计分析 - 「Leafy'John」PlayGround</title>
<meta content="webkit" name="renderer"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport"/>
<meta content="no-transform" http-equiv="Cache-Control"/>
<meta content="no-siteapp" http-equiv="Cache-Control"/>
<meta content="#f8f5ec" name="theme-color"/>
<meta content="#f8f5ec" name="msapplication-navbutton-color"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="#f8f5ec" name="apple-mobile-web-app-status-bar-style"/>
<meta content="Leafy'John" name="author"/><meta content="The site has started using Grafana Loki for statistical analysis. 站点开始使用 Grafana loki 进行统计分析" name="description"/><meta content="Grafana, loki, 站点, nginx, 分析, 指标抓取" name="keywords"/>
<meta content="Hugo 0.92.0 with theme even" name="generator"/>
<link href="https://cdryzun.github.io/post/blog-starts-loki-data-analysis/" rel="canonical"/>
<link href="/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180"/>
<link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"/>
<link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"/>
<link href="/manifest.json" rel="manifest"/>
<link color="#5bbad5" href="/safari-pinned-tab.svg" rel="mask-icon"/>
<link href="/sass/main.min.404b35997075abed13fc31198c48ccfa115c0855fc6e525128eac767d84fdcd2.css" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://cdn.treesir.pub/blog-css/jquery.fancybox.min.css" rel="stylesheet"/>
<link href="/css/custom.css" rel="stylesheet"/>
<meta content="站点开始使用 Grafana loki 统计分析" property="og:title"/>
<meta content="The site has started using Grafana Loki for statistical analysis. 站点开始使用 Grafana loki 进行统计分析" property="og:description"/>
<meta content="article" property="og:type"/>
<meta content="https://cdryzun.github.io/post/blog-starts-loki-data-analysis/" property="og:url"/><meta content="post" property="article:section"/>
<meta content="2023-07-29T16:54:09+08:00" property="article:published_time"/>
<meta content="2023-07-29T16:54:09+08:00" property="article:modified_time"/>
<meta content="站点开始使用 Grafana loki 统计分析" itemprop="name"/>
<meta content="The site has started using Grafana Loki for statistical analysis. 站点开始使用 Grafana loki 进行统计分析" itemprop="description"/><meta content="2023-07-29T16:54:09+08:00" itemprop="datePublished"/>
<meta content="2023-07-29T16:54:09+08:00" itemprop="dateModified"/>
<meta content="4995" itemprop="wordCount"/>
<meta content="DevOps,Logging," itemprop="keywords"/><meta content="summary" name="twitter:card"/>
<meta content="站点开始使用 Grafana loki 统计分析" name="twitter:title"/>
<meta content="The site has started using Grafana Loki for statistical analysis. 站点开始使用 Grafana loki 进行统计分析" name="twitter:description"/>
<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->
<!--[if lt IE 9]>
  <script src="https://cdn.treesir.pub/blog-js/html5shiv.min.js"></script>
  <script src="https://cdn.treesir.pub/blog-js/respond.min.js"></script>
<![endif]-->
<link href="https://cdn.treesir.pub/blog-css/docsearch.min.css" rel="stylesheet"/>
</head>
<body>
<header class="header" id="header">
<div class="logo-wrapper">
<a class="logo" href="/">Leafy'John」PlayGround</a>
</div>
<nav class="site-navbar">
<ul class="menu" id="menu">
<li class="menu-item">
<a class="menu-item-link" href="/">主页</a>
</li><li class="menu-item">
<a class="menu-item-link" href="/post/">归档</a>
</li><li class="menu-item">
<a class="menu-item-link" href="/tags/">标签</a>
</li><li class="menu-item">
<a class="menu-item-link" href="/categories/">分类</a>
</li>
</ul><li style="display:inline-block;margin-right:10px;">
<input class="docsearch-input" placeholder="Search" type="search"/>
</li></nav>
</header>
<div class="mobile-navbar" id="mobile-navbar">
<div class="mobile-header-logo">
<a class="logo" href="/">Leafy'John」PlayGround</a>
</div>
<div class="mobile-navbar-icon">
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav class="mobile-menu slideout-menu" id="mobile-menu">
<ul class="mobile-menu-list">
<a href="/">
<li class="mobile-menu-item">主页</li>
</a><a href="/post/">
<li class="mobile-menu-item">归档</li>
</a><a href="/tags/">
<li class="mobile-menu-item">标签</li>
</a><a href="/categories/">
<li class="mobile-menu-item">分类</li>
</a>
</ul>
</nav>
<div class="container" id="mobile-panel">
<main class="main" id="main">
<div class="content-wrapper">
<div class="content" id="content">
<article class="post">
<header class="post-header">
<h1 class="post-title">站点开始使用 Grafana loki 统计分析</h1>
<div class="post-meta">
<span class="post-time"> 2023-07-29 </span>
<div class="post-category">
<a href="/categories/loki/"> Loki </a>
<a href="/categories/sre/"> SRE </a>
</div>
<span class="more-meta"> 约 4995 字 </span>
<span class="more-meta"> 预计阅读 10 分钟 </span>
</div>
</header>
<div class="post-toc" id="post-toc">
<h2 class="post-toc-title">文章目录</h2>
<div class="post-toc-content always-active">
<nav id="TableOfContents">
<ul>
<li><a href="#说明">说明</a>
<ul>
<li><a href="#站点情况">站点情况</a></li>
<li><a href="#技术说明">技术说明</a></li>
</ul>
</li>
<li><a href="#配置日志格式">配置日志格式</a>
<ul>
<li><a href="#openrestry-编译-geoip2-模块">OpenRestry 编译 GeoIP2 模块</a></li>
<li><a href="#openrestry-配置对接-geo_ip-databases">OpenRestry 配置对接 <code>Geo_IP Databases</code></a></li>
</ul>
</li>
<li><a href="#配置-loki">配置 Loki</a>
<ul>
<li><a href="#什么是-grafana-cloud-">什么是 Grafana Cloud ？</a></li>
<li><a href="#部署-promtail-日志代理">部署 Promtail 日志代理</a></li>
</ul>
</li>
<li><a href="#配置-dashboard">配置 Dashboard</a>
<ul>
<li><a href="#加载-dashboard">加载 Dashboard</a></li>
<li><a href="#修剪变量--dashboard">修剪变量 &amp; Dashboard</a></li>
<li><a href="#添加-pv--uv-指标">添加 PV &amp; UV 指标</a></li>
</ul>
</li>
<li><a href="#总结">总结</a></li>
</ul>
</nav>
</div>
</div>
<div class="post-content">
<h1 id="说明">说明</h1>
<blockquote>
<p>建站已接近快三年，一直没有怎么维护和管理，查看站点访问数据目前还使用的是<code>Google Search Console</code>&amp; 正在对接用的<code>CDN</code>厂商 (又拍云) 所提供的后台统计，又拍云所提供的后台统计有一个痛点，就是无法根据访问 <code>IP</code> 来统计 PV（Page Views） &amp; UV（Unique Visitors）的真实情况，有点鸡肋。所以开始在网上查找合适轻量化解决方案，对眼上了 Grafana 的这款 <a href="https://grafana.com/grafana/dashboards/12559-loki-nginx-service-mesh-json-version/">Dashboard</a>，查看其简介后，此 Dashboard 基于 Loki 进行实现，能够接入 <a href="https://grafana.com/products/cloud/">Grafana Cloud</a> 解决轻量化问题，恰好之前也有对 Loki 有一点了解，部署起来应该问题不大，开始着手探索。</p>
</blockquote>
<p><code>来看一下我最终折腾后的效果，总体还不错的吧</code></p>
<p><img alt="image-20230729174820026" src="https://cdn.treesir.pub/images/2023/07/29/20230729174834.png"/></p>
<hr/>
<h2 id="站点情况">站点情况</h2>
<blockquote>
<p>开始部署前，先说明一下我站点的技术栈选型，目前我站点基于 <a href="https://gohugo.io/">Hugo</a> 实现静态文件的生成，将渲染过后的静态文件通过 <code>Docker + Nginx</code> 打包成镜像，方便后续接入 K8S 种平台，但后面 K8S 这里我最终放弃，因为站点实际流量不大，没有必要，不适合懒人维护还不环保。而站点实际运行的是在一台云主机中， 使用Docker运行博客容器，再通过 <a href="https://openresty.org/cn/">OpenResty</a> 反向代理一下，这里还我套一个 OpenResty 是因为 <code>443</code>，这类端口珍贵，通过反代可以实现<code>复用</code>功能，同时还可以加一些 <a href="https://github.com/mitchellkrogza/nginx-ultimate-bad-bot-blocker">WAF</a> (Web Application Firewall) 的操作使得站点更加的安全、耐操。博客镜像的更新我选择使用的 <a href="https://github.com/containrrr/watchtower">Watchtower</a>，只要博客的镜像基于 Pipeline 生成最新镜像并推送指 Dockerhub 中，Watchtower 它会 <code>自动</code> 帮我完成博客的重载和更新。上述描述即是我目前博客的运行情况。</p>
</blockquote>
<hr/>
<h2 id="技术说明">技术说明</h2>
<ul>
<li>
<p>LoKi  是什么？</p>
<blockquote>
<p>Loki 是 Grafana Labs 开发的一个开源、多租户的日志聚合系统，它的设计目标是能够在公有云、私有云和混合云环境中高效地提供即时日志搜索和探索功能。Loki 的设计理念是将日志数据和监控数据（例如，指标和追踪数据）紧密地结合在一起，从而提供一种统一的、高效的方式来观察和诊断系统行为。</p>
<p>Loki 的主要特点包括：</p>
<ol>
<li>
<p><strong>索引简化</strong>：Loki 不会为每个日志行创建索引，而是为每个日志流创建索引。这种方法大大降低了存储成本，并提高了查询效率。</p>
</li>
<li>
<p><strong>紧密集成 Grafana</strong>：Loki 与 Grafana 紧密集成，可以在 Grafana 的界面中直接查询和查看 Loki 的日志数据。</p>
</li>
<li>
<p><strong>多租户支持</strong>：Loki 支持多租户，每个租户都有自己的隔离的日志数据。</p>
</li>
<li>
<p><strong>高度可扩展</strong>：Loki 的架构支持水平扩展，可以通过添加更多的节点来处理更大的日志数据。</p>
</li>
<li>
<p><strong>兼容 Prometheus</strong>：Loki 的查询语言（LogQL）设计上兼容 Prometheus 的查询语言（PromQL），使得在 Loki 中查询日志数据和在 Prometheus 中查询指标数据的体验非常相似。</p>
</li>
<li>
<p><strong>支持多种数据源</strong>：Loki 支持多种日志数据源，包括但不限于 systemd journal、docker logs、fluentd 等。</p>
</li>
</ol>
</blockquote>
</li>
<li>
<p>Loki 的主要组件有哪些？</p>
<blockquote>
<p>Loki 的架构由几个主要组件构成，这些组件可以在单个二进制文件中一起运行，也可以作为单独的进程运行。以下是 Loki 的主要组件：</p>
<ol>
<li>
<p><strong>Promtail</strong>：Promtail 是 Loki 的代理，它负责收集日志并将它们发送到 Loki。Promtail 通常在产生日志的机器上运行，可以直接读取日志文件，也可以接收由其他进程（如 Fluentd 或 Fluent Bit）转发的日志。</p>
</li>
<li>
<p><strong>Loki</strong>：Loki 是主要的日志聚合和查询组件，它接收并存储日志，同时提供了一个查询接口。Loki 通过索引日志流（而不是每一行日志）来提供高效的存储和查询。</p>
</li>
<li>
<p><strong>Distributor</strong>：Distributor 是 Loki 的组件，它负责接收来自 Promtail 的日志数据，然后将这些数据分发到多个 Ingester。</p>
</li>
<li>
<p><strong>Ingester</strong>：Ingester 是 Loki 的组件，它负责接收日志数据，将数据压缩后存储在内存中，然后定期将这些数据刷新到长期存储（如 Amazon S3 或 Google Cloud Storage）。</p>
</li>
<li>
<p><strong>Querier</strong>：Querier 是 Loki 的组件，它负责处理来自用户的查询请求。Querier 会从 Ingester 和长期存储中获取数据，然后返回查询结果。</p>
</li>
<li>
<p><strong>Query Frontend</strong>：Query Frontend 是 Loki 的组件，它负责优化和加速查询。Query Frontend 会将大查询分解为多个小查询，然后并行执行这些小查询。</p>
</li>
<li>
<p><strong>Compactor</strong>：Compactor 是 Loki 的组件，它负责压缩和优化在长期存储中的数据。</p>
</li>
<li>
<p><strong>Ruler</strong>：Ruler 是 Loki 的组件，它负责执行预定义的规则和警报。</p>
</li>
</ol>
</blockquote>
</li>
</ul>
<hr/>
<h1 id="配置日志格式">配置日志格式</h1>
<blockquote>
<p>因我使用的是 <a href="https://oneinstack.com/auto/">OneinStack</a> 一键部署的 OpenRestry，按照该  <a href="https://grafana.com/grafana/dashboards/12559-loki-nginx-service-mesh-json-version/">Dashboard</a> 中的描述，需要对日志配置 GeoIP，需要对 OpenRestry 重新编译开启，查看了一下 GeoIP 的选项，我选择  <code>GeoIP2 Databases</code>作为我的库，只需要编译一下 <code>module</code> ，在使用时进行 load 即可，对于的 module 地址 &amp; 参考文档</p>
<ul>
<li>模块仓库地址: <a href="https://ghproxy.com/https://github.com/leev/ngx_http_geoip2_module.git">https://ghproxy.com/https://github.com/leev/ngx_http_geoip2_module.git</a></li>
<li>参考文档: <a href="https://www.electrosoftcloud.com/en/compile-geoip2-in-openresty-and-how-to-use-it/">https://www.electrosoftcloud.com/en/compile-geoip2-in-openresty-and-how-to-use-it/</a></li>
</ul>
</blockquote>
<hr/>
<h2 id="openrestry-编译-geoip2-模块">OpenRestry 编译 GeoIP2 模块</h2>
<ul>
<li>
<p>按照上面文档的描述，首先需要安装 maxminddb 依赖，我这里使用的是 <code>CentOS 7</code> 系统，使用下述命令安装</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">yum install -y libmaxminddb-devel libmaxminddb
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Clone GeoIP2 模块仓库代码至目录 (编译时要用)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">mkdir -p /tmp/compile/openresty-<span class="k">$(</span>nginx -v 2&gt;<span class="p">&amp;</span>1<span class="p">|</span>cut -d <span class="s2">"/"</span> -f2<span class="k">)</span>/modules
<span class="nb">cd</span> /tmp/compile/openresty-<span class="k">$(</span>nginx -v 2&gt;<span class="p">&amp;</span>1<span class="p">|</span>cut -d <span class="s2">"/"</span> -f2<span class="k">)</span>/modules
git clone https://ghproxy.com/https://github.com/leev/ngx_http_geoip2_module.git
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>进入 ${NGINX_SOURCE_CODE_PATH} (OpenRestry源码目录) 进行编译，用 OneinStack 安装的话，包会统一存放在 <code>./src</code> 目录下</p>
<blockquote>
<p>我这里 <code>OneinStack</code> ROOT_PATH 为 <code>/data/scripts/oneinstack</code>，替换为你实际的路径</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># cd ${NGINX_SOURCE_CODE_PATH}/bundle/nginx-$(nginx -v 2&gt;&amp;1|cut -d "/" -f2|grep -oP '^d+.d+.d+')</span>

<span class="nb">cd</span> /data/scripts/oneinstack/src/openresty-1.19.3.1/bundle/nginx-1.19.3

<span class="c1"># 配置编译时所需的环境变量（否则将失败）</span>
<span class="nb">export</span> <span class="nv">LUAJIT_LIB</span><span class="o">=</span><span class="s2">"/usr/local/openresty/luajit/lib/"</span>
<span class="nb">export</span> <span class="nv">LUAJIT_INC</span><span class="o">=</span><span class="s2">"../LuaJIT-*/src/"</span>

<span class="c1"># 获取已安装的 OpenResty 编译选项，以避免 "二进制不兼容" 错误</span>

<span class="nv">COMPILEOPTIONS</span><span class="o">=</span><span class="k">$(</span>nginx -V 2&gt;<span class="p">&amp;</span>1<span class="p">|</span>grep -i <span class="s2">"arguments"</span><span class="p">|</span>cut -d <span class="s2">":"</span> -f2-<span class="k">)</span>

<span class="c1"># 使用这些选项配置编译</span>
<span class="c1"># 将 GeoIP2 添加为动态模块，指向你 Clone 的路径</span>
<span class="nb">eval</span> ./configure <span class="nv">$COMPILEOPTIONS</span> --add-dynamic-module<span class="o">=</span>/tmp/compile/openresty-1.19.3.1/modules/ngx_http_geoip2_module/
</code></pre></td></tr></table>
</div>
</div><p><img alt="image-20230729192055972" src="https://cdn.treesir.pub/images/2023/07/29/20230729192058.png"/></p>
</li>
<li>
<p>上一步成功后，开始执行编译动作</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># Compile just the module</span>
make modules
</code></pre></td></tr></table>
</div>
</div><p><img alt="image-20230729192151965" src="https://cdn.treesir.pub/images/2023/07/29/20230729193949.png"/></p>
<p>这一步成功后，会在当前 <code>objs</code> 下生成 所需的 动态库文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">ls -lh objs/*.so
-rwxr-xr-x <span class="m">1</span> root root 86K Jul <span class="m">27</span> 11:22 objs/ngx_http_geoip2_module.so
-rwxr-xr-x <span class="m">1</span> root root 62K Jul <span class="m">27</span> 11:22 objs/ngx_stream_geoip2_module.so  <span class="c1">#  这个动态库文件为 L4 时使用，我们且用上面那个即可</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>OpenRestry 配置加载 GeoIP2 动态库</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">mkdir -p /usr/local/openresty/nginx/modules

cp -a objs/*.so /usr/local/openresty/nginx/modules/ <span class="c1"># COPY 动态库文件，方便后续引用</span>

vim /etc/nginx/nginx.conf <span class="c1"># 编辑 NGINX 主配置文件加入这行</span>

load_module modules/ngx_http_geoip2_module.so<span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><img alt="image-20230729192420002" src="https://cdn.treesir.pub/images/2023/07/29/20230729193906.png"/></p>
</li>
</ul>
<hr/>
<h2 id="openrestry-配置对接-geo_ip-databases">OpenRestry 配置对接 <code>Geo_IP Databases</code></h2>
<blockquote>
<p>模块加载后，实际使用还需要一个 GEO 的数据库，到官网下载到话，需要注册一个账号，有账号的小伙伴可以通过 <a href="https://dev.maxmind.com/geoip/geolite2-free-geolocation-data">官网下载</a>，我尝试注册一个提示我使用 VPN 过不了风控，直接给我干劝退。不过还好有其他方案，就是有人以将数据库文件上传至 Github 中，可用仓库地址如下</p>
<ul>
<li><a href="https://github.com/P3TERX/GeoLite.mmdb">https://github.com/P3TERX/GeoLite.mmdb</a></li>
</ul>
<p>我下载的 <code>GeoLite2-Country.mmdb</code> ，目前已够用</p>
</blockquote>
<ul>
<li>
<p>下载 geoip2 数据库至 <code>/etc/nginx/geoip2</code> 并加载</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># Nginx 主配置文件加入如下内容，放置到 http 段中</span>

vim /etc/nginx/nginx.conf

 <span class="c1"># Geo_IP</span>
   geoip2 /etc/nginx/geoip2/GeoLite2-Country.mmdb <span class="o">{</span>
        auto_reload 5m<span class="p">;</span>
        <span class="nv">$geoip2_metadata_country_build</span> metadata build_epoch<span class="p">;</span>
        <span class="nv">$geoip2_data_country_code</span> <span class="nv">default</span><span class="o">=</span>US country iso_code<span class="p">;</span>
        <span class="nv">$geoip2_data_country_name</span> country names en<span class="p">;</span>
   <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img alt="image-20230729193104645" src="https://cdn.treesir.pub/images/2023/07/29/20230729193108.png"/></p>
</li>
<li>
<p>按照 Dashbaord 文档配置日志格式 <code>json_analytics</code></p>
<blockquote>
<p>注意 <code>geoip_country_code</code> 这里因为我们使用的是 Geo_IP2 ，需要替换为我们上面所定义的变量 <code>geoip2_data_country_name</code></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">vim /etc/nginx/nginx.conf

<span class="c1"># 添加 Dashboard 所需的日志格式</span>
log_format json_analytics <span class="nv">escape</span><span class="o">=</span>json <span class="s1">'{'</span>
                            <span class="s1">'"msec": "$msec", '</span> <span class="c1"># request unixtime in seconds with a milliseconds resolution</span>
                            <span class="s1">'"connection": "$connection", '</span> <span class="c1"># connection serial number</span>
                            <span class="s1">'"connection_requests": "$connection_requests", '</span> <span class="c1"># number of requests made in connection</span>
                    <span class="s1">'"pid": "$pid", '</span> <span class="c1"># process pid</span>
                    <span class="s1">'"request_id": "$request_id", '</span> <span class="c1"># the unique request id</span>
                    <span class="s1">'"request_length": "$request_length", '</span> <span class="c1"># request length (including headers and body)</span>
                    <span class="s1">'"remote_addr": "$remote_addr", '</span> <span class="c1"># client IP</span>
                    <span class="s1">'"remote_user": "$remote_user", '</span> <span class="c1"># client HTTP username</span>
                    <span class="s1">'"remote_port": "$remote_port", '</span> <span class="c1"># client port</span>
                    <span class="s1">'"time_local": "$time_local", '</span>
                    <span class="s1">'"time_iso8601": "$time_iso8601", '</span> <span class="c1"># local time in the ISO 8601 standard format</span>
                    <span class="s1">'"request": "$request", '</span> <span class="c1"># full path no arguments if the request</span>
                    <span class="s1">'"request_uri": "$request_uri", '</span> <span class="c1"># full path and arguments if the request</span>
                    <span class="s1">'"args": "$args", '</span> <span class="c1"># args</span>
                    <span class="s1">'"status": "$status", '</span> <span class="c1"># response status code</span>
                    <span class="s1">'"body_bytes_sent": "$body_bytes_sent", '</span> <span class="c1"># the number of body bytes exclude headers sent to a client</span>
                    <span class="s1">'"bytes_sent": "$bytes_sent", '</span> <span class="c1"># the number of bytes sent to a client</span>
                    <span class="s1">'"http_referer": "$http_referer", '</span> <span class="c1"># HTTP referer</span>
                    <span class="s1">'"http_user_agent": "$http_user_agent", '</span> <span class="c1"># user agent</span>
                    <span class="s1">'"http_x_forwarded_for": "$http_x_forwarded_for", '</span> <span class="c1"># http_x_forwarded_for</span>
                    <span class="s1">'"http_host": "$http_host", '</span> <span class="c1"># the request Host: header</span>
                    <span class="s1">'"server_name": "$server_name", '</span> <span class="c1"># the name of the vhost serving the request</span>
                    <span class="s1">'"request_time": "$request_time", '</span> <span class="c1"># request processing time in seconds with msec resolution</span>
                    <span class="s1">'"upstream": "$upstream_addr", '</span> <span class="c1"># upstream backend server for proxied requests</span>
                    <span class="s1">'"upstream_connect_time": "$upstream_connect_time", '</span> <span class="c1"># upstream handshake time incl. TLS</span>
                    <span class="s1">'"upstream_header_time": "$upstream_header_time", '</span> <span class="c1"># time spent receiving upstream headers</span>
                    <span class="s1">'"upstream_response_time": "$upstream_response_time", '</span> <span class="c1"># time spend receiving upstream body</span>
                    <span class="s1">'"upstream_response_length": "$upstream_response_length", '</span> <span class="c1"># upstream response length</span>
                    <span class="s1">'"upstream_cache_status": "$upstream_cache_status", '</span> <span class="c1"># cache HIT/MISS where applicable</span>
                    <span class="s1">'"ssl_protocol": "$ssl_protocol", '</span> <span class="c1"># TLS protocol</span>
                    <span class="s1">'"ssl_cipher": "$ssl_cipher", '</span> <span class="c1"># TLS cipher</span>
                    <span class="s1">'"scheme": "$scheme", '</span> <span class="c1"># http or https</span>
                    <span class="s1">'"request_method": "$request_method", '</span> <span class="c1"># request method</span>
                    <span class="s1">'"server_protocol": "$server_protocol", '</span> <span class="c1"># request protocol, like HTTP/1.1 or HTTP/2.0</span>
                    <span class="s1">'"pipe": "$pipe", '</span> <span class="c1"># "p" if request was pipelined, "." otherwise</span>
                    <span class="s1">'"gzip_ratio": "$gzip_ratio", '</span>
                    <span class="s1">'"http_cf_ray": "$http_cf_ray",'</span>
                    <span class="s1">'"geoip_country_code": "$geoip2_data_country_code"'</span>
                    <span class="s1">'}'</span><span class="p">;</span>

</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>对应虚拟主机日志格式更改</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 更改对应虚拟主机中的日志格式，为上面定义的 json_analytics</span>

vim vhost/www.conf
server <span class="o">{</span>
  listen <span class="m">443</span> http2<span class="p">;</span>
  server_name www.treesir.pub<span class="p">;</span>
  access_log /data/wwwlogs/nps_www_access_nginx.log json_analytics<span class="p">;</span>
  ...
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>查看效果，以变成我们所期望的格式</p>
<p><img alt="image-20230729193836030" src="https://cdn.treesir.pub/images/2023/07/29/20230729193925.png"/></p>
<p>⚠️ 这里日志所返回的 <code>geoip_country_code</code> 也有可能不是你所期待的效果，比如你的 站点位于 CDN 或者 代理服务器的后端的时候，会导致 <code>remote_addr</code> 地址不是真正客户端的真实IP，影响到最终结果，这里概举这两种方式解决</p>
<ul>
<li>使用 Nginx 自带的 set_real_ip_from</li>
<li>模块提供的 <a href="https://github.com/leev/ngx_http_geoip2_module">geoip2_proxy</a> 相关参数</li>
</ul>
<p>推荐 set_real_ip_from 这种，同时可以让日志中 <code>remote_addr</code> 也获取到真实的IP，使日志便于后续统计和分析，配置方法如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">vim /etc/nginx/nginx.conf <span class="c1"># 更改主配置文件，http 段加入如下内容</span>

  <span class="c1"># 获取 CDN 后真实 IP</span>
  set_real_ip_from 0.0.0.0/0<span class="p">;</span>
  real_ip_header X-Forwarded-For<span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<hr/>
<h1 id="配置-loki">配置 Loki</h1>
<blockquote>
<p>由于我比较懒，不太想在自己的 <code>HomeLab</code> 中部署 Loki (主要部署单实例的 Loki 使用体验不好，部署微服务架构又太重了，白嫖难道不香嘛？)，我们这里基于 Grafana Cloud 实现 Loki 和 Dashboard 的展示。<code>这里省略创建账号这类操作</code>，登陆入口地址如下，有 Google 账号的直接第三方登陆即可</p>
<ul>
<li><a href="https://grafana.com/products/cloud/">https://grafana.com/products/cloud/</a></li>
</ul>
</blockquote>
<h2 id="什么是-grafana-cloud-">什么是 Grafana Cloud ？</h2>
<blockquote>
<p>Grafana Cloud 是 Grafana Labs 提供的一种托管服务，它提供了 Grafana、Prometheus 和 Loki 的托管版本。这意味着你可以使用这些强大的开源监控和可视化工具，而无需自己管理和维护底层的基础设施。</p>
<p>以下是 Grafana Cloud 的一些主要特性：</p>
<ol>
<li>
<p><strong>托管的 Grafana</strong>：你可以使用最新版本的 Grafana，而无需自己进行安装和升级。</p>
</li>
<li>
<p><strong>托管的 Prometheus 和 Alertmanager</strong>：你可以使用 Prometheus 和 Alertmanager 来收集和管理你的指标数据，而无需自己进行安装和配置。</p>
</li>
<li>
<p><strong>托管的 Loki</strong>：你可以使用 Loki 来收集和查询你的日志数据，而无需自己进行安装和配置。</p>
</li>
<li>
<p><strong>托管的 Grafana Tempo</strong>：Grafana Tempo 是一个高度可扩展的、易于操作的分布式追踪后端。你可以使用它来存储和查询你的追踪数据。</p>
</li>
<li>
<p><strong>集成的警报和通知</strong>：你可以使用 Grafana Cloud 的警报和通知功能，来及时了解你的系统状态。</p>
</li>
<li>
<p><strong>安全和可靠</strong>：Grafana Cloud 提供了数据加密、备份和高可用性等安全和可靠性特性。</p>
</li>
</ol>
</blockquote>
<hr/>
<h2 id="部署-promtail-日志代理">部署 Promtail 日志代理</h2>
<blockquote>
<p>这里的 Promtail 为 Loki 的日志代理，通过将主机中的日志收集起来，Post 到 loki 中，实现日志的统一存储。下面的文档中我们会使用 Docker Compose 来部署 <code>Promtail</code></p>
</blockquote>
<ul>
<li>
<p>安装 Docker Compose</p>
<blockquote>
<p>以安装请省略</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">curl -L <span class="s2">"https://github.com/docker/compose/releases/download/1.29.2/docker-compose-</span><span class="k">$(</span>uname -s<span class="k">)</span><span class="s2">-</span><span class="k">$(</span>uname -m<span class="k">)</span><span class="s2">"</span> -o /usr/local/bin/docker-compose <span class="se">\
</span><span class="se"></span><span class="o">&amp;&amp;</span> chmod +x /usr/local/bin/docker-compose <span class="se">\
</span><span class="se"></span><span class="o">&amp;&amp;</span> ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose <span class="se">\
</span><span class="se"></span><span class="o">&amp;&amp;</span> docker-compose --version
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>初始化 promtail 部署</p>
<blockquote>
<p><code>/data/wwwlogs</code> 为你所要收集日志的目录，按你实际情况更改</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">mkdir -p /data/docker-compose/loki-promtail/

<span class="nb">cd</span> /data/docker-compose/loki-promtail/


cat docker-compose.yaml <span class="c1"># 内容如下</span>
version: <span class="s2">"3"</span>

networks:
  loki:

services:
  promtail:
    image: grafana/promtail:2.7.4
    volumes:
      - /data/wwwlogs:/data/wwwlogs:ro
      - ./config/config.yml:/etc/promtail/config.yml:ro
      - /etc/localtime:/etc/localtime
    command: -config.file<span class="o">=</span>/etc/promtail/config.yml
</code></pre></td></tr></table>
</div>
</div><p><code>config/config.yml</code> 配置文件如下</p>
<blockquote>
<p>更改 <code>USER_ID</code> &amp;  <code>TOKEN</code> 为你实际页面生成的，登陆 Cloud 后找 Loki</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">server:
  http_listen_port: <span class="m">0</span>
  grpc_listen_port: <span class="m">0</span>

positions:
  filename: /tmp/positions.yaml

clients:
  - url: https://<span class="si">${</span><span class="nv">USER_ID</span><span class="si">}</span>:<span class="si">${</span><span class="nv">TOKEN</span><span class="si">}</span>@logs-prod-021.grafana.net/loki/api/v1/push

scrape_configs:
    - job_name: system
      pipeline_stages:
      - replace:
          expression: <span class="s1">'(?:[0-9]{1,3}\.){3}([0-9]{1,3})'</span>
          replace: <span class="s1">'***'</span>
      static_configs:
      - targets:
         - www.treesir.pub
        labels:
         job: nginx_access_log
         host: ali-vps
         agent: promtail
         __path__: /data/wwwlogs/nps_www_access_nginx.log
</code></pre></td></tr></table>
</div>
</div><p><img alt="image-20230729202401293" src="https://cdn.treesir.pub/images/2023/07/29/20230729202655.png"/></p>
</li>
<li>
<p>启动 promtail 日志收集</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">docker-compose up -d
</code></pre></td></tr></table>
</div>
</div><p><img alt="image-20230729202633653" src="https://cdn.treesir.pub/images/2023/07/29/20230729202652.png"/></p>
</li>
</ul>
<hr/>
<h1 id="配置-dashboard">配置 Dashboard</h1>
<blockquote>
<p><a href="https://grafana.com/auth/sign-in/?plcmt=top-nav&amp;cta=myaccount">回到 Cloud 主页</a> ，点击进入 Grafana</p>
</blockquote>
<p><img alt="image-20230729203117680" src="https://cdn.treesir.pub/images/2023/07/29/20230729203257.png"/></p>
<h2 id="加载-dashboard">加载 Dashboard</h2>
<p><img alt="image-20230729203251382" src="https://cdn.treesir.pub/images/2023/07/29/20230729203512.png"/></p>
<p><img alt="image-20230729203335944" src="https://cdn.treesir.pub/images/2023/07/29/20230729203516.png"/></p>
<p><img alt="image-20230729203418924" src="https://cdn.treesir.pub/images/2023/07/29/20230729203519.png"/></p>
<p><img alt="image-20230729203441700" src="https://cdn.treesir.pub/images/2023/07/29/20230729203523.png"/></p>
<hr/>
<h2 id="修剪变量--dashboard">修剪变量 &amp; Dashboard</h2>
<blockquote>
<p>导入会有一些报错，不用担心，我们调整一下变量即可，是缺少变量导致的</p>
</blockquote>
<p><img alt="image-20230729203635081" src="https://cdn.treesir.pub/images/2023/07/29/20230729203638.png"/></p>
<p><img alt="image-20230729203653434" src="https://cdn.treesir.pub/images/2023/07/29/20230729204557.png"/></p>
<p><img alt="image-20230729203714291" src="https://cdn.treesir.pub/images/2023/07/29/20230729204553.png"/></p>
<p>datasource 这里添加过滤 <code>.*-logs</code>，后点击 Apply，<code>防止刷新页面失效</code>，记得点击 <code>Save Dashboard</code></p>
<p><img alt="image-20230729203842784" src="https://cdn.treesir.pub/images/2023/07/29/20230729204550.png"/></p>
<p>选择 Dashbaord 参数，就可以看到对应的数值了</p>
<p><img alt="image-20230729204126893" src="https://cdn.treesir.pub/images/2023/07/29/20230729204548.png"/></p>
<p>可以看到 <code>Top Countries</code> 这里有点乱码，点击编辑，右边选项栏往下滑，找到 Mapping 把问号删除即可，或者改成你想要的映射内容。</p>
<p><img alt="image-20230729204313061" src="https://cdn.treesir.pub/images/2023/07/29/20230729204401.png"/></p>
<p><img alt="image-20230729204356085" src="https://cdn.treesir.pub/images/2023/07/29/20230729204358.png"/></p>
<p>更改后不要忘记 <code>Save</code> 一下</p>
<p><img alt="image-20230729204505730" src="https://cdn.treesir.pub/images/2023/07/29/20230729204507.png"/></p>
<hr/>
<h2 id="添加-pv--uv-指标">添加 PV &amp; UV 指标</h2>
<blockquote>
<p>该图表，默认没有提供 PV &amp; UV 指标，Loki 提供了一套与 Prometheus 类似的查询语法，叫 <a href="https://grafana.com/docs/loki/latest/logql/">LogQL</a> , 我们可以通过此查询语法，通过自定义 Visualization ，得到我们想要的内容。</p>
</blockquote>
<ul>
<li>
<p>获取 24H PV 指标, logQL 示例</p>
<blockquote>
<p>由于我使用了 Blackbox Exporter 监控探针，避免影响数据的真实性，我这里把这部分请求添加了过滤</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">sum<span class="o">(</span>count_over_time<span class="o">(</span>
  <span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s2">"</span><span class="nv">$job</span><span class="s2">"</span><span class="o">}</span>
  <span class="p">|</span> json 
  <span class="p">|</span>  <span class="nv">__error__</span><span class="o">=</span><span class="s2">""</span> and remote_addr !<span class="o">=</span> <span class="s2">""</span> and http_user_agent !~ <span class="s2">"^Blackbox.*"</span> 
  <span class="o">[</span>24h<span class="o">]</span>
<span class="o">))</span>
</code></pre></td></tr></table>
</div>
</div><p>新建图形</p>
<p><img alt="image-20230729205538890" src="https://cdn.treesir.pub/images/2023/07/29/20230729212814.png"/></p>
<p><img alt="image-20230729205618899" src="https://cdn.treesir.pub/images/2023/07/29/20230729212810.png"/></p>
<p>输入 logQL 测试运行，可以看到已经有结果了，由于我们这里且需要基于 <code>现在时间</code> 往前推 24h 的 PV 统计，但可以看到下图，它自动查询到了 1473 份数据，并按照这个数据绘制了 <code>区间水平线</code>，这其实有点没有必要，我们进行优化一下。</p>
<p><img alt="image-20230729205746086" src="https://cdn.treesir.pub/images/2023/07/29/20230729205747.png"/></p>
<p>优化查询参数，更改最大查询数据为 <code>1</code> , 时间区间选择 <code>15s</code>, 同时隐藏 <code>时间信息</code>。这样就得到我们预期的结果了。</p>
<p><img alt="image-20230729210106616" src="https://cdn.treesir.pub/images/2023/07/29/20230729210109.png"/></p>
</li>
<li>
<p>获取 24H UV 指标, logQL 示例</p>
<blockquote>
<p>配置方法与 上面的 PV 配置一致，如果你想要好看的样式，可以基于现有 Dashbaord 的图表进行参考配置，这部分就由自己的自由发挥，此篇文档不做这里介绍。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">sum<span class="o">(</span>sum by <span class="o">(</span>remote_addr<span class="o">)</span> <span class="o">(</span>
  sum by <span class="o">(</span>remote_addr, geoip_country_code<span class="o">)</span> <span class="o">(</span>
    count_over_time<span class="o">(</span>
      <span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s2">"</span><span class="nv">$job</span><span class="s2">"</span><span class="o">}</span>
      <span class="p">|</span> json
      <span class="p">|</span> <span class="nv">__error__</span><span class="o">=</span><span class="s2">""</span> and remote_addr !<span class="o">=</span> <span class="s2">""</span> and http_user_agent !~ <span class="s2">"^Blackbox.*"</span>
      <span class="o">[</span>24h<span class="o">]</span>
    <span class="o">)</span>
  <span class="o">)</span> ^ <span class="m">0</span>
<span class="o">))</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>统计区间</code>  PV 增长情况,  logQL 示例如下</p>
<blockquote>
<p>这里的区间我们选择使用 <code>$__interval</code> 内置变量，可以在使用时很好的和主页上的 <code>区间选择器</code>，进行联动查询。</p>
</blockquote>
<p><img alt="image-20230729210708408" src="https://cdn.treesir.pub/images/2023/07/29/20230729210712.png"/></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">sum by <span class="o">(</span>remote_addr<span class="o">)</span> <span class="o">((</span>count_over_time<span class="o">(</span>
  <span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s2">"</span><span class="nv">$job</span><span class="s2">"</span><span class="o">}</span>
  <span class="p">|</span> json 
  <span class="p">|</span>  <span class="nv">__error__</span><span class="o">=</span><span class="s2">""</span> and remote_addr !<span class="o">=</span> <span class="s2">""</span> and http_user_agent !~ <span class="s2">"^Blackbox.*"</span> 
  <span class="o">[</span><span class="nv">$__interval</span><span class="o">]</span>
<span class="o">)))</span>
</code></pre></td></tr></table>
</div>
</div><p>这次是用到的区间查询，配置方法与上面的两个不一样了，再次点击 New Visualization，选择 <code>Time series</code> 类型</p>
<p><img alt="image-20230729211154019" src="https://cdn.treesir.pub/images/2023/07/29/20230729212957.png"/></p>
<p>优化显示，现在看这个图，显的有的臃肿，我们优化一下。Legend 这里我们输入 <code>{{remote_addr}}</code></p>
<p><img alt="image-20230729211346275" src="https://cdn.treesir.pub/images/2023/07/29/20230729212952.png"/></p>
<p>左边找到  <code>Legend</code>，我们把它的 可见效关掉。现在就看起来舒服多了</p>
<p><img alt="image-20230729211715321" src="https://cdn.treesir.pub/images/2023/07/29/20230729211717.png"/></p>
<hr/>
<p>最终效果如下。已经与我最初所展示的效果接近。美化的工作交给你自己，如果实在不行，那你参考我这个导出的 <a href="https://cdn.treesir.pub/tools/share/Blog_%20Real-time%20Monitoring%20of%20Nginx-1690637105257.json">Json</a> 文件吧。</p>
<p><img alt="image-20230729212141818" src="https://cdn.treesir.pub/images/2023/07/29/20230729212146.png"/></p>
</li>
</ul>
<hr/>
<h1 id="总结">总结</h1>
<blockquote>
<p><code>Grafana</code> 可玩性还是挺高，白嫖的  Grafana Cloud 真香。Grafana Cloud 的查询性能是真不错，我尝试自建 Loki 同时使用 Loki 的微服务模式进行部署，却始终无法达到 Cloud 上的使用体验。后面再做深入研究吧，总体来说使用 Loki 统计博客日志的整体体验还是很不错的，不过经过这次折腾也还有几个问题没有得到有效解决</p>
<ul>
<li>
<p>统计 UV 的区间增长指时，这里会得到唯一的 1 ，如果与 PV 同时只有一个时，此处会得到重叠，语法和图片如下</p>
<blockquote>
<p>求大佬给个解疑的思路吧</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">
sum<span class="o">(</span>sum by <span class="o">(</span>remote_addr<span class="o">)</span> <span class="o">(</span>
  sum by <span class="o">(</span>remote_addr, geoip_country_code<span class="o">)</span> <span class="o">(</span>
    count_over_time<span class="o">(</span>
      <span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s2">"</span><span class="nv">$job</span><span class="s2">"</span><span class="o">}</span>
      <span class="p">|</span> json
      <span class="p">|</span> <span class="nv">__error__</span><span class="o">=</span><span class="s2">""</span> and remote_addr !<span class="o">=</span> <span class="s2">""</span> and http_user_agent !~ <span class="s2">"^Blackbox.*"</span>
      <span class="o">[</span>24h<span class="o">]</span>
    <span class="o">)</span>
  <span class="o">)</span> ^ <span class="m">0</span>
<span class="o">))</span>
</code></pre></td></tr></table>
</div>
</div><p><img alt="image-20230729213825942" src="https://cdn.treesir.pub/images/2023/07/29/20230729213828.png"/></p>
</li>
<li>
<p>Geo_IP   加载 <code>GeoLite2-City.mmdb</code> 库时，无法获取的正确的 City 名称（不过现在也用不着，后面说不定用的找呢）</p>
</li>
<li>
<p>Promtail 打印日志时，时区存在问题，目前且能通过更改源码，通过编译再使用解决</p>
</li>
</ul>
</blockquote>
</div>
<div class="post-copyright">
<p class="copyright-item">
<span class="item-title">文章作者</span>
<span class="item-content">Leafy'John</span>
</p>
<p class="copyright-item">
<span class="item-title">上次更新</span>
<span class="item-content">
        2023-07-29
        
    </span>
</p>
<p class="copyright-item">
<span class="item-title">许可协议</span>
<span class="item-content"><a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" rel="license noopener" target="_blank">CC BY-NC-ND 4.0</a></span>
</p>
</div>
<footer class="post-footer">
<div class="post-tags">
<a href="/tags/devops/">DevOps</a>
<a href="/tags/logging/">Logging</a>
</div>
<nav class="post-nav">
<a class="prev" href="/post/istio-in-action-study/">
<i class="iconfont icon-left"></i>
<span class="prev-text nav-default">Istio in Action 学习笔记</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class="next" href="/post/gitea-actrunner-systemd-deployment/">
<span class="next-text nav-default">Gitea Actions ActRunner 基于 Systemd 部署安装</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i>
</a>
</nav>
</footer>
</article>
</div>
<div id="vcomments"></div>
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@3/dist/av-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script>
<script type="text/javascript">
    new Valine({
        el: '#vcomments' ,
        appId: 'wS5tU9o2RILlBpQiEfIDgPwI-gzGzoHsz',
        appKey: 'siSAWI3rzA6Ow8Tmiv7V4GO4',
        notify:  true ,
        verify:  true ,
        avatar:'',
        placeholder: '来留下点什么吧~',
        visitor:  false 
    });
  </script>
</div>
</main>
<footer class="footer" id="footer">
<div class="social-links">
<a class="iconfont icon-email" href="mailto:yangzun@treesir.pub" title="email"></a>
<a class="iconfont icon-github" href="https://github.com/cdryzun" title="github"></a>
<a class="iconfont icon-rss" href="https://cdryzun.github.io/index.xml" title="rss" type="application/rss+xml"></a>
</div>
<div class="copyright">
<span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
</span>
<span class="division">|</span>
<span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
</span>
<span class="copyright-year">
<a class="busuanzi-footer" href="https://beian.miit.gov.cn/">湘ICP备2021002157号-1</a> <img alt="upai" class="ls-is-cached lazyloaded" height="28" src="https://cdn.treesir.pub/img/icp.png" style="margin: -25px 2px" width="23"/> <a href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral" rel="nofollow" target="_blank"><img alt="upai" class="ls-is-cached lazyloaded" height="28" src="https://cdn.treesir.pub/img/upyun.png" style="margin: -25px 2px" width="56"/></a>
    © 
    2019 - 
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>Leafy'John </span>
</span>
</div>
</footer>
<div class="back-to-top" id="back-to-top">
<i class="iconfont icon-up"></i>
</div>
</div>
<script crossorigin="anonymous" src="https://cdn.treesir.pub/blog-js/jquery.min.js"></script>
<script crossorigin="anonymous" src="https://cdn.treesir.pub/blog-js/slideout.min.js"></script>
<script crossorigin="anonymous" src="https://cdn.treesir.pub/blog-js/jquery.fancybox.min.js"></script>
<script src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js" type="text/javascript"></script>
<script src="/js/copy-to-clipboard.js"></script>
<script src="https://cdn.treesir.pub/blog-js/docsearch.min.js"></script>
<script>
    docsearch({
    apiKey: "17388eec628e676a77d6235068b458df",
    indexName: "blog",
    appId: "KEECS2XKBV",
    inputSelector: '.docsearch-input',
    debug: false,
    });
</script>
</body>
</html>
