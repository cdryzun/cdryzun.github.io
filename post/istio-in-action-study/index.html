<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"/>
<title>Istio in Action 学习笔记 - 「Leafy'John」PlayGround</title>
<meta content="webkit" name="renderer"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport"/>
<meta content="no-transform" http-equiv="Cache-Control"/>
<meta content="no-siteapp" http-equiv="Cache-Control"/>
<meta content="#f8f5ec" name="theme-color"/>
<meta content="#f8f5ec" name="msapplication-navbutton-color"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="#f8f5ec" name="apple-mobile-web-app-status-bar-style"/>
<meta content="Leafy'John" name="author"/><meta content="Istio in Action 学习笔记" name="description"/><meta content="Istio, Istio in Action" name="keywords"/>
<meta content="Hugo 0.92.0 with theme even" name="generator"/>
<link href="https://cdryzun.github.io/post/istio-in-action-study/" rel="canonical"/>
<link href="/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180"/>
<link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"/>
<link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"/>
<link href="/manifest.json" rel="manifest"/>
<link color="#5bbad5" href="/safari-pinned-tab.svg" rel="mask-icon"/>
<link href="/sass/main.min.404b35997075abed13fc31198c48ccfa115c0855fc6e525128eac767d84fdcd2.css" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://cdn.treesir.pub/blog-css/jquery.fancybox.min.css" rel="stylesheet"/>
<link href="/css/custom.css" rel="stylesheet"/>
<meta content="Istio in Action 学习笔记" property="og:title"/>
<meta content="Istio in Action 学习笔记" property="og:description"/>
<meta content="article" property="og:type"/>
<meta content="https://cdryzun.github.io/post/istio-in-action-study/" property="og:url"/><meta content="post" property="article:section"/>
<meta content="2023-10-05T16:13:32+08:00" property="article:published_time"/>
<meta content="2023-10-05T16:13:32+08:00" property="article:modified_time"/>
<meta content="Istio in Action 学习笔记" itemprop="name"/>
<meta content="Istio in Action 学习笔记" itemprop="description"/><meta content="2023-10-05T16:13:32+08:00" itemprop="datePublished"/>
<meta content="2023-10-05T16:13:32+08:00" itemprop="dateModified"/>
<meta content="43940" itemprop="wordCount"/>
<meta content="Istio,ServiceMesh," itemprop="keywords"/><meta content="summary" name="twitter:card"/>
<meta content="Istio in Action 学习笔记" name="twitter:title"/>
<meta content="Istio in Action 学习笔记" name="twitter:description"/>
<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->
<!--[if lt IE 9]>
  <script src="https://cdn.treesir.pub/blog-js/html5shiv.min.js"></script>
  <script src="https://cdn.treesir.pub/blog-js/respond.min.js"></script>
<![endif]-->
<link href="https://cdn.treesir.pub/blog-css/docsearch.min.css" rel="stylesheet"/>
</head>
<body>
<header class="header" id="header">
<div class="logo-wrapper">
<a class="logo" href="/">Leafy'John」PlayGround</a>
</div>
<nav class="site-navbar">
<ul class="menu" id="menu">
<li class="menu-item">
<a class="menu-item-link" href="/">主页</a>
</li><li class="menu-item">
<a class="menu-item-link" href="/post/">归档</a>
</li><li class="menu-item">
<a class="menu-item-link" href="/tags/">标签</a>
</li><li class="menu-item">
<a class="menu-item-link" href="/categories/">分类</a>
</li>
</ul><li style="display:inline-block;margin-right:10px;">
<input class="docsearch-input" placeholder="Search" type="search"/>
</li></nav>
</header>
<div class="mobile-navbar" id="mobile-navbar">
<div class="mobile-header-logo">
<a class="logo" href="/">Leafy'John」PlayGround</a>
</div>
<div class="mobile-navbar-icon">
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav class="mobile-menu slideout-menu" id="mobile-menu">
<ul class="mobile-menu-list">
<a href="/">
<li class="mobile-menu-item">主页</li>
</a><a href="/post/">
<li class="mobile-menu-item">归档</li>
</a><a href="/tags/">
<li class="mobile-menu-item">标签</li>
</a><a href="/categories/">
<li class="mobile-menu-item">分类</li>
</a>
</ul>
</nav>
<div class="container" id="mobile-panel">
<main class="main" id="main">
<div class="content-wrapper">
<div class="content" id="content">
<article class="post">
<header class="post-header">
<h1 class="post-title">Istio in Action 学习笔记</h1>
<div class="post-meta">
<span class="post-time"> 2023-10-05 </span>
<div class="post-category">
<a href="/categories/istio/"> Istio </a>
</div>
<span class="more-meta"> 约 43940 字 </span>
<span class="more-meta"> 预计阅读 88 分钟 </span>
</div>
</header>
<div class="post-toc" id="post-toc">
<h2 class="post-toc-title">文章目录</h2>
<div class="post-toc-content always-active">
<nav id="TableOfContents">
<ul>
<li><a href="#istio-解决的问题">Istio 解决的问题</a></li>
<li><a href="#技术介绍">技术介绍</a>
<ul>
<li>
<ul>
<li><a href="#服务网格的缺点是什么">服务网格的缺点是什么？</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#安装使用">安装使用</a>
<ul>
<li><a href="#使用-istioctl-部署">使用 <code>istioctl</code> 部署</a></li>
<li><a href="#istio-控制平面">Istio 控制平面</a>
<ul>
<li><a href="#istiod">istiod</a></li>
</ul>
</li>
<li><a href="#部署应用">部署应用</a></li>
<li><a href="#istioctl-使用记录">istioctl 使用记录</a></li>
<li><a href="#更新">更新</a></li>
</ul>
</li>
<li><a href="#envoy-proxy">Envoy proxy</a>
<ul>
<li><a href="#笔记">笔记</a></li>
<li><a href="#envoy-的核心功能">Envoy 的核心功能</a></li>
<li><a href="#envoy-功能体验">Envoy 功能体验</a></li>
<li><a href="#envoy-的管理-api">Envoy 的管理 API</a></li>
</ul>
</li>
<li><a href="#envoy-ingress">Envoy Ingress</a>
<ul>
<li><a href="#virtualservice">VirtualService</a></li>
<li><a href="#网关-tls">网关 TLS</a></li>
<li><a href="#http-重定向到-https">HTTP 重定向到 HTTPS</a></li>
<li><a href="#具有双向-tls-的-http-流量">具有双向 TLS 的 HTTP 流量</a></li>
<li><a href="#tls-为多个虚拟主机提供服务">TLS 为多个虚拟主机提供服务</a></li>
<li><a href="#tcp-流量">TCP 流量</a></li>
<li><a href="#sni-直通的流量路由">SNI 直通的流量路由</a></li>
<li><a href="#自定义网关">自定义网关</a></li>
<li><a href="#ingress网关访问日志">Ingress网关访问日志</a></li>
</ul>
</li>
<li><a href="#流量控制">流量控制</a>
<ul>
<li><a href="#蓝绿发布">蓝绿发布</a></li>
<li><a href="#金丝雀发布">金丝雀发布</a></li>
<li><a href="#金丝雀-配合-flagger-一起发布">金丝雀 配合 Flagger 一起发布</a></li>
<li><a href="#流量镜像">流量镜像</a></li>
<li><a href="#集群流量安全">集群流量安全</a></li>
</ul>
</li>
<li><a href="#恢复能力解决应用网络挑战">恢复能力：解决应用网络挑战</a>
<ul>
<li><a href="#弹性模式">弹性模式</a></li>
<li><a href="#客户端负载平衡">客户端负载平衡</a></li>
<li><a href="#fortio-负载测试库"><strong>Fortio</strong> 负载测试库</a></li>
<li><a href="#本地感知负载平衡">本地感知负载平衡</a>
<ul>
<li><a href="#实践">实践</a></li>
</ul>
</li>
<li><a href="#透明超时和重试">透明超时和重试</a>
<ul>
<li><a href="#超时计算的重试次数--原理">超时计算的重试次数 &amp; 原理</a></li>
<li><a href="#高级重试">高级重试</a></li>
<li><a href="#请求对冲">请求对冲</a></li>
</ul>
</li>
<li><a href="#使用-istio-熔断">使用 Istio 熔断</a>
<ul>
<li><a href="#无法正常工作的熔断方法">无法正常工作的熔断方法</a></li>
<li><a href="#通过异常值检测来防范不健康的服务">通过异常值检测来防范不健康的服务</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#可观察性">可观察性</a>
<ul>
<li><a href="#了解服务状态">了解服务状态</a></li>
<li><a href="#控制平面中的指标">控制平面中的指标</a></li>
<li><a href="#使用-prometheus-抓取-istio-指标">使用 Prometheus 抓取 Istio 指标</a></li>
<li><a href="#envoy-请求属性">Envoy 请求属性</a></li>
<li><a href="#配置现有指标">配置现有指标</a></li>
<li><a href="#创建新指标">创建新指标</a></li>
<li><a href="#使用新属性对请求进行分组">使用新属性对请求进行分组</a></li>
</ul>
</li>
<li><a href="#可视化">可视化</a>
<ul>
<li><a href="#设置-istio-的-grafana-仪表板">设置 Istio 的 Grafana 仪表板</a></li>
<li><a href="#分布式追踪">分布式追踪</a></li>
<li><a href="#查看分布式跟踪数据">查看分布式跟踪数据</a></li>
<li><a href="#自定义跟踪中的标签">自定义跟踪中的标签</a></li>
<li><a href="#定制后端分布式追踪引擎">定制后端分布式追踪引擎</a></li>
<li><a href="#使用-kiali-进行可视化">使用 Kiali 进行可视化</a>
<ul>
<li><a href="#安装-kiali">安装 Kiali</a></li>
</ul>
</li>
<li><a href="#跟踪指标和日志的关联">跟踪、指标和日志的关联</a></li>
</ul>
</li>
<li><a href="#关于保障微服务安全">关于保障微服务安全</a>
<ul>
<li><a href="#自动-mtls">自动 mTLS</a></li>
<li><a href="#环境搭建">环境搭建</a></li>
<li><a href="#peerauthentication-资源">PeerAuthentication 资源</a></li>
<li><a href="#允许非相互验证的流量">允许非相互验证的流量</a></li>
<li><a href="#两种额外的相互验证模式">两种额外的相互验证模式</a></li>
<li><a href="#tcpdump-流量窃听">TCPDUMP 流量窃听</a></li>
<li><a href="#授权服务到服务的流量">授权服务到服务的流量</a>
<ul>
<li><a href="#允许来自单个命名空间的请求">允许来自单个命名空间的请求</a></li>
<li><a href="#允许来自未经身份验证流量访问单个工作负载">允许来自未经身份验证流量，访问单个工作负载</a></li>
<li><a href="#允许来自单个-sa-账号的请求">允许来自单个 SA 账号的请求</a></li>
<li><a href="#策略的条件匹配">策略的条件匹配</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#数据平面故障排除">数据平面故障排除</a>
<ul>
<li><a href="#检查数据平面是否与最新配置同步">检查数据平面是否与最新配置同步</a></li>
<li><a href="#利用-kiali-发现错误配置">利用 Kiali 发现错误配置</a></li>
<li><a href="#从-envoy-配置中手动发现错误配置">从 Envoy 配置中手动发现错误配置</a>
<ul>
<li><a href="#使用-istioctl-查询-envoy-代理配置">使用 istioctl 查询 envoy 代理配置</a></li>
</ul>
</li>
<li><a href="#排除应用程序问题">排除应用程序问题</a></li>
<li><a href="#查看-envoyhttpswwwenvoyproxyio-访问日志">查看 </a><a href="https://www.envoyproxy.io/">Envoy</a> 访问日志</li>
<li><a href="#使用-envoy-telemetry-了解应用程序">使用 Envoy telemetry 了解应用程序</a></li>
</ul>
</li>
<li><a href="#控制平面的性能调整">控制平面的性能调整</a>
<ul>
<li><a href="#幽灵工作负载">幽灵工作负载</a></li>
<li><a href="#监控控制平面">监控控制平面</a>
<ul>
<li><a href="#饱和度">饱和度</a></li>
<li><a href="#故障">故障</a></li>
</ul>
</li>
<li><a href="#调整性能">调整性能</a>
<ul>
<li><a href="#提高控制平面性能的选项">提高控制平面性能的选项</a></li>
<li><a href="#全网格-sidecar-配置定义"><strong>全网格 Sidecar 配置定义</strong></a></li>
<li><a href="#sidecar-配置范围">Sidecar 配置范围</a></li>
<li><a href="#忽略事件">忽略事件</a></li>
<li><a href="#事件批处理和推送节流特性">事件批处理和推送节流特性</a></li>
</ul>
</li>
<li><a href="#性能调整指南">性能调整指南</a></li>
</ul>
</li>
<li><a href="#网格融合">网格融合</a>
<ul>
<li><a href="#多集群式部署">多集群式部署</a>
<ul>
<li><a href="#跨群集工作负载连接性">跨群集工作负载连接性</a></li>
<li><a href="#集群之间的共同信任">集群之间的共同信任</a></li>
</ul>
</li>
<li><a href="#多群集多网络多控制面服务网格概述">多群集、多网络、多控制面服务网格概述</a></li>
<li><a href="#集群准备">集群准备</a>
<ul>
<li><a href="#启用跨群集工作负载发现">启用跨群集工作负载发现</a></li>
</ul>
</li>
<li><a href="#使用-sni-自动直通功能路由跨集群流量">使用 SNI 自动直通功能路由跨集群流量</a></li>
<li><a href="#跨群集负载均衡">跨群集负载均衡</a></li>
</ul>
</li>
<li><a href="#虚拟机整合并至网格">虚拟机整合并至网格</a>
<ul>
<li><a href="#虚拟机中的旁路代理安装和配置">虚拟机中的旁路代理安装和配置</a>
<ul>
<li><a href="#解虚拟机身份-provisioning">解虚拟机身份 Provisioning</a></li>
<li><a href="#虚拟机高可用性">虚拟机高可用性</a></li>
<li><a href="#健康检查">健康检查</a></li>
<li><a href="#服务的-dns-解析">服务的 DNS 解析</a></li>
</ul>
</li>
<li><a href="#环境搭建-1">环境搭建</a>
<ul>
<li><a href="#配置虚拟机">配置虚拟机</a></li>
</ul>
</li>
<li><a href="#将网格扩展到虚拟机">将网格扩展到虚拟机</a>
<ul>
<li><a href="#向虚拟机提供等效和群集服务">向虚拟机提供等效和群集服务</a></li>
<li><a href="#使用-workloadgroup-表示一组工作负载">使用 WorkloadGroup 表示一组工作负载</a></li>
<li><a href="#将流量路由到群集服务">将流量路由到群集服务</a></li>
<li><a href="#将流量路由到工作负载">将流量路由到工作负载</a></li>
<li><a href="#虚拟机由控制平面配置强制执行相互验证">虚拟机由控制平面配置：强制执行相互验证</a></li>
</ul>
</li>
<li><a href="#解密-dns-代理">解密 DNS 代理</a>
<ul>
<li><a href="#dns-代理如何解析群集主机名">DNS 代理如何解析群集主机名</a></li>
<li><a href="#dns-代理知道哪些主机名">DNS 代理知道哪些主机名？</a></li>
</ul>
</li>
<li><a href="#自定义代理配置">自定义代理配置</a></li>
<li><a href="#从网格中删除工作负载条目">从网格中删除工作负载条目</a></li>
</ul>
</li>
<li><a href="#在请求路径上扩展-istio">在请求路径上扩展 Istio</a></li>
</ul>
</nav>
</div>
</div>
<div class="post-content">
<ul>
<li><a href="#istio-%E8%A7%A3%E5%86%B3%E7%9A%84%E9%97%AE%E9%A2%98">Istio 解决的问题</a></li>
<li><a href="#%E6%8A%80%E6%9C%AF%E4%BB%8B%E7%BB%8D">技术介绍</a></li>
<li><a href="#%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8">安装使用</a>
<ul>
<li><a href="#%E4%BD%BF%E7%94%A8-istioctl-%E9%83%A8%E7%BD%B2">使用 <code>istioctl</code> 部署</a></li>
<li><a href="#istio-%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2">Istio 控制平面</a>
<ul>
<li><a href="#istiod">istiod</a></li>
</ul>
</li>
<li><a href="#%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8">部署应用</a></li>
<li><a href="#istioctl-%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95">istioctl 使用记录</a></li>
<li><a href="#%E6%9B%B4%E6%96%B0">更新</a></li>
</ul>
</li>
<li><a href="#envoy-proxy">Envoy proxy</a>
<ul>
<li><a href="#%E7%AC%94%E8%AE%B0">笔记</a></li>
<li><a href="#envoy-%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD">Envoy 的核心功能</a></li>
<li><a href="#envoy-%E5%8A%9F%E8%83%BD%E4%BD%93%E9%AA%8C">Envoy 功能体验</a></li>
<li><a href="#envoy-%E7%9A%84%E7%AE%A1%E7%90%86-api">Envoy 的管理 API</a></li>
</ul>
</li>
<li><a href="#envoy-ingress">Envoy Ingress</a>
<ul>
<li><a href="#virtualservice">VirtualService</a></li>
<li><a href="#%E7%BD%91%E5%85%B3-tls">网关 TLS</a></li>
<li><a href="#http-%E9%87%8D%E5%AE%9A%E5%90%91%E5%88%B0-https">HTTP 重定向到 HTTPS</a></li>
<li><a href="#%E5%85%B7%E6%9C%89%E5%8F%8C%E5%90%91-tls-%E7%9A%84-http-%E6%B5%81%E9%87%8F">具有双向 TLS 的 HTTP 流量</a></li>
<li><a href="#tls-%E4%B8%BA%E5%A4%9A%E4%B8%AA%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E6%8F%90%E4%BE%9B%E6%9C%8D%E5%8A%A1">TLS 为多个虚拟主机提供服务</a></li>
<li><a href="#tcp-%E6%B5%81%E9%87%8F">TCP 流量</a></li>
<li><a href="#sni-%E7%9B%B4%E9%80%9A%E7%9A%84%E6%B5%81%E9%87%8F%E8%B7%AF%E7%94%B1">SNI 直通的流量路由</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E5%85%B3">自定义网关</a></li>
<li><a href="#ingress%E7%BD%91%E5%85%B3%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97">Ingress网关访问日志</a></li>
</ul>
</li>
<li><a href="#%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6">流量控制</a>
<ul>
<li><a href="#%E8%93%9D%E7%BB%BF%E5%8F%91%E5%B8%83">蓝绿发布</a></li>
<li><a href="#%E9%87%91%E4%B8%9D%E9%9B%80%E5%8F%91%E5%B8%83">金丝雀发布</a></li>
<li><a href="#%E9%87%91%E4%B8%9D%E9%9B%80-%E9%85%8D%E5%90%88-flagger-%E4%B8%80%E8%B5%B7%E5%8F%91%E5%B8%83">金丝雀 配合 Flagger 一起发布</a></li>
<li><a href="#%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F">流量镜像</a></li>
<li><a href="#%E9%9B%86%E7%BE%A4%E6%B5%81%E9%87%8F%E5%AE%89%E5%85%A8">集群流量安全</a></li>
</ul>
</li>
<li><a href="#%E6%81%A2%E5%A4%8D%E8%83%BD%E5%8A%9B%E8%A7%A3%E5%86%B3%E5%BA%94%E7%94%A8%E7%BD%91%E7%BB%9C%E6%8C%91%E6%88%98">恢复能力：解决应用网络挑战</a>
<ul>
<li><a href="#%E5%BC%B9%E6%80%A7%E6%A8%A1%E5%BC%8F">弹性模式</a></li>
<li><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B4%9F%E8%BD%BD%E5%B9%B3%E8%A1%A1">客户端负载平衡</a></li>
<li><a href="#fortio-%E8%B4%9F%E8%BD%BD%E6%B5%8B%E8%AF%95%E5%BA%93"><strong>Fortio</strong> 负载测试库</a></li>
<li><a href="#%E6%9C%AC%E5%9C%B0%E6%84%9F%E7%9F%A5%E8%B4%9F%E8%BD%BD%E5%B9%B3%E8%A1%A1">本地感知负载平衡</a>
<ul>
<li><a href="#%E5%AE%9E%E8%B7%B5">实践</a></li>
</ul>
</li>
<li><a href="#%E9%80%8F%E6%98%8E%E8%B6%85%E6%97%B6%E5%92%8C%E9%87%8D%E8%AF%95">透明超时和重试</a>
<ul>
<li><a href="#%E8%B6%85%E6%97%B6%E8%AE%A1%E7%AE%97%E7%9A%84%E9%87%8D%E8%AF%95%E6%AC%A1%E6%95%B0--%E5%8E%9F%E7%90%86">超时计算的重试次数 &amp; 原理</a></li>
<li><a href="#%E9%AB%98%E7%BA%A7%E9%87%8D%E8%AF%95">高级重试</a></li>
<li><a href="#%E8%AF%B7%E6%B1%82%E5%AF%B9%E5%86%B2">请求对冲</a></li>
</ul>
</li>
<li><a href="#%E4%BD%BF%E7%94%A8-istio-%E7%86%94%E6%96%AD">使用 Istio 熔断</a>
<ul>
<li><a href="#%E6%97%A0%E6%B3%95%E6%AD%A3%E5%B8%B8%E5%B7%A5%E4%BD%9C%E7%9A%84%E7%86%94%E6%96%AD%E6%96%B9%E6%B3%95">无法正常工作的熔断方法</a></li>
<li><a href="#%E9%80%9A%E8%BF%87%E5%BC%82%E5%B8%B8%E5%80%BC%E6%A3%80%E6%B5%8B%E6%9D%A5%E9%98%B2%E8%8C%83%E4%B8%8D%E5%81%A5%E5%BA%B7%E7%9A%84%E6%9C%8D%E5%8A%A1">通过异常值检测来防范不健康的服务</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E5%8F%AF%E8%A7%82%E5%AF%9F%E6%80%A7">可观察性</a>
<ul>
<li><a href="#%E4%BA%86%E8%A7%A3%E6%9C%8D%E5%8A%A1%E7%8A%B6%E6%80%81">了解服务状态</a></li>
<li><a href="#%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2%E4%B8%AD%E7%9A%84%E6%8C%87%E6%A0%87">控制平面中的指标</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8-prometheus-%E6%8A%93%E5%8F%96-istio-%E6%8C%87%E6%A0%87">使用 Prometheus 抓取 Istio 指标</a></li>
<li><a href="#envoy-%E8%AF%B7%E6%B1%82%E5%B1%9E%E6%80%A7">Envoy 请求属性</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE%E7%8E%B0%E6%9C%89%E6%8C%87%E6%A0%87">配置现有指标</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E6%96%B0%E6%8C%87%E6%A0%87">创建新指标</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8%E6%96%B0%E5%B1%9E%E6%80%A7%E5%AF%B9%E8%AF%B7%E6%B1%82%E8%BF%9B%E8%A1%8C%E5%88%86%E7%BB%84">使用新属性对请求进行分组</a></li>
</ul>
</li>
<li><a href="#%E5%8F%AF%E8%A7%86%E5%8C%96">可视化</a>
<ul>
<li><a href="#%E8%AE%BE%E7%BD%AE-istio-%E7%9A%84-grafana-%E4%BB%AA%E8%A1%A8%E6%9D%BF">设置 Istio 的 Grafana 仪表板</a></li>
<li><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E8%BF%BD%E8%B8%AA">分布式追踪</a></li>
<li><a href="#%E6%9F%A5%E7%9C%8B%E5%88%86%E5%B8%83%E5%BC%8F%E8%B7%9F%E8%B8%AA%E6%95%B0%E6%8D%AE">查看分布式跟踪数据</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B7%9F%E8%B8%AA%E4%B8%AD%E7%9A%84%E6%A0%87%E7%AD%BE">自定义跟踪中的标签</a></li>
<li><a href="#%E5%AE%9A%E5%88%B6%E5%90%8E%E7%AB%AF%E5%88%86%E5%B8%83%E5%BC%8F%E8%BF%BD%E8%B8%AA%E5%BC%95%E6%93%8E">定制后端分布式追踪引擎</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8-kiali-%E8%BF%9B%E8%A1%8C%E5%8F%AF%E8%A7%86%E5%8C%96">使用 Kiali 进行可视化</a>
<ul>
<li><a href="#%E5%AE%89%E8%A3%85-kiali">安装 Kiali</a></li>
</ul>
</li>
<li><a href="#%E8%B7%9F%E8%B8%AA%E6%8C%87%E6%A0%87%E5%92%8C%E6%97%A5%E5%BF%97%E7%9A%84%E5%85%B3%E8%81%94">跟踪、指标和日志的关联</a></li>
</ul>
</li>
<li><a href="#%E5%85%B3%E4%BA%8E%E4%BF%9D%E9%9A%9C%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%89%E5%85%A8">关于保障微服务安全</a>
<ul>
<li><a href="#%E8%87%AA%E5%8A%A8-mtls">自动 mTLS</a></li>
<li><a href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">环境搭建</a></li>
<li><a href="#peerauthentication-%E8%B5%84%E6%BA%90">PeerAuthentication 资源</a></li>
<li><a href="#%E5%85%81%E8%AE%B8%E9%9D%9E%E7%9B%B8%E4%BA%92%E9%AA%8C%E8%AF%81%E7%9A%84%E6%B5%81%E9%87%8F">允许非相互验证的流量</a></li>
<li><a href="#%E4%B8%A4%E7%A7%8D%E9%A2%9D%E5%A4%96%E7%9A%84%E7%9B%B8%E4%BA%92%E9%AA%8C%E8%AF%81%E6%A8%A1%E5%BC%8F">两种额外的相互验证模式</a></li>
<li><a href="#tcpdump-%E6%B5%81%E9%87%8F%E7%AA%83%E5%90%AC">TCPDUMP 流量窃听</a></li>
<li><a href="#%E6%8E%88%E6%9D%83%E6%9C%8D%E5%8A%A1%E5%88%B0%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%B5%81%E9%87%8F">授权服务到服务的流量</a>
<ul>
<li><a href="#%E5%85%81%E8%AE%B8%E6%9D%A5%E8%87%AA%E5%8D%95%E4%B8%AA%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E7%9A%84%E8%AF%B7%E6%B1%82">允许来自单个命名空间的请求</a></li>
<li><a href="#%E5%85%81%E8%AE%B8%E6%9D%A5%E8%87%AA%E6%9C%AA%E7%BB%8F%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E6%B5%81%E9%87%8F%E8%AE%BF%E9%97%AE%E5%8D%95%E4%B8%AA%E5%B7%A5%E4%BD%9C%E8%B4%9F%E8%BD%BD">允许来自未经身份验证流量，访问单个工作负载</a></li>
<li><a href="#%E5%85%81%E8%AE%B8%E6%9D%A5%E8%87%AA%E5%8D%95%E4%B8%AA-sa-%E8%B4%A6%E5%8F%B7%E7%9A%84%E8%AF%B7%E6%B1%82">允许来自单个 SA 账号的请求</a></li>
<li><a href="#%E7%AD%96%E7%95%A5%E7%9A%84%E6%9D%A1%E4%BB%B6%E5%8C%B9%E9%85%8D">策略的条件匹配</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E6%95%B0%E6%8D%AE%E5%B9%B3%E9%9D%A2%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4">数据平面故障排除</a>
<ul>
<li><a href="#%E6%A3%80%E6%9F%A5%E6%95%B0%E6%8D%AE%E5%B9%B3%E9%9D%A2%E6%98%AF%E5%90%A6%E4%B8%8E%E6%9C%80%E6%96%B0%E9%85%8D%E7%BD%AE%E5%90%8C%E6%AD%A5">检查数据平面是否与最新配置同步</a></li>
<li><a href="#%E5%88%A9%E7%94%A8-kiali-%E5%8F%91%E7%8E%B0%E9%94%99%E8%AF%AF%E9%85%8D%E7%BD%AE">利用 Kiali 发现错误配置</a></li>
<li><a href="#%E4%BB%8E-envoy-%E9%85%8D%E7%BD%AE%E4%B8%AD%E6%89%8B%E5%8A%A8%E5%8F%91%E7%8E%B0%E9%94%99%E8%AF%AF%E9%85%8D%E7%BD%AE">从 Envoy 配置中手动发现错误配置</a>
<ul>
<li><a href="#%E4%BD%BF%E7%94%A8-istioctl-%E6%9F%A5%E8%AF%A2-envoy-%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE">使用 istioctl 查询 envoy 代理配置</a></li>
</ul>
</li>
<li><a href="#%E6%8E%92%E9%99%A4%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E9%97%AE%E9%A2%98">排除应用程序问题</a></li>
<li><a href="#%E6%9F%A5%E7%9C%8B-envoy-%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97">查看 Envoy 访问日志</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8-envoy-telemetry-%E4%BA%86%E8%A7%A3%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F">使用 Envoy telemetry 了解应用程序</a></li>
</ul>
</li>
<li><a href="#%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2%E7%9A%84%E6%80%A7%E8%83%BD%E8%B0%83%E6%95%B4">控制平面的性能调整</a>
<ul>
<li><a href="#%E5%B9%BD%E7%81%B5%E5%B7%A5%E4%BD%9C%E8%B4%9F%E8%BD%BD">幽灵工作负载</a></li>
<li><a href="#%E7%9B%91%E6%8E%A7%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2">监控控制平面</a>
<ul>
<li><a href="#%E9%A5%B1%E5%92%8C%E5%BA%A6">饱和度</a></li>
<li><a href="#%E6%95%85%E9%9A%9C">故障</a></li>
</ul>
</li>
<li><a href="#%E8%B0%83%E6%95%B4%E6%80%A7%E8%83%BD">调整性能</a>
<ul>
<li><a href="#%E6%8F%90%E9%AB%98%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2%E6%80%A7%E8%83%BD%E7%9A%84%E9%80%89%E9%A1%B9">提高控制平面性能的选项</a></li>
<li><a href="#%E5%85%A8%E7%BD%91%E6%A0%BC-sidecar-%E9%85%8D%E7%BD%AE%E5%AE%9A%E4%B9%89"><strong>全网格 Sidecar 配置定义</strong></a></li>
<li><a href="#sidecar-%E9%85%8D%E7%BD%AE%E8%8C%83%E5%9B%B4">Sidecar 配置范围</a></li>
<li><a href="#%E5%BF%BD%E7%95%A5%E4%BA%8B%E4%BB%B6">忽略事件</a></li>
<li><a href="#%E4%BA%8B%E4%BB%B6%E6%89%B9%E5%A4%84%E7%90%86%E5%92%8C%E6%8E%A8%E9%80%81%E8%8A%82%E6%B5%81%E7%89%B9%E6%80%A7">事件批处理和推送节流特性</a></li>
</ul>
</li>
<li><a href="#%E6%80%A7%E8%83%BD%E8%B0%83%E6%95%B4%E6%8C%87%E5%8D%97">性能调整指南</a></li>
</ul>
</li>
<li><a href="#%E7%BD%91%E6%A0%BC%E8%9E%8D%E5%90%88">网格融合</a>
<ul>
<li><a href="#%E5%A4%9A%E9%9B%86%E7%BE%A4%E5%BC%8F%E9%83%A8%E7%BD%B2">多集群式部署</a>
<ul>
<li><a href="#%E8%B7%A8%E7%BE%A4%E9%9B%86%E5%B7%A5%E4%BD%9C%E8%B4%9F%E8%BD%BD%E8%BF%9E%E6%8E%A5%E6%80%A7">跨群集工作负载连接性</a></li>
<li><a href="#%E9%9B%86%E7%BE%A4%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B1%E5%90%8C%E4%BF%A1%E4%BB%BB">集群之间的共同信任</a></li>
</ul>
</li>
<li><a href="#%E5%A4%9A%E7%BE%A4%E9%9B%86%E5%A4%9A%E7%BD%91%E7%BB%9C%E5%A4%9A%E6%8E%A7%E5%88%B6%E9%9D%A2%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC%E6%A6%82%E8%BF%B0">多群集、多网络、多控制面服务网格概述</a></li>
<li><a href="#%E9%9B%86%E7%BE%A4%E5%87%86%E5%A4%87">集群准备</a>
<ul>
<li><a href="#%E5%90%AF%E7%94%A8%E8%B7%A8%E7%BE%A4%E9%9B%86%E5%B7%A5%E4%BD%9C%E8%B4%9F%E8%BD%BD%E5%8F%91%E7%8E%B0">启用跨群集工作负载发现</a></li>
</ul>
</li>
<li><a href="#%E4%BD%BF%E7%94%A8-sni-%E8%87%AA%E5%8A%A8%E7%9B%B4%E9%80%9A%E5%8A%9F%E8%83%BD%E8%B7%AF%E7%94%B1%E8%B7%A8%E9%9B%86%E7%BE%A4%E6%B5%81%E9%87%8F">使用 SNI 自动直通功能路由跨集群流量</a></li>
<li><a href="#%E8%B7%A8%E7%BE%A4%E9%9B%86%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">跨群集负载均衡</a></li>
</ul>
</li>
<li><a href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%95%B4%E5%90%88%E5%B9%B6%E8%87%B3%E7%BD%91%E6%A0%BC">虚拟机整合并至网格</a>
<ul>
<li><a href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD%E7%9A%84%E6%97%81%E8%B7%AF%E4%BB%A3%E7%90%86%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE">虚拟机中的旁路代理安装和配置</a>
<ul>
<li><a href="#%E8%A7%A3%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BA%AB%E4%BB%BD-provisioning">解虚拟机身份 Provisioning</a></li>
<li><a href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7">虚拟机高可用性</a></li>
<li><a href="#%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5">健康检查</a></li>
<li><a href="#%E6%9C%8D%E5%8A%A1%E7%9A%84-dns-%E8%A7%A3%E6%9E%90">服务的 DNS 解析</a></li>
</ul>
</li>
<li><a href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-1">环境搭建</a>
<ul>
<li><a href="#%E9%85%8D%E7%BD%AE%E8%99%9A%E6%8B%9F%E6%9C%BA">配置虚拟机</a></li>
</ul>
</li>
<li><a href="#%E5%B0%86%E7%BD%91%E6%A0%BC%E6%89%A9%E5%B1%95%E5%88%B0%E8%99%9A%E6%8B%9F%E6%9C%BA">将网格扩展到虚拟机</a>
<ul>
<li><a href="#%E5%90%91%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%8F%90%E4%BE%9B%E7%AD%89%E6%95%88%E5%92%8C%E7%BE%A4%E9%9B%86%E6%9C%8D%E5%8A%A1">向虚拟机提供等效和群集服务</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8-workloadgroup-%E8%A1%A8%E7%A4%BA%E4%B8%80%E7%BB%84%E5%B7%A5%E4%BD%9C%E8%B4%9F%E8%BD%BD">使用 WorkloadGroup 表示一组工作负载</a></li>
<li><a href="#%E5%B0%86%E6%B5%81%E9%87%8F%E8%B7%AF%E7%94%B1%E5%88%B0%E7%BE%A4%E9%9B%86%E6%9C%8D%E5%8A%A1">将流量路由到群集服务</a></li>
<li><a href="#%E5%B0%86%E6%B5%81%E9%87%8F%E8%B7%AF%E7%94%B1%E5%88%B0%E5%B7%A5%E4%BD%9C%E8%B4%9F%E8%BD%BD">将流量路由到工作负载</a></li>
<li><a href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%94%B1%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2%E9%85%8D%E7%BD%AE%E5%BC%BA%E5%88%B6%E6%89%A7%E8%A1%8C%E7%9B%B8%E4%BA%92%E9%AA%8C%E8%AF%81">虚拟机由控制平面配置：强制执行相互验证</a></li>
</ul>
</li>
<li><a href="#%E8%A7%A3%E5%AF%86-dns-%E4%BB%A3%E7%90%86">解密 DNS 代理</a>
<ul>
<li><a href="#dns-%E4%BB%A3%E7%90%86%E5%A6%82%E4%BD%95%E8%A7%A3%E6%9E%90%E7%BE%A4%E9%9B%86%E4%B8%BB%E6%9C%BA%E5%90%8D">DNS 代理如何解析群集主机名</a></li>
<li><a href="#dns-%E4%BB%A3%E7%90%86%E7%9F%A5%E9%81%93%E5%93%AA%E4%BA%9B%E4%B8%BB%E6%9C%BA%E5%90%8D">DNS 代理知道哪些主机名？</a></li>
</ul>
</li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE">自定义代理配置</a></li>
<li><a href="#%E4%BB%8E%E7%BD%91%E6%A0%BC%E4%B8%AD%E5%88%A0%E9%99%A4%E5%B7%A5%E4%BD%9C%E8%B4%9F%E8%BD%BD%E6%9D%A1%E7%9B%AE">从网格中删除工作负载条目</a></li>
</ul>
</li>
<li><a href="#%E5%9C%A8%E8%AF%B7%E6%B1%82%E8%B7%AF%E5%BE%84%E4%B8%8A%E6%89%A9%E5%B1%95-istio">在请求路径上扩展 Istio</a></li>
</ul>
<hr/>
<h1 id="istio-解决的问题">Istio 解决的问题</h1>
<blockquote>
<p>基本的应用程序网络问题并非特定于任何特定的应用程序、语言或框架。重试、超时、客户端负载平衡、熔断等也不是区分应用程序功能。它们是作为服务的一部分的关键问题，但是将大量时间和资源投入到您打算使用的每种语言的特定语言实现中（包括上一节中的其他缺点）是浪费时间。我们真正想要的是一种与技术无关的方式来实现这些问题，并使应用程序不必自己这样做。</p>
</blockquote>
<h1 id="技术介绍">技术介绍</h1>
<ul>
<li>
<p>Envoy：（http://envoyproxy.io） 是一种服务代理，在开源社区中作为多功能、高性能和功能强大的应用层代理出现。Envoy 是在 Lyft 开发的，是该公司 SOA 基础架构的一部分，能够实现网络问题，如重试、超时、熔断、客户端负载平衡、服务发现、安全性和指标收集，而无需任何明确的语言或框架依赖关系。</p>
<ul>
<li>Envoy 还捕获了许多应用程序网络指标，例如每秒请求数、故障数、熔断事件等。</li>
</ul>
</li>
<li>
<p>服务网格: 负责通过实现重试、超时和熔断器等功能，使服务通信能够灵活应对故障。</p>
<ul>
<li>
<p>Istio 的控制平面 （ <code>istiod</code> ） 用于配置 Istio 代理，用于处理路由、安全性、遥测收集和弹性。</p>
</li>
<li>
<p>请求指标会定期发送回各种收集服务。分布式跟踪跨度（如 Jaeger 或 Zipkin）被发送回跟踪存储，稍后可用于跟踪请求通过系统的路径和延迟。</p>
</li>
<li>
<p>Istio 可以管理密钥和证书的颁发、安装和轮换，以便服务开箱即用地获得双向 TLS。</p>
</li>
<li>
<p>Istio 为两大类可观察性创建了遥测。第一类是顶线指标，如每秒请求数、故障数和尾部延迟百分位数。</p>
</li>
<li>
<p>其次，Istio 可以为 OpenTracing.io 这样的分布式跟踪提供便利。Istio 可以将跨度发送到分布式跟踪后端，而无需应用程序操心。</p>
</li>
<li>
<h3 id="服务网格的缺点是什么">服务网格的缺点是什么？</h3>
<ul>
<li>使用服务网格将另一个中间件（特别是代理）放入请求路径中。这个代理可以提供很多价值;但对于那些不熟悉代理的人来说，它最终可能成为一个黑匣子，使调试应用程序的行为变得更加困难。</li>
<li>使用服务网格的另一个缺点是租赁。网格与网格中运行的服务一样有价值。也就是说，网格中的服务越多，网格对于操作这些服务就越有价值。但是，如果没有适当的策略、自动化和深思熟虑进入物理网格部署的租户和隔离模型，您最终可能会遇到错误配置网格会影响许多服务的情况。</li>
<li>最后，服务网格成为服务和应用程序体系结构中至关重要的部分，因为它位于请求路径上。服务网格可以公开许多机会来提高安全性、可观测性和路由控制状态。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Istio会使用Kubernetes的服务注册中心来发现服务。</p>
</li>
<li>
<p>Istio 定义了以下默认提供程序： <code>prometheus</code> 、 <code>stackdriver</code> 和 <code>envoy</code> 。您可以使用网格配置中的 <code>ExtensionProvider</code> API 定义自定义提供程序 (<a href="http://mng.bz/REKP">http://mng.bz/REKP</a>)。</p>
</li>
<li>
<p>性能优化</p>
</li>
<li>
<p>PILOT_FILTER_GATEWAY_CLUSTER_CONFIG</p>
</li>
</ul>
<hr/>
<h1 id="安装使用">安装使用</h1>
<h2 id="使用-istioctl-部署">使用 <code>istioctl</code> 部署</h2>
<ul>
<li><a href="https://github.com/istio/istio/releases">https://github.com/istio/istio/releases</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">
curl -L https://istio.io/downloadIstio <span class="p">|</span> <span class="nv">ISTIO_VERSION</span><span class="o">=</span>1.17.6 sh -

<span class="c1"># 检查当前集群安装是否存在问题</span>
istioctl x precheck

<span class="c1"># 安装 DEMO 版本</span>
istioctl install --set <span class="nv">profile</span><span class="o">=</span>demo -y

<span class="c1"># 查看 POD 是否就绪</span>
kubectl get pod -n istio-system

<span class="c1"># 验证安装</span>
istioctl verify-install
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>安装控制平面支持组件。</p>
<blockquote>
<p>这些组件不是严格必需的，但应该为任何实际部署 Istio 安装。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl apply -f ./samples/addons
</code></pre></td></tr></table>
</div>
</div><ul>
<li>可视化由代理生成并由 Prometheus 收集的指标</li>
<li>分布式跟踪系统，可视化通过网格的请求流</li>
<li>网格的 Web 控制台</li>
<li>收集生成的指标并将其存储为时间序列数据</li>
</ul>
</li>
</ul>
<hr/>
<h2 id="istio-控制平面">Istio 控制平面</h2>
<ul>
<li>控制平面为服务网格的用户提供了一种控制、观察、管理和配置网格的方法。对于 Istio，控制平面提供了以下功能：
<ul>
<li>供操作员指定所需路由/弹性行为的 API</li>
<li>数据平面使用其配置的 API</li>
<li>数据平面的服务发现抽象</li>
<li>用于指定使用策略的 API</li>
<li>证书颁发和轮换</li>
<li>工作负载标识分配</li>
<li>统一遥测收集</li>
<li>服务代理挎斗注入</li>
<li>网络边界的规范以及如何访问它们</li>
</ul>
</li>
</ul>
<p>​	这些职责中的大部分是在称为 的单个控制平面组件中实现的 <code>istiod</code> 。</p>
<p><img alt="Pasted image 20230925183219" src="https://cdn.treesir.pub/images/2023/09/25/20230925183257.png"/></p>
<h3 id="istiod">istiod</h3>
<blockquote>
<p>Istio 的控制平面职责在 <code>istiod</code> 组件中实现。 <code>istiod</code> 有时也称为 Istio Pilot，负责接收用户/操作员指定的更高级别的 Istio 配置，并将其转化为每个数据平面服务代理的特定代理配置</p>
</blockquote>
<p><img alt="Pasted image 20230925183346" src="https://cdn.treesir.pub/images/2023/09/25/20230925184427.png"/></p>
<ul>
<li><code>istiod</code> 获取这些配置并对其进行解释，然后将其作为特定于服务的配置公开。Istio 将 Envoy 用作其服务代理，因此这些配置 <code>会被转换为 Envoy 配置</code></li>
<li><code>istiod</code> 公开的数据平面 API 实现了 Envoy 的 <code>发现 API</code>
<ul>
<li>这些发现 API（如用于服务发现（监听器发现服务 [LDS]）、端点（端点发现服务 [EDS]）和路由规则（路由发现服务 [RDS]）的 API）被称为 xDS API。</li>
<li>这些 API 允许数据平面分离其配置方式，并动态调整其行为，而无需停止和重新加载。</li>
<li>服务代理与每个应用程序实例并行运行，<code>所有应用程序流量都通过这些代理传输</code></li>
<li><img alt="Pasted image 20230925224259" src="https://cdn.treesir.pub/images/2023/09/25/20230925224304.png"/></li>
</ul>
</li>
<li> <code>istio-ingressgateway</code> 和 <code>istio-egressgateway</code> 。以允许流量进入集群，并明确允许哪些流量离开集群。
<ul>
<li><img alt="Pasted image 20230925224530" src="https://cdn.treesir.pub/images/2023/09/25/20230925224533.png"/></li>
</ul>
</li>
</ul>
<h2 id="部署应用">部署应用</h2>
<ul>
<li>
<p>YAML</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">$  kubectl create namespace istioinaction
$  kubectl config set-context <span class="k">$(</span>kubectl config current-context<span class="k">)</span> <span class="se">\
</span><span class="se"></span> --namespace<span class="o">=</span>istioinaction
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">catalog</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">catalog</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">catalog</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">catalog</span><span class="w">
</span><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">catalog</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">catalog</span><span class="w">
</span><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">catalog</span><span class="w">
</span><span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">KUBERNETES_NAMESPACE</span><span class="w">
</span><span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">metadata.namespace</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">istioinaction/catalog:latest</span><span class="w">
</span><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">catalog</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w">        </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>对该 APP 进行 Istio 注入</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">istioctl kube-inject -f catalog.yaml<span class="p">|</span>kubectl apply -f - 
</code></pre></td></tr></table>
</div>
</div><p>命名空间的自动注入，添加如下 Lable 即可</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl label namespace istioinaction istio-injection<span class="o">=</span>enabled
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>验证是否就绪</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"> kubectl run -i -n default --rm --restart<span class="o">=</span>Never dummy <span class="se">\
</span><span class="se"></span>--image<span class="o">=</span>curlimages/curl --command -- <span class="se">\
</span><span class="se"></span>sh -c <span class="s1">'curl -s http://catalog.istioinaction/items/1'</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<hr/>
<h2 id="istioctl-使用记录">istioctl 使用记录</h2>
<p>参考文档: <a href="https://istio.io/latest/docs/reference/commands/istioctl/">https://istio.io/latest/docs/reference/commands/istioctl/</a></p>
<ul>
<li>
<p>查看当前配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">istioctl profile dump 
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>命令补全</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">istioctl completion zsh &gt; <span class="k">$(</span>brew --prefix<span class="k">)</span>/share/zsh/site-functions/_istioctl
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>检查路由</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">istioctl proxy-config routes <span class="se">\
</span><span class="se"></span>deploy/istio-ingressgateway.istio-system
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>查看 Gateway 路由配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">istioctl proxy-config route deploy/istio-ingressgateway <span class="se">\
</span><span class="se"></span>-o json --name http.8080  -n istio-system
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>查看 Gateway 所监听的地址</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">istioctl -n istio-system proxy-config <span class="se">\
</span><span class="se"></span>listener deploy/istio-ingressgateway
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>检查通过 SDS 交付的证书的状态</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">istioctl pc secret -n istio-system deploy/istio-ingressgateway
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>如果您没有看到新的证书配置生效，可以重建 <code>istio-ingressgateway</code> 解决</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl delete po -n istio-system -l <span class="nv">app</span><span class="o">=</span>istio-ingressgateway
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
<li>
<p>更新配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">istioctl profile dump &gt; config.yaml

istioctl upgrade -f ./config.yaml
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="更新">更新</h2>
<ul>
<li><a href="https://istio.io/latest/docs/setup/upgrade/">https://istio.io/latest/docs/setup/upgrade/</a></li>
<li><a href="https://istio.io/latest/docs/setup/upgrade/in-place/">https://istio.io/latest/docs/setup/upgrade/in-place/</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 更新 istioctl</span>

curl -L https://istio.io/downloadIstio <span class="p">|</span> <span class="nv">ISTIO_VERSION</span><span class="o">=</span>1.19.0 sh -

istioctl version

istioctl x precheck 

istioctl upgrade
</code></pre></td></tr></table>
</div>
</div><hr/>
<h1 id="envoy-proxy">Envoy proxy</h1>
<h2 id="笔记">笔记</h2>
<ul>
<li>
<p>Envoy 由 Lyft 开发，旨在解决构建分布式系统时出现的一些应用网络难题。Envoy 采用 <code>C++  </code>编写，旨在提高性能，更重要的是，使其在更高负载梯队中更加稳定和确定。</p>
</li>
<li>
<p>开箱即用的Envoy能理解HTTP 1.1、HTTP 2、gRPC和其他协议，并能添加请求级超时、重试、每次重试超时、熔断和其他弹性功能等行为。<code>而只能理解连接的基本连接级（L3/L4）代理无法实现这样的功能。</code></p>
</li>
<li>
<p>Envoy 的设计目的是通过在应用程序进程外运行，<code>使开发人员免受网络问题的困扰。</code></p>
</li>
<li>
<p>Istio 的控制平面开箱即实现了 Envoy 服务发现 API。</p>
</li>
<li>
<p>Envoy 为以下策略提供了开箱即用的 <code>负载均衡算法</code></p>
<ul>
<li>Random: 随机</li>
<li>Round robin: 轮训</li>
<li>Weighted, least request: 加权，最少请求</li>
<li>Consistent hashing (sticky): hash 粘性</li>
</ul>
</li>
<li>
<p>Envoy 支持基于百分比（即加权）的流量分割/转移。Envoy 还能复制流量，并以 “触发即遗忘 “的模式将该流量阴影化到 Envoy 集群中。</p>
</li>
<li>
<p>Envoy 可以向 OpenTracing ( <a href="http://opentracing.io">http://opentracing.io</a>) 引擎报告跟踪跨度，以便在调用图中直观显示流量、跳数和延迟。</p>
</li>
<li>
<p>Envoy 还支持 Lua (<a href="http://www.lua.org">www.lua.org</a>) 脚本和 WebAssembly (Wasm)，从而以较低的侵入式方法扩展 Envoy 功能。</p>
</li>
<li>
<p>Envoy 主要特性</p>
<ul>
<li><strong>服务发现</strong></li>
<li>负载均衡</li>
<li><strong>流量和请求路由</strong></li>
<li>流量转移和镜像功能</li>
<li><strong>网络复原力</strong>，重试</li>
<li><strong>HTTP/2 和 GRPC</strong> 支持</li>
<li>可观察性与指标收集</li>
<li>分布式跟踪的可观察性</li>
<li><strong>自动 TLS 生命周期管理</strong></li>
<li><strong>流量费率限制</strong></li>
<li>支持自定义扩展</li>
</ul>
</li>
<li>
<p>Envoy 优势</p>
<ul>
<li>支持 HTTP/2（上游和下游）</li>
<li>WebAssembly 的可扩展性</li>
<li>为维护和扩展而构建的模块化代码库</li>
<li>深度协议指标收集</li>
<li>C++ / 无垃圾收集</li>
<li>动态配置，无需热重启</li>
</ul>
</li>
<li>
<p>Envoy 由 JSON 或 YAML 格式的配置文件驱动。最初的版本（v1 和 v2）已被弃用，取而代之的是 v3。</p>
</li>
<li>
<p>Envoy 使用以下 API 进行动态配置： （ 这些 API 统称为<code>xDS</code>服务。一个配置可以使用其中的一个或某些组合，不必全部使用。）</p>
<ul>
<li>监听器发现服务 (LDS)–一种允许 Envoy 查询应在此代理上公开哪些监听器的 API。</li>
<li>群集发现服务 (CDS)–一种 API，可让 Envoy 发现该代理应拥有哪些群集以及每个群集各自的配置。</li>
<li>端点发现服务 (EDS)–群集配置的一部分，用于指定特定群集使用哪些端点。这是 CDS 的子集。</li>
<li>秘密发现服务 (SDS)–用于分发证书的 API。</li>
<li>聚合发现服务 (ADS)–对其他 API 的所有更改进行序列化的数据流。您可以使用此单一 API 按顺序获取所有更改。</li>
</ul>
</li>
</ul>
<h2 id="envoy-的核心功能">Envoy 的核心功能</h2>
<blockquote>
<p>Envoy 对 L7 流量的概念性理解。</p>
</blockquote>
<ul>
<li><em>Listeners</em> : 向外界开放一个端口，应用程序可以连接到该端口。例如，80 端口上的监听器接受流量，并对流量应用任何配置行为</li>
<li><em>Routes</em>: 路由规则，用于处理通过侦听器进入的流量。例如，如果收到的请求与 <code>/catalog</code> 匹配，则将该流量导向 <code>catalog</code> 集群。，则将该流量导向 <code>catalog</code> 集群。</li>
<li><em>Clusters</em>: Envoy 可将流量路由至的特定上游服务。例如， <code>catalog-v1</code> 和 <code>catalog-v2</code> 可以是独立的群集，路由可以指定有关如何将流量导向 <code>catalog</code> 服务的 v1 或 v2 的规则。</li>
</ul>
<h2 id="envoy-功能体验">Envoy 功能体验</h2>
<ul>
<li>
<p>拉取镜像</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">docker pull envoyproxy/envoy:v1.19.0
docker pull curlimages/curl
docker pull citizenstig/httpbin
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>启动第一个容器</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="nv">$docker</span> run -d --name httpbin citizenstig/httpbin

<span class="nv">$docker</span> run -it --rm --link httpbin curlimages/curl <span class="se">\
</span><span class="se"></span>curl -X GET http://httpbin:8000/headers

<span class="o">{</span>
  <span class="s2">"headers"</span>: <span class="o">{</span>
    <span class="s2">"Accept"</span>: <span class="s2">"*/*"</span>,
    <span class="s2">"Host"</span>: <span class="s2">"httpbin:8000"</span>,
    <span class="s2">"User-Agent"</span>: <span class="s2">"curl/8.3.0"</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>创建 Envoy 配置文件</p>
<blockquote>
<p>在 15001 端口暴露了一个监听器，并将所有流量路由到我们的 <code>httpbin</code> 集群。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">
admin:
  address:
    socket_address: <span class="o">{</span> address: 0.0.0.0, port_value: <span class="m">15000</span> <span class="o">}</span>

static_resources:
  listeners:
  - name: httpbin-demo
    address:
      socket_address: <span class="o">{</span> address: 0.0.0.0, port_value: <span class="m">15001</span> <span class="o">}</span>
    filter_chains:
    - filters:
      - name:  envoy.filters.network.http_connection_manager
        typed_config:
          <span class="s2">"@type"</span>: type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          http_filters:
          - name: envoy.filters.http.router
          route_config:
            name: httpbin_local_route
            virtual_hosts:
            - name: httpbin_local_service
              domains: <span class="o">[</span><span class="s2">"*"</span><span class="o">]</span>
              routes:
              - match: <span class="o">{</span> prefix: <span class="s2">"/"</span> <span class="o">}</span>
                route:
                  auto_host_rewrite: <span class="nb">true</span>
                  cluster: httpbin_service
  clusters:
    - name: httpbin_service
      connect_timeout: 5s
      type: LOGICAL_DNS
      dns_lookup_family: V4_ONLY
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: httpbin
        endpoints:
        - lb_endpoints:
          - endpoint:
              address:
                socket_address:
                  address: httpbin
                  port_value: <span class="m">8000</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>启动容器</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">docker run --name proxy --link httpbin envoyproxy/envoy:v1.19.0 <span class="se">\
</span><span class="se"></span>  --config-yaml <span class="s2">"</span><span class="k">$(</span>cat ch3/simple.yaml<span class="k">)</span><span class="s2">"</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>测试一下代理服务器</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">&gt; docker run -it --rm --link proxy curlimages/curl <span class="se">\
</span><span class="se"></span>   curl  -X GET http://proxy:15001/headers
<span class="o">{</span>
  <span class="s2">"headers"</span>: <span class="o">{</span>
    <span class="s2">"Accept"</span>: <span class="s2">"*/*"</span>, 
    <span class="s2">"Host"</span>: <span class="s2">"httpbin"</span>, 
    <span class="s2">"User-Agent"</span>: <span class="s2">"curl/8.3.0"</span>, 
    <span class="s2">"X-Envoy-Expected-Rq-Timeout-Ms"</span>: <span class="s2">"15000"</span>, 
    <span class="s2">"X-Request-Id"</span>: <span class="s2">"a6f3efa5-1f10-4a1f-a18d-fed6006d70ce"</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="c1"># 流量被正确发送到了 httpbin 服务。还新增了一些标头</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="envoy-的管理-api">Envoy 的管理 API</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">docker run -it --rm --link proxy curlimages/curl <span class="se">\
</span><span class="se"></span>curl -X GET http://proxy:15000/stats

docker run -it --rm --link proxy curlimages/curl <span class="se">\
</span><span class="se"></span>curl -X GET http://proxy:15000/stats <span class="p">|</span> grep retry <span class="c1"># 只显示包含 retry 的统计数据</span>
</code></pre></td></tr></table>
</div>
</div><hr/>
<h1 id="envoy-ingress">Envoy Ingress</h1>
<ul>
<li>
<p>例如，如果您有 Kafka 或 NATS.io 工作负载，您可能希望公开与这些消息系统的直接 TCP 连接。 Kubernetes Ingress 不允许这样做。</p>
</li>
<li>
<p>Kubernetes Ingress v1 资源的指定严重不足。没有通用的方法来指定复杂的流量路由规则、流量分割或流量阴影等内容</p>
</li>
<li>
<p>Istio 决定从头开始构建入口模式，并专门将第 4 层（传输）和第 5 层（会话）属性与第 7 层（应用程序）<code>路由问题分开</code>。</p>
<ul>
<li>Istio <code>Gateway</code> 处理 L4 和 L5 问题，而 <code>VirtualService</code> 处理 L7 问题。</li>
</ul>
</li>
<li>
<p>Istio 的实现和资源出现在 Gateway API 之前，<code>并在很多方面启发了 Gateway API</code>。</p>
</li>
<li>
<p>API 网关:  Istio 的入口网关并没有<code>开箱即用</code>地执行这些操作。https://docs.solo.io/gloo-edge/latest</p>
</li>
<li>
<p>Istio 的网关实现允许我们<code>终止传入</code>的 TLS/SSL 流量，将其传递到后端服务，将任何非 TLS 流量重定向到正确的 TLS 端口，<code>并实现相互 TLS</code>。</p>
</li>
<li>
<p>TLS 握手包括一个更复杂的协议，<code>该协议结合了用于初始通信的公钥/私钥（非对称）</code>，然后创建一个 <code>会话密钥（对称</code>），用于 TLS 会话进行加密和加密。解密流量。</p>
</li>
</ul>
<h2 id="virtualservice">VirtualService</h2>
<blockquote>
<p>具有虚拟服务的网关路由</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: catalog-vs-from-gw
spec:
  hosts:
  - <span class="s2">"catalog.istioinaction.io"</span>
  gateways:
  - coolstore-gateway
  http:
  - route:
    - destination:
        host: catalog
        port:
          number: <span class="m">80</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="网关-tls">网关 TLS</h2>
<blockquote>
<p>集成cert-manager 之类的工具可以管理密钥 。</p>
<ul>
<li><a href="https://cert-manager.io/docs">https://cert-manager.io/docs</a></li>
</ul>
</blockquote>
<ul>
<li>创建 webapp-credential 配置密钥</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl create -n istio-system secret tls webapp-credential <span class="se">\
</span><span class="se"></span>--key ch4/certs/3_application/private/webapp.istioinaction.io.key.pem <span class="se">\
</span><span class="se"></span>--cert ch4/certs/3_application/certs/webapp.istioinaction.io.cert.pem
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>配置 Gateway 使用密钥</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: coolstore-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: <span class="m">80</span>
      name: http
      protocol: HTTP
    hosts:
    - <span class="s2">"webapp.istioinaction.io"</span>
  - port:
      number: <span class="m">443</span>
      name: https
      protocol: HTTPS
    tls:
      mode: SIMPLE
      credentialName: webapp-credential
    hosts:
    - <span class="s2">"webapp.istioinaction.io"</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>验证</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">
<span class="c1"># 访问 网关的 443 NodePort 端口</span>
curl -v -H <span class="s2">"Host: webapp.istioinaction.io"</span> https://192.168.8.170:32316/api/catalog

curl -H <span class="s2">"Host: webapp.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>https://webapp.istioinaction.io:32316/api/catalog <span class="se">\
</span><span class="se"></span>--cacert ch4/certs/2_intermediate/certs/ca-chain.cert.pem <span class="se">\
</span><span class="se"></span>--resolve webapp.istioinaction.io:32316:192.168.8.170

<span class="o">[{</span><span class="s2">"id"</span>:1,<span class="s2">"color"</span>:<span class="s2">"amber"</span>,<span class="s2">"department"</span>:<span class="s2">"Eyewear"</span>,<span class="s2">"name"</span>:<span class="s2">"Elinor Glasses"</span>,<span class="s2">"price"</span>:<span class="s2">"282.00"</span><span class="o">}</span>,<span class="o">{</span><span class="s2">"id"</span>:2,<span class="s2">"color"</span>:<span class="s2">"cyan"</span>,<span class="s2">"department"</span>:<span class="s2">"Clothing"</span>,<span class="s2">"name"</span>:<span class="s2">"Atlas Shirt"</span>,<span class="s2">"price"</span>:<span class="s2">"127.00"</span><span class="o">}</span>,<span class="o">{</span><span class="s2">"id"</span>:3,<span class="s2">"color"</span>:<span class="s2">"teal"</span>,<span class="s2">"department"</span>:<span class="s2">"Clothing"</span>,<span class="s2">"name"</span>:<span class="s2">"Small Metal Shoes"</span>,<span class="s2">"price"</span>:<span class="s2">"232.00"</span><span class="o">}</span>,<span class="o">{</span><span class="s2">"id"</span>:4,<span class="s2">"color"</span>:<span class="s2">"red"</span>,<span class="s2">"department"</span>:<span class="s2">"Watches"</span>,<span class="s2">"name"</span>:<span class="s2">"Red Dragon Watch"</span>,<span class="s2">"price"</span>:<span class="s2">"232.00"</span><span class="o">}]</span> 
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="http-重定向到-https">HTTP 重定向到 HTTPS</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: coolstore-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: <span class="m">80</span>
      name: http
      protocol: HTTP
    hosts:
    - <span class="s2">"webapp.istioinaction.io"</span>
    tls:
      httpsRedirect: <span class="nb">true</span>
  - port:
      number: <span class="m">443</span>
      name: https
      protocol: HTTPS
    tls:
      mode: SIMPLE
      credentialName: webapp-credential
    hosts:
    - <span class="s2">"webapp.istioinaction.io"</span>
    
curl -L -v http://192.168.8.170:31193/api/catalog <span class="se">\
</span><span class="se"></span>  -H <span class="s2">"Host: webapp.istioinaction.io"</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="具有双向-tls-的-http-流量">具有双向 TLS 的 HTTP 流量</h2>
<blockquote>
<p>直观地展示了客户端和服务器如何通过双向 TLS (mTLS) 协议验证彼此的证书，即相互验证。证书用于加密流量。</p>
</blockquote>
<p><img alt="Pasted image 20230928182338" src="https://cdn.treesir.pub/images/2023/09/28/20230928182346.png"/></p>
<ul>
<li>
<p>配置 <code>istio-ingressgateway-ca-certs</code> 密钥</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl create -n istio-system secret <span class="se">\
</span><span class="se"></span>generic webapp-credential-mtls --from-file<span class="o">=</span>tls.key<span class="o">=</span><span class="se">\
</span><span class="se"></span>ch4/certs/3_application/private/webapp.istioinaction.io.key.pem <span class="se">\
</span><span class="se"></span>--from-file<span class="o">=</span>tls.crt<span class="o">=</span><span class="se">\
</span><span class="se"></span>ch4/certs/3_application/certs/webapp.istioinaction.io.cert.pem <span class="se">\
</span><span class="se"></span>--from-file<span class="o">=</span>ca.crt<span class="o">=</span>ch4/certs/2_intermediate/certs/ca-chain.cert.pem
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>更新 Istio <code>Gateway</code> 资源以指向 CA 证书链的位置，并将预期协议配置为双向 TLS</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">  - port:
      number: <span class="m">443</span>
      name: https
      protocol: HTTPS
    tls:
      mode: MUTUAL                             ❶
      credentialName: webapp-credential-mtls   ❷
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>测试</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">curl -H <span class="s2">"Host: webapp.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>https://webapp.istioinaction.io:32316/api/catalog <span class="se">\
</span><span class="se"></span>--cacert ch4/certs/2_intermediate/certs/ca-chain.cert.pem <span class="se">\
</span><span class="se"></span>--resolve webapp.istioinaction.io:32316:192.168.8.170

curl: <span class="o">(</span>56<span class="o">)</span> LibreSSL SSL_read: LibreSSL/3.3.6: error:1404C45C:SSL routines:ST_OK:reason<span class="o">(</span>1116<span class="o">)</span>, errno <span class="m">0</span>

<span class="c1"># 此调用被拒绝，因为 SSL 握手未成功。我们仅将 CA 证书链传递给 curl 命令；我们还需要传递客户端的证书和私钥。</span>
➜  book-source-code git:<span class="o">(</span>master<span class="o">)</span> ✗ curl -H <span class="s2">"Host: webapp.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>https://webapp.istioinaction.io:32316/api/catalog <span class="se">\
</span><span class="se"></span>--cacert ch4/certs/2_intermediate/certs/ca-chain.cert.pem <span class="se">\
</span><span class="se"></span>--resolve webapp.istioinaction.io:32316:192.168.8.170 <span class="se">\
</span><span class="se"></span>--cert ch4/certs/4_client/certs/webapp.istioinaction.io.cert.pem <span class="se">\
</span><span class="se"></span>--key ch4/certs/4_client/private/webapp.istioinaction.io.key.pem
<span class="o">[{</span><span class="s2">"id"</span>:1,<span class="s2">"color"</span>:<span class="s2">"amber"</span>,<span class="s2">"department"</span>:<span class="s2">"Eyewear"</span>,<span class="s2">"name"</span>:<span class="s2">"Elinor Glasses"</span>,<span class="s2">"price"</span>:<span class="s2">"282.00"</span><span class="o">}</span>,<span class="o">{</span><span class="s2">"id"</span>:2,<span class="s2">"color"</span>:<span class="s2">"cyan"</span>,<span class="s2">"department"</span>:<span class="s2">"Clothing"</span>,<span class="s2">"name"</span>:<span class="s2">"Atlas Shirt"</span>,<span class="s2">"price"</span>:<span class="s2">"127.00"</span><span class="o">}</span>,<span class="o">{</span><span class="s2">"id"</span>:3,<span class="s2">"color"</span>:<span class="s2">"teal"</span>,<span class="s2">"department"</span>:<span class="s2">"Clothing"</span>,<span class="s2">"name"</span>:<span class="s2">"Small Metal Shoes"</span>,<span class="s2">"price"</span>:<span class="s2">"232.00"</span><span class="o">}</span>,<span class="o">{</span><span class="s2">"id"</span>:4,<span class="s2">"color"</span>:<span class="s2">"red"</span>,<span class="s2">"department"</span>:<span class="s2">"Watches"</span>,<span class="s2">"name"</span>:<span class="s2">"Red Dragon Watch"</span>,<span class="s2">"price"</span>:<span class="s2">"232.00"</span><span class="o">}]</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>Istio 网关 SDS</strong></p>
<blockquote>
<p>Istio 网关从内置于用于启动 <code>istio-proxy</code> 的 <code>istio-agent</code> 进程中的秘密发现服务 (SDS) 获取证书。 SDS 是一个动态 API，应该自动传播更新。</p>
</blockquote>
</li>
</ul>
<h2 id="tls-为多个虚拟主机提供服务">TLS 为多个虚拟主机提供服务</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">  servers:
  - port:
      number: <span class="m">443</span>             ❶
      name: https-webapp
      protocol: HTTPS
    tls:
      mode: SIMPLE
      credentialName: webapp-credential
    hosts:
    - <span class="s2">"webapp.istioinaction.io"</span>
  - port:
      number: <span class="m">443</span>             ❷
      name: https-catalog
      protocol: HTTPS
</code></pre></td></tr></table>
</div>
</div><h2 id="tcp-流量">TCP 流量</h2>
<blockquote>
<p>当 Istio 将流量视为普通 TCP 时，我们无法获得许多有用的功能，例如重试、请求级熔断、复杂路由等。这只是因为 Istio 无法判断正在使用什么协议（除非使用 Istio 理解的特定协议，例如 MongoDB）。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: echo-tcp-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: <span class="m">31400</span>
      name: tcp-echo
      protocol: TCP
    hosts:
    - <span class="s2">"*"</span>
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: tcp-echo-vs-from-gw
spec:
  hosts:
  - <span class="s2">"*"</span>
  gateways:
  - echo-tcp-gateway             ❶
  tcp:
  - match:
    - port: <span class="m">31400</span>                ❷
    route:
    - destination:
        host: tcp-echo-service   ❸
        port:
          number: <span class="m">2701</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="sni-直通的流量路由">SNI 直通的流量路由</h2>
<blockquote>
<p>配置为使用 <code>PASSTHROUGH</code> 作为其路由机制的 <code>Gateway</code> 定义</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: sni-passthrough-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: <span class="m">31400</span>                       ❶
      name: tcp-sni
      protocol: TLS
    hosts:
    - <span class="s2">"simple-sni-1.istioinaction.io"</span>     ❷
    tls:
      mode: PASSTHROUGH                   ❸
      
---
kubectl get svc -n istio-system istio-ingressgateway <span class="se">\
</span><span class="se"></span>  -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.ports[?(@.name == "tcp")]}'</span> 

curl -H <span class="s2">"Host: simple-sni-1.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>https://simple-sni-1.istioinaction.io:31332/api/catalog <span class="se">\
</span><span class="se"></span>--cacert ch4/sni/simple-sni-1/2_intermediate/certs/ca-chain.cert.pem  <span class="se">\
</span><span class="se"></span>--resolve simple-sni-1.istioinaction.io:31332:192.168.8.170
<span class="o">{</span>
  <span class="s2">"name"</span>: <span class="s2">"simple-tls-service-1"</span>,
  <span class="s2">"uri"</span>: <span class="s2">"/api/catalog"</span>,
  <span class="s2">"type"</span>: <span class="s2">"HTTP"</span>,
  <span class="s2">"ip_addresses"</span>: <span class="o">[</span>
    <span class="s2">"10.42.4.12"</span>
  <span class="o">]</span>,
  <span class="s2">"start_time"</span>: <span class="s2">"2023-09-28T11:13:03.866815"</span>,
  <span class="s2">"end_time"</span>: <span class="s2">"2023-09-28T11:13:03.866956"</span>,
  <span class="s2">"duration"</span>: <span class="s2">"141.018µs"</span>,
  <span class="s2">"body"</span>: <span class="s2">"Hello from simple-tls-service-1!!!"</span>,
  <span class="s2">"code"</span>: <span class="m">200</span>
<span class="o">}</span>
---
<span class="c1"># 测试请求使用相同证书的第二个服务</span>
curl -H <span class="s2">"Host: simple-sni-2.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>https://simple-sni-2.istioinaction.io:31332/api/catalog <span class="se">\
</span><span class="se"></span>--cacert ch4/sni/simple-sni-2/2_intermediate/certs/ca-chain.cert.pem   <span class="se">\
</span><span class="se"></span>--resolve simple-sni-2.istioinaction.io:31332:192.168.8.170
<span class="o">{</span>
  <span class="s2">"name"</span>: <span class="s2">"simple-tls-service-2"</span>,
  <span class="s2">"uri"</span>: <span class="s2">"/api/catalog"</span>,
  <span class="s2">"type"</span>: <span class="s2">"HTTP"</span>,
  <span class="s2">"ip_addresses"</span>: <span class="o">[</span>
    <span class="s2">"10.42.8.19"</span>
  <span class="o">]</span>,
  <span class="s2">"start_time"</span>: <span class="s2">"2023-09-28T11:15:05.359662"</span>,
  <span class="s2">"end_time"</span>: <span class="s2">"2023-09-28T11:15:05.359796"</span>,
  <span class="s2">"duration"</span>: <span class="s2">"134.13µs"</span>,
  <span class="s2">"body"</span>: <span class="s2">"Hello from simple-tls-service-2!!!"</span>,
  <span class="s2">"code"</span>: <span class="m">200</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="自定义网关">自定义网关</h2>
<blockquote>
<p>某些服务可能对性能更敏感，或者出于合规性原因需要更高的可用性或隔离性。有时您希望让各个团队拥有自己的网关和配置，而不影响其他团队。</p>
<p><a href="https://istio.io/latest/docs/setup/install/istioctl/#configure-gateways">https://istio.io/latest/docs/setup/install/istioctl/#configure-gateways</a></p>
</blockquote>
<p><img alt="Pasted image 20230928191731" src="https://cdn.treesir.pub/images/2023/09/28/20230928191735.png"/></p>
<hr/>
<p>安装自定义网关</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  name: my-user-gateway-install
  namespace: istioinaction
spec:
  profile: empty
  values:
    gateways:
      istio-ingressgateway:
        autoscaleEnabled: <span class="nb">false</span>
  components:
    ingressGateways:
    - name: istio-ingressgateway
      enabled: <span class="nb">false</span>    
    - name: my-user-gateway
      namespace: istioinaction
      enabled: <span class="nb">true</span>
      label:
        istio: my-user-gateway
---
istioctl install -y -n istioinaction -f ch4/my-user-gateway.yaml
</code></pre></td></tr></table>
</div>
</div><p><code>另一种允许用户创建自己的网关</code>而无需授予他们对 <code>IstioOperator</code> 资源（可以修改现有 Istio 安装）的完全访问权限的方法是通过网关注入。</p>
<p><strong>此方法验证未通过</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl apply -f <span class="s">&lt;&lt; EOF - 
</span><span class="s">apiVersion: apps/v1
</span><span class="s">kind: Deployment
</span><span class="s">metadata:
</span><span class="s">  name: my-user-gateway-injected
</span><span class="s">  namespace: istioinaction
</span><span class="s">spec:
</span><span class="s">  selector:
</span><span class="s">    matchLabels:
</span><span class="s">      ingress: my-user-gateway-injected
</span><span class="s">  template:
</span><span class="s">    metadata:
</span><span class="s">      annotations:
</span><span class="s">        sidecar.istio.io/inject: "true"
</span><span class="s">        inject.istio.io/templates: gateway        
</span><span class="s">      labels:
</span><span class="s">        ingress: my-user-gateway-injected
</span><span class="s">    spec:
</span><span class="s">      containers:
</span><span class="s">      - name: istio-proxy
</span><span class="s">        image: auto 
</span><span class="s">---
</span><span class="s">apiVersion: v1
</span><span class="s">kind: Service
</span><span class="s">metadata:
</span><span class="s">  name: my-user-gateway-injected
</span><span class="s">  namespace: istioinaction
</span><span class="s">spec:
</span><span class="s">  type: LoadBalancer
</span><span class="s">  selector:
</span><span class="s">    ingress: my-user-gateway-injected
</span><span class="s">  ports:
</span><span class="s">  - port: 80
</span><span class="s">    name: http
</span><span class="s">  - port: 443
</span><span class="s">    name: https      
</span><span class="s">---
</span><span class="s">apiVersion: rbac.authorization.k8s.io/v1
</span><span class="s">kind: Role
</span><span class="s">metadata:
</span><span class="s">  name: my-user-gateway-injected-sds
</span><span class="s">  namespace: istioinaction
</span><span class="s">rules:
</span><span class="s">- apiGroups: [""]
</span><span class="s">  resources: ["secrets"]
</span><span class="s">  verbs: ["get", "watch", "list"]
</span><span class="s">---
</span><span class="s">apiVersion: rbac.authorization.k8s.io/v1
</span><span class="s">kind: RoleBinding
</span><span class="s">metadata:
</span><span class="s">  name: my-user-gateway-injected-sds
</span><span class="s">  namespace: istioinaction
</span><span class="s">roleRef:
</span><span class="s">  apiGroup: rbac.authorization.k8s.io
</span><span class="s">  kind: Role
</span><span class="s">  name: my-user-gateway-injected-sds
</span><span class="s">subjects:
</span><span class="s">- kind: ServiceAccount
</span><span class="s">  name: default
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="ingress网关访问日志">Ingress网关访问日志</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl -n istio-system logs deploy/istio-ingressgateway

<span class="c1"># 生产 Istio 安装禁用了 Access 日志记录。但是，您可以通过将 accessLogFile 属性设置为打印到标准输出流来更改此设置</span>
istioctl install --set meshConfig.accessLogFile<span class="o">=</span>/dev/stdout

<span class="c1"># 默认情况下，Access 日志是关闭的，考虑到生产集群有数百或数千个工作负载，每个工作负载都处理大量流量，这是有道理的。</span>

<span class="c1"># 要仅显示入口网关工作负载的访问日志，您可以使用以下 Telemetry 配置：</span>
apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: ingress-gateway
  namespace: istio-system
spec:
  selector:
    matchLabels:
      app: istio-ingressgateway    ❶ 与标签匹配的 Pod 获得遥测配置。
  accessLogging:
  - providers:
    - name: envoy                  ❷ 访问日志记录的提供者配置
    disabled: <span class="nb">false</span>                ❸ 通过设置disabled为false来启用
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>telemetry 存在优先级</p>
<ul>
<li><em>Mesh-wide</em>： 配置应用于整个网格中的工作负载。网格范围的配置必须应用在 Istio 安装命名空间中，并且缺少工作负载选择器。</li>
<li><em>Namespace-wide</em>： 配置应用于命名空间中的所有工作负载。命名空间范围的配置应用于我们想要配置的工作负载的命名空间，并且还缺少工作负载选择器。这会覆盖应用于工作负载的任何网格范围配置。</li>
<li><em>Workload-specific</em>： 配置仅适用于与应用配置的命名空间中的工作负载选择器匹配的工作负载（如前面的代码所示）。特定于工作负载的配置会覆盖网格范围和命名空间范围的配置。</li>
</ul>
</li>
<li>
<p>当您部署新网关（例如入口网关）时，代理将配置有可用于网格中路由的所有服务。如前所述，这可能会导致非常大的配置并对网关造成压力。</p>
<ul>
<li>
<p>诀窍是通过仅包含与网关相关的配置来删除代理的任何其他配置。直到最近，此功能还是默认关闭的。在较新的版本中，您可以仔细检查它是否已启用。</p>
<p><code>PILOT_FILTER_GATEWAY_CLUSTER_CONFIG</code></p>
<p>参考文档:</p>
<ul>
<li><a href="https://istio.io/latest/docs/setup/additional-setup/customize-installation/">https://istio.io/latest/docs/setup/additional-setup/customize-installation/</a></li>
<li><a href="https://istio.io/latest/docs/reference/commands/pilot-agent/">https://istio.io/latest/docs/reference/commands/pilot-agent/</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/436796453">https://zhuanlan.zhihu.com/p/436796453</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl get IstioOperator installed-state -o yaml -n istio-system<span class="p">|</span>grep <span class="s1">'PILOT_FILTER_GATEWAY_CLUSTER_CONFIG'</span>

kubectl get IstioOperator installed-state -o yaml -n istio-system<span class="p">|</span>grep <span class="s1">'ISTIO_META_DNS_CAPTURE'</span>  

<span class="c1"># 1.17.6 中默认关闭</span>
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  name: control-plane
spec:
  profile: minimal
  components:
    pilot:
      k8s:
        env:
        - name: PILOT_FILTER_GATEWAY_CLUSTER_CONFIG
          value: <span class="s2">"true"</span>
  meshConfig:
    defaultConfig:
      proxyMetadata:
        ISTIO_META_DNS_CAPTURE: <span class="s2">"true"</span>
    enablePrometheusMerge: <span class="nb">true</span>
</code></pre></td></tr></table>
</div>
</div><hr/>
</li>
</ul>
</li>
</ul>
<h1 id="流量控制">流量控制</h1>
<p>始之前，让我们先清理一下我们的环境，这样我们就可以从头开始。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl config set-context <span class="k">$(</span>kubectl config current-context<span class="k">)</span> <span class="se">\
</span><span class="se"></span> --namespace<span class="o">=</span>istioinaction

kubectl delete deployment,svc,gateway,<span class="se">\
</span><span class="se"></span>virtualservice,destinationrule --all -n istioinaction

</code></pre></td></tr></table>
</div>
</div><h2 id="蓝绿发布">蓝绿发布</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1">#  catalog 服务的 v1</span>
kubectl apply -f services/catalog/kubernetes/catalog.yaml

<span class="c1"># 创建 暴露网关</span>
kubectl apply -f ch5/catalog-gateway.yaml

<span class="c1"># 创建 VirtualService</span>
kubectl apply -f ch5/catalog-vs.yaml

<span class="c1"># 测试</span>
curl -I http://192.168.8.212/items -H <span class="s2">"Host: catalog.istioinaction.io"</span>
HTTP/1.1 <span class="m">200</span> OK
x-powered-by: Express
vary: Origin, Accept-Encoding
access-control-allow-credentials: <span class="nb">true</span>
cache-control: no-cache
pragma: no-cache
expires: -1
content-type: application/json<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
content-length: <span class="m">502</span>
etag: W/<span class="s2">"1f6-ih2h+hDQ0yLLcKIlBvwkWbyQGK4"</span>
date: Thu, <span class="m">28</span> Sep <span class="m">2023</span> 12:37:28 GMT
x-envoy-upstream-service-time: <span class="m">2</span>
server: istio-envoy

<span class="c1"># 部署 V2</span>
kubectl apply -f services/catalog/kubernetes/catalog-deployment-v2.yaml

<span class="c1"># 请求 10 次</span>
<span class="k">for</span> in in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> curl http://192.168.8.212/items <span class="se">\
</span><span class="se"></span>-H <span class="s2">"Host: catalog.istioinaction.io"</span><span class="p">;</span> <span class="nb">printf</span> <span class="s2">"\n\n"</span><span class="p">;</span> <span class="k">done</span>


<span class="c1"># 将所有流量路由到目录服务的 v1</span>

<span class="c1"># 1. 创建 DestinationRule，Deplyment 分别配置 app &amp; version 标签</span>
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: catalog
spec:
  host: catalog
  subsets:
  - name: version-v1
    labels:
      version: v1
  - name: version-v2
    labels:
      version: v2
<span class="c1"># 2 流量全部指向 v1 ，配置 v2 则流量全部前往 v2</span>
  - route:
    - destination:
        host: catalog
        subset: version-v1     ❶
        
kubectl apply -f ch5/catalog-vs-v1.yaml 
kubectl apply -f ch5/catalog-vs-v2.yaml 
</code></pre></td></tr></table>
</div>
</div><h2 id="金丝雀发布">金丝雀发布</h2>
<ul>
<li>
<p>使用请求头实现，</p>
<blockquote>
<p>包含 HTTP 标头 <code>x-istio-cohort: internal</code> 的任何流量路由到 <code>catalog</code> 的 v2</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: catalog-vs-from-gw
spec:
  hosts:
  - <span class="s2">"catalog.istioinaction.io"</span>
  gateways:
  - catalog-gateway
  http:
  - match:
    - headers:
        x-istio-cohort:
          exact: <span class="s2">"internal"</span>
    route:
    - destination:
        host: catalog
        subset: version-v2
  - route:
    - destination:
        host: catalog
        subset: version-v1

---
curl  http://192.168.8.212/items <span class="se">\
</span><span class="se"></span>-H <span class="s2">"Host: catalog.istioinaction.io"</span> -H <span class="s2">"x-istio-cohort: internal"</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>按流量比例实现</p>
<ul>
<li>您可以为每个服务版本在 1 到 100 之间调整流量，<code>但所有权重的总和必须等于 100</code>。如果不等于 100，可能会发生不可预测的流量路由。</li>
<li>如果您有 v1 和 v2 以外的版本，则必须在 <code>DestinationRule</code> 中将它们声明为 <code>subsets</code> 。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl delete gateway,virtualservice,destinationrule --all
kubectl apply -f services/webapp/kubernetes/webapp.yaml
kubectl apply -f services/webapp/istio/webapp-catalog-gw-vs.yaml
kubectl get pod -w
kubectl apply -f ch5/catalog-dest-rule.yaml
kubectl apply -f ch5/catalog-vs-v1-mesh.yaml
kubectl apply -f ch5/catalog-vs-v2-request-mesh.yaml

<span class="c1"># 让我们将 10% 的流量路由到 catalog 的 v2 ：</span>
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: catalog
spec:
  hosts:
  - catalog
  gateways:
  - mesh
  http:
  - route:
    - destination:
        host: catalog
        subset: version-v1
      weight: <span class="m">90</span>             ❶
    - destination:
        host: catalog
        subset: version-v2
      weight: <span class="m">10</span>             ❷
---
<span class="k">for</span> <span class="k">for</span> in in <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do</span> curl -s http://192.168.8.212/api/catalog <span class="se">\
</span><span class="se"></span>-H <span class="s2">"Host: webapp.istioinaction.io"</span><span class="p">|</span>grep -i imageUrl<span class="p">;</span> <span class="k">done</span><span class="p">|</span>wc -l
      <span class="m">12</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="金丝雀-配合-flagger-一起发布">金丝雀 配合 Flagger 一起发布</h2>
<ul>
<li><a href="https://flagger.app/">https://flagger.app/</a></li>
<li>为了让 Flagger 使用任何成功指标，我们需要安装 <code>Prometheus</code> 并抓取 Istio 数据平面。已安装跳过</li>
</ul>
<p>文档： <a href="https://docs.flagger.app/tutorials/istio-progressive-delivery">https://docs.flagger.app/tutorials/istio-progressive-delivery</a></p>
<blockquote>
<p>在此 Canary 资源中，我们指定哪个 Kubernetes Deployment 应作为金丝雀的目标、应自动创建哪些 Kubernetes Service 和 Istio VirtualService 以及如何继续金丝雀。 Canary 资源的最后一部分描述了推广金丝雀的速度、需要关注哪些指标来确定可行性以及确定成功的阈值。我们每 45 秒评估一次金丝雀步骤，每一步增加 10% 的流量；当流量达到 50% 时，我们将流量削减至 100%。</p>
</blockquote>
<ul>
<li>对于成功率指标，我们只能容忍 1 分钟内 99% 的成功检查。我们还只允许 P99（第 99 个百分位）的请求持续时间为 500 毫秒。如果这些指标偏离我们指定的值超过五个时间间隔，金丝雀将被停止并回滚。</li>
</ul>
<blockquote>
<ul>
<li>在此期间您可以检查金丝雀的状态，如存在问题时，可检查 flagger 中日志, 或执行 <code>kubectl describe canary catalog-release</code></li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>此时，Flagger 已自动创建驱动金丝雀版本所需的一些 Kubernetes 资源，例如 Deployment 、 Service 和 VirtualService 对象。
<code>kubectl get virtualservice catalog -o yaml</code></li>
</ul>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 清理环境</span>
kubectl delete vs,svc,deploy,destinationrule <span class="se">\
</span><span class="se"></span>--all -n istioinaction
kubectl delete -f ch5/flagger
 
<span class="c1"># 部署应用</span>
kubectl config set-context <span class="k">$(</span>kubectl config current-context<span class="k">)</span> <span class="se">\
</span><span class="se"></span> --namespace<span class="o">=</span>istioinaction
kubectl apply -f ./ch5/flagger/catalog-deployment-v1.yaml

<span class="c1">#  创建 mesh 网关</span>
kubectl apply -f <span class="s">&lt;&lt; EOF -
</span><span class="s">apiVersion: networking.istio.io/v1alpha3
</span><span class="s">kind: Gateway
</span><span class="s">metadata:
</span><span class="s">  name: mesh
</span><span class="s">  namespace: istioinaction
</span><span class="s">spec:
</span><span class="s">  selector:
</span><span class="s">    istio: ingressgateway
</span><span class="s">  servers:
</span><span class="s">    - port:
</span><span class="s">        number: 80
</span><span class="s">        name: http
</span><span class="s">        protocol: HTTP
</span><span class="s">      hosts:
</span><span class="s">        - "*"
</span><span class="s">EOF</span>

<span class="c1"># 部署 prometheus</span>
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.19/samples/addons/prometheus.yaml

<span class="c1"># 使用 helm 安装 Flagger</span>
helm repo add flagger https://flagger.app
kubectl apply -f <span class="se">\
</span><span class="se"></span>  https://raw.githubusercontent.com/fluxcd/flagger/main/artifacts/flagger/crd.yaml

helm install flagger flagger/flagger <span class="se">\
</span><span class="se"></span>     --namespace<span class="o">=</span>istio-system <span class="se">\
</span><span class="se"></span>     --set crd.create<span class="o">=</span><span class="nb">false</span> <span class="se">\
</span><span class="se"></span>     --set <span class="nv">meshProvider</span><span class="o">=</span>istio <span class="se">\
</span><span class="se"></span>     --set <span class="nv">metricsServer</span><span class="o">=</span>http://prometheus:9090
     
<span class="c1"># CRD 清单</span>
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: catalog-release
  namespace: istioinaction
spec:
  targetRef:                  ❶ 部署到金丝雀
    apiVersion: apps/v1
    kind: Deployment
    name: catalog
  progressDeadlineSeconds: <span class="m">60</span>
  <span class="c1"># Service / VirtualService Config</span>
  service:                    ❷ 服务配置
    name: catalog
    port: <span class="m">80</span>
    targetPort: <span class="m">3000</span>
    gateways:
    - mesh
    hosts:
    - catalog
  analysis:                   ❸ 金丝雀进展参数
    interval: 45s
    threshold: <span class="m">5</span>
    maxWeight: <span class="m">50</span>
    stepWeight: <span class="m">10</span>
    metrics:
    - name: request-success-rate
      thresholdRange:
        min: <span class="m">99</span>
      interval: 1m
    - name: request-duration
      thresholdRange:
        max: <span class="m">500</span>
      interval: 30s
      
<span class="c1"># 在此 Canary 资源中，我们指定哪个 Kubernetes Deployment 应作为金丝雀的目标、应自动创建哪些 Kubernetes Service 和 Istio VirtualService 以及如何继续金丝雀。 Canary 资源的最后一部分描述了推广金丝雀的速度、需要关注哪些指标来确定可行性以及确定成功的阈值。我们每 45 秒评估一次金丝雀步骤，每一步增加 10% 的流量；当流量达到 50% 时，我们将流量削减至 100%。</span>
<span class="c1">#   - 对于成功率指标，我们只能容忍 1 分钟内 99% 的成功检查。我们还只允许 P99（第 99 个百分位）的请求持续时间为 500 毫秒。如果这些指标偏离我们指定的值超过五个时间间隔，金丝雀将被停止并回滚。</span>
kubectl apply -f <span class="s">&lt;&lt; EOF -
</span><span class="s">apiVersion: flagger.app/v1beta1
</span><span class="s">kind: Canary
</span><span class="s">metadata:
</span><span class="s">  name: catalog-release
</span><span class="s">  namespace: istioinaction
</span><span class="s">spec:
</span><span class="s">  targetRef:
</span><span class="s">    apiVersion: apps/v1
</span><span class="s">    kind: Deployment
</span><span class="s">    name: catalog  
</span><span class="s">  progressDeadlineSeconds: 60
</span><span class="s">  # Service / VirtualService Config
</span><span class="s">  service:
</span><span class="s">    name: catalog
</span><span class="s">    port: 80
</span><span class="s">    targetPort: 3000    
</span><span class="s">    gateways:
</span><span class="s">    - public-gateway.istio-system.svc.cluster.local   
</span><span class="s">    hosts:
</span><span class="s">    - test.example.com
</span><span class="s">  analysis:
</span><span class="s">    interval: 45s
</span><span class="s">    threshold: 5
</span><span class="s">    maxWeight: 50
</span><span class="s">    stepWeight: 10
</span><span class="s">    metrics:
</span><span class="s">    - name: request-success-rate
</span><span class="s">      thresholdRange:
</span><span class="s">        min: 99
</span><span class="s">      interval: 1m
</span><span class="s">    - name: request-duration
</span><span class="s">      thresholdRange:
</span><span class="s">        max: 500
</span><span class="s">      interval: 30s
</span><span class="s">EOF</span>

<span class="c1"># 更新镜像，触发更新</span>
kubectl -n istioinaction <span class="nb">set</span> image deployment/catalog <span class="se">\
</span><span class="se"></span><span class="nv">catalog</span><span class="o">=</span>yangzun/istio-catalog:latest

<span class="c1"># 在此期间您可以检查金丝雀的状态，如存在问题时，可检查 flagger 中日志, 或执行 kubectl describe canary catalog-release</span>
kubectl get canary catalog-release -w

<span class="c1"># 此时，Flagger 已自动创建驱动金丝雀版本所需的一些 Kubernetes 资源，例如 Deployment 、 Service 和 VirtualService 对象。</span>
kubectl get virtualservice catalog -o yaml

kubectl get gw -o yaml 

<span class="c1"># 滚动更新时，需要有流量请求，来触发 analysis 中的阈值更新。请求网关地址时，需要正确可以路由到后端</span>
<span class="k">while</span> true<span class="p">;</span> <span class="k">do</span> curl <span class="s2">"http://192.168.8.212"</span> <span class="se">\
</span><span class="se"></span>-H <span class="s2">"Host: test.example.com"</span> <span class="p">;</span> sleep 1<span class="p">;</span> <span class="k">done</span>

curl -s http://192.168.8.212 -H <span class="s2">"Host: test.example.com"</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">
kubectl apply -f <span class="s">&lt;&lt; EOF -
</span><span class="s">apiVersion: networking.istio.io/v1alpha3
</span><span class="s">kind: Gateway
</span><span class="s">metadata:
</span><span class="s">  name: public-gateway
</span><span class="s">  namespace: istio-system
</span><span class="s">spec:
</span><span class="s">  selector:
</span><span class="s">    istio: ingressgateway
</span><span class="s">  servers:
</span><span class="s">    - port:
</span><span class="s">        number: 80
</span><span class="s">        name: http
</span><span class="s">        protocol: HTTP
</span><span class="s">      hosts:
</span><span class="s">        - "*"
</span><span class="s">EOF</span>

kubectl create ns <span class="nb">test</span>
kubectl label namespace <span class="nb">test</span> istio-injection<span class="o">=</span>enabled

kubectl apply -k https://github.com/fluxcd/flagger//kustomize/podinfo?ref<span class="o">=</span>main

kubectl apply -k https://github.com/fluxcd/flagger//kustomize/tester?ref<span class="o">=</span>main


kubectl apply -f <span class="s">&lt;&lt; EOF -
</span><span class="s">apiVersion: flagger.app/v1beta1
</span><span class="s">kind: Canary
</span><span class="s">metadata:
</span><span class="s">  name: podinfo
</span><span class="s">  namespace: test
</span><span class="s">spec:
</span><span class="s">  # deployment reference
</span><span class="s">  targetRef:
</span><span class="s">    apiVersion: apps/v1
</span><span class="s">    kind: Deployment
</span><span class="s">    name: podinfo
</span><span class="s">  # the maximum time in seconds for the canary deployment
</span><span class="s">  # to make progress before it is rollback (default 600s)
</span><span class="s">  progressDeadlineSeconds: 60
</span><span class="s">  # HPA reference (optional)
</span><span class="s">  autoscalerRef:
</span><span class="s">    apiVersion: autoscaling/v2beta2
</span><span class="s">    kind: HorizontalPodAutoscaler
</span><span class="s">    name: podinfo
</span><span class="s">  service:
</span><span class="s">    # service port number
</span><span class="s">    port: 9898
</span><span class="s">    # container port number or name (optional)
</span><span class="s">    targetPort: 9898
</span><span class="s">    # Istio gateways (optional)
</span><span class="s">    gateways:
</span><span class="s">    - public-gateway.istio-system.svc.cluster.local
</span><span class="s">    # Istio virtual service host names (optional)
</span><span class="s">    hosts:
</span><span class="s">    - app.example.com
</span><span class="s">    # Istio traffic policy (optional)
</span><span class="s">    trafficPolicy:
</span><span class="s">      tls:
</span><span class="s">        # use ISTIO_MUTUAL when mTLS is enabled
</span><span class="s">        mode: DISABLE
</span><span class="s">    # Istio retry policy (optional)
</span><span class="s">    retries:
</span><span class="s">      attempts: 3
</span><span class="s">      perTryTimeout: 1s
</span><span class="s">      retryOn: "gateway-error,connect-failure,refused-stream"
</span><span class="s">  analysis:
</span><span class="s">    # schedule interval (default 60s)
</span><span class="s">    interval: 1m
</span><span class="s">    # max number of failed metric checks before rollback
</span><span class="s">    threshold: 5
</span><span class="s">    # max traffic percentage routed to canary
</span><span class="s">    # percentage (0-100)
</span><span class="s">    maxWeight: 50
</span><span class="s">    # canary increment step
</span><span class="s">    # percentage (0-100)
</span><span class="s">    stepWeight: 10
</span><span class="s">    metrics:
</span><span class="s">    - name: request-success-rate
</span><span class="s">      # minimum req success rate (non 5xx responses)
</span><span class="s">      # percentage (0-100)
</span><span class="s">      thresholdRange:
</span><span class="s">        min: 99
</span><span class="s">      interval: 1m
</span><span class="s">    - name: request-duration
</span><span class="s">      # maximum req duration P99
</span><span class="s">      # milliseconds
</span><span class="s">      thresholdRange:
</span><span class="s">        max: 500
</span><span class="s">      interval: 30s
</span><span class="s">    # testing (optional)
</span><span class="s">    webhooks:
</span><span class="s">      - name: acceptance-test
</span><span class="s">        type: pre-rollout
</span><span class="s">        url: http://flagger-loadtester.test/
</span><span class="s">        timeout: 30s
</span><span class="s">        metadata:
</span><span class="s">          type: bash
</span><span class="s">          cmd: "curl -sd 'test' http://podinfo-canary:9898/token | grep token"
</span><span class="s">      - name: load-test
</span><span class="s">        url: http://flagger-loadtester.test/
</span><span class="s">        timeout: 5s
</span><span class="s">        metadata:
</span><span class="s">          cmd: "hey -z 1m -q 10 -c 2 http://podinfo-canary.test:9898/"
</span><span class="s">EOF</span>


<span class="c1"># 更新镜像触发金丝雀更新</span>

kubectl -n <span class="nb">test</span> <span class="nb">set</span> image deployment/podinfo <span class="se">\
</span><span class="se"></span><span class="nv">podinfod</span><span class="o">=</span>ghcr.io/stefanprodan/podinfo:6.0.1


<span class="c1"># 查看正在进行的所有 金丝雀</span>
watch kubectl get canaries --all-namespaces

curl -s http://192.168.8.212 -H <span class="s2">"Host: app.example.com"</span>
</code></pre></td></tr></table>
</div>
</div><hr/>
<h2 id="流量镜像">流量镜像</h2>
<blockquote>
<p><a href="https://istio.io/latest/docs/tasks/traffic-management/mirroring/">https://istio.io/latest/docs/tasks/traffic-management/mirroring/</a></p>
</blockquote>
<hr/>
<h2 id="集群流量安全">集群流量安全</h2>
<ul>
<li>
<p>运行以下命令将 Istio 的默认值从 <code>ALLOW_ANY</code> 更改为 <code>REGISTRY_ONLY</code> 。这意味着只有在服务网格注册表中明确将流量列入 <code>白名单</code>时，我们才会允许流量离开网格</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">istioctl install --set <span class="nv">profile</span><span class="o">=</span>demo <span class="se">\
</span><span class="se"></span> --set meshConfig.outboundTrafficPolicy.mode<span class="o">=</span>REGISTRY_ONLY
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>ServiceEntry</p>
<blockquote>
<p><strong>可以指定 ServiceEntry 资源，用于增强外部服务并将其插入 Istio 白名单注册表</strong>，白名单。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 此 ServiceEntry 资源会在 Istio 的服务注册表中插入一个条目，明确规定允许网格中的客户端使用主机 jsonplaceholder.typicode.com 调用 JSON 占位符。</span>
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: jsonplaceholder
spec:
  hosts:
  - jsonplaceholder.typicode.com
  ports:
  - number: <span class="m">80</span>
    name: http
    protocol: HTTP
  resolution: DNS
  location: MESH_EXTERNAL

kubectl apply -f services/forum/kubernetes/forum-all.yaml
kubectl apply -f ch5/forum-serviceentry.yaml

</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<hr/>
<h1 id="恢复能力解决应用网络挑战">恢复能力：解决应用网络挑战</h1>
<h2 id="弹性模式">弹性模式</h2>
<ul>
<li>Istio 的服务代理实现了这些开箱即用的基本弹性模式：
<ul>
<li>客户端负载平衡 Client-side load balancing</li>
<li>本地感知负载平衡 Locality-aware load balancing</li>
<li>Circuit breaking 熔断</li>
<li>Timeouts and retries 超时和重试</li>
</ul>
</li>
</ul>
<h2 id="客户端负载平衡">客户端负载平衡</h2>
<blockquote>
<p>ROUND_ROBIN 是默认的负载均衡算法</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl config set-context <span class="k">$(</span>kubectl config current-context<span class="k">)</span> <span class="se">\
</span><span class="se"></span> --namespace<span class="o">=</span>istioinaction
kubectl delete virtualservice,deployment,service,<span class="se">\
</span><span class="se"></span>destinationrule,gateway --all


kubectl apply -f ch6/simple-backend.yaml
kubectl apply -f ch6/simple-web.yaml
kubectl apply -f ch6/simple-web-gateway.yaml

<span class="c1"># 用 Istio DestinationRule 资源为调用 simple-backend 服务的任何客户端指定 ROUND_ROBIN 负载平衡。</span>
curl -s -H <span class="s2">"Host: simple-web.istioinaction.io"</span> http://192.168.8.212


<span class="k">for</span> in in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> <span class="se">\
</span><span class="se"></span>curl -s -H <span class="s2">"Host: simple-web.istioinaction.io"</span> 192.168.8.212 <span class="se">\
</span><span class="se"></span><span class="p">|</span> jq <span class="s2">".upstream_calls[0].body"</span><span class="p">;</span> <span class="nb">printf</span> <span class="s2">"\n"</span><span class="p">;</span> <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><p>​</p>
<h2 id="fortio-负载测试库"><strong>Fortio</strong> 负载测试库</h2>
<blockquote>
<p><a href="https://github.com/fortio/fortio">https://github.com/fortio/fortio</a></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 安装</span>
brew install fortio

<span class="c1"># 运行</span>
kubectl -n default run fortio --image<span class="o">=</span>fortio/fortio:1.60.2 <span class="se">\
</span><span class="se"></span>--restart<span class="o">=</span><span class="s1">'Never'</span> -- load -H <span class="s2">"Host: simple-web.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>-jitter -t 60s -c <span class="m">10</span> -qps <span class="m">1000</span> <span class="se">\
</span><span class="se"></span>http://192.168.8.212
</code></pre></td></tr></table>
</div>
</div><p><strong>测试结果</strong></p>
<ul>
<li>
<p><code>最少连接</code>比随机连接和循环连接的性能都要好</p>
<ul>
<li>最少连接负载平衡器（在 Envoy 中以最少请求方式实现）会考虑特定端点的延迟。</li>
<li>它会监控队列深度，跟踪活动请求，并选择飞行中活动请求最少的端点。利用这种算法，我们可以避免向行为不佳的端点发送请求，而选择响应速度更快的端点。</li>
<li>尽管 Istio 配置将最少请求负载平衡称为 <code>LEAST_CONN</code> ，但 Envoy 追踪的是端点而非连接的请求深度。</li>
</ul>
<p><a href="http://mng.bz/enQJ">http://mng.bz/enQJ</a></p>
</li>
</ul>
<h2 id="本地感知负载平衡">本地感知负载平衡</h2>
<blockquote>
<p>Istio 支持一种负载平衡类型，可根据特定工作负载的位置为路由赋予权重并做出路由决策。Istio 可以识别部署特定服务的区域和可用性区域，并优先考虑距离较近的服务。</p>
</blockquote>
<h3 id="实践">实践</h3>
<p><strong>节点标注</strong></p>
<ul>
<li>
<p>分别指定地区和区域 - 标签</p>
<ul>
<li><code>failure-domain.beta.kubernetes.io/region</code></li>
<li><code>failure-domain.beta.kubernetes.io/zone</code></li>
</ul>
<blockquote>
<p>在 Kubernetes API 最近的通用版本中，这些标签已被 <code>topology.kubernetes.io/region</code> 和 <code>topology.kubernetes.io/zone</code> 所取代。云供应商仍在使用较旧的 <code>failure-domain</code> 标签。<code>Istio</code> 可同时查找这两种标签。</p>
</blockquote>
</li>
</ul>
<p><strong>POD 标注</strong></p>
<ul>
<li>
<p>我们可以用 <code>istio-locality</code> 标记我们的 Pod</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">spec:
  replicas: <span class="m">1</span>
  selector:
    matchLabels:
      app: simple-web
  template:
    metadata:
      labels:
        app: simple-web
        istio-locality: us-west1.us-west1-a    ❶
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p><strong>验证</strong></p>
<blockquote>
<p>默认情况下，Istio 的服务代理会将所有流量发送到同一本地的服务，只有当出现故障或端点不健康时才会溢出。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># Case-1 当 backend-1 存在故障时，将流量切换至 backend-2</span>
kubectl apply -f ch6/simple-service-locality.yaml

<span class="k">for</span> in in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> <span class="se">\
</span><span class="se"></span>curl -s -H <span class="s2">"Host: simple-web.istioinaction.io"</span> 192.168.8.212 <span class="se">\
</span><span class="se"></span><span class="p">|</span> jq <span class="s2">".upstream_calls[0].body"</span><span class="p">;</span> <span class="nb">printf</span> <span class="s2">"\n"</span><span class="p">;</span> <span class="k">done</span>


<span class="c1"># 在 Istio 中实现本地感知负载均衡，我们还需要配置最后一块拼图：健康检查。</span>
kubectl apply -f ch6/simple-backend-dr-outlier.yaml

<span class="k">for</span> in in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> <span class="se">\
</span><span class="se"></span>curl -s -H <span class="s2">"Host: simple-web.istioinaction.io"</span> 192.168.8.212 <span class="se">\
</span><span class="se"></span><span class="p">|</span> jq <span class="s2">".upstream_calls[0].body"</span><span class="p">;</span> <span class="nb">printf</span> <span class="s2">"\n"</span><span class="p">;</span> <span class="k">done</span>


<span class="c1"># 将 backend-1 设置为故障</span>
<span class="k">for</span> <span class="k">for</span> in in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> <span class="se">\
</span><span class="se"></span>curl -s -H <span class="s2">"Host: simple-web.istioinaction.io"</span> 192.168.8.212 <span class="se">\
</span><span class="se"></span><span class="p">|</span> jq <span class="s2">".upstream_calls[0].body"</span><span class="p">;</span> <span class="nb">printf</span> <span class="s2">"\n"</span><span class="p">;</span> <span class="k">done</span>
null
<span class="s2">"Hello from simple-backend-2"</span>
<span class="s2">"Hello from simple-backend-2"</span>
<span class="s2">"Hello from simple-backend-2"</span>
<span class="s2">"Hello from simple-backend-2"</span>
<span class="s2">"Hello from simple-backend-2"</span>
<span class="s2">"Hello from simple-backend-2"</span>
<span class="s2">"Hello from simple-backend-2"</span>
<span class="s2">"Hello from simple-backend-2"</span>
<span class="s2">"Hello from simple-backend-2"</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>利用加权分布对本地负载平衡进行更多控制</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 为了完成这一配置，我们在 DestinationRule 资源中指定了本地化负载均衡首选项：</span>

apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: simple-backend-dr
spec:
  host: simple-backend.istioinaction.svc.cluster.local
  trafficPolicy:
    loadBalancer:                        ❶ 添加负载平衡器配置
      localityLbSetting:
        distribute:
        - from: us-west1/us-west1-a/*    ❷ 来自的区域
          to:
            <span class="s2">"us-west1/us-west1-a/*"</span>: <span class="m">70</span>  ❸ 目的地区域
            <span class="s2">"us-west1/us-west1-b/*"</span>: <span class="m">30</span>  ❹ 目的地区域
    connectionPool:
      http:
        http2MaxRequests: <span class="m">10</span>
        maxRequestsPerConnection: <span class="m">10</span>
    outlierDetection:
      consecutive5xxErrors: <span class="m">1</span>
      interval: 5s
      baseEjectionTime: 30s

<span class="c1"># 应用</span>
kubectl apply -f ch6/simple-backend-dr-outlier-locality.yaml

<span class="k">for</span> <span class="k">for</span> in in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> <span class="se">\
</span><span class="se"></span>curl -s -H <span class="s2">"Host: simple-web.istioinaction.io"</span> 192.168.8.212 <span class="se">\
</span><span class="se"></span><span class="p">|</span> jq <span class="s2">".upstream_calls[0].body"</span><span class="p">;</span> <span class="nb">printf</span> <span class="s2">"\n"</span><span class="p">;</span> <span class="k">done</span>
null
</code></pre></td></tr></table>
</div>
</div><h2 id="透明超时和重试">透明超时和重试</h2>
<blockquote>
<p>在构建依赖分布在网络上的组件的系统时，最大的问题包括延迟和故障。</p>
</blockquote>
<p>分布式环境中最难处理的情况之一就是延迟。当运行速度减慢时，资源可能会被占用更长时间，服务可能会出现倒退，这种情况有可能引发连锁故障。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 重置集群</span>
kubectl apply -f ch6/simple-web.yaml
kubectl apply -f ch6/simple-backend.yaml
kubectl delete destinationrule simple-backend-dr

<span class="k">for</span> in in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> <span class="nb">time</span> curl -s <span class="se">\
</span><span class="se"></span>-H <span class="s2">"Host: simple-web.istioinaction.io"</span> 192.168.8.212  <span class="se">\
</span><span class="se"></span><span class="p">|</span> jq .code<span class="p">;</span> <span class="nb">printf</span> <span class="s2">"\n"</span><span class="p">;</span> <span class="k">done</span>

<span class="c1"># 部署一个 simple-backend 服务版本，为该实例的 50% 调用插入一秒钟的处理延迟：</span>
kubectl apply -f ch6/simple-backend-delayed.yaml


<span class="c1"># 再次请求，有些请求需要一秒钟或更长的时间：</span>
<span class="k">for</span> in in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> <span class="nb">time</span> curl -s <span class="se">\
</span><span class="se"></span>-H <span class="s2">"Host: simple-web.istioinaction.io"</span> 192.168.8.212  <span class="se">\
</span><span class="se"></span><span class="p">|</span> jq .code<span class="p">;</span> <span class="nb">printf</span> <span class="s2">"\n"</span><span class="p">;</span> <span class="k">done</span>
<span class="m">200</span>
curl -s -H <span class="s2">"Host: simple-web.istioinaction.io"</span> 192.168.8.212  0.00s user 0.00s system 0% cpu 1.068 total
jq .code  0.01s user 0.00s system 1% cpu 1.068 total

<span class="m">200</span>
curl -s -H <span class="s2">"Host: simple-web.istioinaction.io"</span> 192.168.8.212  0.00s user 0.01s system 0% cpu 1.035 total
jq .code  0.02s user 0.00s system 1% cpu 1.034 total

<span class="m">200</span>
curl -s -H <span class="s2">"Host: simple-web.istioinaction.io"</span> 192.168.8.212  0.01s user 0.01s system 5% cpu 0.194 total
jq .code  0.03s user 0.00s system 13% cpu 0.194 total


---
<span class="c1">#  在 VirtualService 中指定超时时间</span>
  http:
  - route:
    - destination:
        host: simple-backend
    timeout: 0.5s               ❶ 指定超时值
    
<span class="c1"># 应用</span>
kubectl apply -f ch6/simple-backend-vs-timeout.yaml


<span class="c1"># 再次请求，此时大于 0.5s 的请求，会被判断为 500错误</span>
<span class="k">for</span> <span class="k">for</span> in in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> <span class="nb">time</span> curl -s <span class="se">\
</span><span class="se"></span>-H <span class="s2">"Host: simple-web.istioinaction.io"</span> 192.168.8.212  <span class="se">\
</span><span class="se"></span><span class="p">|</span> jq .code<span class="p">;</span> <span class="nb">printf</span> <span class="s2">"\n"</span><span class="p">;</span> <span class="k">done</span>
<span class="m">200</span>
curl -s -H <span class="s2">"Host: simple-web.istioinaction.io"</span> 192.168.8.212  0.00s user 0.00s system 4% cpu 0.176 total
jq .code  0.02s user 0.00s system 10% cpu 0.175 total

<span class="m">500</span>
curl -s -H <span class="s2">"Host: simple-web.istioinaction.io"</span> 192.168.8.212  0.01s user 0.01s system 2% cpu 0.550 total
jq .code  0.02s user 0.00s system 4% cpu 0.549 total

<span class="m">200</span>
curl -s -H <span class="s2">"Host: simple-web.istioinaction.io"</span> 192.168.8.212  0.01s user 0.01s system 6% cpu 0.188 total
jq .code  0.02s user 0.00s system 14% cpu 0.187 total
</code></pre></td></tr></table>
</div>
</div><p><strong>重试</strong></p>
<ul>
<li>参考文档:
<ul>
<li><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/router_filter#x-envoy-retry-on">https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/router_filter#x-envoy-retry-on</a></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># Reset</span>
kubectl apply -f ch6/simple-web.yaml
kubectl apply -f ch6/simple-backend.yaml

<span class="c1"># Istio 默认启用了重试功能，最多重试两次。让我们禁用示例应用程序的默认重试, 将最大重试次数设置为 0</span>
istioctl install --set <span class="nv">profile</span><span class="o">=</span>demo <span class="se">\
</span><span class="se"></span> --set meshConfig.defaultHttpRetryPolicy.attempts<span class="o">=</span><span class="m">0</span>
 
<span class="c1"># 部署一个有周期性（75%）故障的 simple-backend 服务版本。</span>
kubectl apply -f ch6/simple-backend-periodic-failure-503.yaml

<span class="c1"># 执行 多次调用该服务</span>
<span class="k">for</span> in in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> curl -s <span class="se">\
</span><span class="se"></span>-H <span class="s2">"Host: simple-web.istioinaction.io"</span> 192.168.8.212  <span class="se">\
</span><span class="se"></span><span class="p">|</span> jq .code<span class="p">;</span> <span class="nb">printf</span> <span class="s2">"\n"</span><span class="p">;</span> <span class="k">done</span>
<span class="m">200</span>
curl -s -H <span class="s2">"Host: simple-web.istioinaction.io"</span> 192.168.8.212  0.00s user 0.00s system 3% cpu 0.176 total
jq .code  0.01s user 0.00s system 8% cpu 0.175 total

<span class="m">500</span>
curl -s -H <span class="s2">"Host: simple-web.istioinaction.io"</span> 192.168.8.212  0.00s user 0.01s system 31% cpu 0.034 total
jq .code  0.02s user 0.00s system 74% cpu 0.033 total

<span class="m">500</span>
curl -s -H <span class="s2">"Host: simple-web.istioinaction.io"</span> 192.168.8.212  0.00s user 0.00s system 27% cpu 0.024 total
jq .code  0.02s user 0.00s system 73% cpu 0.023 total


<span class="c1"># 调用 simple-backend 时的重试尝试明确配置为 2</span>
  http:
  - route:
    - destination:
        host: simple-backend
    retries:
      attempts: <span class="m">2</span>
      
kubectl apply -f ch6/simple-backend-enable-retry.yaml

<span class="c1"># 再次查看</span>
<span class="k">for</span> in in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> curl -s <span class="se">\
</span><span class="se"></span>-H <span class="s2">"Host: simple-web.istioinaction.io"</span> 192.168.8.212  <span class="se">\
</span><span class="se"></span><span class="p">|</span> jq .code<span class="p">;</span> <span class="nb">printf</span> <span class="s2">"\n"</span><span class="p">;</span> <span class="k">done</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>

<span class="c1"># 启用了 Istio 的重试策略来解决这些错误。默认情况下，HTTP 503 是可重试状态代码之一。</span>
<span class="c1"># 下面的 VirtualService 重试策略显示了重试时可配置的参数：</span>
  http:
  - route:
    - destination:
        host: simple-backend
    retries:
      attempts: <span class="m">2</span>                                             ❶
      retryOn: gateway-error,connect-failure,retriable-4xx    ❷
      perTryTimeout: 300ms                                    ❸
      retryRemoteLocalities: <span class="nb">true</span>                             ❹
      
❶ 最大重试次数
❷ 需要重试的错误
❸ 超时
❹是否重试其他地区的端点

<span class="c1"># 部署的 simple-backend 服务返回 HTTP 500 代码，默认重试行为将无法捕获</span>
<span class="k">for</span> in in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> curl -s <span class="se">\
</span><span class="se"></span>-H <span class="s2">"Host: simple-web.istioinaction.io"</span> 192.168.8.212  <span class="se">\
</span><span class="se"></span><span class="p">|</span> jq .code<span class="p">;</span> <span class="nb">printf</span> <span class="s2">"\n"</span><span class="p">;</span> <span class="k">done</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">500</span>
<span class="m">200</span>

<span class="c1"># 使用 VirtualService 重试策略，重试所有 HTTP 500 代码（包括 connect-failure 和 refused-stream ）</span>
  http:
  - route:
    - destination:
        host: simple-backend
    retries:
      attempts: <span class="m">2</span>
      retryOn: 5xx     ❶
      
kubectl apply -f ch6/simple-backend-vs-retry-500.yaml

<span class="c1"># 此时执行，将不存在 500 异常</span>
<span class="k">for</span> in in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> curl -s <span class="se">\
</span><span class="se"></span>-H <span class="s2">"Host: simple-web.istioinaction.io"</span> 192.168.8.212  <span class="se">\
</span><span class="se"></span><span class="p">|</span> jq .code<span class="p">;</span> <span class="nb">printf</span> <span class="s2">"\n"</span><span class="p">;</span> <span class="k">done</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="超时计算的重试次数--原理">超时计算的重试次数 &amp; 原理</h3>
<ul>
<li>
<p>每次重试都有自己的 <code>perTryTimeout</code> ,<code>perTryTimeout</code> 值乘以总尝试次数必须小于总请求超时</p>
<ul>
<li>例如，总超时时间为一秒，重试策略为三次，每次重试超时时间为 500 毫秒，这样的设置是行不通的。</li>
</ul>
</li>
<li>
<p>当请求流经 Istio 服务代理时，如果<code>未能向上游交付</code>，则会被<code>标记为失败并重试</code>，重试次数最多可达 <code>VirtualService</code> 资源中定义的最大 <code>attempts</code> 字段。</p>
<ul>
<li>意味着当 <code>attempts</code> 值为 <code>2</code> 时的情况下，请求最多会被交付三次：原始请求一次，重试两次。</li>
</ul>
</li>
<li>
<p>Istio 将以 25 毫秒为基数 “后退 “重试。</p>
<ul>
<li>这意味着每次连续重试时，Istio 都会后退（等待）至（25 毫秒 x 尝试次数 #），以错开重试时间。</li>
<li>重试基础是固定的
<img alt="Pasted image 20230929204213" src="https://cdn.treesir.pub/images/2023/09/29/20230929204218.png"/></li>
</ul>
</li>
<li>
<p><strong>请求失败时重试的请求流程</strong></p>
<ul>
<li>
<p>Istio 默认将重试 <code>attempts</code> 设置为 <code>2</code> 。.您可能希望覆盖此设置，以便系统的不同层重试不同次数。天真的重试设置（如默认设置）会导致严重的重试 “thundering herd “问题</p>
</li>
<li>
<p>例如，如果一个服务链有 5 个深度调用，每个步骤可以重试请求 2 次，那么每个传入请求可能会有<code> 32 个请求</code>。如果服务链末端的资源超载，这些额外的负载可能会使目标资源不堪重负，以至于崩溃。</p>
</li>
<li>
<p>这些额外的负载可能会使目标资源不堪重负，以至于崩溃。处理这种情况的一种方法是，将架构边缘的重试尝试限制为一次或零次，只在调用栈深处重试，中间组件不重试。<code>这可能也不会有很好的效果</code>。另一种策略是对总重试次数设置上限。我们可以通过重试预算来做到这一点，<code>但 Istio API 还没有公开预算</code>。</p>
<ul>
<li>Istio 中存在解决这一问题的变通方法，<code>但不在本书讨论范围之内</code>
<img alt="Pasted image 20230929204741" src="https://cdn.treesir.pub/images/2023/09/29/20230929204744.png"/></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>重试相互复合时的 “thundering herd “效应</strong></p>
<ul>
<li>默认情况下，将尝试对本地区的端点进行重试。retryRemoteLocalities设置会影响此行为：如果将其设置为true，则Istio允许重试溢出到其他地区。在异常检测确定本地首选端点表现不佳之前，这可能非常有用。</li>
</ul>
<h3 id="高级重试">高级重试</h3>
</li>
</ul>
<blockquote>
<p>默认情况下，回退时间为 <code>25 毫秒</code>，可重试代码仅限于 <code>HTTP 503</code>尽管在撰写本文时，Istio API 并未公开这些配置，但我们可以使用 Istio 扩展 API 直接在 Envoy 配置中更改这些值。我们使用 <code>EnvoyFilter</code> API 来实现</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: simple-backend-retry-status-codes
  namespace: istioinaction
spec:
  workloadSelector:
    labels:
      app: simple-web
  configPatches:
  - applyTo: HTTP_ROUTE
    match:
      context: SIDECAR_OUTBOUND
      routeConfiguration:
        vhost:
          name: <span class="s2">"simple-backend.istioinaction.svc.cluster.local:80"</span>
    patch:
      operation: MERGE
      value:
        route:
          retry_policy:                ❶ 直接从Envoy配置中获取
            retry_back_off:
              base_interval: 50ms      ❷ 增加基本间隔
            retriable_status_codes:    ❸ 添加可重试代码
            - <span class="m">408</span>
            - <span class="m">400</span>
            
<span class="c1"># 应用</span>
kubectl apply -f ch6/simple-backend-ef-retry-status-codes.yaml

<span class="c1"># 还希望更新 retryOn 字段，使其包含 retriable-status-codes</span>

apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: simple-backend-vs
spec:
  hosts:
  - simple-backend
  http:
  - route:
    - destination:
        host: simple-backend
    retries:
      attempts: <span class="m">2</span>
      retryOn: 5xx,retriable-status-codes     ❶ 包括可重试的状态码


kubectl apply -f ch6/simple-backend-vs-retry-on.yaml


<span class="c1"># 更新 sample-backend 服务，使其返回 HTTP 408（超时），并验证是否能继续获得 HTTP 200</span>
kubectl apply -f ch6/simple-backend-periodic-failure-408.yaml

<span class="c1"># 验证</span>
<span class="k">for</span> in in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> curl -s <span class="se">\
</span><span class="se"></span>-H <span class="s2">"Host: simple-web.istioinaction.io"</span> 192.168.8.212  <span class="se">\
</span><span class="se"></span><span class="p">|</span> jq .code<span class="p">;</span> <span class="nb">printf</span> <span class="s2">"\n"</span><span class="p">;</span> <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="请求对冲">请求对冲</h3>
<blockquote>
<p>当请求达到其阈值并超时时，我们可以选择配置Envoy，在底层执行所谓的请求hedging。通过请求hedging，如果一个请求超时了，Envoy可以发送另一个请求到不同的主机上，“竞赛”原始的、超时的请求。在这种情况下，如果竞赛的请求成功返回，则将其响应发送给原始下游调用者。如果原始请求在竞赛请求返回之前返回，则将原始请求返回给下游调用者。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 要设置请求对冲，我们可以使用以下 EnvoyFilter 资源：</span>
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: simple-backend-retry-hedge
  namespace: istioinaction
spec:
  workloadSelector:
    labels:
      app: simple-web
  configPatches:
  - applyTo: VIRTUAL_HOST
    match:
      context: SIDECAR_OUTBOUND
      routeConfiguration:
        vhost:
          name: <span class="s2">"simple-backend.istioinaction.svc.cluster.local:80"</span>
    patch:
      operation: MERGE
      value:
        hedge_policy:
          hedge_on_per_try_timeout: <span class="nb">true</span>
</code></pre></td></tr></table>
</div>
</div><p><code>超时和重试的主题并不简单</code>。为服务<code>制定良好</code>的超时和重试策略非常<code>具有挑战性</code>，尤其是考虑到它们是如何串联在一起的。<code>配置错误的超时和重试可能会放大系统架构中的不良行为</code>，以至于使系统超载并引发<code>连锁故障</code>。构建弹性架构的最后一个难题是<code>完全跳过重试</code>：与其重试，不如快速失败。我们可以在一段时间内限制负载，让上游系统恢复，而不是增加负载。为此，我们可以采用熔断技术</p>
<hr/>
<h2 id="使用-istio-熔断">使用 Istio 熔断</h2>
<blockquote>
<p>使用断路功能来帮助防范部分或级联故障。我们希望<code>减少进入不健康系统的流量</code>，从而<code>避免这些系统继续超负荷运行</code>，导致无法恢复。这种方法与房屋电气系统中空气开关的工作原理类似。如果系统出现短路或重复故障，空气开关就会保护系统的其他部分。熔断器模式迫使我们的应用程序处理网络调用可能发生故障的事实，并有助于保护整个系统免受连锁故障的影响。</p>
</blockquote>
<h3 id="无法正常工作的熔断方法">无法正常工作的熔断方法</h3>
<blockquote>
<p>如果有十个请求正在向某个服务发送，而且在相同的入站负载量下，请求数量还在不断增加，那么继续发送请求就没有意义了–发送更多请求可能会使上游服务不堪重负。我们使用目标规则中的 <code>connectionPool</code> 设置来限制调用服务时可能堆积的连接和请求数量。如果请求堆积过多，我们可以短路（快速失败）并返回客户端。</p>
<p>第二种控制方法是观察 <code>负载平衡池中端点的健康状况</code>，并 <code>暂时驱逐行为不端的端点</code>。</p>
</blockquote>
<p><strong>利用连接池控制防止服务速度过慢</strong></p>
<ul>
<li>maxConnections-我们报告连接溢出的阈值。Istio代理（Envoy）使用连接来服务请求，上限由此设置定义。实际上，我们可以预期最大连接数为负载均衡池中每个端点加上此设置的值。每当超过这个值时，Envoy将在其指标中报告。</li>
<li>http1MaxPendingRequests-允许挂起且没有可用连接的请求数。</li>
<li>http2MaxRequests-Istio中不幸地命名错误。在底层，它控制着集群中所有端点/主机之间并行请求的最大数量，无论是HTTP2还是HTTP1.1（参见https://github.com/istio/istio/issues/27473）。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">
<span class="c1"># 引入一秒钟的延迟</span>
kubectl apply -f ch6/simple-backend-delayed.yaml


<span class="c1"># 删除目的地规则</span>
kubectl delete destinationrule --all

fortio load -H <span class="s2">"Host: simple-web.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>-quiet -jitter -t 30s -c <span class="m">1</span> -qps <span class="m">1</span> http://192.168.8.212/
Error cases : count <span class="m">0</span> avg <span class="m">0</span> +/- <span class="m">0</span> min <span class="m">0</span> max <span class="m">0</span> sum <span class="m">0</span>
<span class="c1"># Socket and IP used for each connection:</span>
<span class="o">[</span>0<span class="o">]</span>   <span class="m">1</span> socket used, resolved to 192.168.8.212:80, connection timing : count <span class="m">1</span> avg 0.000936291 +/- <span class="m">0</span> min 0.000936291 max 0.000936291 sum 0.000936291
Sockets used: <span class="m">1</span> <span class="o">(</span><span class="k">for</span> perfect keepalive, would be 1<span class="o">)</span>
Uniform: false, Jitter: true, Catchup allowed: <span class="nb">true</span>
IP addresses distribution:
192.168.8.212:80: <span class="m">1</span>
Code <span class="m">200</span> : <span class="m">30</span> <span class="o">(</span>100.0 %<span class="o">)</span>
All <span class="k">done</span> <span class="m">30</span> calls <span class="o">(</span>plus <span class="m">1</span> warmup<span class="o">)</span> 1029.536 ms avg, 1.0 qp

<span class="c1">#引入一些连接和请求限制</span>
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: simple-backend-dr
spec:
  host: simple-backend.istioinaction.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: <span class="m">1</span>               ❶ 连接总数
      http:
        http1MaxPendingRequests: <span class="m">1</span>      ❷ 排队请求
        maxRequestsPerConnection: <span class="m">1</span>     ❸ 每个连接的请求数量
        maxRetries: <span class="m">1</span>
        http2MaxRequests: <span class="m">1</span>             ❹ 所有主机的最大并发请求数量
        
kubectl apply -f ch6/simple-backend-dr-conn-limit.yaml

fortio load -H <span class="s2">"Host: simple-web.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>-quiet -jitter -t 30s -c <span class="m">1</span> -qps <span class="m">1</span> http://192.168.8.212
Code <span class="m">200</span> : <span class="m">30</span> <span class="o">(</span>100.0 %<span class="o">)</span>

fortio load -H <span class="s2">"Host: simple-web.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>-quiet -jitter -t 30s -c <span class="m">2</span> -qps <span class="m">2</span> -allow-initial-errors http://192.168.8.212
Code <span class="m">200</span> : <span class="m">31</span> <span class="o">(</span>60.8 %<span class="o">)</span>
Code <span class="m">500</span> : <span class="m">20</span> <span class="o">(</span>39.2 %<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>请求返回失败（HTTP 5xx）。我们如何确定这些请求是受断路影响，而不是上游故障？</p>
<ul>
<li>
<p>要确定这些信息，我们需要在 Istio 服务代理中启用更多统计数据收集功能。默认情况下，Istio 的服务代理（Envoy）会为每个群集保存大量统计数据，<code>但 Istio 会对这些数据进行缩减</code>，以免大量统计数据使收集代理（如 <code>Prometheus</code>）不堪重负。</p>
</li>
<li>
<p>为了扩展 Istio 公开的统计数据，尤其是上游断路统计数据，我们在 <code>simple-web</code> 中使用了 <code>annotations</code></p>
<ul>
<li>
<p>sidecar.istio.io/statsInclusionPrefixes</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">template:
    metadata:
      annotations:
        sidecar.istio.io/statsInclusionPrefixes: 
➥<span class="s2">"cluster.outbound|80||simple-backend.istioinaction.svc.cluster.local"</span>
      labels:
        app: simple-web
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 在 simple-web 中  应用注释</span>
kubectl apply -f ch6/simple-web-stats-incl.yaml

<span class="c1"># 重置 simple-web 服务中 Istio 代理的所有统计数据</span>
kubectl <span class="nb">exec</span> -it deploy/simple-web -c istio-proxy <span class="se">\
</span><span class="se"></span>-- curl -X POST localhost:15000/reset_counters
OK

<span class="c1"># 再次产生负载时</span>
fortio load -H <span class="s2">"Host: simple-web.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>-quiet -jitter -t 30s -c <span class="m">2</span> -qps <span class="m">2</span> -allow-initial-errors http://192.168.8.212
Code <span class="m">200</span> : <span class="m">30</span> <span class="o">(</span>55.6 %<span class="o">)</span>
Code <span class="m">500</span> : <span class="m">24</span> <span class="o">(</span>44.4 %<span class="o">)</span>

<span class="c1"># 运行下面的查询</span>
kubectl <span class="nb">exec</span> -it deploy/simple-web -c istio-proxy <span class="se">\
</span><span class="se"></span>-- curl localhost:15000/stats <span class="p">|</span> grep simple-backend <span class="p">|</span> grep overflow
cluster.outbound<span class="p">|</span>80<span class="o">||</span>simple-backend.istioinaction.svc.cluster.local.upstream_cx_overflow: <span class="m">53</span>
cluster.outbound<span class="p">|</span>80<span class="o">||</span>simple-backend.istioinaction.svc.cluster.local.upstream_cx_pool_overflow: <span class="m">0</span>
cluster.outbound<span class="p">|</span>80<span class="o">||</span>simple-backend.istioinaction.svc.cluster.local.upstream_rq_pending_overflow: <span class="m">25</span>
cluster.outbound<span class="p">|</span>80<span class="o">||</span>simple-backend.istioinaction.svc.cluster.local.upstream_rq_retry_overflow: <span class="m">0</span>

<span class="c1"># upstream_cx_overflow 和 upstream_rq_pending_overflow 。这表明有足够多的连接和请求超过了我们指定的阈值（并行请求过多或排队请求过多），导致空气开关跳闸。</span>

<span class="c1"># 增加 http2MaxRequests 字段，以应对并行发生的更多请求呢？让我们将该值提高到 2 重置计数器，然后重新运行负载测试</span>
kubectl patch destinationrule simple-backend-dr --type merge <span class="se">\
</span><span class="se"></span>--patch <span class="se">\
</span><span class="se"></span><span class="s1">'{"spec": {"trafficPolicy": {"connectionPool": {
</span><span class="s1">  "http": {"http2MaxRequests": 2}}}}}'</span>
  
kubectl <span class="nb">exec</span> -it deploy/simple-web -c istio-proxy <span class="se">\
</span><span class="se"></span>-- curl -X POST localhost:15000/reset_counters

fortio load -H <span class="s2">"Host: simple-web.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>-quiet -jitter -t 30s -c <span class="m">2</span> -qps <span class="m">2</span> -allow-initial-errors http://192.168.8.212
Code <span class="m">200</span> : <span class="m">31</span> <span class="o">(</span>100.0 %<span class="o">)</span>

<span class="c1"># 熔断而受阻的请求减少：</span>
kubectl <span class="nb">exec</span> -it deploy/simple-web -c istio-proxy <span class="se">\
</span><span class="se"></span>-- curl localhost:15000/stats <span class="p">|</span> grep simple-backend <span class="p">|</span> grep overflow
cluster.outbound<span class="p">|</span>80<span class="o">||</span>simple-backend.istioinaction.svc.cluster.local.upstream_cx_overflow: <span class="m">35</span>
cluster.outbound<span class="p">|</span>80<span class="o">||</span>simple-backend.istioinaction.svc.cluster.local.upstream_cx_pool_overflow: <span class="m">0</span>
cluster.outbound<span class="p">|</span>80<span class="o">||</span>simple-backend.istioinaction.svc.cluster.local.upstream_rq_pending_overflow: <span class="m">1</span>
cluster.outbound<span class="p">|</span>80<span class="o">||</span>simple-backend.istioinaction.svc.cluster.local.upstream_rq_retry_overflow: <span class="m">0</span>


<span class="c1"># 将待处理队列深度增加到 2 </span>
kubectl patch destinationrule simple-backend-dr --type merge <span class="se">\
</span><span class="se"></span>--patch <span class="se">\
</span><span class="se"></span><span class="s1">'{"spec": {"trafficPolicy": {"connectionPool": {
</span><span class="s1">  "http": {"http1MaxPendingRequests": 2}}}}}'</span>
  
kubectl <span class="nb">exec</span> -it deploy/simple-web -c istio-proxy <span class="se">\
</span><span class="se"></span>-- curl -X POST localhost:15000/reset_counters

fortio load -H <span class="s2">"Host: simple-web.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>-quiet -jitter -t 30s -c <span class="m">2</span> -qps <span class="m">2</span> -allow-initial-errors http://192.168.8.212
Code <span class="m">200</span> : <span class="m">32</span> <span class="o">(</span>100.0 %<span class="o">)</span>

<span class="c1"># 此时发生触发熔断重试为 0</span>
kubectl <span class="nb">exec</span> -it deploy/simple-web -c istio-proxy <span class="se">\
</span><span class="se"></span>-- curl localhost:15000/stats <span class="p">|</span> grep simple-backend <span class="p">|</span> grep overflow
cluster.outbound<span class="p">|</span>80<span class="o">||</span>simple-backend.istioinaction.svc.cluster.local.upstream_cx_overflow: <span class="m">41</span>
cluster.outbound<span class="p">|</span>80<span class="o">||</span>simple-backend.istioinaction.svc.cluster.local.upstream_cx_pool_overflow: <span class="m">0</span>
cluster.outbound<span class="p">|</span>80<span class="o">||</span>simple-backend.istioinaction.svc.cluster.local.upstream_rq_pending_overflow: <span class="m">0</span>
cluster.outbound<span class="p">|</span>80<span class="o">||</span>simple-backend.istioinaction.svc.cluster.local.upstream_rq_retry_overflow: <span class="m">0</span>
</code></pre></td></tr></table>
</div>
</div><p><code>upstream_rq_retry_overflow</code> ：由于断路器触发或超出重试预算，未重新尝试的总请求数量。</p>
<p><code>upstream_cx_overflow</code> :集群连接断路器溢出的总次数</p>
<blockquote>
<p>更多参数详情请参考: <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/upstream/cluster_manager/cluster_stats">https://www.envoyproxy.io/docs/envoy/latest/configuration/upstream/cluster_manager/cluster_stats</a></p>
</blockquote>
<p>当请求因触及断路阈值而失败时，Istio 的服务代理会添加一个 <code>x-envoy-overloaded</code> 头信息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">...
<span class="s2">"upstream_calls"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"uri"</span>: <span class="s2">"http://simple-backend:80/"</span>,
      <span class="s2">"headers"</span>: <span class="o">{</span>
        <span class="s2">"Content-Length"</span>: <span class="s2">"81"</span>,
        <span class="s2">"Content-Type"</span>: <span class="s2">"text/plain"</span>,
        <span class="s2">"Date"</span>: <span class="s2">"Tue, 22 Sep 2020 20:01:44 GMT"</span>,
        <span class="s2">"Server"</span>: <span class="s2">"envoy"</span>,
        <span class="s2">"x-envoy-overloaded"</span>: <span class="s2">"true"</span>      ❶
      <span class="o">}</span>,
...
</code></pre></td></tr></table>
</div>
</div><h3 id="通过异常值检测来防范不健康的服务">通过异常值检测来防范不健康的服务</h3>
<p>配置参考文档: <a href="https://istio.io/latest/docs/reference/config/networking/destination-rule/">https://istio.io/latest/docs/reference/config/networking/destination-rule/</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl apply -f ch6/simple-backend.yaml
kubectl delete destinationrule --all

kubectl apply -f ch6/simple-web-stats-incl.yaml

<span class="c1"># 禁用整个网格的重试功能， 删除任何已配置重试的 VirtualService 资源</span>
istioctl install --set <span class="nv">profile</span><span class="o">=</span>demo <span class="se">\
</span><span class="se"></span> --set meshConfig.defaultHttpRetryPolicy.attempts<span class="o">=</span><span class="m">0</span>
 
kubectl delete vs simple-backend-vs


<span class="c1"># 75% 的 simple-backend-1 端点调用都会以 HTTP 500 失败</span>
kubectl apply -f ch6/simple-backend-periodic-failure-500.yaml

fortio load -H <span class="s2">"Host: simple-web.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>-allow-initial-errors -quiet -jitter -t 30s -c <span class="m">10</span> -qps <span class="m">20</span> -allow-initial-errors http://192.168.8.212
Sockets used: <span class="m">304</span> <span class="o">(</span><span class="k">for</span> perfect keepalive, would be 10<span class="o">)</span>
Uniform: false, Jitter: true, Catchup allowed: <span class="nb">true</span>
IP addresses distribution:
Code <span class="m">200</span> : <span class="m">304</span> <span class="o">(</span>50.7 %<span class="o">)</span>
Code <span class="m">500</span> : <span class="m">296</span> <span class="o">(</span>49.3 %<span class="o">)</span>

<span class="c1"># 配置离群点检测 示例</span>
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: simple-backend-dr
spec:
  host: simple-backend.istioinaction.svc.cluster.local
  trafficPolicy:
    outlierDetection:
      consecutive5xxErrors: <span class="m">1</span> <span class="c1"># 配置为 1 值。这意味着异常点检测只会在一个坏请求后跳闸</span>
      interval: 5s <span class="c1"># 设置指定 Istio 服务代理检查主机的频率，并根据 consecutive5xxErrors 设置决定是否弹出端点。</span>
      baseEjectionTime: 5s <span class="c1"># 如果服务端点被弹出，则弹出时间为 n * baseEjectionTime 。其中 n 是该端点被弹出的次数。时间结束后，该端点将重新加入负载平衡池。</span>
      maxEjectionPercent: <span class="m">100</span> <span class="c1"># 上游服务负载均衡池中可被剔除的最大主机百分比。默认为10%。</span>
      
kubectl apply -f ch6/simple-backend-dr-outlier-5s.yaml

fortio load -H <span class="s2">"Host: simple-web.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>-allow-initial-errors -quiet -jitter -t 30s -c <span class="m">10</span> -qps <span class="m">20</span> -allow-initial-errors http://192.168.8.212
Code <span class="m">200</span> : <span class="m">581</span> <span class="o">(</span>96.8 %<span class="o">)</span>
Code <span class="m">500</span> : <span class="m">19</span> <span class="o">(</span>3.2 %<span class="o">)</span>

<span class="c1"># 由于行为不端的端点被弹出一段时间，我们的错误率大幅降低。不过，我们仍有 19 次调用失败。为了证明这些错误是由行为不端的端点造成的，我们可以检查统计数据：</span>

kubectl <span class="nb">exec</span> -it deploy/simple-web -c istio-proxy -- <span class="se">\
</span><span class="se"></span>curl localhost:15000/stats <span class="p">|</span> grep simple-backend <span class="p">|</span> grep outlier

<span class="c1"># simple-backend-1 主机被弹出三次。</span>

<span class="c1"># 添加默认重试设置，解决最后几个错误。我们可以添加默认重试设置为，总计3。</span>
istioctl install --set <span class="nv">profile</span><span class="o">=</span>demo  <span class="se">\
</span><span class="se"></span>  --set meshConfig.defaultHttpRetryPolicy.attempts<span class="o">=</span><span class="m">2</span>

<span class="c1"># vs 重建一下，再次执行测试</span>
fortio load -H <span class="s2">"Host: simple-web.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>-allow-initial-errors -quiet -jitter -t 30s -c <span class="m">10</span> -qps <span class="m">20</span> -allow-initial-errors http://192.168.8.212
Code <span class="m">200</span> : <span class="m">600</span> <span class="o">(</span>100.0 %<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><hr/>
<h1 id="可观察性">可观察性</h1>
<blockquote>
<p>可观察性是系统的一种特性，它是通过观察系统的外部信号和特征来了解和推理系统内部状态的程度来衡量的。</p>
</blockquote>
<p><strong>文档</strong></p>
<h2 id="了解服务状态">了解服务状态</h2>
<ul>
<li>Metrics 说明:  <a href="https://istio.io/latest/docs/reference/config/metrics/">https://istio.io/latest/docs/reference/config/metrics/</a>
<ul>
<li><code>istio_requests_total</code>: 从入口网关向服务发出的请求的指标</li>
<li><code>istio_request_bytes</code></li>
<li><code>istio_response_bytes</code></li>
<li><code>istio_request_duration</code></li>
<li><code>istio_request_duration_milliseconds</code></li>
</ul>
</li>
<li>Envoy 在识别流量时有一个内部来源和外部来源的概念。内部流量通常指来自网状网内部的流量，外部流量指来自网状网外部的流量（进入入口网关的流量）。
<ul>
<li>通过 <code>cluster_name.internal.*</code> 指标，我们可以查看有多少成功请求来自内部或网状网络内部：</li>
<li><code>cluster_name.ssl.*</code> 指标 , 确定流量是否通过 TLS 进入上游群集，以及与连接相关的任何其他细节（密码、曲线等等）</li>
</ul>
</li>
<li>各 Envoy cluster 指标说明:  <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/upstream/cluster_manager/cluster_stats#general">https://www.envoyproxy.io/docs/envoy/latest/configuration/upstream/cluster_manager/cluster_stats#general</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> /Users/yangzun/Desktop/istio-1.19.0

kubectl delete -f samples/addons/


<span class="c1"># 清理</span>
kubectl config set-context <span class="k">$(</span>kubectl config current-context<span class="k">)</span> <span class="se">\
</span><span class="se"></span> --namespace<span class="o">=</span>istioinaction
kubectl delete virtualservice,deployment,service,<span class="se">\
</span><span class="se"></span>destinationrule,gateway --all


<span class="c1"># 部署应用</span>
kubectl apply -f services/catalog/kubernetes/catalog.yaml
kubectl apply -f services/webapp/kubernetes/webapp.yaml
kubectl apply -f services/webapp/istio/webapp-catalog-gw-vs.yaml


<span class="c1"># 测试</span>
curl -H <span class="s2">"Host: webapp.istioinaction.io"</span> http://192.168.8.212/api/catalog

<span class="c1"># 查看 webapp 的统计数据</span>

kubectl <span class="nb">exec</span> -it deploy/webapp -c istio-proxy <span class="se">\
</span><span class="se"></span>-- curl localhost:15000/stats

<span class="c1"># 使用  pilot-agent 查看，help: pilot-agent request GET help</span>
kubectl <span class="nb">exec</span> -it deploy/webapp -c istio-proxy <span class="se">\
</span><span class="se"></span> -- pilot-agent request GET stats
 
 
 <span class="c1"># 配置代理以报告更多特使统计数据</span>
spec:
  profile: demo
  meshConfig:
    defaultConfig:                                    ❶ 为所有服务定义默认代理配置
      proxyStatsMatcher:                              ❷ 自定义报告的指标
        inclusionPrefixes:                            ❸ 与前缀匹配的指标将与默认指标一起报告。
        - <span class="s2">"cluster.outbound|80||catalog.istioinaction"</span>
        
<span class="c1"># 在整个网格中增加收集的度量指标可能会使度量指标收集系统超负荷，因此应该非常谨慎。更好的方法是以注释的形式按工作量指定所包含的指标。</span>
metadata:
 annotations:
   proxy.istio.io/config: <span class="p">|</span>-    ❶
     proxyStatsMatcher:
       inclusionPrefixes:
       - <span class="s2">"cluster.outbound|80||catalog.istioinaction"</span>
       
kubectl apply -f ch7/webapp-deployment-stats-inclusion.yaml

curl -H <span class="s2">"Host: webapp.istioinaction.io"</span> http://192.168.8.212/api/catalog

kubectl <span class="nb">exec</span> -it deploy/webapp -c istio-proxy <span class="se">\
</span><span class="se"></span>-- curl localhost:15000/stats <span class="p">|</span> grep catalog
...
cluster.outbound<span class="p">|</span>80<span class="o">||</span>catalog.istioinaction.svc.cluster.local.bind_errors: <span class="m">0</span>
cluster.outbound<span class="p">|</span>80<span class="o">||</span>catalog.istioinaction.svc.cluster.local.circuit_breakers.default.cx_open: <span class="m">0</span>
cluster.outbound<span class="p">|</span>80<span class="o">||</span>catalog.istioinaction.svc.cluster.local.circuit_breakers.default.cx_pool_open: <span class="m">0</span>
...

<span class="c1"># 查询，列出代理知道的所有后端群集及其各自端点的信息</span>
<span class="c1"># 该查询能够输出，端点位于哪个区域、区域和子区域；以及该上游端点的任何活动请求或错误。上一组统计数据提供的是整个集群的数据。通过这组统计信息，我们可以看到每个端点的详细信息。</span>
<span class="c1"># https://www.envoyproxy.io/docs/envoy/latest/configuration/upstream/cluster_manager/cluster_stats#general</span>
kubectl <span class="nb">exec</span> -it deploy/webapp -c istio-proxy <span class="se">\
</span><span class="se"></span>-- curl localhost:15000/clusters<span class="p">|</span>grep catalog
</code></pre></td></tr></table>
</div>
</div><h2 id="控制平面中的指标">控制平面中的指标</h2>
<blockquote>
<p><a href="https://istio.io/latest/docs/reference/commands/pilot-discovery/#metrics">https://istio.io/latest/docs/reference/commands/pilot-discovery/#metrics</a></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 要查看控制平面指标</span>
kubectl <span class="nb">exec</span> -it -n istio-system deploy/istiod -- curl localhost:15014/metrics
</code></pre></td></tr></table>
</div>
</div><h2 id="使用-prometheus-抓取-istio-指标">使用 Prometheus 抓取 Istio 指标</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 查看 公开的 Prometheus </span>
kubectl <span class="nb">exec</span> -it deploy/webapp -c istio-proxy <span class="se">\
</span><span class="se"></span>-- curl localhost:15090/stats/prometheus
</code></pre></td></tr></table>
</div>
</div><p><strong>a安装 Prometheus 和 Grafana</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> ~/Desktop/istio-1.19.0 

kubectl delete -f samples/addons/

<span class="c1"># 使用 helm 安装 prometheus</span>
helm repo add prometheus-community <span class="se">\
</span><span class="se"></span>https://prometheus-community.github.io/helm-charts

helm repo update

kubectl create ns prometheus

helm pull prometheus-community/kube-prometheus-stack --untar

helm install prom ./kube-prometheus-stack <span class="se">\
</span><span class="se"></span>-n prometheus -f kube-prometheus-stack/values-prod.yaml
</code></pre></td></tr></table>
</div>
</div><p><strong>创建 ServiceMonitor 监控 istio</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: istio-component-monitor
  namespace: prometheus
  labels:
    monitoring: istio-components
    release: prom
spec:
  jobLabel: istio
  targetLabels: <span class="o">[</span>app<span class="o">]</span>
  selector:
    matchExpressions:
    - <span class="o">{</span>key: istio, operator: In, values: <span class="o">[</span>pilot<span class="o">]}</span>
  namespaceSelector:
    any: <span class="nb">true</span>
  endpoints:
  - port: http-monitoring
    interval: 15s
    
---
kubectl apply -f ch7/service-monitor-cp.yaml


kubectl -n prometheus port-forward <span class="se">\
</span><span class="se"></span>statefulset/prometheus-prom-kube-prometheus-stack-prometheus <span class="m">9090</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>配置 <code>PodMonitor</code> 资源，抓取包含 <code>istio-proxy</code> 容器的每个 Pod 的指标</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: envoy-stats-monitor
  namespace: prometheus
  labels:
    monitoring: istio-proxies
    release: prom
spec:
  selector:
    matchExpressions:
    - <span class="o">{</span>key: istio-prometheus-ignore, operator: DoesNotExist<span class="o">}</span>
  namespaceSelector:
    any: <span class="nb">true</span>
  jobLabel: envoy-stats
  podMetricsEndpoints:
  - path: /stats/prometheus
    interval: 15s
    relabelings:
    - action: keep
      sourceLabels: <span class="o">[</span>__meta_kubernetes_pod_container_name<span class="o">]</span>
      regex: <span class="s2">"istio-proxy"</span>
    - action: keep
      sourceLabels: <span class="o">[</span>__meta_kubernetes_pod_annotationpresent_prometheus_io_scrape<span class="o">]</span>
    - sourceLabels: <span class="o">[</span>__address__, __meta_kubernetes_pod_annotation_prometheus_io_port<span class="o">]</span>
      action: replace
      regex: <span class="o">([</span>^:<span class="o">]</span>+<span class="o">)(</span>?::<span class="se">\d</span>+<span class="o">)</span>?<span class="p">;</span><span class="o">(</span><span class="se">\d</span>+<span class="o">)</span>
      replacement: <span class="nv">$1</span>:<span class="nv">$2</span>
      targetLabel: __address__
    - action: labeldrop
      regex: <span class="s2">"__meta_kubernetes_pod_label_(.+)"</span>
    - sourceLabels: <span class="o">[</span>__meta_kubernetes_namespace<span class="o">]</span>
      action: replace
      targetLabel: namespace
    - sourceLabels: <span class="o">[</span>__meta_kubernetes_pod_name<span class="o">]</span>
      action: replace
      targetLabel: pod_name
      
---
kubectl apply -f ch7/pod-monitor-dp.yaml

<span class="c1"># 为数据平面生成一些负载</span>
<span class="k">for</span> i in <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do</span> curl http://192.168.8.212/api/catalog -H <span class="se">\
</span><span class="se"></span><span class="s2">"Host: webapp.istioinaction.io"</span><span class="p">;</span> sleep .5s<span class="p">;</span>  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>标准指标</strong></p>
<blockquote>
<p><a href="https://istio.io/latest/docs/reference/config/metrics">https://istio.io/latest/docs/reference/config/metrics</a></p>
</blockquote>
<table>
<thead>
<tr>
<th>istio_requests_total</th>
<th>每个请求都会递增的 COUNTER</th>
</tr>
</thead>
<tbody>
<tr>
<td>istio_request_duration_milliseconds</td>
<td>每次请求通过时递增的计数器</td>
</tr>
<tr>
<td>istio_request_bytes</td>
<td>测量请求体大小的分布</td>
</tr>
<tr>
<td>istio_response_bytes</td>
<td>测量响应主体大小的分布</td>
</tr>
<tr>
<td>istio_request_messages_total</td>
<td>(gRPC) 对于来自客户端的报文，计数器递增</td>
</tr>
<tr>
<td>istio_response_messages_total</td>
<td>(gRPC) 从服务器发送的信息的 COUNTER 递增</td>
</tr>
</tbody>
</table>
<h2 id="envoy-请求属性">Envoy 请求属性</h2>
<blockquote>
<p><a href="https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/advanced/attributes#request-attributes">https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/advanced/attributes#request-attributes</a></p>
</blockquote>
<table>
<thead>
<tr>
<th>属性</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>request.path</td>
<td>URL 的路径部分</td>
</tr>
<tr>
<td>request.url_path</td>
<td>不含查询字符串的 URL 路径部分</td>
</tr>
<tr>
<td>request.host</td>
<td>URL 的主机部分</td>
</tr>
<tr>
<td>request.scheme</td>
<td>URL 的方案部分（如 “http）</td>
</tr>
<tr>
<td>request.method</td>
<td>请求方法（如 “GET）</td>
</tr>
<tr>
<td>request.headers</td>
<td>以小写标头名称为索引的所有请求标头</td>
</tr>
<tr>
<td>request.referer</td>
<td>请求标头</td>
</tr>
<tr>
<td>request.useragent</td>
<td>用户代理请求标头</td>
</tr>
<tr>
<td>request.time</td>
<td>收到第一个字节的时间</td>
</tr>
<tr>
<td>request.id</td>
<td>与x-request-id头部值对应的请求ID</td>
</tr>
<tr>
<td>request.protocol</td>
<td>请求协议</td>
</tr>
</tbody>
</table>
<p><strong>其他属性</strong></p>
<ul>
<li>Response</li>
<li>Connection</li>
<li>Upstream</li>
<li>Metadata/filter state</li>
<li>Wasm</li>
</ul>
<h2 id="配置现有指标">配置现有指标</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 查看已安装的 envoyfilter</span>

kubectl get envoyfilter -n istio-system


    value:
      name: istio.stats       ❶ 过滤器名称
      typed_config:
        <span class="s1">'@type'</span>: type.googleapis.com/udpa.type.v1.TypedStruct
        type_url: type.googleapis.com/
          envoy.extensions.filters.http.wasm.v3.Wasm
        value:
          config:             ❷ 过滤器配置
            configuration:
</code></pre></td></tr></table>
</div>
</div><p><strong>为现有指标增加维度</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 添加 upstream_proxy_version 和 source_mesh_id 维度</span>
  profile: demo
  values:
    telemetry:
      v2:
        prometheus:
          configOverride:
            inboundSidecar:
              metrics:
              - name: requests_total
                dimensions:                                ❶ 新增维度
                  upstream_proxy_version: upstream_peer.istio_version
                  source_mesh_id: node.metadata<span class="o">[</span><span class="s1">'MESH_ID'</span><span class="o">]</span>
                tags_to_remove:                            ❷ 要删除的标记列表
                - request_protocol
            outboundSidecar:
            
istioctl install -f ch7/metrics/istio-operator-new-dimensions.yaml -y

<span class="c1"># 让 Istio 的代理知道它。为此，我们必须使用 sidecar.istio.io/extraStatTags 注解注释部署 Pod 规范。</span>
<span class="c1"># 注意，该注解需要放在 spec.template.metadata Pod 模板上，而不是部署元数据本身</span>
spec:
  replicas: <span class="m">1</span>
  selector:
    matchLabels:
      app: webapp
  template:
    metadata:
      annotations:
        proxy.istio.io/config: <span class="p">|</span>-
          extraStatTags:
          - <span class="s2">"upstream_proxy_version"</span>
          - <span class="s2">"source_mesh_id"</span>
      labels:
        app: webapp

kubectl -n istioinaction apply -f <span class="se">\
</span><span class="se"></span>ch7/metrics/webapp-deployment-extrastats.yaml


curl -H <span class="s2">"Host: webapp.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>http://192.168.8.212/api/catalog

kubectl -n istioinaction <span class="nb">exec</span> -it deploy/webapp -c istio-proxy <span class="se">\
</span><span class="se"></span>-- curl localhost:15000/stats/prometheus <span class="p">|</span> grep istio_requests_total

<span class="c1"># 您应该会看到类似下面的内容（您可能会看到两个条目：一个是入站流量，一个是出站流量）：</span>
istio_requests_total<span class="o">{</span>
	...
	<span class="nv">source_mesh_id</span><span class="o">=</span><span class="s2">"cluster.local"</span>,
	<span class="nv">upstream_proxy_version</span><span class="o">=</span><span class="s2">"1.19.0"</span><span class="o">}</span> <span class="m">1</span>
	
<span class="c1"># 另外请注意， request_protocol 维度不在维度列表中，因为我们在之前的配置中删除了它</span>
</code></pre></td></tr></table>
</div>
</div><p>Istio 在 Istio 1.12 中引入了新的 <code>Telemetry API</code>，为用户配置度量指标提供了更多灵活性和控制。在本节中，我们使用 <code>IstioOperator</code> 来安装新的度量配置，但这种方法会对度量进行全局配置。如果我们想将指标配置限制在 <code>单个命名空间或单个工作负载</code>，可以使用新的遥测 API。</p>
<p><a href="https://istio.io/latest/docs/reference/config/telemetry/#Telemetry">https://istio.io/latest/docs/reference/config/telemetry/#Telemetry</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 等效上面操作的示例 </span>
apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: add-dimension-tags
  namespace: istioinaction
spec:
  metrics:
  - providers:
      - name: prometheus
    overrides:
      - match: 
          metric: REQUEST_COUNT
          mode: CLIENT_AND_SERVER
        disabled: <span class="nb">false</span>
        tagOverrides:
          upstream_proxy_version:
            operation: UPSERT
            value: upstream_peer.istio_version
          source_mesh_id: 
            operation: UPSERT
            value: node.metadata<span class="o">[</span><span class="s1">'MESH_ID'</span><span class="o">]</span>
          request_protocol:
            operation: REMOVE
            
kubectl apply -f ch7/metrics/v2/add-dimensions-telemetry.yaml
</code></pre></td></tr></table>
</div>
</div><h2 id="创建新指标">创建新指标</h2>
<blockquote>
<p>创建一个名为istio_get_calls的新指标，但请注意我们将其定义为get_calls。如前所述，istio_前缀会自动添加。我们将此指标定义为COUNTER，但也可以选择GAUGE和HISTOGRAM。该指标的值是一个字符串，它是一个通用表达式语言（CEL；https://opensource.google/projects/cel）表达式，必须返回整数以满足COUNTER类型要求。这个CEL表达式操作属性，在这种情况下，我们计算的是HTTP GET请求的数量。</p>
<p>新版本中，可以使用 <code>Telemetry</code> (Alpha) 资源来控制指标生成，具体文档 ：</p>
<ul>
<li><a href="https://istio.io/latest/zh/docs/tasks/observability/metrics/telemetry-api/">https://istio.io/latest/zh/docs/tasks/observability/metrics/telemetry-api/</a></li>
<li><a href="https://istio.io/latest/zh/docs/tasks/observability/metrics/customize-metrics/">https://istio.io/latest/zh/docs/tasks/observability/metrics/customize-metrics/</a></li>
</ul>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 示例, 为 stats 插件配置新的度量定义</span>
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  profile: demo
  values:
    telemetry:
      v2:
        prometheus:
          configOverride:
            inboundSidecar:
              definitions:
              - name: get_calls
                type: COUNTER
                value: <span class="s2">"(request.method.startsWith('GET') ? 1 : 0)"</span>
            outboundSidecar:
              definitions:
              - name: get_calls
                type: COUNTER
                value: <span class="s2">"(request.method.startsWith('GET') ? 1 : 0)"</span>
            gateway:
              definitions:
              - name: get_calls
                type: COUNTER
                value: <span class="s2">"(request.method.startsWith('GET') ? 1 : 0)"</span>

istioctl install -f ch7/metrics/istio-operator-new-metric.yaml -y

<span class="c1"># pod 添加注解，在代理上公开这些 metrics</span>
spec:
  replicas: <span class="m">1</span>
  selector:
    matchLabels:
      app: webapp
  template:
    metadata:
      annotations:
        proxy.istio.io/config: <span class="p">|</span>-
          proxyStatsMatcher:
            inclusionPrefixes:
            - <span class="s2">"istio_get_calls"</span>
      labels:
        app: webapp

kubectl -n istioinaction apply -f <span class="se">\
</span><span class="se"></span>ch7/metrics/webapp-deployment-new-metric.yaml

curl -H <span class="s2">"Host: webapp.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>http://192.168.8.212/api/catalog

kubectl -n istioinaction <span class="nb">exec</span> -it deploy/webapp -c istio-proxy <span class="se">\
</span><span class="se"></span>-- curl localhost:15000/stats/prometheus <span class="p">|</span> grep istio_get_calls
<span class="c1"># TYPE istio_get_calls counter</span>
istio_get_calls<span class="o">{}</span> <span class="m">2</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="使用新属性对请求进行分组">使用新属性对请求进行分组</h2>
<blockquote>
<p>可以基于现有属性创建新的属性，使其更细粒度或领域特定。例如，我们可以创建一个名为istio_operationId的新属性，它将request.path_url和request.method结合起来，以尝试跟踪目录服务上/items API的GET调用次数。为此，我们使用Istio attribute-gen代理插件，这是另一个用于自定义代理指标行为的Wasm扩展。attribute-gen插件与前面一节中使用过的stats插件相辅相成。attribute-gen插件在stats插件之前进行层叠操作，以便任何它创建的属性都可以在统计数据中使用。</p>
</blockquote>
<p>参考文档:</p>
<ul>
<li><a href="https://istio.io/latest/docs/reference/config/networking/envoy-filter/">https://istio.io/latest/docs/reference/config/networking/envoy-filter/</a></li>
<li><a href="https://istio.io/latest/docs/reference/config/networking/envoy-filter/">https://istio.io/latest/docs/reference/config/networking/envoy-filter/</a></li>
<li><a href="https://istio.io/latest/zh/docs/tasks/observability/metrics/classify-metrics/">https://istio.io/latest/zh/docs/tasks/observability/metrics/classify-metrics/</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 使用 EnvoyFilter 资源配置 attribute-gen 插件</span>

<span class="o">{</span>
  <span class="s2">"attributes"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"output_attribute"</span>: <span class="s2">"istio_operationId"</span>,      ❶ 属性名称
      <span class="s2">"match"</span>: <span class="o">[</span>
        <span class="o">{</span>
          <span class="s2">"value"</span>: <span class="s2">"getitems"</span>,                      ❷ 属性值
          <span class="s2">"condition"</span>: <span class="s2">"request.url_path == '/items'
</span><span class="s2">            &amp;&amp; request.method == 'GET'"</span>
        <span class="o">}</span>,
<span class="o">}</span>

kubectl apply -f ch7/metrics/attribute-gen.yaml

<span class="c1"># 创建一个名为 upstream_operation 的新维度，该维度使用 istio_requests_total 指标中的属性来识别对 catalog 的 API 调用。</span>
istioctl install -y -f ch7/metrics/istio-operator-new-attribute.yaml

<span class="c1"># 使用新维度时，我们还需要将其添加到服务中的 extraStats 注解中</span>
kubectl apply -f ch7/metrics/webapp-deployment-extrastats-new-attr.yaml

curl -H <span class="s2">"Host: webapp.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>http://192.168.8.212/api/catalog

curl -H <span class="s2">"Host: webapp.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>http://192.168.8.212/items

kubectl -n istioinaction <span class="nb">exec</span> -it deploy/webapp -c istio-proxy <span class="se">\
</span><span class="se"></span>-- curl localhost:15000/stats/prometheus <span class="p">|</span> grep istio_requests_total

kubectl <span class="nb">exec</span> -it deploy/webapp -c istio-proxy <span class="se">\
</span><span class="se"></span>-- curl -X POST localhost:15000/reset_counters <span class="c1"># 清理指标</span>
</code></pre></td></tr></table>
</div>
</div><p>Google SRE 一书[ https://sre.google/sre-book/monitoring-distributed-systems] 将以下指标称为<code>黄金信号指标</code>：</p>
<ul>
<li>
<p>延迟</p>
</li>
<li>
<p>吞吐量</p>
</li>
<li>
<p>错误和饱和度</p>
</li>
</ul>
<p><strong>新版本中貌似一被 <code>WasmPlugin</code> 替代</strong></p>
<ul>
<li>
<p><a href="https://istio.io/latest/zh/docs/tasks/observability/metrics/classify-metrics/">https://istio.io/latest/zh/docs/tasks/observability/metrics/classify-metrics/</a></p>
</li>
<li>
<p>使用此种方法时，需要在 VirtualService 中指定注入</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 清理环境</span>
kubectl config set-context <span class="k">$(</span>kubectl config current-context<span class="k">)</span> <span class="se">\
</span><span class="se"></span> --namespace<span class="o">=</span>istioinaction
kubectl delete virtualservice,deployment,service,<span class="se">\
</span><span class="se"></span>destinationrule,gateway,WasmPlugin,Telemetry --all

<span class="c1"># 创建应用</span>
kubectl apply -f services/catalog/kubernetes/catalog.yaml
kubectl apply -f services/webapp/kubernetes/webapp.yaml
kubectl apply -f services/webapp/istio/webapp-catalog-gw-vs.yaml

<span class="c1"># 测试</span>
curl -H <span class="s2">"Host: webapp.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>http://192.168.8.212/api/catalog

---
kubectl apply -f <span class="s">&lt;&lt; EOF - 
</span><span class="s">apiVersion: extensions.istio.io/v1alpha1
</span><span class="s">kind: WasmPlugin
</span><span class="s">metadata:
</span><span class="s">  name: istio-attributegen-filter
</span><span class="s">  namespace: istioinaction
</span><span class="s">spec:
</span><span class="s">  selector:
</span><span class="s">    matchLabels:
</span><span class="s">      app: webapp
</span><span class="s">  url: https://storage.googleapis.com/istio-build/proxy/attributegen-359dcd3a19f109c50e97517fe6b1e2676e870c4d.wasm
</span><span class="s">  imagePullPolicy: Always
</span><span class="s">  phase: AUTHN
</span><span class="s">  pluginConfig:
</span><span class="s">    attributes:
</span><span class="s">    - output_attribute: "istio_operationId"
</span><span class="s">      match:
</span><span class="s">        - value: "ListCatalog"
</span><span class="s">          condition: "request.url_path == '/api/catalog' &amp;&amp; request.method == 'GET'"
</span><span class="s">---
</span><span class="s">apiVersion: telemetry.istio.io/v1alpha1
</span><span class="s">kind: Telemetry
</span><span class="s">metadata:
</span><span class="s">  name: custom-tags
</span><span class="s">  namespace: istioinaction
</span><span class="s">spec:
</span><span class="s">  metrics:
</span><span class="s">    - overrides:
</span><span class="s">        - match:
</span><span class="s">            metric: REQUEST_COUNT
</span><span class="s">            mode: CLIENT_AND_SERVER
</span><span class="s">          tagOverrides:
</span><span class="s">            request_operation:
</span><span class="s">              value: istio_operationId
</span><span class="s">      providers:
</span><span class="s">        - name: prometheus 
</span><span class="s">EOF</span>


<span class="c1"># istioctl install -y -f ch7/metrics/istio-operator-new-attribute.yaml</span>
---

<span class="k">for</span> i in <span class="k">$(</span>seq <span class="m">1</span> 5<span class="k">)</span><span class="p">;</span><span class="k">do</span>
  curl -H <span class="s2">"Host: webapp.istioinaction.io"</span> http://192.168.8.212/api/catalog <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -e <span class="s2">"\n"</span>
<span class="k">done</span>

<span class="k">while</span> true<span class="p">;</span><span class="k">do</span>
	curl -H <span class="s2">"Host: webapp.istioinaction.io"</span> http://192.168.8.212/api/catalog <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -e <span class="s2">"\n"</span> <span class="o">&amp;&amp;</span> sleep <span class="m">1</span>
<span class="k">done</span>

kubectl -n istioinaction <span class="nb">exec</span> -it deploy/webapp -c istio-proxy <span class="se">\
</span><span class="se"></span>-- curl localhost:15000/stats/prometheus <span class="p">|</span> grep istio_requests_total

<span class="c1"># DEBUG</span>
kubectl logs deploy/webapp  -c istio-proxy <span class="p">|</span> grep -e <span class="s2">"Config Error"</span> -e <span class="s2">"envoy wasm"</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="可视化">可视化</h1>
<p><strong>打开 Grafana</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 代理 Grafana ， U/P: admin prom-operator</span>
kubectl -n prometheus port-forward svc/prom-grafana 3000:80
</code></pre></td></tr></table>
</div>
</div><h2 id="设置-istio-的-grafana-仪表板">设置 Istio 的 Grafana 仪表板</h2>
<blockquote>
<p><a href="https://grafana.com/orgs/istio/dashboards">https://grafana.com/orgs/istio/dashboards</a></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> ch8/

kubectl -n prometheus create cm istio-dashboards <span class="se">\
</span><span class="se"></span>--from-file<span class="o">=</span>pilot-dashboard.json<span class="o">=</span>dashboards/pilot-dashboard.json <span class="se">\
</span><span class="se"></span>--from-file<span class="o">=</span>istio-workload-dashboard.json<span class="o">=</span>dashboards/<span class="se">\
</span><span class="se"></span>istio-workload-dashboard.json <span class="se">\
</span><span class="se"></span>--from-file<span class="o">=</span>istio-service-dashboard.json<span class="o">=</span>dashboards/<span class="se">\
</span><span class="se"></span>istio-service-dashboard.json <span class="se">\
</span><span class="se"></span>--from-file<span class="o">=</span>istio-performance-dashboard.json<span class="o">=</span>dashboards/<span class="se">\
</span><span class="se"></span>istio-performance-dashboard.json <span class="se">\
</span><span class="se"></span>--from-file<span class="o">=</span>istio-mesh-dashboard.json<span class="o">=</span>dashboards/<span class="se">\
</span><span class="se"></span>istio-mesh-dashboard.json <span class="se">\
</span><span class="se"></span>--from-file<span class="o">=</span>istio-extension-dashboard.json<span class="o">=</span>dashboards/<span class="se">\
</span><span class="se"></span>istio-extension-dashboard.json

<span class="c1"># 将 cm 注入成  grafana_dashboard</span>
kubectl label -n prometheus cm istio-dashboards <span class="nv">grafana_dashboard</span><span class="o">=</span><span class="m">1</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="分布式追踪">分布式追踪</h2>
<blockquote>
<p>OpenTelemetry是一个由社区驱动的框架，其中包括了OpenTracing，它是一种规范，用于捕获与分布式跟踪相关的概念和API。分布式跟踪在某种程度上依赖于开发人员对其代码进行仪器化，并在应用程序处理请求并向其他系统发出新请求时进行注释。追踪引擎有助于组合请求流程的完整图像，可以用来识别我们架构中行为异常的区域。</p>
<p>借助 Istio，我们可以承担开发人员必须自己实现的大部分繁重工作，并提供分布式跟踪作为服务网格的一部分。</p>
<p>一个 Span 是表示服务或组件内的工作单元的数据集合。这些数据包括操作的开始时间、结束时间、操作名称以及一组标签和日志。</p>
</blockquote>
<p>OpenTracing 实现包括如下系统：</p>
<ul>
<li>Jaeger</li>
<li>Zipkin</li>
<li>Lightstep</li>
<li>Instana</li>
</ul>
<p>Istio 将 HTTP 标头（通常称为 Zipkin 跟踪标头）附加到请求中，可用于将后续 <code>Span</code> 对象与整个 <code>Trace</code> 相关联。如果请求进入服务并且 Istio 代理识别分布式跟踪标头，代理会将其视为正在进行的跟踪，并且不会尝试生成新的跟踪。 Istio 和分布式跟踪功能使用以下 Zipkin 跟踪标头：</p>
<ul>
<li><code>x-request-id</code></li>
<li><code>x-b3-traceid</code></li>
<li><code>x-b3-spanid</code></li>
<li><code>x-b3-parentspanid</code></li>
<li><code>x-b3-sampled</code></li>
<li><code>x-b3-flags</code></li>
<li><code>x-ot-span-context</code></li>
</ul>
<p>Istio 无法知道哪些传出调用是哪些传入请求的结果。为了正确地将上游调用与进入服务的调用相关联，<code>应用程序必须承担传播这些标头的责任</code>。很多时候，开箱即用的 RPC 框架与 OpenTracing 集成或直接支持 OpenTracing，并且可以自动为您传播这些标头。无论哪种方式，<code>应用程序都必须确保传播这些标头</code>。</p>
<blockquote>
<p><strong>应用程序必须传播跟踪标头。否则，我们将丢失请求的完整范围。</strong></p>
</blockquote>
<p><img alt="Pasted image 20230930183951" src="https://cdn.treesir.pub/images/2023/09/30/20230930183955.png"/></p>
<hr/>
<p><strong>安装分布式跟踪系统</strong></p>
<p>Jaeger: Jaeger</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 从 Istio 示例目录安装示例 Jaeger 一体化部署</span>

<span class="nb">cd</span> ~/Desktop/istio-1.19.0

kubectl apply -f samples/addons/jaeger.yaml

<span class="c1"># 等待服务启动完成</span>
kubectl get pod -n istio-system
kubectl get svc -n istio-system
</code></pre></td></tr></table>
</div>
</div><p>可以配置 Istio 进行多个级别的分布式跟踪：全局网格、命名空间或特定工作负载。</p>
<blockquote>
<p><a href="https://istio.io/latest/docs/tasks/observability/telemetry">https://istio.io/latest/docs/tasks/observability/telemetry</a></p>
</blockquote>
<p><strong>在安装时配置跟踪</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># Istio 支持分布式跟踪后端，包括 Zipkin、Datadog、Jaeger（Zipkin 兼容）等。</span>
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  namespace: istio-system
spec:
  meshConfig:
    defaultConfig:
      tracing:
        lightstep: <span class="o">{}</span>
        zipkin: <span class="o">{}</span>
        datadog: <span class="o">{}</span>
        stackdriver: <span class="o">{}</span>

---
<span class="c1"># 使用 Jaeger，它与 Zipkin 兼容，我们可以配置如下</span>
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  namespace: istio-system
spec:
  meshConfig:
    defaultConfig:
      tracing:
        sampling: <span class="m">100</span>
        zipkin:
          address: zipkin.istio-system:9411

istioctl install -y -f ch8/install-istio-tracing-zipkin.yaml

<span class="c1"># 已经安装了 Istio 并且没有配置跟踪后端，或者想要更新配置，您可以在 istioconfigmap 中的 MeshConfig 对象中看到 Istio 的网格范围默认值在 istio-system 命名空间中</span>
kubectl get cm istio -n istio-system -o yaml
...
data:
  mesh: <span class="p">|</span>-
    defaultConfig:
      discoveryAddress: istiod.istio-system.svc:15012
      proxyMetadata: <span class="o">{}</span>
      tracing:
        sampling: <span class="m">100</span>
        zipkin:
          address: zipkin.istio-system:9411
    defaultProviders:
      metrics:
      - prometheus
...

<span class="c1"># 配置工作负载的 TRACING, 下面是 Deployment 的例子</span>
apiVersion: apps/v1
kind: Deployment
...
spec:
  template:
    metadata:
      annotations:
        proxy.istio.io/config: <span class="p">|</span>
          tracing:
            zipkin:
              address: zipkin.istio-system:9411


<span class="c1"># 检查默认 TRACING 标头</span>
<span class="c1"># 使用 Istio 的入口网关调用外部 httpbin 服务并调用显示请求标头的端点。</span>

kubectl apply -n istioinaction <span class="se">\
</span><span class="se"></span>-f ch8/tracing/thin-httpbin-virtualservice.yaml

curl -H <span class="s2">"Host: httpbin.istioinaction.io"</span> http://192.168.8.212/headers
<span class="o">{</span>
  <span class="s2">"headers"</span>: <span class="o">{</span>
    <span class="s2">"Accept"</span>: <span class="s2">"*/*"</span>, 
    <span class="s2">"Host"</span>: <span class="s2">"httpbin.istioinaction.io"</span>, 
    <span class="s2">"User-Agent"</span>: <span class="s2">"curl/8.1.2"</span>, 
    <span class="s2">"X-Amzn-Trace-Id"</span>: <span class="s2">"Root=1-65180064-39d6410b0b3e94550ef3b250"</span>, 
    <span class="s2">"X-B3-Sampled"</span>: <span class="s2">"1"</span>, 
    <span class="s2">"X-B3-Spanid"</span>: <span class="s2">"34914a388f45a982"</span>, 
    <span class="s2">"X-B3-Traceid"</span>: <span class="s2">"a8440b2adfa0236034914a388f45a982"</span>, 
    <span class="s2">"X-Envoy-Attempt-Count"</span>: <span class="s2">"1"</span>, 
    <span class="s2">"X-Envoy-Decorator-Operation"</span>: <span class="s2">"httpbin.org:80/*"</span>, 
    <span class="s2">"X-Envoy-Internal"</span>: <span class="s2">"true"</span>, 
    <span class="s2">"X-Envoy-Peer-Metadata"</span>: <span class="s2">"ChoKCkNMVVNURVJfSUQSDBoKS3ViZXJuZXRlcwodCgxJTlNUQU5DRV9JUFMSDRoLMTAuNDIuNC4xMTEKGQoNSVNUSU9fVkVSU0lPThIIGgYxLjE5LjAKnAMKBkxBQkVMUxKRAyqOAwodCgNhcHASFhoUaXN0aW8taW5ncmVzc2dhdGV3YXkKEwoFY2hhcnQSChoIZ2F0ZXdheXMKFAoIaGVyaXRhZ2USCBoGVGlsbGVyCjYKKWluc3RhbGwub3BlcmF0b3IuaXN0aW8uaW8vb3duaW5nLXJlc291cmNlEgkaB3Vua25vd24KGQoFaXN0aW8SEBoOaW5ncmVzc2dhdGV3YXkKGQoMaXN0aW8uaW8vcmV2EgkaB2RlZmF1bHQKMAobb3BlcmF0b3IuaXN0aW8uaW8vY29tcG9uZW50EhEaD0luZ3Jlc3NHYXRld2F5cwoSCgdyZWxlYXNlEgcaBWlzdGlvCjkKH3NlcnZpY2UuaXN0aW8uaW8vY2Fub25pY2FsLW5hbWUSFhoUaXN0aW8taW5ncmVzc2dhdGV3YXkKLwojc2VydmljZS5pc3Rpby5pby9jYW5vbmljYWwtcmV2aXNpb24SCBoGbGF0ZXN0CiIKF3NpZGVjYXIuaXN0aW8uaW8vaW5qZWN0EgcaBWZhbHNlChoKB01FU0hfSUQSDxoNY2x1c3Rlci5sb2NhbAovCgROQU1FEicaJWlzdGlvLWluZ3Jlc3NnYXRld2F5LTU5Yzc4Njc2OGQtY2duNTUKGwoJTkFNRVNQQUNFEg4aDGlzdGlvLXN5c3RlbQpdCgVPV05FUhJUGlJrdWJlcm5ldGVzOi8vYXBpcy9hcHBzL3YxL25hbWVzcGFjZXMvaXN0aW8tc3lzdGVtL2RlcGxveW1lbnRzL2lzdGlvLWluZ3Jlc3NnYXRld2F5CicKDVdPUktMT0FEX05BTUUSFhoUaXN0aW8taW5ncmVzc2dhdGV3YXk="</span>, 
    <span class="s2">"X-Envoy-Peer-Metadata-Id"</span>: <span class="s2">"router~10.42.4.111~istio-ingressgateway-59c786768d-cgn55.istio-system~istio-system.svc.cluster.local"</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1"># 可以清楚地看到 x-b3-* Zipkin 标头自动附加到我们的请求中。这些 Zipkin 标头用于创建 Span 并发送给 Jaeger</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="查看分布式跟踪数据">查看分布式跟踪数据</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">istioctl dashboard jaeger --browser<span class="o">=</span><span class="nb">false</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>调整网格的跟踪采样</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 将服务网格中所有工作负载的全局采样率更改为 10%。</span>
kubectl edit -n istio-system cm istio
apiVersion: v1
data:
  mesh: <span class="p">|</span>-
    accessLogFile: /dev/stdout
    defaultConfig:
      discoveryAddress: istiod.istio-system.svc:15012
      proxyMetadata: <span class="o">{}</span>
      tracing:
        sampling: <span class="m">10</span>
        zipkin:
          address: zipkin.istio-system:9411
          
<span class="c1"># 除了全局配置之外，我们还可以在注释中针对每个工作负载进行配置。</span>
apiVersion: apps/v1
kind: Deployment
...
spec:
  template:
    metadata:
      annotations:
        proxy.istio.io/config: <span class="p">|</span>
          tracing:
            sampling: <span class="m">10</span>
            zipkin:
              address: zipkin.istio-system:9411
              
kubectl apply -f ch8/webapp-deployment-zipkin.yaml
</code></pre></td></tr></table>
</div>
</div><p><strong>来自客户端的强制追踪</strong></p>
<p>在生产中，将跟踪采样率保持在 <code>最低水平</code> 然后在出现问题时针对每个工作负载启用它非常有意义。有时您需要启用特定跟踪的跟踪。您可以配置 Istio 以强制跟踪特定请求。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 将 x-envoy-force-trace 标头添加到请求中，以触发 Istio 捕获请求生成的特定调用图的跨度和跟踪。</span>
curl -H <span class="s2">"x-envoy-force-trace: true"</span>  <span class="se">\
</span><span class="se"></span>-H <span class="s2">"Host: webapp.istioinaction.io"</span> http://192.168.8.212/api/catalog
</code></pre></td></tr></table>
</div>
</div><p>每次我们发送此 <code>x-envoy-force-trace</code> 标头时，我们都会触发对该请求以及该请求的<code>整个调用图</code>的跟踪</p>
<h2 id="自定义跟踪中的标签">自定义跟踪中的标签</h2>
<p>可以配置三种不同类型的自定义标签</p>
<ul>
<li>显式指定一个值</li>
<li>从环境变量中提取值</li>
<li>从请求标头中提取值</li>
</ul>
<p>** 注释该工作负载的 Deployment 资源**</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">apiVersion: apps/v1
kind: Deployment
...
spec:
  template:
    metadata:
      annotations:
        proxy.istio.io/config: <span class="p">|</span>
          tracing:
            sampling: <span class="m">100</span>
            customTags:
              custom_tag:
                literal:
                  value: <span class="s2">"Test Tag"</span>
            zipkin:
              address: zipkin.istio-system:9411
              
curl -H <span class="s2">"Host: webapp.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>http://192.168.8.212/api/catalog
</code></pre></td></tr></table>
</div>
</div><p><img alt="image-20230930193353348" src="https://cdn.treesir.pub/images/2023/09/30/20230930193355.png"/></p>
<blockquote>
<p>自定义标签可用于报告、过滤和以其他方式探索跟踪数据</p>
<ul>
<li><a href="https://istio.io/latest/docs/tasks/observability/distributed-tracing/">https://istio.io/latest/docs/tasks/observability/distributed-tracing/</a></li>
</ul>
</blockquote>
<h2 id="定制后端分布式追踪引擎">定制后端分布式追踪引擎</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 查看 默认跟踪配置</span>
istioctl pc bootstrap -n istioinaction deploy/webapp <span class="se">\
</span><span class="se"></span>-o json  <span class="p">|</span> jq .bootstrap.tracing
<span class="o">{</span>
  <span class="s2">"http"</span>: <span class="o">{</span>
    <span class="s2">"name"</span>: <span class="s2">"envoy.tracers.zipkin"</span>,
    <span class="s2">"typedConfig"</span>: <span class="o">{</span>
      <span class="s2">"@type"</span>: <span class="s2">"type.googleapis.com/envoy.config.trace.v3.ZipkinConfig"</span>,
      <span class="s2">"collectorCluster"</span>: <span class="s2">"zipkin"</span>,
      <span class="s2">"collectorEndpoint"</span>: <span class="s2">"/api/v2/spans"</span>,
      <span class="s2">"traceId128bit"</span>: true,
      <span class="s2">"sharedSpanContext"</span>: false,
      <span class="s2">"collectorEndpointVersion"</span>: <span class="s2">"HTTP_JSON"</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1"># 跟踪引擎配置为基于Zipkin，发送到/api/v2/spans端点，并将其视为JSON端点。如果我们需要覆盖这些设置或以任何方式进行调整，则必须能够在使用Zipkin作为跟踪引擎时覆盖Istio中内置的静态定义。我们可以通过自定义启动配置来实现这一点。</span>


<span class="c1"># 在 Kubernetes configmap 中指定要调整的配置片段</span>

apiVersion: v1
kind: ConfigMap
metadata:
  name: istio-custom-zipkin
data:
  custom_bootstrap.json: <span class="p">|</span>
    <span class="o">{</span>
      <span class="s2">"tracing"</span>: <span class="o">{</span>
        <span class="s2">"http"</span>: <span class="o">{</span>
          <span class="s2">"name"</span>: <span class="s2">"envoy.tracers.zipkin"</span>,
          <span class="s2">"typedConfig"</span>: <span class="o">{</span>
            <span class="s2">"@type"</span>: <span class="s2">"type.googleapis.com/
</span><span class="s2">              envoy.config.trace.v3.ZipkinConfig"</span>,
            <span class="s2">"collectorCluster"</span>: <span class="s2">"zipkin"</span>,
            <span class="s2">"collectorEndpoint"</span>: <span class="s2">"/zipkin/api/v1/spans"</span>,
            <span class="s2">"traceId128bit"</span>: <span class="s2">"true"</span>,
            <span class="s2">"collectorEndpointVersion"</span>: <span class="s2">"HTTP_JSON"</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
    
kubectl apply -f ch8/istio-custom-bootstrap.yaml <span class="se">\
</span><span class="se"></span>-n istioinaction

<span class="c1"># 在 Deployment 资源的 Pod 模板中添加一个注解来引用这个 configmap</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: webapp
  name: webapp
spec:
  replicas: <span class="m">1</span>
  selector:
    matchLabels:
      app: webapp
  template:
    metadata:
      annotations:
        sidecar.istio.io/bootstrapOverride: <span class="s2">"istio-custom-zipkin"</span>
        
kubectl apply -f ch8/webapp-deployment-custom-boot.yaml <span class="se">\
</span><span class="se"></span>-n istioinaction

<span class="c1"># 自定义引导配置与幕后使用的 Envoy 代理版本相关，并且不能保证向后兼容性。任何错误配置都可能导致的服务瘫痪。</span>
istioctl pc bootstrap -n istioinaction deploy/webapp <span class="se">\
</span><span class="se"></span>-o json <span class="p">|</span> jq .bootstrap.tracing
<span class="o">{</span>
  <span class="s2">"http"</span>: <span class="o">{</span>
    <span class="s2">"name"</span>: <span class="s2">"envoy.tracers.zipkin"</span>,
    <span class="s2">"typedConfig"</span>: <span class="o">{</span>
      <span class="s2">"@type"</span>: <span class="s2">"type.googleapis.com/envoy.config.trace.v3.ZipkinConfig"</span>,
      <span class="s2">"collectorCluster"</span>: <span class="s2">"zipkin"</span>,
      <span class="s2">"collectorEndpoint"</span>: <span class="s2">"/zipkin/api/v1/spans"</span>,
      <span class="s2">"traceId128bit"</span>: true,
      <span class="s2">"collectorEndpointVersion"</span>: <span class="s2">"HTTP_JSON"</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1"># Reset</span>
kubectl apply -f services/webapp/kubernetes/webapp.yaml 

</code></pre></td></tr></table>
</div>
</div><h2 id="使用-kiali-进行可视化">使用 Kiali 进行可视化</h2>
<blockquote>
<p>Istio可以与一个名为Kiali的开源项目配合使用，该项目提供了一个强大的可视化仪表板（www.kiali.io），可以帮助理解服务网格在运行时的情况。Kiali从Prometheus和底层平台中获取许多指标，并建立一个运行时图形来展示网格中各个组件之间的通信情况，以便您能够直观地了解哪些服务正在与其他服务进行通信。您还可以与图形进行交互，并深入研究可能存在问题的区域，以更多地了解发生了什么。Kiali不同于Grafana，它专注于构建一个有向图，展示服务之间如何相互交互并实时更新指标。Grafana非常擅长创建具有刻度、计数器、图表等功能的仪表板，但不能呈现集群中服务的交互式绘图或地图。</p>
</blockquote>
<h3 id="安装-kiali">安装 Kiali</h3>
<blockquote>
<p>使用 helm 安装</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl create ns kiali-operator

helm repo add kiali https://kiali.org/helm-charts

helm repo update 

helm pull kiali/kiali-operator  --untar

cat &gt; kiali-operator/values-prod.yaml <span class="s">&lt;&lt; EOF
</span><span class="s">cr:
</span><span class="s">  create: false
</span><span class="s">  name: kiali
</span><span class="s">  namespace: "istio-system"
</span><span class="s">EOF</span>

helm upgrade --install kiali-operator -f <span class="se">\
</span><span class="se"></span>  ./kiali-operator/values-prod.yaml  <span class="se">\
</span><span class="se"></span>  -n kiali-operator ./kiali-operator
---
<span class="c1"># 创建 kiali 实例</span>
<span class="c1"># 配置模板 https://github.com/kiali/kiali-operator/blob/master/crd-docs/cr/kiali.io_v1alpha1_kiali.yaml</span>
kubectl apply -f <span class="s">&lt;&lt; EOF - 
</span><span class="s">apiVersion: kiali.io/v1alpha1
</span><span class="s">kind: Kiali
</span><span class="s">metadata:
</span><span class="s">  namespace: istio-system
</span><span class="s">  name: kiali
</span><span class="s">spec:
</span><span class="s">  istio_namespace: "istio-system"  
</span><span class="s">  istio_component_namespaces:
</span><span class="s">    prometheus: prometheus
</span><span class="s">  auth:    
</span><span class="s">    strategy: anonymous
</span><span class="s">  deployment:
</span><span class="s">    accessible_namespaces:
</span><span class="s">    - '**'
</span><span class="s">  external_services:    
</span><span class="s">    prometheus:
</span><span class="s">      cache_duration: 10
</span><span class="s">      cache_enabled: true
</span><span class="s">      cache_expiration: 300
</span><span class="s">      url: "http://prom-kube-prometheus-stack-prometheus.prometheus:9090"    
</span><span class="s">    tracing:
</span><span class="s">      enabled: true
</span><span class="s">      in_cluster_url: "http://tracing.istio-system:16685/jaeger"
</span><span class="s">      use_grpc: true
</span><span class="s">EOF</span>


<span class="c1"># 代理至本地</span>
kubectl -n istio-system port-forward deploy/kiali <span class="m">20001</span>

<span class="c1"># 创建 token</span>
kubectl -n istio-system create token kiali-service-account


<span class="c1"># 创建数据</span>
<span class="k">for</span> i in <span class="o">{</span>1..20<span class="o">}</span><span class="p">;</span> <span class="k">do</span> curl http://192.168.8.212/api/catalog -H <span class="se">\
</span><span class="se"></span><span class="s2">"Host: webapp.istioinaction.io"</span><span class="p">;</span> sleep .5s<span class="p">;</span>  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><p><img alt="image-20230930202847716" src="https://cdn.treesir.pub/images/2023/09/30/20230930202853.png"/></p>
<h2 id="跟踪指标和日志的关联">跟踪、指标和日志的关联</h2>
<blockquote>
<p>Kiali正在逐渐发展成为一个能回答所有服务网格可观察性问题的仪表板。其中之一的Kiali功能——关联跟踪、指标和日志——只是未来可能性的一个承诺。</p>
</blockquote>
<p><strong>查看遥测数据之间的相关性</strong></p>
<p><img alt="image-20230930203123235" src="https://cdn.treesir.pub/images/2023/09/30/20230930203127.png"/></p>
<p><strong>选项卡说明</strong></p>
<ul>
<li>Logs: 应用程序日志、Envoy访问日志和相关的跨度</li>
<li>Inbound Metrics and Outbound Metrics:  与跨度相关</li>
<li>Traces:  Jaeger 报告 的追踪</li>
<li>Envoy: 应用于工作负载的Envoy配置，如集群、监听器和路由</li>
</ul>
<p><strong>了解 Kiali 工作负载与应用程序</strong></p>
<blockquote>
<p>在 Kiali 中, 您会注意到工作负载和应用程序之间的区别。对于我们的示例应用程序，它们实际上是相同的，但两者之间的最大区别是：</p>
<ul>
<li>工作负载是一个运行的二进制文件，可以部署为一组相同的运行副本。例如，在 Kubernetes 中，这将是部署的 Pod 部分。具有三个副本的服务部署将是一个工作负载。</li>
<li>一个应用是 <code>一组工作负载</code> 和 <code>相关构件</code>，如服务和配置。在Kubernetes中，这可能是一个服务A以及一个服务B和可能的数据库。每个都将成为自己的工作负载，并且它们<code>共同组成了一个Kiali 应用程序</code>。</li>
</ul>
</blockquote>
<p>Kiali 对于服务网格 管理人员很有用，因为它可以验证以下 Istio 资源</p>
<ul>
<li>VirtualService 指向不存在的 Gateway</li>
<li>路由到不存在的目的地</li>
<li>同一主机有多个 VirtualService</li>
<li>未找到服务子集</li>
</ul>
<p>关于更多 kiali 检查问题: <a href="https://kiali.io/docs/features/validations/">https://kiali.io/docs/features/validations/</a></p>
<h1 id="关于保障微服务安全">关于保障微服务安全</h1>
<blockquote>
<p>应用程序安全性包括有助于保护具有关键价值的应用程序数据的所有活动，这些数据不应被破坏、窃取或被未经授权的用户访问。为了保护用户数据，我们需要：</p>
<ul>
<li>在允许访问资源之前对用户进行身份验证和授权</li>
<li>对传输中的数据进行加密，以防止数据在通过多个网络设备到达请求数据的客户端时被窃听</li>
</ul>
</blockquote>
<ul>
<li>服务间认证： (SPIFFE) 框架提供一种自动化的方式来发布服务身份。颁发的身份用于服务之间的相互验证。</li>
<li>最终用户认证: 用户将此凭证提供给服务进行身份验证。在允许任何类型的访问之前，服务会使用颁发凭证的身份验证服务器来验证凭证（ HTTP cookie 或 JSON Web 令牌 [JWT] 等 )</li>
<li>授权</li>
</ul>
<p><strong>SPIFFE 规范</strong></p>
<blockquote>
<p>SPIFFE 是一组开源标准，用于为高度动态和异构环境中的工作负载提供身份</p>
<ul>
<li><a href="https://spiffe.io/docs/latest/spire-about/">https://spiffe.io/docs/latest/spire-about/</a></li>
<li>SPIFFE 身份是一个符合 RFC 3986 的 URI，以 spiffe://trust-domain/path 格式组成
<ul>
<li>信任域代表身份的颁发者，例如个人或组织。</li>
<li>该路径唯一标识信任域内的工作负载。</li>
</ul>
</li>
</ul>
</blockquote>
<p>Istio 使用运行特定工作负载的服务帐户来填充此路径。此 SPIFFE 身份编码在 X.509 证书中，也称为 SPIFFE 可验证身份文档 (SVID)，由 Istio 的控制平面为工作负载铸造。然后，这些证书用于通过加密传输中的数据来保护服务到服务通信的传输。</p>
<p><strong>Istio 定义的自定义资源来配置服务代理</strong></p>
<ul>
<li><code>PeerAuthentication</code> 资源配置代理以验证服务到服务的流量。身份验证成功后，代理会提取对等方证书中编码的信息，并使其可用于授权请求。</li>
<li><code>RequestAuthentication</code> 资源将代理配置为针对颁发最终用户凭据的服务器进行身份验证。身份验证成功后，它还会提取凭证中编码的信息，并使其可用于授权请求。</li>
<li><code>AuthorizationPolicy</code> 资源将代理配置为根据前两个资源提取的数据做出决策来授权或拒绝请求。
<img alt="Pasted image 20230930223127" src="https://cdn.treesir.pub/images/2023/09/30/20230930223130.png"/></li>
</ul>
<blockquote>
<p>展示了PeerAuthentication和RequestAuthentication资源如何配置代理以对请求进行身份验证，此时将编码到凭据（SVID或JWT）中的数据提取并存储为过滤器元数据。过滤器元数据表示连接身份。AuthorizationPolicy资源根据其连接身份决定是否允许或拒绝请求。</p>
</blockquote>
<h2 id="自动-mtls">自动 mTLS</h2>
<blockquote>
<p>对服务进行身份验证使我们能够遵守最小特权原则，为每个服务创建策略，并仅允许其功能所需的最低访问权限。这非常重要，因为当代表服务身份的证书最终落入坏人之手时，损害范围仅限于允许该身份访问的少数服务。</p>
</blockquote>
<p><strong>工作负载使用 Istio 证书颁发机构颁发的 SVID 证书进行相互身份验证。</strong></p>
<p><img alt="Pasted image 20230930222720" src="https://cdn.treesir.pub/images/2023/09/30/20230930222724.png"/></p>
<h2 id="环境搭建">环境搭建</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl config set-context <span class="k">$(</span>kubectl config current-context<span class="k">)</span> <span class="se">\
</span><span class="se"></span> --namespace<span class="o">=</span>istioinaction
 
kubectl delete virtualservice,deployment,service,<span class="se">\
</span><span class="se"></span>destinationrule,gateway --all


<span class="c1"># 设置的三个工作负载</span>
kubectl label namespace istioinaction istio-injection<span class="o">=</span>enabled
kubectl apply -f services/catalog/kubernetes/catalog.yaml
kubectl apply -f services/webapp/kubernetes/webapp.yaml
kubectl apply -f services/webapp/istio/webapp-catalog-gw-vs.yaml
kubectl apply -f ch9/sleep.yaml -n default


<span class="c1"># 从 sleep 工作负载到 webapp 工作负载的明文请求，验证服务是否已正确设置</span>
kubectl -n default <span class="nb">exec</span> deploy/sleep -c sleep -- <span class="se">\
</span><span class="se"></span>     curl -s webapp.istioinaction/api/catalog <span class="se">\
</span><span class="se"></span>     -o /dev/null -w <span class="s2">"%{http_code}"</span>
<span class="m">200</span>

<span class="c1"># 使用 PeerAuthentication 可以禁止明文流量</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="peerauthentication-资源">PeerAuthentication 资源</h2>
<p><a href="https://istio.io/latest/docs/reference/config/security/peer_authentication/">https://istio.io/latest/docs/reference/config/security/peer_authentication/</a></p>
<blockquote>
<p><code>PeerAuthentication</code> 资源允许将工作负载配置为严格要求 mTLS 或宽松并接受明文流量，分别使用 <code>STRICT</code> 或 <code>PERMISSIVE</code> 身份验证模式。相互认证模式可以在不同范围内配置：</p>
<ul>
<li>网格范围的 <code>PeerAuthentication</code> 策略适用于服务网格的所有工作负载。</li>
<li>命名空间范围的 <code>PeerAuthentication</code> 策略适用于命名空间中的所有工作负载。</li>
<li>特定于工作负载的 <code>PeerAuthentication</code> 策略适用于与策略中指定的选择器匹配的所有工作负载。</li>
</ul>
</blockquote>
<p><strong>使用网格范围策略拒绝所有未经身份验证的流量</strong></p>
<ul>
<li>
<p>创建强制执行 <code>STRICT</code> 相互身份验证模式的网格范围策略来禁止明文流量。</p>
</li>
<li>
<p>PeerAuthentication  策略必须满足两个条件：它必须应用在<code> Istio 安装命名空间</code>中，并且必须命名为  <code>default</code></p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">apiVersion: <span class="s2">"security.istio.io/v1beta1"</span>
kind: <span class="s2">"PeerAuthentication"</span>
metadata:
  name: <span class="s2">"default"</span>                ❶ 网格范围内的策略必须命名为“default”。
  namespace: <span class="s2">"istio-system"</span>      ❷ Istio安装命名空间
spec:
  mtls:
    mode: STRICT                 ❸  双向 TLS 模式

kubectl apply -f ch9/meshwide-strict-peer-authn.yaml

<span class="c1">#  此时未在 istio 网格中的服务，将被禁止</span>
kubectl -n default <span class="nb">exec</span> deploy/sleep -c sleep -- <span class="se">\
</span><span class="se"></span>     curl -s webapp.istioinaction/api/catalog
000command terminated with <span class="nb">exit</span> code <span class="m">56</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="允许非相互验证的流量">允许非相互验证的流量</h2>
<blockquote>
<p>使用命名空间范围的策略，我们可以覆盖网格范围的策略。</p>
</blockquote>
<p>此操作为不推荐做法，无法保证攻击面做到最小，应该针对 特定 workload 授权</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">apiVersion: <span class="s2">"security.istio.io/v1beta1"</span>
kind: <span class="s2">"PeerAuthentication"</span>
metadata:
  name: <span class="s2">"default"</span>              ❶ 使用“默认”命名约定，以便仅存在一个名称空间范围的资源
  namespace: <span class="s2">"istioinaction"</span>   ❷ 指定应用策略的命名空间
spec:
  mtls:
    mode: PERMISSIVE           ❸ PERMISSIVE 允许 HTTP 流量。
</code></pre></td></tr></table>
</div>
</div><p><strong>应用特定于工作负载的对等身份验证策略</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">apiVersion: <span class="s2">"security.istio.io/v1beta1"</span>
kind: <span class="s2">"PeerAuthentication"</span>
metadata:
  name: <span class="s2">"webapp"</span>
  namespace: <span class="s2">"istioinaction"</span>
spec:
  selector:
    matchLabels:
      app: <span class="s2">"webapp"</span>      ❶ 与标签匹配的工作负载使用 mTLS 的 PERMISSIVE 模式。
  mtls:
    mode: PERMISSIVE
    
kubectl apply -f ch9/workload-permissive-peer-authn.yaml

kubectl -n default <span class="nb">exec</span> deploy/sleep -c sleep -- <span class="se">\
</span><span class="se"></span>     curl -I -s webapp.istioinaction/api/catalog
HTTP/1.1 <span class="m">200</span> OK
...
</code></pre></td></tr></table>
</div>
</div><p><img alt="Pasted image 20230930224904" src="https://cdn.treesir.pub/images/2023/09/30/20230930224909.png"/></p>
<p><code>istiod</code> 监听 <code>PeerAuthentication</code> 资源的创建，将资源转换为 Envoy-特定配置，并使用侦听器发现服务 (LDS) 将其应用到服务代理。针对每个传入请求评估配置的策略。</p>
<hr/>
<h2 id="两种额外的相互验证模式">两种额外的相互验证模式</h2>
<blockquote>
<p>大多数时候，您将使用 <code>STRICT</code> 或 <code>PERMISSIVE</code> 模式。但还有两种额外的模式</p>
<ul>
<li><code>UNSET</code> — 继承父级的 <code>PeerAuthentication</code> 策略。</li>
<li><code>DISABLE</code> ——不要通过隧道传输流量；直接将其发送到服务。</li>
</ul>
</blockquote>
<h2 id="tcpdump-流量窃听">TCPDUMP 流量窃听</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># Istio 代理预装了 tcpdump 命令行实用程序。默认情况下，这些都是关闭的。</span>
istioctl install -y --set <span class="nv">profile</span><span class="o">=</span>demo <span class="se">\
</span><span class="se"></span>     --set values.global.proxy.privileged<span class="o">=</span><span class="nb">true</span>
     
<span class="c1"># 更新了 Istio 以注入特权 sidecar 代理。需要重新创建 webapp 工作负载。</span>
kubectl delete po -l <span class="nv">app</span><span class="o">=</span>webapp -n istioinaction

<span class="c1"># 执行以下 tcpdump 命令来嗅探 Pod 流量</span>
kubectl -n istioinaction <span class="nb">exec</span> deploy/webapp -c istio-proxy <span class="se">\
</span><span class="se"></span>     -- sudo tcpdump -l --immediate-mode -vv -s <span class="m">0</span> <span class="se">\
</span><span class="se"></span>     <span class="s1">'(((ip[2:2] - ((ip[0]&amp;0xf)&lt;&lt;2)) - ((tcp[12]&amp;0xf0)&gt;&gt;2)) != 0)'</span>
     
<span class="c1"># 触发从 sleep 工作负载到 webapp 的请求</span>
kubectl -n default <span class="nb">exec</span> deploy/sleep -c sleep -- <span class="se">\
</span><span class="se"></span>     curl -s webapp.istioinaction/api/catalog
     
    webapp-6c89558f4c-8n4vn.http-alt &gt; 10-42-8-191.sleep.default.svc.cluster.local.50240: Flags <span class="o">[</span>P.<span class="o">]</span>, cksum 0x2b70 <span class="o">(</span>incorrect -&gt; 0x0c5b<span class="o">)</span>, seq 1:1398, ack 94, win 128, options <span class="o">[</span>nop,nop,TS val <span class="m">3429114437</span> ecr 3550089041<span class="o">]</span>, length 1397: HTTP, length: <span class="m">1397</span>
        HTTP/1.1 <span class="m">200</span> OK
        content-length: <span class="m">357</span>
...

<span class="c1"># 会看到信息在集群内传输是明文的</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>验证工作负载身份是否与工作负载服务帐户绑定</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl -n istioinaction <span class="nb">exec</span> deploy/webapp -c istio-proxy <span class="se">\
</span><span class="se"></span>     -- openssl s_client -showcerts <span class="se">\
</span><span class="se"></span>     -connect catalog.istioinaction.svc.cluster.local:80 <span class="se">\
</span><span class="se"></span>     -CAfile /var/run/secrets/istio/root-cert.pem <span class="p">|</span> <span class="se">\
</span><span class="se"></span>     openssl x509 -in /dev/stdin -text -noout
...
          X509v3 Subject Alternative Name: critical
                URI:spiffe://cluster.local/ns/istioinaction/sa/catalog
...


<span class="c1"># 使用 openssl verify 实用程序，我们通过根据证书颁发机构 (CA) 根证书检查其签名来确保 X.509 SVID 的内容有效</span>
kubectl -n istioinaction <span class="nb">exec</span> -it <span class="se">\
</span><span class="se"></span>     deploy/webapp -c istio-proxy -- /bin/bash
     
openssl verify -CAfile /var/run/secrets/istio/root-cert.pem <span class="se">\
</span><span class="se"></span>     &lt;<span class="o">(</span>openssl s_client -connect <span class="se">\
</span><span class="se"></span>     catalog.istioinaction.svc.cluster.local:80 -showcerts 2&gt;/dev/null<span class="o">)</span>
     
/dev/fd/63: OK
</code></pre></td></tr></table>
</div>
</div><h2 id="授权服务到服务的流量">授权服务到服务的流量</h2>
<p><a href="https://istio.io/latest/docs/reference/config/security/authorization-policy">https://istio.io/latest/docs/reference/config/security/authorization-policy</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 示例 AuthorizationPolicy 定义</span>
apiVersion: <span class="s2">"security.istio.io/v1beta1"</span>
kind: <span class="s2">"AuthorizationPolicy"</span>
metadata:
  name: <span class="s2">"allow-catalog-requests-in-web-app"</span>
  namespace: istioinaction
spec:
  selector:
    matchLabels:
      app: webapp
  action: ALLOW
  rules:
  - to:
    - operation:
        paths: <span class="o">[</span><span class="s2">"/api/catalog*"</span><span class="o">]</span>
        
当 istiod 发现新的 AuthorizationPolicy 已应用于集群时，它会使用该资源处理和更新数据平面代理，就像其他 Istio 资源一样。  
</code></pre></td></tr></table>
</div>
</div><p>授权策略的属性</p>
<ul>
<li><code>selector</code> 字段定义应用策略的工作负载子集。</li>
<li><code>action</code> 字段指定这是否是 <code>ALLOW</code> 、 <code>DENY</code> 或 <code>CUSTOM</code> 策略。</li>
<li><code>rules</code> 字段定义了一个规则列表，用于标识将激活策略的请求。</li>
</ul>
<p><strong>授权政策规则</strong></p>
<ul>
<li>
<p><code>from</code> 字段指定请求的来源，可以是以下类型之一</p>
<ul>
<li>
<p><code>principals</code> — 源身份列表（SPIFFE ID，如 mTLS 示例中所示）。</p>
</li>
<li>
<p><code>namespaces</code> —与源命名空间匹配的命名空间列表。</p>
</li>
<li>
<p><code>ipBlocks</code> — 使用与源 IP 地址匹配的无类域间路由 (CIDR) 的单个 IP 地址或范围的列表。</p>
</li>
</ul>
</li>
<li>
<p><code>to</code> 字段指定请求的操作，例如请求的主机或方法。</p>
</li>
<li>
<p><code>when</code> 字段指定规则匹配后需要满足的条件列表。</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl config set-context <span class="k">$(</span>kubectl config current-context<span class="k">)</span> <span class="se">\
</span><span class="se"></span> --namespace<span class="o">=</span>istioinaction
kubectl delete virtualservice,deployment,service,<span class="se">\
</span><span class="se"></span>destinationrule,gateway --all
 
kubectl apply -f services/catalog/kubernetes/catalog.yaml
kubectl apply -f services/webapp/kubernetes/webapp.yaml
kubectl apply -f services/webapp/istio/webapp-catalog-gw-vs.yaml
kubectl apply -f ch9/sleep.yaml -n default

<span class="c1"># webapp 工作负载部署在 istioinaction 命名空间中，并接受来自 default 命名空间中工作负载的未经身份验证的请求。</span>
<span class="c1"># catalog 工作负载部署在 istioinaction 命名空间中，并且仅接受来自同一命名空间中经过身份验证的工作负载的请求。</span>
kubectl apply -f ch9/meshwide-strict-peer-authn.yaml
kubectl apply -f ch9/workload-permissive-peer-authn.yaml  
</code></pre></td></tr></table>
</div>
</div><p><strong>基于URL的授权</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl apply -f ./ch9/allow-catalog-requests-in-web-app.yaml 

kubectl -n default <span class="nb">exec</span> deploy/sleep -c sleep -- <span class="se">\
</span><span class="se"></span>      curl -sSL webapp.istioinaction/api/catalog
 
kubectl -n default <span class="nb">exec</span> deploy/sleep -c sleep -- <span class="se">\
</span><span class="se"></span>      curl -sSL webapp.istioinaction/hello/world 
RBAC: access denied
</code></pre></td></tr></table>
</div>
</div><p><strong>注意</strong></p>
<ul>
<li>如果一个工作负载有ALLOW策略，则必须进行匹配才能允许流量通过。其他流量均会被 deny</li>
<li>建议添加一个 <code>拒绝</code> 所有流量的策略，考虑需要接受的流量，并为其创建策略。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 拒绝所有未明确指定 ALLOW 策略的请求,  deny-all 策略</span>
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
 name: deny-all
 namespace: istio-system     ❶
spec: <span class="o">{}</span>                     ❷

kubectl -n default <span class="nb">exec</span> deploy/sleep -c sleep -- <span class="se">\
</span><span class="se"></span>     curl -sSL webapp.istioinaction/api/catalog
     
kubectl delete -f ./ch9/allow-catalog-requests-in-web-app.yaml

kubectl -n default <span class="nb">exec</span> deploy/sleep -c sleep -- <span class="se">\ </span>           
     curl -sSL webapp.istioinaction/api/catalog
RBAC: access denied


<span class="c1"># 下内容默认允许所有请求</span>
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-all
  namespace: istio-system
spec:
  rules:
  - <span class="o">{}</span>
</code></pre></td></tr></table>
</div>
</div><hr/>
<h3 id="允许来自单个命名空间的请求">允许来自单个命名空间的请求</h3>
<blockquote>
<p>使用前提，源流量需要在 <code>网格中</code></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">apiVersion: <span class="s2">"security.istio.io/v1beta1"</span>
kind: <span class="s2">"AuthorizationPolicy"</span>
metadata:
 name: <span class="s2">"webapp-allow-view-default-ns"</span>
 namespace: istioinaction              ❶ istioinaction 中的工作负载
spec:
  rules:
  - from:                              ❷ 源自默认命名空间的源
    - source:
        namespaces: <span class="o">[</span><span class="s2">"default"</span><span class="o">]</span>
    to:                                ❸ 仅适用于HTTP GET方法
    - operation:
        methods: <span class="o">[</span><span class="s2">"GET"</span><span class="o">]</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="允许来自未经身份验证流量访问单个工作负载">允许来自未经身份验证流量，访问单个工作负载</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 删除了 from 字段</span>

apiVersion: <span class="s2">"security.istio.io/v1beta1"</span>
kind: <span class="s2">"AuthorizationPolicy"</span>
metadata:
 name: <span class="s2">"webapp-allow-unauthenticated-view"</span>
 namespace: istioinaction
spec:
  selector:
    matchLabels:
      app: webapp
  rules:
  - to:
    - operation:
        methods: <span class="o">[</span><span class="s2">"GET"</span><span class="o">]</span>
        
kubectl -n default <span class="nb">exec</span> deploy/sleep -c sleep -- <span class="se">\
</span><span class="se"></span>     curl -sSL webapp.istioinaction/api/catalog
</code></pre></td></tr></table>
</div>
</div><h3 id="允许来自单个-sa-账号的请求">允许来自单个 SA 账号的请求</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">apiVersion: <span class="s2">"security.istio.io/v1beta1"</span>
kind: <span class="s2">"AuthorizationPolicy"</span>
metadata:
 name: <span class="s2">"catalog-viewer"</span>
 namespace: istioinaction
spec:
 selector:
   matchLabels:
     app: catalog
 rules:
 - from:
   - source:
       principals: <span class="o">[</span><span class="s2">"cluster.local/ns/istioinaction/sa/webapp"</span><span class="o">]</span>    ❶ 允许带有webapp身份的请求
   to:
   - operation:
       methods: <span class="o">[</span><span class="s2">"GET"</span><span class="o">]</span>
       
kubectl -n default <span class="nb">exec</span> deploy/sleep -c sleep -- <span class="se">\
</span><span class="se"></span>      curl -sSL webapp.istioinaction/api/catalog
</code></pre></td></tr></table>
</div>
</div><h3 id="策略的条件匹配">策略的条件匹配</h3>
<ul>
<li><a href="https://istio.io/latest/docs/reference/config/security/conditions/">https://istio.io/latest/docs/reference/config/security/conditions/</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 当用户是管理员时允许所有操作。</span>
apiVersion: <span class="s2">"security.istio.io/v1beta1"</span>
kind: <span class="s2">"AuthorizationPolicy"</span>
metadata:
  name: <span class="s2">"allow-mesh-all-ops-admin"</span>
  namespace: istio-system
spec:
  rules:
    - from:
      - source:
          requestPrincipals: <span class="o">[</span><span class="s2">"auth@istioinaction.io/*"</span><span class="o">]</span>
      when:
      - key: request.auth.claims<span class="o">[</span>group<span class="o">]</span>     ❶ 指定Istio属性 
        values: <span class="o">[</span><span class="s2">"admin"</span><span class="o">]</span>                   ❷ 指定必须匹配的值列表
        
<span class="c1"># 此策略仅在满足两个条件时才允许请求：首先，令牌是由请求主体 auth@istioinaction.io/* 颁发的；其次，JWT 包含值为 admin 的组声明。 </span>
</code></pre></td></tr></table>
</div>
</div><p><code>principals</code> 和 <code>requestPrincipals</code> 。区别</p>
<ul>
<li><a href="https://istio.io/latest/docs/reference/config/security/authorization-policy/#Source">https://istio.io/latest/docs/reference/config/security/authorization-policy/#Source</a></li>
<li><code>principals</code> 是来自 <code>PeerAuthentication</code> 配置的 mTLS 连接的对等方，而 <code>requestPrincipals</code> 用于最终用户 <code>RequestAuthentication</code> 来自 JWT</li>
<li>是用于定义哪些主体有权访问服务或资源的全局身份标识，通常在策略配置中定义。</li>
<li><code>Principals</code> 是用于定义哪些主体有权访问服务或资源的全局身份标识，通常在策略配置中定义。</li>
<li><code>RequestPrincipals</code> 是在请求级别确定的主体身份，用于在请求到达服务时进行更细粒度的访问控制决策。这些可以基于请求中的信息动态计算。</li>
</ul>
<hr/>
<p><strong>暂时跳过此章节部分</strong></p>
<hr/>
<h1 id="数据平面故障排除">数据平面故障排除</h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl config set-context <span class="k">$(</span>kubectl config current-context<span class="k">)</span> <span class="se">\
</span><span class="se"></span> --namespace<span class="o">=</span>istioinaction
kubectl delete virtualservice,deployment,service,<span class="se">\
</span><span class="se"></span>destinationrule,gateway,authorizationpolicy,peerauthentication --all
kubectl delete authorizationpolicy,peerauthentication --all -n istio-system

kubectl apply -f services/catalog/kubernetes/catalog.yaml
kubectl apply -f ch10/catalog-deployment-v2.yaml
kubectl apply -f ch10/catalog-gateway.yaml
kubectl apply -f ch10/catalog-virtualservice-subsets-v1-v2.yaml

<span class="k">for</span> i in <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do</span> curl http://192.168.8.212/items <span class="se">\
</span><span class="se"></span>-H <span class="s2">"Host: catalog.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>-w <span class="s2">"\nStatus Code %{http_code}\n"</span><span class="p">;</span> sleep .5s<span class="p">;</span>  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="检查数据平面是否与最新配置同步">检查数据平面是否与最新配置同步</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"> istioctl proxy-status
</code></pre></td></tr></table>
</div>
</div><p>同步状态</p>
<ul>
<li><code>SYNCED</code> -特使已确认控制平面发送的最后一个配置。</li>
<li><code>NOT SENT</code> -控制平面没有向 Envoy 发送任何信息。这通常是因为控制平面没有东西要发送。路由发现服务（RDS）的 <code>istio-egressgateway</code> 就是这种情况。</li>
<li><code>STALE</code> -控制平面 <code>istiod</code> 已发送更新，但未确认。这表明以下情况之一：控制平面超载；Envoy 与控制平面之间缺乏连接或连接中断；或 Istio 存在错误。</li>
</ul>
<h2 id="利用-kiali-发现错误配置">利用 Kiali 发现错误配置</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">istioctl dashboard kiali
</code></pre></td></tr></table>
</div>
</div><p><img alt="image-20231001113810641" src="https://cdn.treesir.pub/images/2023/10/01/20231001113815.png"/></p>
<p><strong>使用 istioctl 发现错误配置</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">istioctl analyze
istioctl describe

<span class="c1"># 分析一下 istioinaction 命名空间</span>
Error <span class="o">[</span>IST0101<span class="o">]</span> <span class="o">(</span>VirtualService istioinaction/catalog-v1-v2<span class="o">)</span> Referenced host+subset in destinationrule not found: <span class="s2">"catalog.istioinaction.svc.cluster.local+version-v1"</span>
Error <span class="o">[</span>IST0101<span class="o">]</span> <span class="o">(</span>VirtualService istioinaction/catalog-v1-v2<span class="o">)</span> Referenced host+subset in destinationrule not found: <span class="s2">"catalog.istioinaction.svc.cluster.local+version-v2"</span>

istioctl x describe pod catalog-5df8455c79-rk4l9
VirtualService: catalog-v1-v2
   WARNING: No destinations match pod subsets <span class="o">(</span>checked <span class="m">1</span> HTTP routes<span class="o">)</span>
      Warning: Route to subset version-v1 but NO DESTINATION RULE defining subsets!
      Warning: Route to subset version-v2 but NO DESTINATION RULE defining subsets!
</code></pre></td></tr></table>
</div>
</div><h2 id="从-envoy-配置中手动发现错误配置">从 Envoy 配置中手动发现错误配置</h2>
<p><a href="https://www.envoyproxy.io/docs/envoy/v1.20.1/operations/admin">https://www.envoyproxy.io/docs/envoy/v1.20.1/operations/admin</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">istioctl dashboard envoy deploy/catalog -n istioinaction
</code></pre></td></tr></table>
</div>
</div><h3 id="使用-istioctl-查询-envoy-代理配置">使用 istioctl 查询 envoy 代理配置</h3>
<blockquote>
<p>通过 <code>istioctl proxy-config</code> 命令，我们可以根据 Envoy xDS API 检索和过滤工作负载的代理配置，其中每个子命令都有适当的名称：</p>
<ul>
<li><code>cluster</code> -读取群集配置</li>
<li><code>endpoint</code> -读取端点配置</li>
<li><code>listener</code> -读取监听器配置</li>
<li><code>route</code> -检索路由配置</li>
<li><code>secret</code> -读取秘密配置</li>
</ul>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">istioctl proxy-config listeners <span class="se">\
</span><span class="se"></span>     deploy/istio-ingressgateway -n istio-system
ADDRESSES PORT  MATCH DESTINATION
0.0.0.0   <span class="m">8080</span>  ALL   Route: http.8080 <span class="c1">#  8080 端口上的请求根据路由 http.8080 进行路由配置。</span>
0.0.0.0   <span class="m">15021</span> ALL   Inline Route: /healthz/ready*
0.0.0.0   <span class="m">15090</span> ALL   Inline Route: /stats/prometheus*

<span class="c1"># 在 8080 端口上配置了一个监听器。</span>
<span class="c1"># 流量将根据名为 http.8080 的路由进行路由，该监听器的路由名为 http.8080。</span>

 kubectl -n istio-system get svc istio-ingressgateway -o yaml <span class="se">\
</span><span class="se"></span><span class="p">|</span> grep <span class="s2">"ports:"</span> -A <span class="m">10</span>


<span class="c1"># http.8080 路由的流量被路由到哪些应用</span>
istioctl pc routes deploy/istio-ingressgateway <span class="se">\
</span><span class="se"></span>      -n istio-system --name http.8080
    
<span class="c1"># 按 Json 打印，将会更详细</span>
istioctl pc routes deploy/istio-ingressgateway -n istio-system <span class="se">\
</span><span class="se"></span>      --name http.8080 -o json
      
<span class="c1"># 查询 ENVOY 群组配置</span>
istioctl proxy-config clusters <span class="se">\
</span><span class="se"></span>     deploy/istio-ingressgateway.istio-system <span class="se">\
</span><span class="se"></span>     --fqdn catalog.istioinaction.svc.cluster.local  <span class="se">\
</span><span class="se"></span>     --port <span class="m">80</span> <span class="se">\
</span><span class="se"></span>     --subset version-v1
     
<span class="c1"># 找到请求会失败原因，因为 VirtualService 会路由到不存在的群组。</span>

istioctl analyze ch10/catalog-destinationrule-v1-v2.yaml <span class="se">\
</span><span class="se"></span>    -n istioinaction
    
<span class="c1"># 修复问题</span>
kubectl apply -f ch10/catalog-destinationrule-v1-v2.yaml
 
<span class="c1"># 再次查询聚类，我们应该会看到新定义的 version-v1 和 version-v2 子集：</span>
istioctl pc clusters deploy/istio-ingressgateway -n istio-system <span class="se">\
</span><span class="se"></span>     --fqdn catalog.istioinaction.svc.cluster.local --port <span class="m">80</span>
     
<span class="c1"># 查询 ENVOY 群组端点，群组端点可以使用上面的 "查询 ENVOY 群组配置" 获取到。</span>
istioctl pc endpoints deploy/istio-ingressgateway -n istio-system <span class="se">\
</span><span class="se"></span>--cluster <span class="s2">"outbound|80|version-v1|catalog.istioinaction.svc.cluster.local"</span>

<span class="c1"># 安装端点IP 查询属于哪个 pod</span>
kubectl get pods -n istioinaction <span class="se">\
</span><span class="se"></span>    --field-selector status.podIP<span class="o">=</span>10.42.8.208
NAME                       READY   STATUS    RESTARTS   AGE
catalog-5df8455c79-rk4l9   2/2     Running   <span class="m">0</span>          29m
</code></pre></td></tr></table>
</div>
</div><h2 id="排除应用程序问题">排除应用程序问题</h2>
<blockquote>
<p>对于基于微服务的应用程序来说，服务代理生成的日志和指标有助于排除许多问题，如发现导致<code>性能瓶颈的服务</code>、识别经常出现<code>故障的端点</code>、<code>检测性能下降</code>等。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 设置会超时的间歇性慢速工作负载</span>

<span class="nv">CATALOG_POD</span><span class="o">=</span><span class="k">$(</span>kubectl get pods -l <span class="nv">version</span><span class="o">=</span>v2 -n istioinaction -o  <span class="nv">jsonpath</span><span class="o">={</span>.items..metadata.name<span class="o">}</span><span class="p">|</span>cut -d <span class="s1">' '</span> -f1<span class="k">)</span>
 
kubectl -n istioinaction <span class="nb">exec</span> -c catalog <span class="nv">$CATALOG_POD</span>  <span class="se">\
</span><span class="se"></span>  -- curl -s -X POST -H <span class="s2">"Content-Type: application/json"</span> <span class="se">\
</span><span class="se"></span>  -d <span class="s1">'{"active": true, "type": "latency", "volatile": true}'</span> <span class="se">\
</span><span class="se"></span>  localhost:3000/blowup
  
<span class="c1"># 对 catalog-v1-v2 虚拟服务进行配置，使其在请求处理时间超过半秒时超时</span>
kubectl patch vs catalog-v1-v2 -n istioinaction --type json <span class="se">\
</span><span class="se"></span>      -p <span class="s1">'[{"op": "add", "path": "/spec/http/0/timeout", "value": "0.5s"}]'</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>两种变化：请求半秒后超时，工作负载间歇性变慢。</strong></p>
<p><img alt="Pasted image 20231001120739" src="https://cdn.treesir.pub/images/2023/10/01/20231001120743.png"/></p>
<hr/>
<p><strong>为 <code>catalog</code> 工作负载生成持续流量。生成我们分析所需要的日志和遥测数据</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="k">for</span> i in <span class="o">{</span>1..9999<span class="o">}</span><span class="p">;</span> <span class="k">do</span> curl http://192.168.8.212/items <span class="se">\
</span><span class="se"></span>-H <span class="s2">"Host: catalog.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>-w <span class="s2">"\nStatus Code %{http_code}\n"</span><span class="p">;</span> sleep 1s<span class="p">;</span>  <span class="k">done</span>

<span class="c1"># 此操作会间断性的出现 错误</span>
upstream request timeout
Status Code <span class="m">504</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="查看-envoyhttpswwwenvoyproxyio-访问日志">查看 <a href="https://www.envoyproxy.io/">Envoy</a> 访问日志</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"> kubectl -n istio-system logs deploy/istio-ingressgateway <span class="se">\
</span><span class="se"></span> <span class="p">|</span> grep <span class="m">504</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>默认情况下，只有 Istio 的演示安装配置文件会将访问日志打印到标准输出。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 可以通过如下方法配置</span>
istioctl install --set meshConfig.accessLogFile<span class="o">=</span><span class="s2">"/dev/stdout"</span>
</code></pre></td></tr></table>
</div>
</div><p>注意，这将启用整个网格的访问日志记录。要启用某个特定工作负载的访问日志，可以使用  <code>Telemetry API</code></p>
</blockquote>
<p><strong>更改特使访问日志格式</strong></p>
<blockquote>
<p>这种更新会应用到整个网格，从而大大增加每个工作负载代理的 <code>日志记录量</code>。在较大的集群中，我们不鼓励这样做，因为这<code>会给日志记录基础架构造成压力</code>。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">istioctl install --set <span class="nv">profile</span><span class="o">=</span>demo <span class="se">\
</span><span class="se"></span>    --set meshConfig.accessLogEncoding<span class="o">=</span><span class="s2">"JSON"</span>
 
<span class="c1"># 再次查看日志，使用 jq 格式化后，可观性变好</span>
kubectl -n istio-system logs deploy/istio-ingressgateway <span class="se">\
</span><span class="se"></span><span class="p">|</span> grep <span class="m">504</span> <span class="p">|</span> tail -n <span class="m">1</span> <span class="p">|</span> jq
<span class="o">{</span>
  <span class="s2">"protocol"</span>: <span class="s2">"HTTP/1.1"</span>,
  <span class="s2">"method"</span>: <span class="s2">"GET"</span>,
  <span class="s2">"connection_termination_details"</span>: null,
  <span class="s2">"response_flags"</span>: <span class="s2">"UT"</span>, <span class="c1"># Envoy 返回标识，值为 UT ，代表 "上游请求超时"</span>
  <span class="s2">"x_forwarded_for"</span>: <span class="s2">"192.168.8.170"</span>,
  <span class="s2">"upstream_host"</span>: <span class="s2">"10.42.4.139:3000"</span>, <span class="c1"># 接收请求的上游主机</span>
  <span class="s2">"upstream_service_time"</span>: null,
  <span class="s2">"bytes_received"</span>: 0,
  <span class="s2">"downstream_remote_address"</span>: <span class="s2">"192.168.8.170:21110"</span>,
  <span class="s2">"response_code"</span>: 504,
  <span class="s2">"upstream_local_address"</span>: <span class="s2">"10.42.8.196:45484"</span>,
  <span class="s2">"upstream_transport_failure_reason"</span>: null,
  <span class="s2">"upstream_cluster"</span>: <span class="s2">"outbound|80|version-v2|catalog.istioinaction.svc.cluster.local"</span>,
  <span class="s2">"duration"</span>: 500, <span class="c1">#  超过 500 毫秒的持续时间</span>
  <span class="s2">"response_code_details"</span>: <span class="s2">"response_timeout"</span>,
  <span class="s2">"bytes_sent"</span>: 24,
  <span class="s2">"downstream_local_address"</span>: <span class="s2">"10.42.8.196:8080"</span>,
  <span class="s2">"request_id"</span>: <span class="s2">"3c93d66c-161f-9f4d-8b0b-783ec5f17423"</span>,
  <span class="s2">"start_time"</span>: <span class="s2">"2023-10-01T04:17:20.471Z"</span>,
  <span class="s2">"route_name"</span>: null,
  <span class="s2">"path"</span>: <span class="s2">"/items"</span>,
  <span class="s2">"requested_server_name"</span>: null,
  <span class="s2">"authority"</span>: <span class="s2">"catalog.istioinaction.io"</span>,
  <span class="s2">"user_agent"</span>: <span class="s2">"curl/8.1.2"</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>response_flags:</p>
<blockquote>
<p><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage">https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage</a></p>
</blockquote>
<ul>
<li><code>UT</code> ，代表 “上游请求超时”</li>
<li><code>UH</code> -没有健康的上游（群集没有工作负载）</li>
<li><code>NR</code> -未配置路由</li>
<li><code>UC</code> -上游连接终止</li>
<li><code>DC</code> -下行连接终止</li>
</ul>
</li>
<li>
<p>upstream_host: 值表示处理请求的工作负载的实际 IP 地址。</p>
</li>
</ul>
<p><strong>DEBUG</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="nv">SLOW_POD_IP</span><span class="o">=</span><span class="k">$(</span>kubectl -n istio-system logs deploy/istio-ingressgateway <span class="se">\
</span><span class="se"></span><span class="p">|</span> grep <span class="m">504</span> <span class="p">|</span> tail -n <span class="m">1</span> <span class="p">|</span> jq -r .upstream_host <span class="p">|</span> cut -d <span class="s2">":"</span> -f1<span class="k">)</span>
<span class="nv">SLOW_POD</span><span class="o">=</span><span class="k">$(</span>kubectl get pods -n istioinaction <span class="se">\
</span><span class="se"></span>     --field-selector status.podIP<span class="o">=</span><span class="nv">$SLOW_POD_IP</span> <span class="se">\
</span><span class="se"></span>     -o <span class="nv">jsonpath</span><span class="o">={</span>.items..metadata.name<span class="o">}</span><span class="k">)</span>
     
<span class="c1"># 查看入口网关的日志记录级别  </span>
istioctl proxy-config log <span class="se">\
</span><span class="se"></span>     deploy/istio-ingressgateway -n istio-system
     
<span class="c1"># 提高 connection 、 http 的日志记录级别。, http和 router 日志记录</span>
istioctl proxy-config log deploy/istio-ingressgateway <span class="se">\
</span><span class="se"></span>   -n istio-system <span class="se">\
</span><span class="se"></span>   --level http:debug,router:debug,connection:debug,pool:debug

<span class="c1"># 查看现在的日志，分析日志。得到有一个实例，响应超时，导致客户端断开。</span>
kubectl logs -n istio-system deploy/istio-ingressgateway <span class="se">\
</span><span class="se"></span>&gt; /tmp/ingress-logs.txt

<span class="o">[</span>2023-10-01T04:14:35.091Z<span class="o">]</span> <span class="s2">"GET /items HTTP/1.1"</span> <span class="m">504</span> UT response_timeout - <span class="s2">"-"</span> <span class="m">0</span> <span class="m">24</span> <span class="m">500</span> - <span class="s2">"192.168.8.170"</span> <span class="s2">"curl/8.1.2"</span> <span class="s2">"412ca5dc-e88a-9ffb-97cb-52c1298432c5"</span> <span class="s2">"catalog.istioinaction.io"</span> <span class="s2">"10.42.4.139:3000"</span> outbound<span class="p">|</span>80<span class="p">|</span>version-v2<span class="p">|</span>catalog.istioinaction.svc.cluster.local 10.42.8.196:44492 10.42.8.196:8080 192.168.8.170:59883 - -

</code></pre></td></tr></table>
</div>
</div><p><strong>使用 ksniff 检查网络流量</strong></p>
<blockquote>
<p>Ksniff– <code>kubectl</code> 插件，使用 tcpdump 捕获 Pod 的网络流量，并将其重定向至 Wireshark</p>
<p>和 Wireshark 配合使用，可提供流畅的调试体验</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 安装 krew</span>
https://krew.sigs.k8s.io/docs/user-guide/setup/install/#bash


<span class="c1"># 要安装 ksniff</span>
kubectl krew install sniff

<span class="c1"># 安装 wireshark</span>
www.wireshark.org/download.html

<span class="c1"># wireshark -v</span>
Wireshark 4.0.8 <span class="o">(</span>v4.0.8-0-g81696bb74857<span class="o">)</span>.

<span class="c1"># 检查 LOCALHOST 接口上的网络流量</span>
kubectl sniff -n istioinaction <span class="nv">$SLOW_POD</span> -i lo

<span class="c1"># 模拟请求</span>
<span class="k">for</span> i in <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do</span> curl http://192.168.8.212/items <span class="se">\
</span><span class="se"></span>-H <span class="s2">"Host: catalog.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>-w <span class="s2">"\nStatus Code %{http_code}\n"</span><span class="p">;</span> sleep .5s<span class="p">;</span>  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><p>Wireshark 中执行查询 <code>http contains "GET /items"</code></p>
<p><img alt="image-20231001162038712" src="https://cdn.treesir.pub/images/2023/10/01/20231001162043.png"/></p>
<p>Wireshak 中抓取 TCP 流包，<code>tcp.stream eq 4</code></p>
<p><img alt="image-20231001163434948" src="https://cdn.treesir.pub/images/2023/10/01/20231001163438.png"/></p>
<p><img alt="image-20231001163345766" src="https://cdn.treesir.pub/images/2023/10/01/20231001195449.png"/></p>
<p>图二数据包，方框依次说明:</p>
<ul>
<li>TCP 三次握手以建立 TCP 连接</li>
<li>连接建立后，连接被重复用于客户端的多个请求，并且所有请求都成功送达。</li>
<li>客户端发出另一个请求，服务器确认了该请求，但响应时间超过半秒。从数据包 <code>82</code> 到数据包 <code>86</code> 的时间差可以看出这一点。<code>15.812597</code> <code>16.313059</code>。</li>
</ul>
<p><strong>TCP 控制标志</strong></p>
<ul>
<li>同步 ( <code>SYN</code> ) 用于建立新连接。</li>
<li>确认（ <code>ACK</code> ）用于确认数据包已成功接收。</li>
<li>Finish ( <code>FIN</code> ) 用于请求终止连接。</li>
</ul>
<hr/>
<h2 id="使用-envoy-telemetry-了解应用程序">使用 Envoy telemetry 了解应用程序</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="k">for</span> i in <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do</span> curl http://192.168.8.212/items <span class="se">\
</span><span class="se"></span>-H <span class="s2">"Host: catalog.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>-w <span class="s2">"\nStatus Code %{http_code}\n"</span><span class="p">;</span> sleep .5s<span class="p">;</span>  <span class="k">done</span>

<span class="c1"># 代理 Grafana</span>
kubectl -n prometheus port-forward svc/prom-grafana 3000:80
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>登陆Grafana 找到 <code>Istio Service Dashboard</code></p>
<blockquote>
<p>正常来说，这里会看到数据，如果没有，检查 Dashboard 版本是否与当前 Istio 版本匹配。</p>
<p><a href="https://grafana.com/grafana/dashboards/7636-istio-service-dashboard/?tab=revisions">https://grafana.com/grafana/dashboards/7636-istio-service-dashboard/?tab=revisions</a></p>
</blockquote>
<p>服务器报告的成功率是 100%，因为 Envoy 代理会将下游终止请求的响应代码标记为 <code> 0</code>，这不是 <code>5xx</code> 响应，因此 <code>不计入失败率</code>。与此同时，客户端将请求标记为正确的状态代码 504（“网关超时”），因此它被计入失败请求中</p>
<p><img alt="image-20231001165430593" src="https://cdn.treesir.pub/images/2023/10/01/20231001165433.png"/></p>
<p><strong>使用 Prometheus 查询受影响的 Pods</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl -n prometheus port-forward <span class="se">\
</span><span class="se"></span>svc/prom-kube-prometheus-stack-prometheus <span class="m">9090</span>

<span class="c1"># 使用 PromQL 查询</span>
sort_desc<span class="o">(</span>sum<span class="o">(</span>irate<span class="o">(</span>
    istio_requests_total<span class="o">{</span>
      <span class="nv">reporter</span><span class="o">=</span><span class="s2">"destination"</span>,
      <span class="nv">destination_service</span><span class="o">=</span>~<span class="s2">"catalog.istioinaction.svc.cluster.local"</span>,
      <span class="nv">response_flags</span><span class="o">=</span><span class="s2">"DC"</span><span class="o">}[</span>5m<span class="o">]))</span>
by <span class="o">(</span>response_code, pod_name<span class="o">))</span>
</code></pre></td></tr></table>
</div>
</div><p><img alt="image-20231001165846628" src="https://cdn.treesir.pub/images/2023/10/01/20231001165848.png"/></p>
</li>
</ul>
<p><strong>切换为图表</strong></p>
<p><img alt="image-20231001170221341" src="https://cdn.treesir.pub/images/2023/10/01/20231001170223.png"/></p>
<p><strong>由此我们就找到了存在故障到POD</strong>，可以使用一个错误的 app 标签，将此 pod 进行移出端点。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl patch pod catalog-v2-6666d48675-m8bck <span class="se">\
</span><span class="se"></span>  -p <span class="s1">'{"metadata":{"labels":{"app":"catalog-discard"}}}'</span> <span class="se">\
</span><span class="se"></span>  -n istioinaction
pod/catalog-v2-6666d48675-m8bck patched
</code></pre></td></tr></table>
</div>
</div><p><strong>执行后将恢复正常</strong></p>
<p><img alt="image-20231001171118828" src="https://cdn.treesir.pub/images/2023/10/01/20231001171122.png"/></p>
<h1 id="控制平面的性能调整">控制平面的性能调整</h1>
<h2 id="幽灵工作负载">幽灵工作负载</h2>
<blockquote>
<p>性能下降时出现的一个常见现象被称为幽灵工作负载：服务被配置为将流量路由到早已不存在的端点，从而导致请求失败。</p>
</blockquote>
<p><img alt="Pasted image 20231001195447" src="https://cdn.treesir.pub/images/2023/10/01/20231001195449-1.png"/></p>
<p><strong>决定性能的因素</strong></p>
<ul>
<li>变化率 - 较高的变化率需要更多的处理来保持数据平面的同步。</li>
<li>分配资源–如果需求超过了分配给 <code>istiod</code> 的资源，工作就必须排队。，工作就必须排队，从而导致更新分配速度减慢。</li>
<li>需要更新的工作负载数量–需要更强的处理能力和网络带宽，才能将更新分配给更多的工作负载。</li>
<li>配置大小-分发较大的 Envoy 配置需要更强的处理能力和更大的网络带宽。</li>
</ul>
<p><img alt="Pasted image 20231001195925" src="https://cdn.treesir.pub/images/2023/10/01/20231001195930.png"/></p>
<hr/>
<h2 id="监控控制平面">监控控制平面</h2>
<blockquote>
<p>istiod 公开了衡量关键性能指标持续时间和频率的指标，如资源利用率、传入或传出流量导致的负载、错误率等。这些指标有助于了解控制平面的运行情况、即将发生的故障，以及如何排除可能已经出现错误的故障。</p>
<p><a href="https://istio.io/latest/docs/reference/commands/pilot-discovery/#metrics">https://istio.io/latest/docs/reference/commands/pilot-discovery/#metrics</a></p>
</blockquote>
<p>对于 Istio 的控制平面，衡量延迟的标准是控制平面向数据平面分发更新的速度。衡量延迟的关键指标是</p>
<ul>
<li><code>pilot_proxy_convergence_time</code> 测量整个流程从代理推送请求进入队列到分发到工作负载的持续时间。</li>
<li><code>pilot_proxy_queue_time</code> 衡量的是推送请求在队列中等待工作者处理的时间。如果在推送队列中花费了大量时间，我们可以纵向扩展 <code>istiod</code> ，提高并发处理能力。</li>
<li><code>pilot_xds_push_time</code> 衡量向工作负载推送 Envoy 配置所需的时间。时间增加表明网络带宽因数据传输量而超载。在后面的章节中，我们将介绍如何通过减少配置更新的大小和每个代理的变更频率来大大改善这种情况。</li>
</ul>
<p><img alt="Pasted image 20231001200601" src="https://cdn.treesir.pub/images/2023/10/01/20231001200603.png"/></p>
<p><strong>在之前配置 Istio 的 Control Plane Dashboard 中可以看到</strong></p>
<blockquote>
<p>99.9% 的推送分配到工作负载的时间少于 100 毫秒，这是理想状态</p>
</blockquote>
<p><img alt="image-20231001200751340" src="https://cdn.treesir.pub/images/2023/10/01/20231001200753.png"/></p>
<hr/>
<p><strong>建议使用这些基线来考虑阈值</strong></p>
<ul>
<li>延迟时间超过 1 秒且超过 10 秒时，发出严重警告</li>
<li>当延迟时间超过 2 秒且超过 10 秒时，严重程度为临界状态</li>
</ul>
<blockquote>
<p>当收到第一个警报时，不必惊慌；这只是一个行动呼吁，说明服务延迟已经增加，性能需要优化。但是，如果不加以控制，进一步的性能下降将影响最终用户。</p>
</blockquote>
<h3 id="饱和度">饱和度</h3>
<p><strong>CPU</strong></p>
<blockquote>
<p>饱和度指标显示资源的使用能力。如果利用率超过 90%，说明服务已经饱和或即将饱和。当 <code>istiod</code> 达到饱和时，由于推送请求排队等待处理的时间较长，分发更新的速度会减慢。</p>
<p>饱和通常是由最受限制的资源造成的，由于 <code>istiod</code> 是 <code> CPU 密集型资源</code>，通常是 <code>CPU 首先饱和</code>。衡量 CPU 利用率的指标有</p>
<ul>
<li><code>container_cpu_usage_seconds_total</code> 测量 Kubernetes 容器报告的 CPU 利用率。</li>
<li><code>process_cpu_seconds_total</code> 根据 <code>istiod</code> 仪器报告的 CPU 利用率进行测量。</li>
</ul>
</blockquote>
<p><strong>流量</strong></p>
<blockquote>
<p>流量指标衡量系统所承受的负载。例如，对于网络应用程序来说，负载是以每秒请求数来定义的。同时，Istio 的控制平面会接收传入流量（以配置更改的形式），并产生传出流量（将更改推送到数据平面）。我们需要测量这两个方向的流量，以找到性能限制因素；在此基础上，我们可以采用不同的方法来提高性能。</p>
<p>输入流量的指标如下：</p>
<ul>
<li><code>pilot_inbound_updates</code> 显示每个 <code>istiod</code> 实例收到的配置更新计数。</li>
<li><code>pilot_push_triggers</code> 是触发推送的事件总数。推送触发器可以是以下类型之一： <code>service</code> , <code>endpoint</code> 或 <code>config</code> 。其中 <code>config</code> 表示任何 Istio 自定义资源，如 <code>Gateway</code> 或 <code>VirtualService</code> 。.</li>
<li><code>pilot_services</code> 衡量试点已知的服务数量。当试点已知的服务越多，就需要对传入事件进行更多处理，以生成 Envoy 配置。因此，该指标对 <code>istiod</code> 因传入流量而承受的负载起着重要作用。</li>
</ul>
<p>出站流量指标如下：</p>
<ul>
<li><code>pilot_xds_pushes</code> 测量控制平面发出的所有类型的推送，如 <code>listener</code> 、 <code>route</code> 和 <code>cluster</code> 。, <code>route</code>, <code>cluster</code>和 <code>endpoint</code> 更新。该指标在  <code>Istio Control Plane Dashboard</code> 中展示。</li>
</ul>
</blockquote>
<p><img alt="Pasted image 20231001201526" src="https://cdn.treesir.pub/images/2023/10/01/20231001201530.png"/></p>
<p><strong>Pilot Pushes 图表显示推送频率。XDS 活动连接图显示由控制平面管理的端点</strong></p>
<ul>
<li><code>pilot_xds</code> 显示每个试点实例处理的工作负载总连接数。该指标在<code>Istio Control Plane Dashboard</code>  显示，标题为 <code>ADS Monitoring</code>。</li>
<li><code>envoy_cluster_upstream_cx_tx_bytes_total</code> 测量通过网络传输的配置大小。</li>
</ul>
<hr/>
<h3 id="故障">故障</h3>
<blockquote>
<p>错误代表 <code>istiod</code> 的故障率，通常在服务饱和、性能下降时出现。</p>
</blockquote>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>pilot_total_xds_rejects</td>
<td>pushes 被拒绝的配置推送次数</td>
</tr>
<tr>
<td>pilot_xds_eds_reject,pilot_xds_lds_reject,pilot_xds_rds_reject,pilot_xds_cds_reject</td>
<td>pilot_total_xds_rejects 指标的子集，用于缩小 API 推送被拒绝的范围</td>
</tr>
<tr>
<td>pilot_xds_write_timeout</td>
<td>The sum of errors and timeouts when initiating a push 启动推送时的错误和超时总和</td>
</tr>
<tr>
<td>pilot_xds_push_context_errors</td>
<td>Istio Pilot 在生成 Envoy 配置时的错误计数；通常是 Istio Pilot 中的错误</td>
</tr>
</tbody>
</table>
<h2 id="调整性能">调整性能</h2>
<h3 id="提高控制平面性能的选项">提高控制平面性能的选项</h3>
<p>如下：</p>
<ul>
<li>忽略与服务网格无关的事件。</li>
<li>在较长时间内批处理事件，以减少更新数据平面所需的推送次数。</li>
<li>通过以下方式分配额外资源
<ul>
<li>扩大 <code>istiod</code> 部署规模，通过在试点实例之间分配所管理的工作负载数量来减少负载</li>
<li>扩大 <code>istiod</code> 部署规模，以加快 Envoy 配置的生成速度，同时处理更多推送请求</li>
</ul>
</li>
<li>更新针对工作负载的相关配置去通知控制平面，只向匹配工作负载推送相关更新。
<ul>
<li>只发送服务代理进程所需的最小配置，从而减少发送到服务代理的配置大小</li>
<li>减少为单个事件更新的代理数量</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl config set-context <span class="k">$(</span>kubectl config current-context<span class="k">)</span> <span class="se">\
</span><span class="se"></span> --namespace<span class="o">=</span>istioinaction
 
kubectl delete virtualservice,deployment,service,<span class="se">\
</span><span class="se"></span>destinationrule,gateway --all

kubectl -n istioinaction apply -f services/catalog/kubernetes/catalog.yaml
kubectl -n istioinaction apply -f ch11/catalog-virtualservice.yaml
kubectl -n istioinaction apply -f ch11/catalog-gateway.yaml
kubectl -n istioinaction apply -f ch11/sleep-dummy-workloads.yaml

<span class="c1">#  在 Envoy 配置中添加一些虚假服务，使情况进一步恶化，创建 600个</span>
kubectl -n istioinaction apply -f ./ch11/resources-600.yaml

<span class="c1"># 现在单个 istiod 实例管理着 13 个工作负载（包括入口和出口网关），已知的服务总数还有 600 个，这增加了生成 Envoy 配置的处理量，并使推送给工作负载的配置变得更加臃肿。</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>测量优化前的性能</strong></p>
<blockquote>
<p><strong>了解 P99</strong></p>
<p>P99 或第 99 百分位数测量的是 <code>传播最快</code> 的 99% 更新的最大延迟。例如，<code>80 毫秒的 P99 延迟告诉我们，99% 的请求传播速度超过 80 毫秒！</code>我们并不确切知道这些请求中的每一个请求的延迟时间，大多数请求的延迟时间可能只有几毫秒。但我们知道，如果只考虑最快的 99%，即使是表现最差的请求也能在 80 毫秒内得到服务。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 让我们重复运行 10 次测试，每次重复之间延迟 2.5 秒，以分散更改，避免成批更改：</span>
./bin/performance-test.sh --reps <span class="m">10</span> <span class="se">\
</span><span class="se"></span>  --delay 2.5 --gateway 192.168.8.212
...
<span class="o">==============</span>
Push count: <span class="m">700</span> <span class="c1"># Push 应用更改的次数</span>
Latency in the last minute: 0.49 seconds <span class="c1"># 最后一分钟的延迟</span>

<span class="c1"># 根据测试结果，使用当前配置分发更改时，共执行了 700 次推送，P99 延迟为 0.49 毫秒。</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>使用SIDECARS 减少配置大小和推送次数</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 计算一下 catalog 工作负载的配置大小</span>
<span class="nv">CATALOG_POD</span><span class="o">=</span><span class="k">$(</span>kubectl -n istioinaction get pod -l <span class="nv">app</span><span class="o">=</span>catalog <span class="se">\
</span><span class="se"></span>    -o <span class="nv">jsonpath</span><span class="o">={</span>.items..metadata.name<span class="o">}</span>  <span class="p">|</span> cut -d <span class="s1">' '</span> -f 1<span class="k">)</span>
    
kubectl -n istioinaction <span class="nb">exec</span> -ti <span class="nv">$CATALOG_POD</span> -c catalog <span class="se">\
</span><span class="se"></span>    -- curl -s localhost:15000/config_dump &gt; /tmp/config_dump
    
du -sh /tmp/config_dump
2.3M    /tmp/config_dump

<span class="c1"># 配置大小为 2.3M 。这已经很大了！即使是 200 个工作负载的中型集群，Envoy 配置的大小也达到了 920 MB，这就需要更多的计算能力、网络带宽和内存，因为这些配置都存储在每个旁路代理中。</span>

apiVersion: networking.istio.io/v1beta1
kind: Sidecar
metadata:
  name: default
  namespace: istioinaction
spec:
  workloadSelector:  <span class="c1"># 字段限制了 Sidecar 配置适用的工作负载。</span>
    labels:
      app: foo
  egress: <span class="c1"># egress 字段指定了应用程序通过 Sidecar 向外部服务发送出站流量的处理方式。如果省略，配置将从更通用的 Sidecar（如果存在）继承出口配置；否则，配置将返回到访问所有其他服务的默认行为。</span>
  - hosts:
    - <span class="s2">"./bar.istioinaction.svc.cluster.local"</span>
    - <span class="s2">"istio-system/*"</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Sidecar 其他字段含义</p>
<ul>
<li>outboundTrafficPolicy: 指定处理出站流量的模式。可以设置为以下任一模式
<ul>
<li><code>REGISTRY_ONLY</code> 模式，可将工作负载配置为只允许向其配置的服务发送出站流量</li>
<li><code>ALLOW_ANY</code> 模式，允许向任何目的地发送出站流量</li>
</ul>
</li>
</ul>
<p>当 <code>Sidecar</code> 资源应用于工作负载时，控制平面会使用 <code>egress</code> 字段来确定工作负载需要访问哪些服务。这样，Istio 的控制平面就能识别相关配置和更新，并只向相应代理发送这些配置和更新。避免了生成和分发所有关于如何访问其他服务的配置，从而减少了 CPU、内存和网络带宽消耗。</p>
</blockquote>
<h3 id="全网格-sidecar-配置定义"><strong>全网格 Sidecar 配置定义</strong></h3>
<blockquote>
<p>要减少发送到每个服务代理的 Envoy 配置并提高控制平面性能，最简单的方法就是定义一个全网状网络的 Sidecar 配置，只允许出口流量到 <code>istio-system</code> 名称空间中的服务。定义这样的默认配置后，网状网络中的所有代理都将获得仅连接控制平面的最低配置，并放弃连接其他服务的所有配置。这种方法引导服务所有者走上正确的道路，为其工作负载定义更具体的 Sidecar 定义，并明确说明其服务所需的所有出口流量，从而确保工作负载获得其流程所需的最低相关配置。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">apiVersion: networking.istio.io/v1beta1
kind: Sidecar
metadata:
  name: default                ❶  istio-system 命名空间中的 Sidecar 将适用于整个网格。
  namespace: istio-system      ❶
spec:
  egress:
  - hosts:
    - <span class="s2">"istio-system/*"</span>         ❷ 出口流量仅为 istio 系统命名空间中的工作负载配置。
    - <span class="s2">"prometheus/*"</span>
  outboundTrafficPolicy:
    mode: REGISTRY_ONLY        ❸ REGISTRY_ONLY 模式只允许向 Sidecar 配置的服务发送出站流量。
    
<span class="c1"># 应用到集群</span>
kubectl apply -f ch11/sidecar-mesh-wide.yaml

<span class="c1"># 再次验证一下</span>
kubectl -n istioinaction <span class="nb">exec</span> -ti <span class="nv">$CATALOG_POD</span> -c catalog <span class="se">\
</span><span class="se"></span>    -- curl -s localhost:15000/config_dump &gt; /tmp/config_dump
    
du -sh /tmp/config_dump
644K    /tmp/config_dump <span class="c1"># 配置大小从 2.3 MB 大幅减少到 644K。</span>

<span class="c1"># 现在再次测试一下 P99</span>
./bin/performance-test.sh --reps <span class="m">10</span> <span class="se">\
</span><span class="se"></span>  --delay 2.5 --gateway 192.168.8.212
  
Push count: <span class="m">74</span>
Latency in the last minute: 0.10 seconds
</code></pre></td></tr></table>
</div>
</div><p><strong>推送次数和延迟都有所下降。性能的提升说明了定义全网格 <code>Sidecar</code> 资源的重要性。</strong></p>
<h3 id="sidecar-配置范围">Sidecar 配置范围</h3>
<blockquote>
<p>与 <code>PeerAuthentication</code> 资源类似，可应用于不同范围</p>
<ul>
<li>全网格 Sidecar适用于网格中的所有工作负载，并可定义默认值，例如限制出口流量，除非另有明确规定。要创建全网格配置，可在 Istio 安装命名空间（如 <code>istio-system</code> ）中应用。按照惯例，整个网状网络的 Sidecar 命名为 <code>default</code> 。</li>
<li>命名空间范围的 Sidecar 配置优先级更高，可覆盖全网格范围的配置。要创建命名空间的 Sidecar 配置，请在所需的命名空间中应用该配置，而无需定义 <code>workloadSelector</code> 字段。按照惯例，命名空间范围内的 Sidecar 也被命名为 <code>default</code></li>
<li>特定于工作负载的 Sidecar 配置针对的是与 <code>workloadSelector</code> 属性匹配的特定工作负载。该配置最为具体，可覆盖整个网格和整个命名空间的配置。</li>
</ul>
</blockquote>
<h3 id="忽略事件">忽略事件</h3>
<blockquote>
<p>Istio 控制平面默认监视所有命名空间中 Pod、服务和其他资源的创建事件，在大型集群中，这可能会给控制平面造成压力，因为控制平面需要处理并生成每个事件的 Envoy 配置，以保持数据平面的更新。</p>
<p>为了减轻这种压力，Istio 1.10 添加了名为命名空间发现选择器的新功能，允许您精确调整控制平面所关注的入站事件。通过该功能，您可以准确指定要关注的工作负载和端点命名空间。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 启用发现选择器功能</span>
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  namespace: istio-system
spec:
  meshConfig:
    discoverySelectors:              ❶ 启用发现选择器
      - matchLabels:
          istio-discovery: enabled   ❷ 指定要使用的标签
          
<span class="c1"># 将控制平面处理的命名空间子集限制为只有标有 istio-discovery: enabled 的命名空间。.如果某个命名空间没有该标签，则会被忽略。</span>


<span class="c1"># 在集群中要包含大部分命名空间，只排除一小部分，可以使用标签匹配表达式来指定不包含哪些命名空间。</span>
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  namespace: istio-system
spec:
  meshConfig:
    discoverySelectors:
      - matchExpressions:
        - key: istio-exclude
          operator: NotIn
          values:
            - <span class="s2">"true"</span>
            
istioctl install -y -f ch11/istio-discovery-selector.yaml

<span class="c1"># 创建一个包含新工作负载的新命名空间。给这个新命名空间贴上如下标签</span>
kubectl label ns new-namespace istio-exclude<span class="o">=</span><span class="nb">true</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="事件批处理和推送节流特性">事件批处理和推送节流特性</h3>
<p><img alt="Pasted image 20231001210950" src="https://cdn.treesir.pub/images/2023/10/01/20231001210952.png"/></p>
<blockquote>
<p><code>反向缩短周期可确保更快的更新</code>。但是，这样做会产生许多控制平面可能无法分发的推送请求；这些请求将在推送队列中被节流，从而<code>导致延迟增加</code>。</p>
</blockquote>
<p><strong>环境变量来定义批处理周期和推送节流</strong></p>
<ul>
<li><code>PILOT_DEBOUNCE_AFTER</code> -指定将事件添加到推送队列的消隐时间。默认设置为 100 ms，这意味着当控制平面接收到一个事件时，会在 100 ms 内取消将其添加到推送队列的操作。在这段时间内发生的其他事件将与前一个事件合并，并再次取消该操作。如果在这段时间内没有事件发生，所产生的批次就会被添加到推送队列中，随时可以进行处理。</li>
<li><code>PILOT_DEBOUNCE_MAX</code> -指定允许事件排阻的最长时间。超过该时间后，当前合并的事件将被添加到推送队列中。默认情况下，此变量设置为 10 秒。</li>
<li><code>PILOT_ENABLE_EDS_DEBOUNCE</code> -指定端点更新是否符合延迟规则，或是否具有优先级并立即进入推送队列。默认情况下，该变量被设置为 <code>true</code> 。这意味着端点更新也会被去抖。</li>
<li><code>PILOT_PUSH_THROTTLE</code> -指定 <code>istiod</code> 同时处理的推送请求。默认情况下，此变量设置为 100 个并发推送。如果 CPU 利用率不足，可以将节流阀设置为<code>更大的数值</code>，以加快更新速度。</li>
</ul>
<p>使用这些配置选项的一些一般指导</p>
<ul>
<li><code>当控制平面饱和，传入流量导致性能瓶颈时，增加事件批处理。</code></li>
<li>如果目标是更快地传播更新，则应减少事件批处理并增加并发推送。只有在控制平面不饱和的情况下，才建议这样做。</li>
<li>当控制平面趋于饱和，出站流量成为性能瓶颈时，减少并发推送。</li>
<li>当控制平面未达到饱和，或您已扩大规模并希望加快更新速度时，增加并发推送次数。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 增加事件批量推送的周期。 2.5 秒是个高得离谱的值，这不应该在生产中使用</span>
istioctl install --set <span class="nv">profile</span><span class="o">=</span>demo <span class="se">\
</span><span class="se"></span>      --set values.pilot.env.PILOT_DEBOUNCE_AFTER<span class="o">=</span><span class="s2">"2500ms"</span>
      
./bin/performance-test.sh --reps <span class="m">10</span> <span class="se">\
</span><span class="se"></span>  --delay 2.5 --gateway 192.168.8.212
  
Push count: <span class="m">28</span>
Latency in the last minute: 0.10 seconds

<span class="c1"># 推送次数减少到只有 28 次</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>减少配置推送给工作负载的工作，会降低 CPU 利用率和网络带宽消耗。</p>
<p>值的大小根据观察到的指标和环境调整 Istio 控制平面的配置，并以较小的增量进行调整，这比做出可能对控制平面性能产生不利影响的重大变更更安全。</p>
</blockquote>
<p><strong>调整延迟指标</strong></p>
<blockquote>
<p>延迟指标测量的时间是从推送请求添加到推送队列时开始的, (上图)。这就意味着，在事件被转发的同时，更新并没有送达。因此，推送更新的时间增加了，但这并没有出现在延迟指标中。</p>
<p>由于事件排错时间过长而导致延迟增加，就像性能低下一样，会导致配置陈旧。因此，可对批处理属性进行适度修改，稍微增大或减小数值。</p>
<p>注意 数据平面通常会受到端点更新延迟的影响。将环境变量 <code>PILOT_ENABLE_EDS_DEBOUNCE</code> 设置为 <code>false</code> 可确保端点更新不会延迟并跳过除错期。</p>
</blockquote>
<p><strong>为控制平面分配额外资源</strong></p>
<blockquote>
<p>可以使用 HPA 为 <strong>istiod</strong> 进行自动伸缩</p>
</blockquote>
<p><img alt="Pasted image 20231001213058" src="https://cdn.treesir.pub/images/2023/10/01/20231001213101.png"/></p>
<h2 id="性能调整指南">性能调整指南</h2>
<blockquote>
<p>在调整性能之前，请记住 Istio 的性能确实很高。Istio 团队用以下参数测试每个新版本</p>
<ul>
<li>1,000 个 Kubernetes 服务使 Envoy 配置变得臃肿</li>
<li>2,000 个需要同步的工作负载</li>
<li>整个服务网格每秒 70,000 次请求</li>
</ul>
<p>官方数据: <a href="https://istio.io/latest/docs/ops/deployment/performance-and-scalability/">https://istio.io/latest/docs/ops/deployment/performance-and-scalability/</a></p>
</blockquote>
<p><strong>控制平面性能调整指南：</strong></p>
<ul>
<li>确保这是性能问题。回答以下问题
<ul>
<li>数据平面与控制平面之间是否存在连接？</li>
<li>是平台问题吗？例如，在 Kubernetes 上，API 服务器是否健康？</li>
<li><code>Sidecar</code> 资源是否定义为范围变更？</li>
</ul>
</li>
<li>找出性能瓶颈。使用收集到的延迟、饱和度和流量指标，为调整决策提供信息。例如
<ul>
<li>在控制平面未饱和的情况下，延迟增加表明资源未得到最佳利用。可以提高并发推送阈值，以便并发处理更多的推送。</li>
<li>利用率低但在负载情况下很快达到饱和，说明更改非常频繁，也就是说，在长时间没有更改的情况下，会在短时间内出现峰值事件。增加 Istio Pilot 的副本数量，或者，如果有延迟更新的余地，调整批处理属性。</li>
</ul>
</li>
<li>进行渐进式改革。找出瓶颈后，进行渐进式更改。例如，为了解决控制平面接收事件序列的时间较长的问题，很容易将去抖周期延长一倍甚至四倍，但这样做很容易导致数据平面变得陈旧。取而代之的是进行细微的调整，如在 10% 到 30% 的范围内增加或减少属性。然后，监测几天的效益（或性能下降），并根据新数据做出明智的决定。</li>
<li>确保安全。Istio Pilot 正在管理整个网格的网络；宕机很容易导致网络中断。请务必审慎使用控制平面的资源，切勿将规模扩大到两个副本以下，并在安全范围内行事。</li>
<li>考虑使用可突发虚拟机。Istio Pilot 不需要持续的 CPU 资源，而且对性能有突发要求。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># clean</span>
kubectl delete -f ch11/sidecar-mesh-wide.yaml
</code></pre></td></tr></table>
</div>
</div><hr/>
<h1 id="网格融合">网格融合</h1>
<blockquote>
<p>网格融合，也称为多网格融合，可实现两个独立服务网格的工作负载通信。这种方案的自动化程度较低，需要在两个网格上进行手动配置，以实现服务到服务的流量。</p>
<ul>
<li><a href="https://istio.io/latest/docs/ops/deployment/deployment-models/#multiple-meshes">https://istio.io/latest/docs/ops/deployment/deployment-models/#multiple-meshes</a></li>
</ul>
</blockquote>
<p><strong>所需的条件</strong></p>
<ul>
<li>跨群集工作负载发现: 控制平面（Istiod） 必须能发现对方集群中的工作负载，以便配置服务代理。</li>
<li>跨集群工作负载连接性: 工作负载之间必须具有连接性</li>
<li>集群之间的共同信任: 跨集群工作负载必须相互验证，以启用 Istio 的安全功能。
<img alt="Pasted image 20231002102820" src="https://cdn.treesir.pub/images/2023/10/02/20231002102824.png"/></li>
</ul>
<blockquote>
<p>每个 workloads 都可以访问所有其他集群的 API。在这种情况下，<a href="https://docs.solo.io/gloo-mesh-enterprise/latest/">Gloo Mesh </a>是一种很好的解决方法。</p>
</blockquote>
<hr/>
<h2 id="多集群式部署">多集群式部署</h2>
<ul>
<li><strong>Primary cluster</strong> : 安装 Istio 控制平面</li>
<li><strong>Remote cluster</strong>： 控制平面安装的远程集群</li>
</ul>
<p><code>单个控制平面或共享控制平面部署模式（主从模式）</code>。这种模式使用的资源较少，但主群集的中断会影响整个网状网络。因此，它的可用性较低</p>
<p><img alt="Pasted image 20231002103411" src="https://cdn.treesir.pub/images/2023/10/02/20231002103414.png"/></p>
<p><code>主主部署模式</code>, 有多个控制平面，可确保更高的可用性，但需要更多的资源。
<img alt="Pasted image 20231002103453" src="https://cdn.treesir.pub/images/2023/10/02/20231002103500.png"/></p>
<p><code>外部控制平面</code>，所有集群都使用远程方式连接到控制平面。</p>
<p><img alt="Pasted image 20231002103637" src="https://cdn.treesir.pub/images/2023/10/02/20231002103643.png"/></p>
<p><strong>如何在多群集部署中发现工作负载</strong></p>
<ul>
<li>Kubernetes 使用 RBAC 确保对 API 服务器的访问安全。</li>
</ul>
<p>展示如何为 <code>istiod</code> 提供身份验证和授权的 Kubernetes  API 权限资源。</p>
<p><img alt="Pasted image 20231002103957" src="https://cdn.treesir.pub/images/2023/10/02/20231002104000.png"/></p>
<hr/>
<ul>
<li>我们需要向 <code>istiod</code> 提供远程群集的 SA 令牌（以及启动与 API 服务器的安全连接所需的集群证书），<code>istiod</code> 使用该令牌对远程集群进行身份验证，并发现其中运行的工作负载。
<img alt="Pasted image 20231002104125" src="https://cdn.treesir.pub/images/2023/10/02/20231002104130.png"/></li>
</ul>
<h3 id="跨群集工作负载连接性">跨群集工作负载连接性</h3>
<blockquote>
<p>当集群位于扁平网络中时，工作负载可以使用 IP 地址进行连接，因此条件已经满足！但是，当集群位于不同的网络中时，我们必须使用位于网格的特殊 Istio 入口网关来代理跨集群流量。搭建桥梁的入口网关被称为 <code>east-west gateway</code></p>
<ul>
<li><a href="https://istio.io/latest/docs/setup/install/multicluster/multi-primary_multi-network/">https://istio.io/latest/docs/setup/install/multicluster/multi-primary_multi-network/</a></li>
</ul>
</blockquote>
<h3 id="集群之间的共同信任">集群之间的共同信任</h3>
<blockquote>
<p>多群集服务网格中的群集必须具有共同信任。有了共同信任，才能确保相对集群的工作负载能够相互验证。在相对集群的工作负载之间实现共同信任有两种方法。第一种方法是使用我们所说的插件 CA 证书：由共同根 CA 签发的用户自定义证书。第二种方法是集成一个外部 CA，两个集群都使用它来签署证书。</p>
</blockquote>
<p><img alt="Pasted image 20231002104623" src="https://cdn.treesir.pub/images/2023/10/02/20231002104625.png"/></p>
<p><strong>插件 CA 证书</strong></p>
<blockquote>
<p>使用插件中间 CA 证书非常简单！无需让 Istio 生成中间 CA，只需在 Istio 安装命名空间中将其作为秘密提供，即可指定要使用的证书。</p>
</blockquote>
<p><img alt="Pasted image 20231002104745" src="https://cdn.treesir.pub/images/2023/10/02/20231002104748.png"/></p>
<p><strong>使用由同一根 CA 签发的中间 CA 证书</strong></p>
<blockquote>
<p>这种方法因其简单性而受到青睐，但如果中间 CA 暴露，则会带来安全风险。攻击者可以利用它们签署受信任的证书，直到暴露被发现，中间 CA 的证书被吊销。解决暴露的方法</p>
<ul>
<li>只将中间 CA 加载到内存中</li>
<li>集成一个外部 CA 来签署证书</li>
</ul>
</blockquote>
<p><strong>外部证书颁发机构集成</strong></p>
<ul>
<li>cert-manager:  托管 CA 需要受 cert-manager 支持才行。</li>
<li><a href="https://cert-manager.io/docs/configuration/external/">https://cert-manager.io/docs/configuration/external/</a></li>
<li><a href="https://tetratelabs.io/istio-ca-certs-integrations/cert-manager-integration/">https://tetratelabs.io/istio-ca-certs-integrations/cert-manager-integration/</a></li>
<li>定制开发: 创建一个 Kubernetes 控制器，监听已批准的 Kubernetes CSR，并将其提交给外部 CA 进行签署。</li>
</ul>
<h2 id="多群集多网络多控制面服务网格概述">多群集、多网络、多控制面服务网格概述</h2>
<p>基础架构环境说明</p>
<ul>
<li>west-cluster: cluster-1</li>
<li>east-cluster: cluster-2</li>
</ul>
<p><img alt="Pasted image 20231002105810" src="https://cdn.treesir.pub/images/2023/10/02/20231002105813.png"/></p>
<hr/>
<p><strong>选择多群集部署模式</strong></p>
<blockquote>
<p>模式选择，取决于业务需求。</p>
</blockquote>
<h2 id="集群准备">集群准备</h2>
<blockquote>
<p>由于  <code>azure</code> 试用账号被我之前玩没了，我这里就使用 RKE &amp; Terraform 创建两套相互隔离的集群作为环境，大致图如下。</p>
</blockquote>
<p><img alt="image-20231002195605214" src="https://cdn.treesir.pub/images/2023/10/02/20231002195606.png"/></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kubectl --context<span class="o">=</span><span class="s2">"istio-study-2"</span> get pods -n kube-system
kubectl --context<span class="o">=</span><span class="s2">"istio-study-3"</span> get pods -n kube-system

<span class="nb">alias</span> <span class="nv">kwest</span><span class="o">=</span><span class="s1">'kubectl --context="istio-study-2"'</span>
<span class="nb">alias</span> <span class="nv">keast</span><span class="o">=</span><span class="s1">'kubectl --context="istio-study-3"'</span>

<span class="c1"># 为 west 集设置证书</span>
kwest create namespace istio-system
kwest create secret generic cacerts -n istio-system <span class="se">\
</span><span class="se"></span>       --from-file<span class="o">=</span>ch12/certs/west-cluster/ca-cert.pem <span class="se">\
</span><span class="se"></span>       --from-file<span class="o">=</span>ch12/certs/west-cluster/ca-key.pem <span class="se">\
</span><span class="se"></span>       --from-file<span class="o">=</span>ch12/certs/root-cert.pem <span class="se">\
</span><span class="se"></span>       --from-file<span class="o">=</span>ch12/certs/west-cluster/cert-chain.pem

<span class="c1"># 为 east 群集设置证书</span>
keast create namespace istio-system
keast create secret generic cacerts -n istio-system <span class="se">\
</span><span class="se"></span>       --from-file<span class="o">=</span>ch12/certs/east-cluster/ca-cert.pem <span class="se">\
</span><span class="se"></span>       --from-file<span class="o">=</span>ch12/certs/east-cluster/ca-key.pem <span class="se">\
</span><span class="se"></span>       --from-file<span class="o">=</span>ch12/certs/root-cert.pem <span class="se">\
</span><span class="se"></span>       --from-file<span class="o">=</span>ch12/certs/east-cluster/cert-chain.pem
</code></pre></td></tr></table>
</div>
</div><p><strong>在每个群集安装控制平面</strong></p>
<ul>
<li>
<p>为每个集群标记  topology 标签。另外一种方法</p>
<blockquote>
<p><a href="https://istio.io/latest/docs/reference/config/istio.mesh.v1alpha1/#MeshNetworks">https://istio.io/latest/docs/reference/config/istio.mesh.v1alpha1/#MeshNetworks</a></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kwest label namespace istio-system <span class="se">\
</span><span class="se"></span>     topology.istio.io/network<span class="o">=</span>west-network

keast label namespace istio-system <span class="se">\
</span><span class="se"></span>     topology.istio.io/network<span class="o">=</span>east-network
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 使用  IstioOperator 安装 istiod</span>

apiVersion: install.istio.io/v1alpha1
metadata:
 name: istio-controlplane
 namespace: istio-system
kind: IstioOperator
spec:
  profile: demo
  components:
    egressGateways:                ❶ 禁用出口网关
    - name: istio-egressgateway
      enabled: <span class="nb">false</span>
 values:
   global:
     meshID: usmesh                ❷ 网格名称
     multiCluster:
       clusterName: west-cluster   ❸ 多群组网格中的群组标识符
     network: west-network         ❹ 安装所在的网络
     
istioctl --context<span class="o">=</span><span class="s2">"istio-study-2"</span> install -y <span class="se">\
</span><span class="se"></span>     -f ch12/controlplanes/cluster-west.yaml
     
istioctl --context<span class="o">=</span><span class="s2">"istio-study-3"</span> install -y <span class="se">\
</span><span class="se"></span>      -f ch12/controlplanes/cluster-east.yaml
      
<span class="c1"># 设置 istiod 别名</span>
<span class="nb">alias</span> <span class="nv">iwest</span><span class="o">=</span><span class="s1">'istioctl --context="istio-study-2"'</span>
<span class="nb">alias</span> <span class="nv">ieast</span><span class="o">=</span><span class="s1">'istioctl --context="istio-study-3"'</span>
</code></pre></td></tr></table>
</div>
</div><p><img alt="Pasted image 20231002212108" src="https://cdn.treesir.pub/images/2023/10/02/20231002212111.png"/></p>
<p><strong>在两个集群上运行工作负载</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kwest create ns istioinaction
kwest label namespace istioinaction istio-injection<span class="o">=</span>enabled
kwest -n istioinaction apply -f ch12/webapp-deployment-svc.yaml
kwest -n istioinaction apply -f ch12/webapp-gw-vs.yaml
kwest -n istioinaction apply -f ch12/catalog-svc.yaml <span class="c1"># 注意这里。catalog app 在 west 集群并不存在</span>

<span class="c1"># 在 east-cluster 中安装 catalog 服务</span>
keast create ns istioinaction
keast label namespace istioinaction istio-injection<span class="o">=</span>enabled
keast -n istioinaction apply -f ch12/catalog.yaml
</code></pre></td></tr></table>
</div>
</div><h3 id="启用跨群集工作负载发现">启用跨群集工作负载发现</h3>
<blockquote>
<p>要对 Istio 进行身份验证以查询远程群集的信息，它需要一个服务账户（SA）来定义其权限的身份和角色绑定。因此，Istio 会在安装时创建一个服务账户（名为 <code>istio-reader-service-account</code> ），该账户具有最小权限集，可被另一个控制平面用于验证自身身份并查询服务和端点等工作负载相关信息。不过，我们需要向对面的群集提供服务帐户令牌以及证书，以启动与远程群集的安全连接。</p>
</blockquote>
<ul>
<li><a href="https://istio.io/latest/docs/setup/install/multicluster/primary-remote_multi-network/">https://istio.io/latest/docs/setup/install/multicluster/primary-remote_multi-network/</a></li>
</ul>
<p><strong>为远程群集访问创建机密</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">ieast create-remote-secret <span class="se">\
</span><span class="se"></span>  --name<span class="o">=</span><span class="s2">"east-cluster"</span>

apiVersion: v1
kind: Secret
metadata:
  annotations:
    networking.istio.io/cluster: east-cluster
  creationTimestamp: null
  labels:
    istio/multiCluster: <span class="s2">"true"</span> <span class="c1">#  Istio 的控制平面会监控此标签设置为 "true "的秘密，以注册新群集。</span>
  name: istio-remote-secret-east-cluster
  namespace: istio-system
stringData:
  east-cluster: <span class="p">|</span>
    apiVersion: v1
    clusters:
    - cluster:
        certificate-authority-data: &lt;omitted&gt;  <span class="c1"># 用于启动与该群集的安全连接的 CA</span>
        server: https://192.168.10.170:6443
      name: east-cluster
    contexts:
    - context:
        cluster: east-cluster
        user: east-cluster
      name: east-cluster
    current-context: east-cluster
    kind: Config
    preferences: <span class="o">{}</span>
    users:
    - name: east-cluster
      user:
        token: &lt;omitted&gt; <span class="c1"># 代表服务账户身份的令牌</span>
        
---
<span class="c1"># 注意这里，west 需要可以连接到 east 集群的 API Server</span>
ieast create-remote-secret --name<span class="o">=</span><span class="s2">"east-cluster"</span><span class="p">|</span>kwest apply -f -

<span class="c1"># secret 创建后， istiod 会立即获取并查询新添加的远程集群中的工作负载。这将记录在 istiod 中。</span>
kwest logs deploy/istiod -n istio-system <span class="p">|</span> grep -A <span class="m">3</span> <span class="s1">'Adding cluster'</span>
2023-10-02T13:44:59.812807Z     info    Adding cluster  <span class="nv">cluster</span><span class="o">=</span>east-cluster <span class="nv">secret</span><span class="o">=</span>istio-system/istio-remote-secret-east-cluster
2023-10-02T13:44:59.813966Z     info    initializing Kubernetes credential reader <span class="k">for</span> cluster east-cluster
2023-10-02T13:44:59.814011Z     info    kube    Initializing Kubernetes service registry <span class="s2">"east-cluster"</span>
2023-10-02T13:44:59.814086Z     info    kube    Creating WorkloadEntry only config store <span class="k">for</span> east-cluster
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>对于，主主部署，需要互相创建 Secret</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">iwest create-remote-secret --name<span class="o">=</span><span class="s2">"west-cluster"</span><span class="p">|</span>keast apply -f -
</code></pre></td></tr></table>
</div>
</div></blockquote>
<p><strong>设置跨群集连接</strong></p>
<blockquote>
<p>比之下，不同内部网络（例如我们的集群网络）之间的流量被称为东西向流量</p>
</blockquote>
<p><img alt="Pasted image 20231002215300" src="https://cdn.treesir.pub/images/2023/10/02/20231002215302.png"/></p>
<hr/>
<p><strong>南北向和东西向 流量</strong></p>
<blockquote>
<p>为了简化东西向流量，只要网络地址空间不重叠，大多数云提供商都能实现虚拟网络的对等互联。对等虚拟网络中的服务使用 IPv4 和 IPv6 地址启动直接连接。不过，网络对等互联是云特有的功能。每当我们要连接不同云提供商或内部部署的集群时，如果无法实现网络对等互联，Istio 就会提供一个东西向网关。该网关必须与负载平衡器一起暴露在对面集群的工作负载中。</p>
</blockquote>
<p><strong>Istio 的东西门户</strong></p>
<blockquote>
<p>东西向网关的目标除了作为跨群集东西向流量的入口点外，还要使这一过程对维护的团队透明。为实现这一目标，网关必须</p>
<ul>
<li>实现跨集群的细粒度流量管理</li>
<li>路由加密流量，实现工作负载之间的相互验证</li>
</ul>
</blockquote>
<hr/>
<p><strong>使用 SNI 集群配置东西网关</strong></p>
<blockquote>
<p>东西网关是入口网关，为每项服务附加服务器名称指示（SNI）群组配置。什么是 SNI 群集？SNI 群集与普通的 Envoy 群集一样（，由方向、子集、端口和 FQDN 组成，将一组类似的工作负载组合在一起，流量可在其中路由。不过，SNI 群集有一个关键区别：它们在 SNI 中编码了所有 Envoy 群集信息。这样，东西网关就能将加密流量代理到客户在 SNI 中指定的群集。举个具体例子，当一个客户端（如 <code>webapp</code> -客户端（如 <code>catalog</code> 工作负载）启动与远程群集工作负载的连接时，会将目标群集编码到 SNI 中，如图 所示。</p>
<p><strong>集群信息被编码到 SNI 中。(2) SNI 包含决定路由决策的方向、端口、版本和服务名称。</strong></p>
</blockquote>
<p><img alt="Pasted image 20231002215854" src="https://cdn.treesir.pub/images/2023/10/02/20231002215856.png"/></p>
<p><strong>使用 SNI 群集安装东西网关</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  name: istio-eastwestgateway                          ❶  IstioOperator 名称不应与之前的 Istio 安装重叠。
  namespace: istio-system
spec:
  profile: empty                                       ❷  空配置文件不会安装其他 Istio 组件。
  components:
    ingressGateways:
    - name: istio-eastwestgateway                      ❸ 网关名称
      label:
        istio: eastwestgateway
        app: istio-eastwestgateway
      enabled: <span class="nb">true</span>
      k8s:
        env:
          - name: ISTIO_META_ROUTER_MODE               ❹ <span class="s2">"sni-dnat "</span>模式会添加代理流量所需的 SNI 群集。
            value: <span class="s2">"sni-dnat"</span>                          ❹
          - name: ISTIO_META_REQUESTED_NETWORK_VIEW    ❺ 网关路由流量的网络
            value: east-network                        ❺
        service:
          ports:
            <span class="c1"># redacted for brevity</span>
  values:
    global:
      meshID: usmesh                                   ❻  网格、群集和网络识别信息
      multiCluster:                                    ❻
        clusterName: east-cluster                      ❻
      network: east-network                            ❻
</code></pre></td></tr></table>
</div>
</div><p><strong>解读</strong></p>
<ul>
<li><code>IstioOperator</code> 资源的名称不得与最初用于安装控制平面的资源相同。如果使用相同的名称，先前的安装将被覆盖。</li>
<li>将 <code>ISTIO_META_ROUTER_MODE</code> 设置为 <code>sni-dnat</code> 可自动配置 SNI 群集。如果未指定，则退回到 <code>standard</code> 模式，即不配置 SNI 群集。</li>
<li><code>ISTIO_META_REQUESTED_NETWORK_VIEW</code> 定义代理的网络流量。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 安装</span>
ieast install -y -f ch12/gateways/cluster-east-eastwest-gateway.yaml
</code></pre></td></tr></table>
</div>
</div><h2 id="使用-sni-自动直通功能路由跨集群流量">使用 SNI 自动直通功能路由跨集群流量</h2>
<blockquote>
<p>要理解 SNI 自动直通，我们不妨回顾一下，手动 SNI 直通配置入口网关根据 SNI 标头接纳流量。由此可见，服务运营商必须手动定义 <code>VirtualService</code> 资源，才能对接纳的流量进行路由。SNI 自动直通，顾名思义，不需要手动创建 <code>VirtualService</code> 来路由接纳的流量。路由器模式设置为 <code>sni-dnat</code> 时，东西网关会自动配置 SNI 群集。</p>
</blockquote>
<p><strong>使用 SNI 直通进行流量路由选择需要定义 VirtualService 资源</strong></p>
<p><img alt="Pasted image 20231002220437" src="https://cdn.treesir.pub/images/2023/10/02/20231002220440.png"/></p>
<p><strong>使用 SNI 自动直通的流量路由使用 SNI 群集，并以 sni-dnat 路由器模式初始化。</strong></p>
<p><img alt="Pasted image 20231002220503" src="https://cdn.treesir.pub/images/2023/10/02/20231002220505.png"/></p>
<p>SNI 自动直通模式通过 Istio <code>Gateway</code> 资源进行配置。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 将 SNI 自动直通用于 SNI 标头与表达式 *.local 匹配的所有流量。的所有流量都使用 SNI 自动直通，所有 Kubernetes 服务都是这种情况</span>
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: cross-network-gateway
  namespace: istio-system
spec:
  selector:
    istio: eastwestgateway        ❶ 配置仅应用于与选择器匹配的网关。
  servers:
    - port:
        number: <span class="m">15443</span>             ❷ 在 Istio 中，端口 <span class="m">15443</span> 是为多群集 mTLS 流量指定的特殊端口。
        name: tls
        protocol: TLS
      tls:
        mode: AUTO_PASSTHROUGH    ❸  使用 SNI 标头确定目的地，并使用 SNI 集群
      hosts:
        - <span class="s2">"*.local"</span>               ❹ 仅接纳与 regex *.local 匹配的 SNI 的流量
        
        
<span class="c1"># 将其应用到群集后， east-cluster 的工作负载就会暴露给 west-cluster</span>
keast apply -n istio-system -f ch12/gateways/expose-services.yaml

<span class="c1"># 在 west-cluster 中创建一个东西向网关，并将其服务暴露给 east-cluster 中的工作负载</span>
iwest install -y -f ch12/gateways/cluster-west-eastwest-gateway.yaml
kwest apply -n istio-system -f ch12/gateways/expose-services.yaml

<span class="c1"># 通过查询东西网关的群集代理配置，并将输出过滤为仅包含 catalog 文本的行来验证 SNI 群集是否已配置</span>
ieast pc clusters deploy/istio-eastwestgateway.istio-system  <span class="se">\
</span><span class="se"></span>    <span class="p">|</span> grep catalog <span class="p">|</span> awk <span class="s1">'{printf "CLUSTER: %s\n", $1}'</span>
CLUSTER: catalog.istioinaction.svc.cluster.local
CLUSTER: outbound_.80_._.catalog.istioinaction.svc.cluster.local <span class="c1"># 用于目录服务的 SNI 集群</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>验证跨集群工作负载发现</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 获取 east-cluster 中 eastwestgateway 地址</span>
keast -n istio-system get svc istio-eastwestgateway <span class="se">\
</span><span class="se"></span>      -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span>
192.168.10.210
      
<span class="c1"># 将其与 west-cluster 中的工作负载在路由跨集群流量时使用的地址进行比较</span>
iwest pc endpoints deploy/webapp.istioinaction <span class="p">|</span> grep catalog
</code></pre></td></tr></table>
</div>
</div><p><img alt="image-20231002223535571" src="https://cdn.treesir.pub/images/2023/10/02/20231002223539.png"/>
<img alt="Pasted image 20231002223604" src="https://cdn.treesir.pub/images/2023/10/02/20231002223606.png"/></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 手动触发一个请求，进行最终验证</span>
<span class="nv">EXT_IP</span><span class="o">=</span><span class="k">$(</span>kwest -n istio-system get svc istio-ingressgateway <span class="se">\
</span><span class="se"></span>     -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="k">)</span>
     
curl http://<span class="nv">$EXT_IP</span>/api/catalog -H <span class="s2">"Host: webapp.istioinaction.io"</span><span class="p">|</span>jq
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
<span class="m">100</span>   <span class="m">357</span>  <span class="m">100</span>   <span class="m">357</span>    <span class="m">0</span>     <span class="m">0</span>  <span class="m">16758</span>      <span class="m">0</span> --:--:-- --:--:-- --:--:-- <span class="m">21000</span>
<span class="o">[</span>
  <span class="o">{</span>
    <span class="s2">"id"</span>: 1,
    <span class="s2">"color"</span>: <span class="s2">"amber"</span>,
    <span class="s2">"department"</span>: <span class="s2">"Eyewear"</span>,
    <span class="s2">"name"</span>: <span class="s2">"Elinor Glasses"</span>,
    <span class="s2">"price"</span>: <span class="s2">"282.00"</span>
  <span class="o">}</span>,
...
<span class="o">]</span>
</code></pre></td></tr></table>
</div>
</div><p>当我们向入口网关触发请求时，该请求被路由至 <code>west-cluster</code> 中的 <code>webapp</code> 。然后解析到 <code>east-cluster</code> 中的 <code>catalog</code> 工作负载。最终，<code>east-cluster</code>中的工作负载为请求提供了服务。</p>
<p><img alt="2023-10-02 22.45.37" src="https://cdn.treesir.pub/images/2023/10/02/20231002224614.gif"/></p>
<p><strong>回顾一下建立多集群服务网格所需的条件</strong></p>
<ul>
<li>使用包含服务账户令牌和证书的 <code>kubeconfig</code> ，让每个控制平面都能访问对等集群，从而发现跨集群工作负载。 <code>istioctl</code> 为这一过程提供了便利。我们仅将其应用于对等集群。</li>
<li>通过配置东西向网关，在不同集群（位于不同网络）的工作负载之间路由流量，并为每个集群标注网络信息，以便 Istio 知道工作负载所在的网络，从而实现跨集群工作负载连接。</li>
<li>通过使用共同的信任根来配置群集之间的信任，该信任根负责签发相对群集的中间证书。</li>
</ul>
<h2 id="跨群集负载均衡">跨群集负载均衡</h2>
<blockquote>
<p>部署两个示例服务，每个服务都被配置为返回工作负载运行所在集群的名称。这样，我们就能轻松确定提供请求的工作负载的位置。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 在 west-cluster 中部署第一个服务</span>
$  kwest apply -f <span class="se">\ </span>                                    ❶ 在西群集部署一个简单的后端部署
ch12/locality-aware/west/simple-backend-deployment.yaml
 
$  kwest apply -f <span class="se">\
</span><span class="se"></span>ch12/locality-aware/west/simple-backend-svc.yaml        ❷ 用于简单后端部署的 Kubernetes 服务
 
$  kwest apply -f <span class="se">\
</span><span class="se"></span>ch12/locality-aware/west/simple-backend-gw.yaml         ❸ 应用网关资源以接纳流量
 
$  kwest apply -f <span class="se">\
</span><span class="se"></span>ch12/locality-aware/west/simple-backend-vs.yaml         ❹ 应用 VirtualService 资源，将流量从网关路由到简单的后端工作负载

kwest apply -f <span class="se">\
</span><span class="se"></span>ch12/locality-aware/west/simple-backend-deployment.yaml
kwest apply -f <span class="se">\
</span><span class="se"></span>ch12/locality-aware/west/simple-backend-svc.yaml
kwest apply -f <span class="se">\
</span><span class="se"></span>ch12/locality-aware/west/simple-backend-gw.yaml
kwest apply -f <span class="se">\
</span><span class="se"></span>ch12/locality-aware/west/simple-backend-vs.yaml

<span class="c1"># 立即向 west-cluster 中的服务发出请求，并看到它返回集群名称：</span>
curl -s <span class="nv">$EXT_IP</span> -H <span class="s2">"Host: simple-backend.istioinaction.io"</span> <span class="p">|</span> jq <span class="s2">".body"</span>
<span class="s2">"Hello from WEST"</span>

<span class="c1"># 在 east-cluster 中部署服务</span>
keast apply -f ch12/locality-aware/east/simple-backend-deployment.yaml
keast apply -f ch12/locality-aware/east/simple-backend-svc.yaml
</code></pre></td></tr></table>
</div>
</div><p>两个集群中运行服务后，在入口网关中配置其端点，并在它们之间对请求进行负载均衡</p>
<p><img alt="Pasted image 20231002232035" src="https://cdn.treesir.pub/images/2023/10/02/20231002232041.png"/></p>
<p>默认情况下，Istio 使用 <code>round-robin</code> 在工作负载之间进行负载平衡。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="k">for</span> i in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> curl --max-time <span class="m">5</span> -s <span class="nv">$EXT_IP</span> <span class="se">\
</span><span class="se"></span>    -H <span class="s2">"Host: simple-backend.istioinaction.io"</span> <span class="p">|</span> jq .body<span class="p">;</span> <span class="k">done</span>
<span class="s2">"Hello from EAST"</span>
<span class="s2">"Hello from WEST"</span>
...

</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>使用 <code>本地感知负载均衡 </code>可以进一步提高性能，这样工作负载就会优先将流量路由到其本地范围内的工作负载。前面的章节中提到，云提供商将本地信息作为标签添加到节点中。Istio 使用从标签中获取的这些信息来配置工作负载的本地性。</p>
</blockquote>
<p><strong>验证跨集群的本地感知路由选择</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 由于实验环境，非按书中公有云部署，我们手动添加为 node 打一下 region 标签</span>
<span class="c1"># https://istio.io/latest/docs/tasks/traffic-management/locality-load-balancing/</span>
<span class="k">for</span> node in <span class="k">$(</span>kwest get nodes -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[*].metadata.name}'</span><span class="k">)</span><span class="p">;</span><span class="k">do</span> 
	kwest label nodes <span class="nv">$node</span> topology.kubernetes.io/region<span class="o">=</span>westus topology.kubernetes.io/zone<span class="o">=</span><span class="m">0</span> <span class="p">;</span>
<span class="k">done</span>

kwest get nodes -o custom-columns<span class="o">=</span><span class="s2">"\                                      
</span><span class="s2">NAME:{.metadata.name},\                                                                             
</span><span class="s2">REGION:{.metadata.labels.topology\.kubernetes\.io/region},\
</span><span class="s2">ZONE:{metadata.labels.topology\.kubernetes\.io/zone}"</span>
NAME        REGION   ZONE
agent191    westus   <span class="m">0</span>
agent192    westus   <span class="m">0</span>
server190   westus   <span class="m">0</span>

<span class="k">for</span> node in <span class="k">$(</span>keast get nodes -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[*].metadata.name}'</span><span class="k">)</span><span class="p">;</span><span class="k">do</span> 
	keast label nodes <span class="nv">$node</span> topology.kubernetes.io/region<span class="o">=</span>eastus topology.kubernetes.io/zone<span class="o">=</span><span class="m">0</span> <span class="p">;</span>
<span class="k">done</span>

<span class="c1"># 添加 lable 后，重新启动一下 istiod 即可。</span>

iwest pc endpoints deploy/istio-ingressgateway.istio-system <span class="se">\
</span><span class="se"></span>    --cluster <span class="se">\
</span><span class="se"></span>    <span class="s1">'outbound|80||simple-backend.istioinaction.svc.cluster.local'</span> <span class="se">\
</span><span class="se"></span>    -o json
    
    
<span class="o">[{</span>
  <span class="s2">"name"</span>: <span class="s2">"outbound|80||simple-backend.istioinaction.svc.cluster.local"</span>,
  <span class="s2">"addedViaApi"</span>: true,
  <span class="s2">"hostStatuses"</span>: <span class="o">[</span>
      <span class="o">{</span>
          <span class="s2">"address"</span>: &lt;omitted&gt;,
          <span class="s2">"stats"</span>: &lt;omitted&gt;,
          <span class="s2">"healthStatus"</span>: <span class="o">{</span>
              <span class="s2">"edsHealthStatus"</span>: <span class="s2">"HEALTHY"</span>
          <span class="o">}</span>,
          <span class="s2">"weight"</span>: 1,
          <span class="s2">"locality"</span>: <span class="o">{</span>
              <span class="s2">"region"</span>: <span class="s2">"westus"</span>,    ❶ 西集群中工作负载的位置信息
              <span class="s2">"zone"</span>: <span class="s2">"0"</span>            ❶
          <span class="o">}</span>
      <span class="o">}</span>,
      <span class="o">{</span>
          <span class="s2">"address"</span>: &lt;omitted&gt;,
          <span class="s2">"stats"</span>: &lt;omitted&gt;,
          <span class="s2">"healthStatus"</span>: <span class="o">{</span>
              <span class="s2">"edsHealthStatus"</span>: <span class="s2">"HEALTHY"</span>
          <span class="o">}</span>,
          <span class="s2">"weight"</span>: 1,
          <span class="s2">"locality"</span>: <span class="o">{</span>
              <span class="s2">"region"</span>: <span class="s2">"eastus"</span>,    ❷ 东集群中工作量的位置信息
              <span class="s2">"zone"</span>: <span class="s2">"0"</span>            ❷
          <span class="o">}</span>
      <span class="o">}</span>
  <span class="o">]</span>,
  <span class="s2">"circuitBreakers"</span>: &lt;omitted&gt;
<span class="o">}]</span>

<span class="c1"># 应用目标规则，使用离群点检测来被动检查端点的健康状况</span>
kwest apply -f ch12/locality-aware/west/simple-backend-dr.yaml


<span class="c1"># 验证请求是否使用了定位信息，将流量执向同一集群内</span>
<span class="k">for</span> i in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> curl --max-time <span class="m">5</span> -s <span class="nv">$EXT_IP</span> <span class="se">\
</span><span class="se"></span>      -H <span class="s2">"Host: simple-backend.istioinaction.io"</span> <span class="p">|</span> jq .body<span class="p">;</span> <span class="k">done</span>
<span class="s2">"Hello from WEST"</span>
<span class="s2">"Hello from WEST"</span>
...

<span class="c1"># 所有请求都会在 west-cluster 内路由。中路由，因为它离路由流量的入口网关最近。</span>
iwest pc endpoints deploy/istio-ingressgateway.istio-system <span class="se">\
</span><span class="se"></span>      --cluster <span class="se">\
</span><span class="se"></span>      <span class="s1">'outbound|80||simple-backend.istioinaction.svc.cluster.local'</span> <span class="se">\
</span><span class="se"></span>      -o json
 
<span class="o">[{</span>
  <span class="s2">"name"</span>: <span class="s2">"outbound|80||simple-backend.istioinaction.svc.cluster.local"</span>,
  <span class="s2">"addedViaApi"</span>: true,
  <span class="s2">"hostStatuses"</span>: <span class="o">[</span>
      <span class="o">{</span>
          &lt;omitted&gt;
          <span class="s2">"weight"</span>: 1,
          <span class="s2">"locality"</span>: <span class="o">{</span>
              <span class="s2">"region"</span>: <span class="s2">"westus"</span>,
              <span class="s2">"zone"</span>: <span class="s2">"0"</span>
          <span class="o">}</span>
      <span class="o">}</span>,
      <span class="o">{</span>
          &lt;omitted&gt;
          <span class="s2">"weight"</span>: 1,
          <span class="s2">"priority"</span>: 1,    ❶ 第二台主机的优先级为 <span class="m">1</span>
          <span class="s2">"locality"</span>: <span class="o">{</span>
              <span class="s2">"region"</span>: <span class="s2">"eastus"</span>,
              <span class="s2">"zone"</span>: <span class="s2">"0"</span>
          <span class="o">}</span>
      <span class="o">}</span>
  <span class="o">]</span>,
  <span class="s2">"circuitBreakers"</span>: &lt;omitted&gt;
<span class="o">}]</span>


</code></pre></td></tr></table>
</div>
</div><p>看到了优先级字段，该字段指定了路由到该主机的流量优先级。最高优先级为 0。值为 1 的主机优先级较低，依此类推。当优先级最高的主机不可用时，流量就会被路由到优先级较低的主机。</p>
<p><strong>验证跨群集故障切换</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 为了模拟简单后端部署失败，我们可以将环境变量 ERROR_RATE 设置为 1，从而将其配置为请求失败。</span>
kwest -n istioinaction <span class="nb">set</span> env <span class="se">\
</span><span class="se"></span>      deploy simple-backend-west <span class="nv">ERROR_RATE</span><span class="o">=</span><span class="s1">'1'</span>
      
---
<span class="c1"># 一段时间后，异常点检测会检测到主机不健康，并将流量路由到 east-cluster 中的工作负载。</span>
<span class="k">for</span> i in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> curl --max-time <span class="m">5</span> -s <span class="nv">$EXT_IP</span> <span class="se">\
</span><span class="se"></span>      -H <span class="s2">"Host: simple-backend.istioinaction.io"</span> <span class="p">|</span> jq .body<span class="p">;</span> <span class="k">done</span>
<span class="s2">"Hello from EAST"</span>
<span class="s2">"Hello from EAST"</span>
<span class="s2">"Hello from EAST"</span>
<span class="s2">"Hello from EAST"</span>
<span class="s2">"Hello from EAST"</span>
<span class="s2">"Hello from EAST"</span>
...

</code></pre></td></tr></table>
</div>
</div><p><strong>使用授权策略验证跨集群访问控制</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 假设我们希望只有当流量来源是 Istio 的入口网关时，服务才会接纳该流量；否则，流量将被拒绝。</span>
apiVersion: <span class="s2">"security.istio.io/v1beta1"</span>
kind: <span class="s2">"AuthorizationPolicy"</span>
metadata:
  name: <span class="s2">"allow-only-ingress"</span>
  namespace: istioinaction
spec:
  selector:
    matchLabels:
      app: simple-backend
  rules:
  - from:
    - source:
        principals: <span class="o">[</span><span class="s2">"cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"</span><span class="o">]</span>
        
<span class="c1"># 在执行任何请求之前，我们先清理 west-cluster 中的服务，以便只有 east-cluster 中的实例才能为流量提供服务：  </span>
kwest delete deploy simple-backend-west -n istioinaction

<span class="c1"># 触发 west-cluster 中工作负载的请求来测试策略</span>
keast run -i -n default --rm --restart<span class="o">=</span>Never sleep <span class="se">\
</span><span class="se"></span>--image<span class="o">=</span>curlimages/curl --command -- <span class="se">\
</span><span class="se"></span>sh -c <span class="s1">'curl -s simple-backend.istioinaction.svc.cluster.local'</span>
RBAC: access deniedpod <span class="s2">"sleep"</span> deleted

<span class="c1"># 请求被拒绝。与此同时，向入口网关触发请求并从网关路由请求会得到成功响应</span>
curl --max-time <span class="m">5</span> -s <span class="nv">$EXT_IP</span> <span class="se">\
</span><span class="se"></span>    -H <span class="s2">"Host: simple-backend.istioinaction.io"</span> <span class="p">|</span> jq .body
<span class="s2">"Hello from EAST"</span>
</code></pre></td></tr></table>
</div>
</div><p>多集群服务网格中的工作负载可以使用 Istio 的所有功能，而无需考虑它们在哪个集群中运行。而且不需要任何额外的配置。</p>
<hr/>
<h1 id="虚拟机整合并至网格">虚拟机整合并至网格</h1>
<p>Istio 早期就支持将虚拟机集成到网格中，但这需要大量的变通方法和控制平面外部的自动化。Istio 的虚拟机支持在 Istio 1.9.0 中升级为测试版，其中一些关键功能已经实现，API 也确定了合适的方法。这些关键功能包括</p>
<ul>
<li>使用 <code>istioctl</code> 简化了虚拟机中 Sidecar 代理的安装和配置。</li>
<li>通过引入两个新的 Istio 资源，实现了虚拟机的高可用性： <code>WorkloadGroup</code> 和 <code>WorkloadEntry</code> 。</li>
<li>使用本地 DNS 代理（与 Istio 的 sidecar 一起安装），可以对虚拟机的网内服务进行 DNS 解析。</li>
</ul>
<h2 id="虚拟机中的旁路代理安装和配置">虚拟机中的旁路代理安装和配置</h2>
<p>要让虚拟机成为网格的一部分，我们需要</p>
<ul>
<li>安装 Sidecar 代理管理网络流量</li>
<li>配置代理连接到 <code>istiod</code> 并接收网格配置</li>
<li>为虚拟机提供身份令牌，用于向 <code>istiod</code> 进行身份验证</li>
</ul>
<p>任何工作负载成为网格一部分所需的先决条件。在 Kubernetes 中运行的工作负载也需要相同的步骤：</p>
<ul>
<li>通过 webhook 或使用 <code>istioctl</code> 自动安装和配置 Sidecar。</li>
<li><code>拥有身份令牌</code>–Kubernetes 会自动将其注入 Pod。</li>
</ul>
<p><img alt="Pasted image 20231004220159" src="https://cdn.treesir.pub/images/2023/10/04/20231004220201.png"/></p>
<hr/>
<h3 id="解虚拟机身份-provisioning">解虚拟机身份 Provisioning</h3>
<blockquote>
<p>Istio 使用 Kubernetes 作为信任源来配置虚拟机的身份。具体做法是在 Kubernetes 中生成一个令牌，并将其传输到虚拟机。安装在机器中的 <code>istio-agent</code> 会获取该令牌，并用于向 <code>istiod</code> 进行身份验证。</p>
</blockquote>
<p><strong>集群中的工作负载（1）获得注入 Pod 的服务帐户令牌，（2）使用令牌进行身份验证并检索 SVID。</strong></p>
<p><img alt="Pasted image 20231004220325" src="https://cdn.treesir.pub/images/2023/10/04/20231004220327.png"/></p>
<p><strong>由于虚拟机是外部的，因此需要手动执行以下步骤：(1) 创建服务帐户；(2) 将令牌传输到虚拟机；(3) 使用令牌进行身份验证并接收 SVID。</strong></p>
<blockquote>
<p>这两种方法类似，唯一不同的是，Kubernetes 会自动将令牌注入 Pod。相比之下，对于虚拟机，这必须由服务网格操作员完成，他们必须手动将令牌安全地传输到虚拟机。</p>
</blockquote>
<p><img alt="Pasted image 20231004220444" src="https://cdn.treesir.pub/images/2023/10/04/20231004220446.png"/></p>
<hr/>
<p>为不同云提供商的机器提供 <code>自动的工作负载身份</code>，改功能尚未开发</p>
<ul>
<li><a href="https://docs.google.com/document/d/1-612Sgz_skeoX44dw3MU6Z8ONgq1f29wLUI9zggyLec">https://docs.google.com/document/d/1-612Sgz_skeoX44dw3MU6Z8ONgq1f29wLUI9zggyLec</a></li>
</ul>
<hr/>
<h3 id="虚拟机高可用性">虚拟机高可用性</h3>
<blockquote>
<p>为了实现虚拟机的高可用性，Istio 密切模仿了 Kubernetes 处理其容器化工作负载的方法。基本上，Kubernetes 通过以下资源实现高可用性：</p>
<ul>
<li><code>Deployment</code> s 作为更高级别的资源，包含了复制创建方式的配置。</li>
<li><code>Pod</code> s 是根据该配置创建的副本。这就确保了 Pod 没有任何独一无二之处，只要 Pod 不健康，就可以将其废弃或替换（或在不需要时将其缩减），从而保持服务的高可用性。</li>
</ul>
<p>Istio 为虚拟机引入的资源与 Kubernetes 的部署和 Pod 概念密切相关：</p>
<ul>
<li><code>WorkloadGroup</code> 资源类似于 Kubernetes 的 “部署”（Deployments），因为它定义了如何配置其管理的工作负载的模板。</li>
<li><code>WorkloadEntry</code> 类似于 Kubernetes Pod。它代表服务于终端用户流量的单个虚拟机。除了 <code>WorkloadGroup</code> 定义的通用属性外， <code>WorkloadEntry</code> 还拥有独特的属性，如虚拟机的地址和健康状态。</li>
</ul>
<p><code>WorkloadEntry</code> 可以手动创建，但建议使用工作负载自动注册，即新配置的工作负载自动加入网格。</p>
</blockquote>
<p><strong>WORKLOAD</strong>  自动注册</p>
<p>在工作负载自动注册过程中，工作负载会连接到控制平面（使用向其提供的配置），并使用身份令牌将 自己认证为 <code>WorkloadGroup</code> 的成员。注册成功后，控制平面将创建一个 <code>WorkloadEntry</code> 来代表网格中的虚拟机。</p>
<p>在网格中使用 <code>WorkloadEntry</code> 表示虚拟机非常重要，原因有很多。尤其是，Kubernetes 服务或 Istio <code>ServiceEntry</code> 资源可以使用标签选择器选择<code>WorkloadEntry</code>，并将其作为路由流量的后端。</p>
<p><img alt="Pasted image 20231004221301" src="https://cdn.treesir.pub/images/2023/10/04/20231004221304.png"/></p>
<p>渐进式虚拟机流量迁移。
<img alt="Pasted image 20231004221433" src="https://cdn.treesir.pub/images/2023/10/04/20231004221510.png"/></p>
<hr/>
<h3 id="健康检查">健康检查</h3>
<ul>
<li><em>Readiness</em></li>
<li><em>Liveness</em></li>
</ul>
<hr/>
<p>云厂商健康自检</p>
<ul>
<li>Azure 实现了虚拟机规模集的自动实例修复：http://mng.bz/0wrx。</li>
<li>亚马逊网络服务为自动扩展组实例实施健康检查：http://mng.bz/KB4K。</li>
<li>Google Cloud Platform 为受管实例组实施健康检查和自动修复：http://mng.bz/9KNl。</li>
</ul>
<hr/>
<p>ISTIO 如何在 VMS 中执行准备状态探测</p>
<ul>
<li>根据 <code>istio-agent</code> 定义中的规范， <code>WorkloadGroup</code> 会定期探测应用程序是否已做好接收流量的准备。根据 <code>WorkloadGroup</code> 定义中的说明，定期探测应用程序是否已做好接收流量的准备。代理会向 <code>istiod</code> 报告应用程序的健康状态。</li>
</ul>
<p><code>SIdecat proxy 向 istiod 更新，健康状态</code></p>
<p><img alt="" src="https://cdn.treesir.pub/images/2023/10/04/20231004221822.png"/>)</p>
<p>当应用程序处于健康状态时，数据平面会配置应用程序所在虚拟机的端点。反之亦然：当应用程序不健康时，端点会从数据平面中移除。</p>
<p>建议对有效性和就绪性探针使用不同的配置</p>
<ul>
<li><code>istio-agent</code> 执行的就绪状态探测应 <code>积极主动</code>，防止流量被路由到正在返回错误的实例。</li>
<li>云提供商执行的有效性探测应更加 <code>保守</code>，并为虚拟机留出恢复时间。</li>
</ul>
<p>尽量避免过于仓促地杀死实例，因为这样会在没有宽限期的情况下终止飞行中的请求，从而导致最终用户可见的故障。<code>一个好的经验法则是，准备状态探测总是先于有效性探测失败</code>。</p>
<h3 id="服务的-dns-解析">服务的 DNS 解析</h3>
<blockquote>
<p>由于虚拟机处于 Kubernetes 群集的外部，因此无法访问其内部 DNS 服务器。因此，虚拟机无法解析群集服务的主机名。</p>
</blockquote>
<p>代理拥有如何路由流量的配置！然而，问题在于如何将流量从应用程序中导出并导入代理。实现这一点的前提条件是主机名已解析。否则，流量就无法离开应用程序，也就无法重定向到 Envoy 代理。</p>
<p><strong>由于 DNS 解析失败，出站流量从未到达 Envoy 代理</strong></p>
<p><img alt="Pasted image 20231004222534" src="https://cdn.treesir.pub/images/2023/10/04/20231004222537.png"/></p>
<hr/>
<p>使用 Kubernetes 控制器自动配置私有 DNS 服务器，该控制器会监听这些变化并保持 DNS 服务器同步。 <code>external-dns</code></p>
<ul>
<li>
<p><a href="https://github.com/kubernetes-sigs/external-dns">https://github.com/kubernetes-sigs/external-dns</a></p>
</li>
<li>
<p>(<code>1.8</code> 及以后版本）在 <code>istio-agent</code> 侧卡中引入了本地 DNS 代理，并通过 <code>istiod</code> 对所有网状服务进行了配置。DNS 代理在 Istio 的侧卡中与 Envoy 代理一起运行，处理来自应用程序的 DNS 查询，这些查询使用 Iptable 规则重定向到 DNS 代理，这也是 Istio 惯用的流量捕获方法。使用 <code>istio-cni</code> 时，情况略有不同。</p>
<p><img alt="Pasted image 20231004222838" src="https://cdn.treesir.pub/images/2023/10/04/20231004222841.png"/></p>
</li>
</ul>
<hr/>
<p>为了保持 DNS 代理的持续更新，Istio 引入了名为名称发现服务（NDS）的新 API。有了 NDS，每当 Kubernetes 服务或 Istio <code>ServiceEntry</code> 被添加到网格中时，控制平面就会将新的 DNS 条目同步到数据平面。</p>
<ul>
<li><a href="https://istio.io/latest/blog/2020/dns-proxy">https://istio.io/latest/blog/2020/dns-proxy</a></li>
</ul>
<h2 id="环境搭建-1">环境搭建</h2>
<p>我们将创建一个 Kubernetes 集群和一个虚拟机，用于托管我们的 cool-store 应用程序</p>
<ul>
<li><code>webapp</code> 和 <code>catalogs</code> 服务部署在 Kubernetes 集群中。</li>
<li><code>forum</code> 服务部署在虚拟机中。</li>
</ul>
<p><img alt="Pasted image 20231004223029" src="https://cdn.treesir.pub/images/2023/10/04/20231004223032.png"/></p>
<blockquote>
<p>集群和虚拟机位于不同的网络中，这就需要一个 <code>east-west gateway</code>，以反向代理从虚拟机到集群服务的流量。</p>
</blockquote>
<p><strong>基于 Terraform 创建基础设施</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">module <span class="s2">"istio-vm"</span> <span class="o">{</span>
  <span class="nb">source</span> <span class="o">=</span> <span class="s2">"git::https://gitlab-ee.treesir.pub/lac/terraform-proxmox-vm-rke-collection.git//?ref=main"</span>
  <span class="nv">cluster</span> <span class="o">=</span> <span class="o">{</span>
    istio-vm <span class="o">=</span> <span class="o">{</span>
      <span class="nv">server_group</span> <span class="o">=</span> <span class="o">{</span>
        <span class="nv">server1</span> <span class="o">=</span> <span class="o">{</span>
          <span class="nv">vm_servers_list</span>         <span class="o">=</span> <span class="o">[</span><span class="s2">"192.168.10.190"</span><span class="o">]</span>
          <span class="nv">vm_servers_memory</span>       <span class="o">=</span> <span class="s2">"4096"</span>
          <span class="nv">vm_servers_cores</span>        <span class="o">=</span> <span class="s2">"2"</span>
          <span class="nv">vm_servers_disk_size</span>    <span class="o">=</span> <span class="s2">"40G"</span>
          <span class="nv">vm_servers_disk_storage</span> <span class="o">=</span> <span class="s2">"sd"</span>
          <span class="nv">vm_servers_target_node</span>  <span class="o">=</span> <span class="s2">"amd"</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="nv">agent_group</span> <span class="o">=</span> <span class="o">{</span>
        <span class="nv">agent1</span> <span class="o">=</span> <span class="o">{</span>
          <span class="nv">vm_agents_list</span>         <span class="o">=</span> <span class="o">[</span><span class="s2">"192.168.10.191"</span>, <span class="s2">"192.168.10.192"</span><span class="o">]</span>
          <span class="nv">vm_agents_memory</span>       <span class="o">=</span> <span class="s2">"8192"</span>
          <span class="nv">vm_agents_cores</span>        <span class="o">=</span> <span class="s2">"4"</span>
          <span class="nv">vm_agents_disk_size</span>    <span class="o">=</span> <span class="s2">"100G"</span>
          <span class="nv">vm_agents_disk_storage</span> <span class="o">=</span> <span class="s2">"ew"</span>
          <span class="nv">vm_agents_target_node</span>  <span class="o">=</span> <span class="s2">"amd"</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="nv">rke_enable_private_registry</span> <span class="o">=</span> <span class="nb">false</span>
      <span class="nv">private_registry</span>            <span class="o">=</span> <span class="s2">""</span>
      <span class="nv">vm_ssh_port</span>                 <span class="o">=</span> <span class="s2">"22"</span>
      <span class="nv">vm_ssh_user</span>                 <span class="o">=</span> <span class="s2">"rke"</span>
      <span class="nv">vm_ssh_private_key</span>          <span class="o">=</span> <span class="s2">"</span><span class="si">${</span><span class="nv">path</span><span class="p">.root</span><span class="si">}</span><span class="s2">/id_rsa"</span>
      <span class="nv">vm_ip_gw</span>                    <span class="o">=</span> <span class="s2">"192.168.10.1"</span>
      <span class="nv">vm_pool</span>                     <span class="o">=</span> <span class="s2">"devops"</span>
      <span class="nv">vm_clone_target</span>             <span class="o">=</span> <span class="s2">"centos7"</span>
      <span class="nv">vm_ip_subnet</span>                <span class="o">=</span> <span class="s2">"24"</span>
      <span class="nv">cluster_kubernetes_version</span>  <span class="o">=</span> <span class="s2">"v1.26.4-rancher2-1"</span>
      <span class="nv">cluster_onboot</span>              <span class="o">=</span> <span class="s2">"false"</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="nv">rke_user</span>        <span class="o">=</span> var.rke_user
  <span class="nv">rke_user_passwd</span> <span class="o">=</span> var.rke_user_passwd
<span class="o">}</span>


module <span class="s2">"istio-forum-vm"</span> <span class="o">{</span>
  <span class="nb">source</span> <span class="o">=</span> <span class="s2">"git::https://gitlab-ee.treesir.pub/lac/terraform-proxmox-vm-collection.git//?ref=main"</span>
  <span class="nv">groups</span> <span class="o">=</span> <span class="o">{</span>
    istio-forum-vm-8 <span class="o">=</span> <span class="o">{</span>
      <span class="nv">desc</span>              <span class="o">=</span> <span class="s2">"istio forum vm"</span>
      <span class="nv">target_node</span>       <span class="o">=</span> <span class="s2">"amd"</span>
      <span class="nv">onboot</span>            <span class="o">=</span> <span class="nb">true</span>
      <span class="nv">target_clone_name</span> <span class="o">=</span> <span class="s2">"centos7"</span>
      <span class="nv">pool</span>              <span class="o">=</span> <span class="s2">"devops"</span>
      <span class="nv">cores</span>             <span class="o">=</span> <span class="s2">"2"</span>
      <span class="nv">memory</span>            <span class="o">=</span> <span class="s2">"2048"</span>
      <span class="nv">ip</span>                <span class="o">=</span> <span class="s2">"192.168.8.8"</span>
      <span class="nv">ip_gw</span>             <span class="o">=</span> <span class="s2">"192.168.8.1"</span>
      <span class="nv">dns</span>               <span class="o">=</span> <span class="s2">"192.168.8.1"</span>
      <span class="nv">disk_size</span>         <span class="o">=</span> <span class="s2">"40G"</span>
      <span class="nv">storage</span>           <span class="o">=</span> <span class="s2">"ew"</span>
      <span class="nv">ip_subnet</span>         <span class="o">=</span> <span class="s2">"24"</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="nv">depends_on</span> <span class="o">=</span> <span class="o">[</span>module.istio-vm<span class="o">]</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img alt="image-20231005101500900" src="https://cdn.treesir.pub/images/2023/10/05/20231005101504.png"/></p>
<p>istio vm 集群初始化</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 安装 istiod</span>

<span class="nb">alias</span> <span class="nv">kvm</span><span class="o">=</span><span class="s1">'kubectl --context="istio-vm"'</span>
<span class="nb">alias</span> <span class="nv">ivm</span><span class="o">=</span><span class="s1">'istioctl --context="istio-vm"'</span>

kvm create namespace istio-system
kvm label namespace istio-system <span class="se">\
</span><span class="se"></span>     topology.istio.io/network<span class="o">=</span>west-network

ivm install -y -f ch13/controlplane/cluster-in-west-network.yaml

kvm create ns istioinaction
kvm label namespace istioinaction <span class="se">\
</span><span class="se"></span>      istio-injection<span class="o">=</span>enabled
      
kvm -n istioinaction apply <span class="se">\
</span><span class="se"></span>    -f ch12/webapp-deployment-svc.yaml
kvm -n istioinaction apply <span class="se">\
</span><span class="se"></span>    -f ch12/webapp-gw-vs.yaml
 
kvm -n istioinaction apply <span class="se">\
</span><span class="se"></span>    -f ch12/catalog.yaml
</code></pre></td></tr></table>
</div>
</div><p>kube-vip 安装，实现 <strong>LoadBalancer</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="nb">export</span> <span class="nv">VIP</span><span class="o">=</span>192.168.10.99
<span class="nb">export</span> <span class="nv">INTERFACE</span><span class="o">=</span>eth0
docker pull plndr/kube-vip:v0.6.2
docker run --name vip --rm --net<span class="o">=</span>host plndr/kube-vip:v0.6.2 <span class="se">\
</span><span class="se"></span>manifest pod <span class="se">\
</span><span class="se"></span>--interface <span class="nv">$INTERFACE</span> <span class="se">\
</span><span class="se"></span>--vip <span class="nv">$VIP</span> <span class="se">\
</span><span class="se"></span>--controlplane <span class="se">\
</span><span class="se"></span>--services <span class="se">\
</span><span class="se"></span>--arp <span class="se">\
</span><span class="se"></span>--leaderElection <span class="p">|</span> tee  /etc/kubernetes/manifests/kube-vip.yaml

<span class="c1"># kube-vip-cloud-controller 安装</span>
kvm apply -f https://raw.githubusercontent.com/kube-vip/kube-vip-cloud-provider/main/manifest/kube-vip-cloud-controller.yaml

<span class="c1"># 配置 LoadBalancer 自助分配多IP段</span>
cat <span class="s">&lt;&lt; EOF |tr -s "n" | tee kubevip-cm.yaml | kvm apply -f -
</span><span class="s">apiVersion: v1
</span><span class="s">kind: ConfigMap
</span><span class="s">metadata:
</span><span class="s">  name: kubevip
</span><span class="s">  namespace: kube-system
</span><span class="s">data:
</span><span class="s">  range-global: 192.168.10.120-192.168.10.140
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>测试 istio vm 集群正常与否</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="nv">EXT_IP</span><span class="o">=</span><span class="k">$(</span>kvm -n istio-system get svc istio-ingressgateway -o <span class="se">\
</span><span class="se"></span>       <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="k">)</span>
192.168.10.120

<span class="c1"># 192.168.10.120 在 8.1 OpenWRT 中添加静态路由</span>
route add -net 192.168.10.120/32 gw 192.168.1.31 <span class="c1"># 1.31 为 10.1 WAN 口 IP</span>

curl -H <span class="s2">"Host: webapp.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>      http://<span class="nv">$EXT_IP</span>/api/catalog/items/1
</code></pre></td></tr></table>
</div>
</div><p><img alt="image-20231005103358946" src="https://cdn.treesir.pub/images/2023/10/05/20231005103400.png"/></p>
<h3 id="配置虚拟机">配置虚拟机</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="nv">VM_IP</span><span class="o">=</span>192.168.8.8
chmod <span class="m">600</span> ch13/keys/id_rsa
ssh -i ch13/keys/id_rsa root@<span class="nv">$VM_IP</span> -- ls -la


<span class="c1"># 由于使用自有私有云，forum 服务，我们使用 traefik/whoami 代替，并使其监听在 80 端口。</span>
wget -O forum https://git.io/J3QrT

chmod a+x forum

nohup ./forum <span class="p">&amp;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="将网格扩展到虚拟机">将网格扩展到虚拟机</h2>
<blockquote>
<p>集成虚拟机的功能还处于测试阶段 1 ，默认情况下尚未启用。因此，我们需要使用以下 <code>IstioOperator</code> 定义更新 Istio 安装，启用以下功能：工作负载自动注册、健康检查、捕获 DNS 查询并将这些查询重定向到 DNS 代理。</p>
<p><a href="https://istio.io/latest/docs/setup/install/virtual-machine/">https://istio.io/latest/docs/setup/install/virtual-machine/</a></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">apiVersion: install.istio.io/v1alpha1
metadata:
  name: istio-controlplane
  namespace: istio-system
kind: IstioOperator
spec:
  profile: demo
  components:
    egressGateways:
    - name: istio-egressgateway
      enabled: <span class="nb">false</span>
  meshConfig:
    defaultConfig:
      proxyMetadata:
        ISTIO_META_DNS_CAPTURE: <span class="s2">"true"</span>                        ❶ DNS 查询被捕获并重定向到 DNS 代理。
  values:
    pilot:
      env:
        PILOT_ENABLE_WORKLOAD_ENTRY_AUTOREGISTRATION: <span class="nb">true</span>    ❷ 工作负载可自动注册到控制平面。
        PILOT_ENABLE_WORKLOAD_ENTRY_HEALTHCHECKS: <span class="nb">true</span>        ❸ 对虚拟机中的工作负载进行健康检查。
    global:
      meshID: usmesh
      multiCluster:
        clusterName: west-cluster
      network: west-network
      
ivm install -y -f <span class="se">\
</span><span class="se"></span>     ch13/controlplane/cluster-in-west-network-with-vm-features.yaml
</code></pre></td></tr></table>
</div>
</div><h3 id="向虚拟机提供等效和群集服务">向虚拟机提供等效和群集服务</h3>
<blockquote>
<p>要成为网格结构的一部分，虚拟机必须能够与 <code>istiod</code> 对话，并启动与群集服务的连接。当虚拟机和群集位于同一网络时，这种方式就能正常工作；案例中，虚拟机和群集位于不同的网络，需要一个 east-west-gw 将流量代理到 Istio 控制平面或工作负载。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">ivm install -y -f ch13/gateways/cluster-east-west-gw.yaml
</code></pre></td></tr></table>
</div>
</div><p>安装网关后，我们就可以为虚拟机暴露访问群集服务和 <code>istiod</code> 所需的端口。</p>
<p><img alt="Pasted image 20231005105027" src="https://cdn.treesir.pub/images/2023/10/05/20231005105029.png"/></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kvm apply -f ch13/expose-services.yaml
</code></pre></td></tr></table>
</div>
</div><p><strong>向虚拟机暴露 istiod 和群集服务的端口</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 通过应用 Gateway 资源和 VirtualService 资源来接收流量并将其路由到 istiod 来暴露 istiod 端口。</span>
kvm apply -f ch13/expose-istiod.yaml
</code></pre></td></tr></table>
</div>
</div><h3 id="使用-workloadgroup-表示一组工作负载">使用 WorkloadGroup 表示一组工作负载</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">apiVersion: networking.istio.io/v1alpha3
kind: WorkloadGroup
metadata:
  name: forum
  namespace: forum-services
spec:
  metadata:
    annotations: <span class="o">{}</span>
    labels:
      app: forum                   <span class="c1"># 服务可使用标签锁定该组中的工作负载。</span>
  template:
    ports:
      http: <span class="m">8080</span>
    serviceAccount: forum-sa       <span class="c1"># 验证工作负载是否拥有来自 forum-sa 的验证令牌，以便注册到该工作负载组中</span>
    network: vm-network            <span class="c1"># 使 Istio 能够配置同一网络中工作负载之间的直接访问</span>
  probe:                           <span class="c1"># 在该工作负载组实例中运行的 istio-agent 会通过 8080 端口和 /api/healthz 路径上的 HTTP GET 请求检查应用程序的就绪状态。</span>
    periodSeconds: <span class="m">5</span>
    initialDelaySeconds: <span class="m">1</span>
    httpGet:
      port: <span class="m">8080</span>
      path: /api/healthz
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kvm create namespace forum-services
kvm create serviceaccount forum-sa -n forum-services
kvm apply -f ch13/workloadgroup.yaml 

<span class="c1"># 现在，群集已配置为自动注册工作负载，这些工作负载可以代表 WorkloadGroup 中指定的 SA forum-sa 的有效令牌。</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>生成虚拟机 Sidecar 配置</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">istioctl x workload entry configure <span class="se">\
</span><span class="se"></span>    --name forum <span class="se">\ </span>                      ❶ 从 forum-services 命名空间中名为 forum 的 WorkloadGroup 生成工作负载配置
    --namespace forum-services <span class="se">\ </span>        ❶ 
    --clusterID <span class="s2">"west-cluster"</span> <span class="se">\ </span>        ❷ 必须设置为 Istio 安装时指定的群集名称
    --externalIP <span class="nv">$VM_IP</span> <span class="se">\ </span>               ❸ 当工作负载与群集不在同一网络中时，需要使用 workloadIP 参数。如果默认未定义，则使用网络分配给它的私有 IP。
    --autoregister <span class="se">\ </span>                    ❹ 设置配置以自动注册工作负载
    -o ./ch13/workload-files/            ❺ 与执行命令的位置相对应的存储配置文件的目录
    
    
<span class="nv">VM_IP</span><span class="o">=</span>192.168.8.8
ivm x workload entry configure <span class="se">\
</span><span class="se"></span>    --name forum <span class="se">\
</span><span class="se"></span>    --namespace forum-services <span class="se">\
</span><span class="se"></span>    --clusterID <span class="s2">"west-cluster"</span> <span class="se">\
</span><span class="se"></span>    --externalIP <span class="nv">$VM_IP</span> <span class="se">\
</span><span class="se"></span>    --autoregister <span class="se">\
</span><span class="se"></span>    -o ./ch13/workload-files/
Warning: a security token <span class="k">for</span> namespace <span class="s2">"forum-services"</span> and service account <span class="s2">"forum-sa"</span> has been generated and stored at <span class="s2">"ch13/workload-files/istio-token"</span>
Configuration generation into directory ./ch13/workload-files/ was successful
</code></pre></td></tr></table>
</div>
</div><p>生成的配置，这些文件中包含</p>
<ul>
<li><code>east-west gateway</code> 的暴露 <code>istiod</code> 的 IP 地址。</li>
<li>根证书，以验证 <code>istiod</code> 提交的证书的真实性。</li>
<li>用于验证论坛会员身份的服务帐户令牌 <code>WorkloadGroup</code> 到 <code>istiod</code> .</li>
<li><code>WorkloadGroup</code> 中定义的有关服务网格、网络和通用属性的配置。</li>
</ul>
<p><strong>将生成的文件传输到虚拟机</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">scp -i ch13/keys/id_rsa <span class="se">\
</span><span class="se"></span>  -r ./ch13/workload-files/* root@<span class="nv">$VM_IP</span>:/root/

<span class="c1"># istio-agent yum install</span>
curl -LO https://storage.googleapis.com/istio-release/releases/1.19.1/rpm/istio-sidecar.rpm
sudo rpm -i istio-sidecar.rpm



mkdir -p /etc/certs
<span class="se">\c</span>p <span class="se">\
</span><span class="se"></span>    <span class="s2">"</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">"</span>/root-cert.pem /etc/certs/root-cert.pem
mkdir -p /var/run/secrets/tokens
<span class="se">\c</span>p <span class="s2">"</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">"</span>/istio-token <span class="se">\
</span><span class="se"></span>    /var/run/secrets/tokens/istio-token
<span class="se">\c</span>p <span class="s2">"</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">"</span>/cluster.env <span class="se">\
</span><span class="se"></span>    /var/lib/istio/envoy/cluster.env
<span class="se">\c</span>p <span class="se">\
</span><span class="se"></span>    <span class="s2">"</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">"</span>/mesh.yaml /etc/istio/config/mesh
    
cat <span class="s2">"</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">"</span>/hosts <span class="p">|</span> <span class="se">\
</span><span class="se"></span>    sudo sh -c <span class="s1">'cat &gt;&gt; /etc/hosts'</span>

<span class="c1"># 当前 IP 与 主机名称绑定</span>
<span class="nb">echo</span> <span class="s2">"</span><span class="k">$(</span>hostname --all-ip-addresses <span class="p">|</span> cut -d <span class="s1">' '</span> -f 1<span class="k">)</span><span class="s2"> </span><span class="k">$(</span>hostname<span class="k">)</span><span class="s2">"</span> <span class="p">|</span> <span class="se">\
</span><span class="se"></span> sudo sh -c <span class="s1">'cat &gt;&gt; /etc/hosts'</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>启动代理</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="c1"># 启动代理前的最后一步是赋予其读写目录的所有者权限：</span>
sudo mkdir -p /etc/istio/proxy

sudo chown -R istio-proxy /var/lib/istio <span class="se">\
</span><span class="se"></span>    /etc/certs /etc/istio/proxy /etc/istio/config <span class="se">\
</span><span class="se"></span>    /var/run/secrets /etc/certs/root-cert.pem

systemctl <span class="nb">enable</span> istio --now
</code></pre></td></tr></table>
</div>
</div><p>检查代理日志</p>
<ul>
<li>标准输出通道写入文件 /var/log/istio/istio.log</li>
<li>标准错误通道写入文件 /var/log/istio/istio.err.log</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">cat /var/log/istio/istio.log <span class="p">|</span> grep xdsproxy
2023-10-05T04:37:04.364701Z	info	xdsproxy	Initializing with upstream address <span class="s2">"istiod.istio-system.svc:15012"</span> and cluster <span class="s2">"west-cluster"</span>
2023-10-05T04:37:04.410387Z	info	xdsproxy	connected to upstream XDS server: istiod.istio-system.svc:15012
</code></pre></td></tr></table>
</div>
</div><p>列出 <code>forum-services</code> 名称空间中的工作负载条目来验证这一下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kvm get workloadentry -n forum-services 
NAME                           AGE   ADDRESS
forum-192.168.8.8-vm-network   44m   192.168.8.8
</code></pre></td></tr></table>
</div>
</div><h3 id="将流量路由到群集服务">将流量路由到群集服务</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="o">[</span>root@istio-forum-vm-8 ~<span class="o">]</span><span class="c1"># curl webapp.istioinaction/api/catalog/items/1</span>
<span class="o">{</span><span class="s2">"id"</span>:1,<span class="s2">"color"</span>:<span class="s2">"amber"</span>,<span class="s2">"department"</span>:<span class="s2">"Eyewear"</span>,<span class="s2">"name"</span>:<span class="s2">"Elinor Glasses"</span>,<span class="s2">"price"</span>:<span class="s2">"282.00"</span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>请求得到服务的过程</p>
<ul>
<li>流量要离开应用程序，就必须解析其主机名。为此，DNS 查询必须重定向到 DNS 代理。</li>
<li>将名称解析为 IP 地址后，应用程序就能触发出站请求，并通过 Iptable 规则重定向到 Envoy 代理。</li>
<li>Envoy 代理将流量路由到 east-west gateway</li>
<li>east-west gateway 将请求代理给 <code>webapp</code> ，由 <code>webapp</code> 查询项目。，该网关会向 <code>catalog</code> 服务查询项目。</li>
</ul>
<p><strong>流量如何到达群集服务</strong></p>
<p><img alt="Pasted image 20231005124225" src="https://cdn.treesir.pub/images/2023/10/05/20231005124228.png"/></p>
<h3 id="将流量路由到工作负载">将流量路由到工作负载</h3>
<p>必须创建一个 Kubernetes 服务，使用标签选择实例，并让 Istio 用正确的 IP 地址动态配置所有服务。例如，为了选择 <code>forum</code> 工作负载条目，我们使用了以下 Kubernetes 服务：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">apiVersion: v1
kind: Service
metadata:
  labels:
    app: forum
  name: forum
spec:
  ports:
  - name: http
    port: <span class="m">80</span>
    protocol: TCP
    targetPort: <span class="m">8080</span>
  selector:
    app: forum
    
    
kvm apply -f services/forum/kubernetes/forum-svc.yaml <span class="se">\
</span><span class="se"></span>      -n forum-services
      
<span class="c1"># 创建服务后， WorkloadEntry 端点将被选中， istiod 将通过它配置数据平面。我们可以通过向 forum 服务发出请求来轻松验证这一点</span>
<span class="nv">EXT_IP</span><span class="o">=</span><span class="k">$(</span>kvm -n istio-system get svc istio-ingressgateway -o <span class="se">\
</span><span class="se"></span>      <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="k">)</span>
curl -is -H <span class="s2">"Host: webapp.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>      http://<span class="nv">$EXT_IP</span>/api/users <span class="p">|</span> grep HTTP
HTTP/1.1 <span class="m">500</span> Internal Server Error


<span class="c1"># 检查日志</span>
kvm -n istioinaction logs deploy/webapp -c istio-proxy <span class="p">|</span> tail -2
<span class="o">[</span>2023-10-05T04:50:49.931Z<span class="o">]</span> <span class="s2">"GET /api/users HTTP/1.1"</span> <span class="m">200</span> - via_upstream - <span class="s2">"-"</span> <span class="m">0</span> <span class="m">716</span> <span class="m">7</span> <span class="m">6</span> <span class="s2">"192.168.10.190"</span> <span class="s2">"beegoServer"</span> <span class="s2">"c8adce51-d210-4695-b6f8-d2ecf3dff6fb"</span> <span class="s2">"forum.forum-services:80"</span> <span class="s2">"192.168.8.8:80"</span> outbound<span class="p">|</span>80<span class="o">||</span>forum.forum-services.svc.cluster.local 10.42.8.7:40796 10.43.62.157:80 192.168.10.190:0 - default
<span class="o">[</span>2023-10-05T04:50:49.928Z<span class="o">]</span> <span class="s2">"GET /api/users HTTP/1.1"</span> <span class="m">500</span> - via_upstream - <span class="s2">"-"</span> <span class="m">0</span> <span class="m">27</span> <span class="m">10</span> <span class="m">10</span> <span class="s2">"192.168.10.190"</span> <span class="s2">"curl/8.1.2"</span> <span class="s2">"c8adce51-d210-4695-b6f8-d2ecf3dff6fb"</span> <span class="s2">"webapp.istioinaction.io"</span> <span class="s2">"10.42.8.7:8080"</span> inbound<span class="p">|</span>8080<span class="o">||</span> 127.0.0.6:37817 10.42.8.7:8080 192.168.10.190:0 outbound_.80_._.webapp.istioinaction.svc.cluster.local default


<span class="c1"># 检查端点</span>
ivm proxy-config endpoints deploy/webapp.istioinaction <span class="p">|</span> <span class="se">\
</span><span class="se"></span>       grep forum
192.168.8.8:8080                                        HEALTHY     OK                outbound<span class="p">|</span>80<span class="o">||</span>forum.forum-services.svc.cluster.local

<span class="c1"># 再次测试</span>
curl -is -H <span class="s2">"Host: webapp.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>      http://<span class="nv">$EXT_IP</span>/api/users <span class="p">|</span> grep HTTP 
HTTP/1.1 <span class="m">200</span> OK
</code></pre></td></tr></table>
</div>
</div><h3 id="虚拟机由控制平面配置强制执行相互验证">虚拟机由控制平面配置：强制执行相互验证</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">curl -is 192.168.8.8:8080/api/users <span class="p">|</span> grep HTTP
HTTP/1.1 <span class="m">200</span> OK

<span class="c1"># 在服务网格中配置一个全网格策略，只为经过相互验证的流量提供服务，从而保护我们的服务免受未经授权的访问</span>
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: istio-system
spec:
  mtls:
    mode: STRICT
    
kvm apply -f ch13/strict-peer-auth.yaml 


<span class="c1"># 此时再次请求时，已无响应</span>
curl -is 192.168.8.8:8080/api/users <span class="p">|</span> grep HTTP

<span class="c1"># 请求网格网关，却可以</span>
curl -is -H <span class="s2">"Host: webapp.istioinaction.io"</span> <span class="se">\
</span><span class="se"></span>      http://<span class="nv">$EXT_IP</span>/api/users <span class="p">|</span> grep HTTP
HTTP/1.1 <span class="m">200</span> OK
</code></pre></td></tr></table>
</div>
</div><h2 id="解密-dns-代理">解密 DNS 代理</h2>
<h3 id="dns-代理如何解析群集主机名">DNS 代理如何解析群集主机名</h3>
<ul>
<li>客户端通过 DNS 查询解析 <code>webapp.istioinaction</code></li>
<li>操作系统处理 DNS 解析。它首先会检查主机名是否与主机文件中定义的任何条目相匹配。如果不匹配，则将请求转发给默认 DNS 解析器。</li>
<li><code>istio-agent</code> 配置了 Iptable 规则，将请求重定向至 DNS 代理，因此请求未到达 <code>系统解析器</code>。</li>
<li>DNS 代理包含用于解析服务网格内已知服务的条目。如果主机名匹配，则会得到解析， <code>webapp.istioinaction</code> 就是这种情况，因为它是由控制平面使用 NDS 配置的。</li>
<li>否则，如果不是集群服务，DNS 代理会返回到 resolv.conf 文件中指定的 DNS，在那里进行解析或解析失败</li>
</ul>
<p>流程图如下:</p>
<p><img alt="Pasted image 20231005144527" src="https://cdn.treesir.pub/images/2023/10/05/20231005144529.png"/></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="o">[</span>root@istio-forum-vm-8 ~<span class="o">]</span><span class="c1"># iptables-save | grep 'to-ports 15053'</span>
-A OUTPUT -d 192.168.8.1/32 -p udp -m udp --dport <span class="m">53</span> -j REDIRECT --to-ports <span class="m">15053</span>
-A ISTIO_OUTPUT -d 192.168.8.1/32 -p tcp -m tcp --dport <span class="m">53</span> -j REDIRECT --to-ports <span class="m">15053</span>

<span class="c1"># 输出结果中，我们看到流量被重定向到 DNS 代理端口。</span>


<span class="o">[</span>root@istio-forum-vm-8 ~<span class="o">]</span><span class="c1"># netstat -ltunp</span>
Active Internet connections <span class="o">(</span>only servers<span class="o">)</span>
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:15090           0.0.0.0:*               LISTEN      7062/envoy
tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:22              0.0.0.0:*               LISTEN      1174/sshd
tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:15000         0.0.0.0:*               LISTEN      7062/envoy
tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:15001           0.0.0.0:*               LISTEN      7062/envoy
tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:15004         0.0.0.0:*               LISTEN      7054/pilot-agent
tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:15006           0.0.0.0:*               LISTEN      7062/envoy
tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:15021           0.0.0.0:*               LISTEN      7062/envoy
tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:15053         0.0.0.0:*               LISTEN      7054/pilot-agent  <span class="c1">#  istio-agent 正在监听端口 </span>
tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:111             0.0.0.0:*               LISTEN      737/rpcbind
tcp6       <span class="m">0</span>      <span class="m">0</span> :::22                   :::*                    LISTEN      1174/sshd
tcp6       <span class="m">0</span>      <span class="m">0</span> :::15020                :::*                    LISTEN      7054/pilot-agent
tcp6       <span class="m">0</span>      <span class="m">0</span> :::111                  :::*                    LISTEN      737/rpcbind
tcp6       <span class="m">0</span>      <span class="m">0</span> :::8080                 :::*                    LISTEN      6458/./forum
udp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:111             0.0.0.0:*                           737/rpcbind
udp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:323           0.0.0.0:*                           747/chronyd
udp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:15053         0.0.0.0:*                           7054/pilot-agent <span class="c1">#  istio-agent 正在监听端口 </span>
udp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:907             0.0.0.0:*                           737/rpcbind
udp6       <span class="m">0</span>      <span class="m">0</span> :::111                  :::*                                737/rpcbind
udp6       <span class="m">0</span>      <span class="m">0</span> ::1:323                 :::*                                747/chronyd
udp6       <span class="m">0</span>      <span class="m">0</span> :::907                  :::*                                737/rpcbind


---
<span class="c1"># 基于 dig 测试该代理 DNS</span>
<span class="o">[</span>root@istio-forum-vm-8 ~<span class="o">]</span><span class="c1"># dig +short @localhost -p 15053 webapp.istioinaction</span>
10.43.23.214 <span class="c1"># 可以正常返回解析。</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="dns-代理知道哪些主机名">DNS 代理知道哪些主机名？</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">ivm proxy-status  <span class="p">|</span> awk <span class="s1">'{print $1}'</span>
NAME
catalog-5df8455c79-jlv6r.istioinaction
istio-eastwestgateway-6cd6bb8544-p94g8.istio-system
istio-forum-vm-8.forum-services
istio-ingressgateway-57cbdcb9d9-xv485.istio-system
webapp-5f5984d7d5-4p7qp.istioinaction

<span class="c1"># 在检索 NDS 配置时，我们使用 proxyID 参数的名称。</span>
kvm -n istio-system <span class="nb">exec</span> deploy/istiod <span class="se">\
</span><span class="se"></span>      -- curl -Ls <span class="se">\
</span><span class="se"></span>      <span class="s2">"localhost:8080/debug/ndsz?proxyID=istio-forum-vm-8.forum-services"</span>
      
<span class="o">{</span>
  <span class="s2">"resource"</span>: <span class="o">{</span>
    <span class="s2">"@type"</span>: <span class="s2">"type.googleapis.com/istio.networking.nds.v1.NameTable"</span>,
    <span class="s2">"table"</span>: <span class="o">{</span>
      <span class="s2">"catalog.istioinaction.svc.cluster.local"</span>: <span class="o">{</span>
        <span class="s2">"ips"</span>: <span class="o">[</span>
          <span class="s2">"10.43.94.148"</span>
        <span class="o">]</span>,
        <span class="s2">"registry"</span>: <span class="s2">"Kubernetes"</span>,
        <span class="s2">"shortname"</span>: <span class="s2">"catalog"</span>,
        <span class="s2">"namespace"</span>: <span class="s2">"istioinaction"</span>
      <span class="o">}</span>,
      <span class="s2">"forum.forum-services.svc.cluster.local"</span>: <span class="o">{</span>
        <span class="s2">"ips"</span>: <span class="o">[</span>
          <span class="s2">"10.43.62.157"</span>
        <span class="o">]</span>,
        <span class="s2">"registry"</span>: <span class="s2">"Kubernetes"</span>,
        <span class="s2">"shortname"</span>: <span class="s2">"forum"</span>,
        <span class="s2">"namespace"</span>: <span class="s2">"forum-services"</span>
      <span class="o">}</span>,
      <span class="s2">"ingress-nginx-controller-admission.ingress-nginx.svc.cluster.local"</span>: <span class="o">{</span>
        <span class="s2">"ips"</span>: <span class="o">[</span>
          <span class="s2">"10.43.107.78"</span>
        <span class="o">]</span>,
        <span class="s2">"registry"</span>: <span class="s2">"Kubernetes"</span>,
        <span class="s2">"shortname"</span>: <span class="s2">"ingress-nginx-controller-admission"</span>,
        <span class="s2">"namespace"</span>: <span class="s2">"ingress-nginx"</span>
      <span class="o">}</span>,
      <span class="s2">"istio-eastwestgateway.istio-system.svc.cluster.local"</span>: <span class="o">{</span>
        <span class="s2">"ips"</span>: <span class="o">[</span>
          <span class="s2">"10.43.84.94"</span>
        <span class="o">]</span>,
        <span class="s2">"registry"</span>: <span class="s2">"Kubernetes"</span>,
        <span class="s2">"shortname"</span>: <span class="s2">"istio-eastwestgateway"</span>,
        <span class="s2">"namespace"</span>: <span class="s2">"istio-system"</span>
      <span class="o">}</span>,
      <span class="s2">"istio-ingressgateway.istio-system.svc.cluster.local"</span>: <span class="o">{</span>
        <span class="s2">"ips"</span>: <span class="o">[</span>
          <span class="s2">"10.43.212.115"</span>
        <span class="o">]</span>,
        <span class="s2">"registry"</span>: <span class="s2">"Kubernetes"</span>,
        <span class="s2">"shortname"</span>: <span class="s2">"istio-ingressgateway"</span>,
        <span class="s2">"namespace"</span>: <span class="s2">"istio-system"</span>
      <span class="o">}</span>,
      <span class="s2">"istiod.istio-system.svc.cluster.local"</span>: <span class="o">{</span>
        <span class="s2">"ips"</span>: <span class="o">[</span>
          <span class="s2">"10.43.82.93"</span>
        <span class="o">]</span>,
        <span class="s2">"registry"</span>: <span class="s2">"Kubernetes"</span>,
        <span class="s2">"shortname"</span>: <span class="s2">"istiod"</span>,
        <span class="s2">"namespace"</span>: <span class="s2">"istio-system"</span>
      <span class="o">}</span>,
      <span class="s2">"kube-dns-upstream.kube-system.svc.cluster.local"</span>: <span class="o">{</span>
        <span class="s2">"ips"</span>: <span class="o">[</span>
          <span class="s2">"10.43.43.125"</span>
        <span class="o">]</span>,
        <span class="s2">"registry"</span>: <span class="s2">"Kubernetes"</span>,
        <span class="s2">"shortname"</span>: <span class="s2">"kube-dns-upstream"</span>,
        <span class="s2">"namespace"</span>: <span class="s2">"kube-system"</span>
      <span class="o">}</span>,
      <span class="s2">"kube-dns.kube-system.svc.cluster.local"</span>: <span class="o">{</span>
        <span class="s2">"ips"</span>: <span class="o">[</span>
          <span class="s2">"10.43.0.10"</span>
        <span class="o">]</span>,
        <span class="s2">"registry"</span>: <span class="s2">"Kubernetes"</span>,
        <span class="s2">"shortname"</span>: <span class="s2">"kube-dns"</span>,
        <span class="s2">"namespace"</span>: <span class="s2">"kube-system"</span>
      <span class="o">}</span>,
      <span class="s2">"kubernetes.default.svc.cluster.local"</span>: <span class="o">{</span>
        <span class="s2">"ips"</span>: <span class="o">[</span>
          <span class="s2">"10.43.0.1"</span>
        <span class="o">]</span>,
        <span class="s2">"registry"</span>: <span class="s2">"Kubernetes"</span>,
        <span class="s2">"shortname"</span>: <span class="s2">"kubernetes"</span>,
        <span class="s2">"namespace"</span>: <span class="s2">"default"</span>
      <span class="o">}</span>,
      <span class="s2">"metrics-server.kube-system.svc.cluster.local"</span>: <span class="o">{</span>
        <span class="s2">"ips"</span>: <span class="o">[</span>
          <span class="s2">"10.43.138.157"</span>
        <span class="o">]</span>,
        <span class="s2">"registry"</span>: <span class="s2">"Kubernetes"</span>,
        <span class="s2">"shortname"</span>: <span class="s2">"metrics-server"</span>,
        <span class="s2">"namespace"</span>: <span class="s2">"kube-system"</span>
      <span class="o">}</span>,
      <span class="s2">"webapp.istioinaction.svc.cluster.local"</span>: <span class="o">{</span>
        <span class="s2">"ips"</span>: <span class="o">[</span>
          <span class="s2">"10.43.23.214"</span>
        <span class="o">]</span>,
        <span class="s2">"registry"</span>: <span class="s2">"Kubernetes"</span>,
        <span class="s2">"shortname"</span>: <span class="s2">"webapp"</span>,
        <span class="s2">"namespace"</span>: <span class="s2">"istioinaction"</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>  
</code></pre></td></tr></table>
</div>
</div><p>当 <code>istio-agent</code> 接收到 NDS 配置时，它会生成在 Kubernetes 集群中配置的所有DNS 格式，例如</p>
<ul>
<li>webapp.istioinaction.svc.cluster.local</li>
<li>webapp.istioinaction</li>
<li>webapp.istioinaction.svc</li>
</ul>
<hr/>
<p><strong>总结</strong></p>
<ul>
<li>DNS 代理由 <code>istiod</code> 使用已知服务进行配置。</li>
<li><code>istio-agent</code> 会生成主机名的较短变体（以符合 Kubernetes 的经验）。</li>
</ul>
<hr/>
<h2 id="自定义代理配置">自定义代理配置</h2>
<p>代理有大量的配置选项：记录什么、如何格式化，以及诸如配置代理为获得证书而要求的证书有效期等行为。</p>
<ul>
<li>将 DNS 代理的日志记录级别提高到 debug 级别。</li>
<li>将证书有效期缩短至 12 小时。</li>
</ul>
<p>可以更新 <code>/var/lib/istio/envoy/sidecar.env</code> 文件，该文件用于特定于 sidecar 的配置</p>
<blockquote>
<p><a href="https://istio.io/latest/docs/reference/commands/pilot-agent/">https://istio.io/latest/docs/reference/commands/pilot-agent/</a></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="nv">ISTIO_AGENT_FLAGS</span><span class="o">=</span><span class="s2">"--log_output_level=dns:debug"</span>
<span class="nv">SECRET_TTL</span><span class="o">=</span><span class="s2">"12h0m0s"</span>


<span class="c1"># 配置重启生效</span>
sudo systemctl restart istio
</code></pre></td></tr></table>
</div>
</div><h2 id="从网格中删除工作负载条目">从网格中删除工作负载条目</h2>
<blockquote>
<p>和虚拟机自动注册到网格中一样，当它被 <code>删除时</code>，也会被自动清理掉。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash">kvm get workloadentries -n forum-services
</code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>特点</th>
<th>Kubernetes</th>
<th>虚拟机</th>
</tr>
</thead>
<tbody>
<tr>
<td>安装代理</td>
<td>使用 istioctl 手动注入或使用 webhook 自动注入</td>
<td>下载并手动安装</td>
</tr>
<tr>
<td>配置代理</td>
<td>在 Sidecar 中完成</td>
<td>使用 istioctl 从 WorkloadGroup 生成配置并通过代理传输到虚拟机</td>
</tr>
<tr>
<td>引导式工作量识别</td>
<td>服务账户令牌由 Kubernetes 机制注入 Pod</td>
<td>手动将服务帐户令牌传输到虚拟机</td>
</tr>
<tr>
<td>健康检查</td>
<td>由 Kubernetes 执行就绪性和有效性探测。</td>
<td>准备状态探针在工作负载组中配置。</td>
</tr>
<tr>
<td>注册</td>
<td>由 Kubernetes 处理</td>
<td>将虚拟机自动注册为工作负载组成员</td>
</tr>
<tr>
<td>DNS 解析</td>
<td>群集内 DNS 服务器用于解析群集内的 FQDN。DNS 代理是可选的。</td>
<td>DNS 代理由 istiod 配置，解析 FQDN。</td>
</tr>
</tbody>
</table>
<hr/>
<h1 id="在请求路径上扩展-istio">在请求路径上扩展 Istio</h1>
<p>Todos</p>
</div>
<div class="post-copyright">
<p class="copyright-item">
<span class="item-title">文章作者</span>
<span class="item-content">Leafy'John</span>
</p>
<p class="copyright-item">
<span class="item-title">上次更新</span>
<span class="item-content">
        2023-10-05
        
    </span>
</p>
<p class="copyright-item">
<span class="item-title">许可协议</span>
<span class="item-content"><a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" rel="license noopener" target="_blank">CC BY-NC-ND 4.0</a></span>
</p>
</div>
<footer class="post-footer">
<div class="post-tags">
<a href="/tags/istio/">Istio</a>
<a href="/tags/servicemesh/">ServiceMesh</a>
</div>
<nav class="post-nav">
<a class="prev" href="/post/pve-autosnap/">
<i class="iconfont icon-left"></i>
<span class="prev-text nav-default">PVE AutoSnap 工具使用</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class="next" href="/post/blog-starts-loki-data-analysis/">
<span class="next-text nav-default">站点开始使用 Grafana loki 统计分析</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i>
</a>
</nav>
</footer>
</article>
</div>
<div id="vcomments"></div>
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@3/dist/av-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script>
<script type="text/javascript">
    new Valine({
        el: '#vcomments' ,
        appId: 'wS5tU9o2RILlBpQiEfIDgPwI-gzGzoHsz',
        appKey: 'siSAWI3rzA6Ow8Tmiv7V4GO4',
        notify:  true ,
        verify:  true ,
        avatar:'',
        placeholder: '来留下点什么吧~',
        visitor:  false 
    });
  </script>
</div>
</main>
<footer class="footer" id="footer">
<div class="social-links">
<a class="iconfont icon-email" href="mailto:yangzun@treesir.pub" title="email"></a>
<a class="iconfont icon-github" href="https://github.com/cdryzun" title="github"></a>
<a class="iconfont icon-rss" href="https://cdryzun.github.io/index.xml" title="rss" type="application/rss+xml"></a>
</div>
<div class="copyright">
<span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
</span>
<span class="division">|</span>
<span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
</span>
<span class="copyright-year">
<a class="busuanzi-footer" href="https://beian.miit.gov.cn/">湘ICP备2021002157号-1</a> <img alt="upai" class="ls-is-cached lazyloaded" height="28" src="https://cdn.treesir.pub/img/icp.png" style="margin: -25px 2px" width="23"/> <a href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral" rel="nofollow" target="_blank"><img alt="upai" class="ls-is-cached lazyloaded" height="28" src="https://cdn.treesir.pub/img/upyun.png" style="margin: -25px 2px" width="56"/></a>
    © 
    2019 - 
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>Leafy'John </span>
</span>
</div>
</footer>
<div class="back-to-top" id="back-to-top">
<i class="iconfont icon-up"></i>
</div>
</div>
<script crossorigin="anonymous" src="https://cdn.treesir.pub/blog-js/jquery.min.js"></script>
<script crossorigin="anonymous" src="https://cdn.treesir.pub/blog-js/slideout.min.js"></script>
<script crossorigin="anonymous" src="https://cdn.treesir.pub/blog-js/jquery.fancybox.min.js"></script>
<script src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js" type="text/javascript"></script>
<script src="/js/copy-to-clipboard.js"></script>
<script src="https://cdn.treesir.pub/blog-js/docsearch.min.js"></script>
<script>
    docsearch({
    apiKey: "17388eec628e676a77d6235068b458df",
    indexName: "blog",
    appId: "KEECS2XKBV",
    inputSelector: '.docsearch-input',
    debug: false,
    });
</script>
</body>
</html>
